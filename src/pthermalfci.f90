SUBROUTINE THERMAL_CORRELATION
! PERFORM LAMBDA-VARIATION CALCULATIONS

   USE CONSTANTS
   USE CONTROL
   USE STRUCTURE
   USE INTEGRAL
   USE BASISSET
   USE GRADIENT
   USE THR_FULLCI

   IMPLICIT NONE
   DOUBLE PRECISION,PARAMETER :: DELTALAMBDA=0.01D0
   DOUBLE PRECISION :: B(-3:8,4),C
   DOUBLE PRECISION,ALLOCATABLE :: HCPT(:,:)
   INTEGER :: I

   NALL=2**(2*(IALL(0,0,0)-IVIRTCORE-ICORE))
   ALLOCATE(HCPT(NALL,0:2))

   CALL TSDA_GRANDCANONICAL(1.0D0,B(I,1),B(I,2),B(I,3),B(I,4),.TRUE.)

   CALL THERMAL_GRANDCANONICAL(1.0D0,B(I,1),B(I,2),B(I,3),B(I,4),.TRUE.)
   DO I=-3,8
    CALL THERMAL_GRANDCANONICAL(DFLOAT(I)*DELTALAMBDA,B(I,1),B(I,2),B(I,3),B(I,4),.FALSE.)
   ENDDO

   WRITE(6,'(/,A,/)') "/\/\/\/\/\/\/\/\/\/\/\/\/\/\/\/\/\/\/\/\/\/\/\/\/\/\/\/\/\/\/\/\/\/\/\/\/\/\"
   WRITE(6,'(A)')     "LAMBDA-VARIATION FOR THERMODYNAMIC QUANTITIES IN GRAND CANONICAL ENSEMBLE "

   WRITE(6,'(/,A,/)') "CENTRAL SEVEN-POINT FORMULA "
   DO I=1,4
    IF (I==1) WRITE(6,'(A)') 'MU (CHEMICAL POTENTIAL)'
    IF (I==2) WRITE(6,'(A)') 'OMEGA (GRAND POTENTIAL)'
    IF (I==3) WRITE(6,'(A)') 'U (INTERNAL ENERGY)'
    IF (I==4) WRITE(6,'(A)') 'S (ENTROPY)'
    C=B(0,I)
    WRITE(6,'(I2,F20.10)') 0,C
    C=(-B(-3,I)+9.0D0*B(-2,I)-45.0D0*B(-1,I)+45.0D0*B(1,I) &
      -9.0D0*B(2,I)+B(3,I))/60.0D0/DELTALAMBDA    
    WRITE(6,'(I2,F20.10)') 1,C
    C=(2.0D0*B(-3,I)-27.0D0*B(-2,I)+270.0D0*B(-1,I)-490.0D0*B(0,I) &
      +270.0D0*B(1,I)-27.0D0*B(2,I)+2.0D0*B(3,I)) &
      /180.0D0/(DELTALAMBDA**2)/2.0D0
    WRITE(6,'(I2,F20.10)') 2,C
    C=(B(-3,I)-8.0D0*B(-2,I)+13.0D0*B(-1,I)-13.0D0*B(1,I) &
      +8.0D0*B(2,I)-B(3,I))/8.0D0/(DELTALAMBDA**3)/6.0D0
    WRITE(6,'(I2,F20.10)') 3,C
    C=(-B(-3,I)+12.0D0*B(-2,I)-39.0D0*B(-1,I)+56.0D0*B(0,I) &
      -39.0D0*B(1,I)+12.0D0*B(2,I)-B(3,I)) &
      /6.0D0/(DELTALAMBDA**4)/24.0D0
    WRITE(6,'(I2,F20.10)') 4,C
    C=(-B(-3,I)+4.0D0*B(-2,I)-5.0D0*B(-1,I)+5.0D0*B(1,I) &
      -4.0D0*B(2,I)+B(3,I))/2.0D0/(DELTALAMBDA**5)/120.0D0
    WRITE(6,'(I2,F20.10)') 5,C
   ENDDO

   WRITE(6,'(/,A,/)') "FORWARD SEVEN- THROUGH NINE-POINT FORMULA"
   DO I=1,4
    IF (I==1) WRITE(6,'(A)') 'MU (CHEMICAL POTENTIAL)'
    IF (I==2) WRITE(6,'(A)') 'OMEGA (GRAND POTENTIAL)'
    IF (I==3) WRITE(6,'(A)') 'U (INTERNAL ENERGY)'
    IF (I==4) WRITE(6,'(A)') 'S (ENTROPY)'
    C=B(0,I)
    WRITE(6,'(I2,F20.10)') 0,C
    C=(-49.0D0/20.0D0*B(0,I)+6.0D0*B(1,I)-15.0D0/2.0D0*B(2,I) &
      +20.0D0/3.0D0*B(3,I)-15.0D0/4.0D0*B(4,I)+6.0D0/5.0D0*B(5,I) &
      -1.0D0/6.0D0*B(6,I))/DELTALAMBDA
    WRITE(6,'(I2,F20.10)') 1,C
    C=(+469.0D0/90.0D0*B(0,I)-223.0D0/10.0D0*B(1,I)+879.0D0/20.0D0*B(2,I) &
      -949.0D0/18.0D0*B(3,I)+41.0D0*B(4,I)-201.0D0/10.0D0*B(5,I) &
      +1019.0D0/180.0D0*B(6,I)-7.0D0/10.0D0*B(7,I))/(DELTALAMBDA**2)/2.0D0
    WRITE(6,'(I2,F20.10)') 2,C
    C=(-801.0D0/80.0D0*B(0,I)+349.0D0/6.0D0*B(1,I)-18353.0D0/120.0D0*B(2,I) &
      +2391.0D0/10.0D0*B(3,I)-1457.0D0/6.0D0*B(4,I)+4891.0D0/30.0D0*B(5,I) &
      -561.0D0/8.0D0*B(6,I)+527.0D0/30.0D0*B(7,I)-469.0D0/240.0D0*B(8,I))/(DELTALAMBDA**3)/6.0D0
    WRITE(6,'(I2,F20.10)') 3,C
    C=(1069.0D0/80.0D0*B(0,I)-1316.0D0/15.0D0*B(1,I)+15289.0D0/60.0D0*B(2,I) &
      -2144.0D0/5.0D0*B(3,I)+10993.0D0/24.0D0*B(4,I)-4772.0D0/15.0D0*B(5,I) &
      +2803.0D0/20.0D0*B(6,I)-536.0D0/15.0D0*B(7,I)+967.0D0/240.0D0*B(8,I)) &
      /(DELTALAMBDA**4)/24.0D0
    WRITE(6,'(I2,F20.10)') 4,C
   ENDDO
   WRITE(6,'(/,A)') "\/\/\/\/\/\/\/\/\/\/\/\/\/\/\/\/\/\/\/\/\/\/\/\/\/\/\/\/\/\/\/\/\/\/\/\/\/\/"

   CALL THERMAL_CANONICAL(1.0D0,B(I,1),B(I,2),B(I,3),B(I,4),.TRUE.)
   DO I=-3,8
    CALL THERMAL_CANONICAL(DFLOAT(I)*DELTALAMBDA,B(I,1),B(I,2),B(I,3),B(I,4),.FALSE.)
   ENDDO

   WRITE(6,'(/,A,/)') "==================================================================="
   WRITE(6,'(A)')     "LAMBDA-VARIATION FOR THERMODYNAMIC QUANTITIES IN CANONICAL ENSEMBLE"

   WRITE(6,'(/,A,/)') "CENTRAL SEVEN-POINT FORMULA "
   DO I=2,4
    IF (I==2) WRITE(6,'(A)') 'F (HERMHOLTZ ENERGY)'
    IF (I==3) WRITE(6,'(A)') 'U (INTERNAL ENERGY)'
    IF (I==4) WRITE(6,'(A)') 'S (ENTROPY)'
    C=B(0,I)
    WRITE(6,'(I2,F20.10)') 0,C
    C=(-B(-3,I)+9.0D0*B(-2,I)-45.0D0*B(-1,I)+45.0D0*B(1,I) &
      -9.0D0*B(2,I)+B(3,I))/60.0D0/DELTALAMBDA    
    WRITE(6,'(I2,F20.10)') 1,C
    C=(2.0D0*B(-3,I)-27.0D0*B(-2,I)+270.0D0*B(-1,I)-490.0D0*B(0,I) &
      +270.0D0*B(1,I)-27.0D0*B(2,I)+2.0D0*B(3,I)) &
      /180.0D0/(DELTALAMBDA**2)/2.0D0
    WRITE(6,'(I2,F20.10)') 2,C
    C=(B(-3,I)-8.0D0*B(-2,I)+13.0D0*B(-1,I)-13.0D0*B(1,I) &
      +8.0D0*B(2,I)-B(3,I))/8.0D0/(DELTALAMBDA**3)/6.0D0
    WRITE(6,'(I2,F20.10)') 3,C
    C=(-B(-3,I)+12.0D0*B(-2,I)-39.0D0*B(-1,I)+56.0D0*B(0,I) &
      -39.0D0*B(1,I)+12.0D0*B(2,I)-B(3,I)) &
      /6.0D0/(DELTALAMBDA**4)/24.0D0
    WRITE(6,'(I2,F20.10)') 4,C
    C=(-B(-3,I)+4.0D0*B(-2,I)-5.0D0*B(-1,I)+5.0D0*B(1,I) &
      -4.0D0*B(2,I)+B(3,I))/2.0D0/(DELTALAMBDA**5)/120.0D0
    WRITE(6,'(I2,F20.10)') 5,C
   ENDDO

   WRITE(6,'(/,A,/)') "FORWARD SEVEN- THROUGH NINE-POINT FORMULA"
   DO I=2,4
    IF (I==2) WRITE(6,'(A)') 'F (HERMHOLTZ ENERGY)'
    IF (I==3) WRITE(6,'(A)') 'U (INTERNAL ENERGY)'
    IF (I==4) WRITE(6,'(A)') 'S (ENTROPY)'
    C=B(0,I)
    WRITE(6,'(I2,F20.10)') 0,C
    C=(-49.0D0/20.0D0*B(0,I)+6.0D0*B(1,I)-15.0D0/2.0D0*B(2,I) &
      +20.0D0/3.0D0*B(3,I)-15.0D0/4.0D0*B(4,I)+6.0D0/5.0D0*B(5,I) &
      -1.0D0/6.0D0*B(6,I))/DELTALAMBDA
    WRITE(6,'(I2,F20.10)') 1,C
    C=(+469.0D0/90.0D0*B(0,I)-223.0D0/10.0D0*B(1,I)+879.0D0/20.0D0*B(2,I) &
      -949.0D0/18.0D0*B(3,I)+41.0D0*B(4,I)-201.0D0/10.0D0*B(5,I) &
      +1019.0D0/180.0D0*B(6,I)-7.0D0/10.0D0*B(7,I))/(DELTALAMBDA**2)/2.0D0
    WRITE(6,'(I2,F20.10)') 2,C
    C=(-801.0D0/80.0D0*B(0,I)+349.0D0/6.0D0*B(1,I)-18353.0D0/120.0D0*B(2,I) &
      +2391.0D0/10.0D0*B(3,I)-1457.0D0/6.0D0*B(4,I)+4891.0D0/30.0D0*B(5,I) &
      -561.0D0/8.0D0*B(6,I)+527.0D0/30.0D0*B(7,I)-469.0D0/240.0D0*B(8,I))/(DELTALAMBDA**3)/6.0D0
    WRITE(6,'(I2,F20.10)') 3,C
    C=(1069.0D0/80.0D0*B(0,I)-1316.0D0/15.0D0*B(1,I)+15289.0D0/60.0D0*B(2,I) &
      -2144.0D0/5.0D0*B(3,I)+10993.0D0/24.0D0*B(4,I)-4772.0D0/15.0D0*B(5,I) &
      +2803.0D0/20.0D0*B(6,I)-536.0D0/15.0D0*B(7,I)+967.0D0/240.0D0*B(8,I)) &
      /(DELTALAMBDA**4)/24.0D0
    WRITE(6,'(I2,F20.10)') 4,C
   ENDDO
   WRITE(6,'(/,A)') "==================================================================="

   DEALLOCATE(HCPT)

   RETURN

END SUBROUTINE



SUBROUTINE THERMAL_GRANDCANONICAL(LAMBDA,MU,OOO,UUU,SSS,LPRINT)
! PERFORM THERMAL FULL CI IN GRAND CANONICAL ENSEMBLE

   USE CONSTANTS
   USE CONTROL
   USE STRUCTURE
   USE INTEGRAL
   USE BASISSET
   USE GRADIENT
   USE THR_FULLCI

   IMPLICIT NONE
   LOGICAL :: LPRINT
   DOUBLE PRECISION :: LAMBDA
   INTEGER :: NALL_CHECK,I
   DOUBLE PRECISION :: NBAR  ! MEAN NUMBER OF ELECTRONS
   DOUBLE PRECISION :: XI    ! GRAND PARTITION FUNCTION
   DOUBLE PRECISION :: MU    ! CHEMICAL POTENTIAL
   DOUBLE PRECISION :: OOO   ! GRAND POTENTIAL
   DOUBLE PRECISION :: UUU   ! INTERNAL ENERGY
   DOUBLE PRECISION :: SSS   ! ENTROPY
   DOUBLE PRECISION :: BETA  ! 1/(kB T)
   DOUBLE PRECISION :: MUMAX,MUMIN,MUMID
   DOUBLE PRECISION :: NBMAX,NBMIN,NBMID,NBERR

   IF ((KVCX /= 0).OR.(KVCY /= 0).OR.(KVCZ /= 0)) CALL PABORT('FOR MOLECULES ONLY')
   IF (LOPTN(25)) CALL PABORT('USE NON-DIRECT ALGORITHM')
   IF (IALL(0,0,0)-IOCC-IVIRTCORE <= 0) CALL PABORT('NO VIRTUAL ORBITAL')
   IF (ICORE > 0) CALL PABORT('ICORE LOGIC NOT TESTED YET')
   IF (IVIRTCORE > 0) CALL PABORT('IVIRTCORE LOGIC NOT TESTED YET')

   IF (LPRINT) THEN
    WRITE(6,'(/,A)') '***********************************'
    WRITE(6,'(A)')   '* THERMAL FULL CI GRAND CANONICAL *'
    WRITE(6,'(A)')   '***********************************'
    WRITE(6,'(A,F20.6,A)') 'LAMBDA    = ',LAMBDA
    WRITE(6,'(A,E20.6,A)') 'TEMP      = ',DOPTN(98),' K'
    WRITE(6,'(A,F20.6,A)') 'FERMI     = ',FERMI,' HARTREE'
   ENDIF

   ALLOCATE(H(IALLMAX-IVIRTCORE,IALLMAX-IVIRTCORE))
   ALLOCATE(G(IALLMAX-IVIRTCORE,IALLMAX-IVIRTCORE,IALLMAX-IVIRTCORE,IALLMAX-IVIRTCORE))
   CALL THERMAL_ONE_ELECTRON_INTEGRALS
   CALL THERMAL_TWO_ELECTRON_INTEGRALS

   NALL=2**(2*(IALL(0,0,0)-IVIRTCORE-ICORE))
   ALLOCATE(ALLE(NALL),ALLN(NALL))

   ! LOOP OVER NUMBER OF ELECTRONS
   NALL_CHECK=0
   ESHIFT=1.0D9
   DO NELE=2*ICORE,2*(IALL(0,0,0)-IVIRTCORE)
!   WRITE(6,'(/,A,I3)')   'TOTAL # ELECTRONS             = ',NELE
    ! LOOP OVER SZ
    DO NELEA=ICORE,NELE
     NELEB=NELE-NELEA
     IF (NELEA > IALL(0,0,0)-IVIRTCORE) CYCLE
     IF (NELEB > IALL(0,0,0)-IVIRTCORE) CYCLE
     IF (NELEA < ICORE) CYCLE
     IF (NELEB < ICORE) CYCLE
!    WRITE(6,'(/,A,I3,A,I3)') ' # ALPHA-, BETA-ELECTRONS       = ',NELEA,'  ',NELEB
     CALL THERMAL_GENERATE_CONFIGURATIONSA(NELEA,MIN(NELEA,IALL(0,0,0)-IVIRTCORE-NELEA))
!    WRITE(6,'(A)') '     -----------------------'
     CALL THERMAL_GENERATE_CONFIGURATIONSB(NELEB,MIN(NELEB,IALL(0,0,0)-IVIRTCORE-NELEB))
!    WRITE(6,'(A,I3,A,I3,A,I4)') ' # ALPHA-, BETA-CONFIGURATIONS  = ',NCFA,' x',NCFB,'=',NCFA*NCFB
     CALL THERMAL_FULL_CI(LAMBDA,NALL_CHECK)
     DO I=1,NCFA*NCFB
      ALLN(NALL_CHECK+I)=NELE
      IF (ALLE(NALL_CHECK+I) < ESHIFT) ESHIFT=ALLE(NALL_CHECK+I) 
     ENDDO
     NALL_CHECK=NALL_CHECK+NCFA*NCFB
     DEALLOCATE(CFHALFA,ADDRSSA,NORDERA)
     DEALLOCATE(CFHALFB,ADDRSSB,NORDERB)
    ENDDO
   ENDDO
!  WRITE(6,'(A,2I6)') 'TOTAL # CONFIGURATIONS = ',NALL_CHECK
   IF (NALL_CHECK /= NALL) CALL PABORT('A BUG IN THERMAL_CORRELATION')

!  WRITE(6,'(A)') '----------------------------'
!  WRITE(6,'(A)') '       N        ENERGY'
!  WRITE(6,'(A)') '----------------------------'
!  DO I=1,NALL
!   WRITE(6,'(I5,I3,F20.15)') I,ALLN(I),ALLE(I)
!  ENDDO
!  WRITE(6,'(A)') '----------------------------'
!  WRITE(6,'(A,F20.15)') 'SHIFT = ',ESHIFT

   ! CALCULATE XI & MU
   NBAR=DFLOAT(IOCC*2)
   BETA=1.0D0/BOLTZMANN/DOPTN(98)
   MUMAX=FERMI+DSQRT(DOPTN(98)/1.0D4)
   MUMIN=FERMI-DSQRT(DOPTN(98)/1.0D4)
   MUMID=(MUMAX+MUMIN)/2.0D0
   NBERR=1.0D9

   IF (LPRINT) THEN
    WRITE(6,'(/,A)') '----------------------------------------------------------------------------'
    WRITE(6,'(A)') '  TREND         N   (  MU MIN  )      N   (  MU MID  )      N   (  MU MAX  )'
    WRITE(6,'(A)') '----------------------------------------------------------------------------'
   ENDIF
   DO WHILE ((NBERR > 1.0D-10).OR.(MUMAX-MUMIN > 1.0D-6))
    CALL CALCNBAR(BETA,MUMAX,NBMAX)
    CALL CALCNBAR(BETA,MUMIN,NBMIN)
    CALL CALCNBAR(BETA,MUMID,NBMID)
    IF ((NBMAX > NBMID).AND.(NBMID > NBMIN)) THEN
     IF (LPRINT) &
     WRITE(6,'(A,3(F10.6,A,F10.6,A))') 'INCREASING',NBMIN,'(',MUMIN,')',NBMID,'(',MUMID,')',NBMAX,'(',MUMAX,')'
     IF (NBAR > NBMAX) THEN
      MUMIN=MUMAX
      MUMAX=MUMAX+(MUMAX-MUMID)
     ELSE IF (NBAR > NBMID) THEN
      MUMIN=MUMID
     ELSE IF (NBAR > NBMIN) THEN
      MUMAX=MUMID
     ELSE
      MUMAX=MUMIN
      MUMIN=MUMIN-(MUMID-MUMIN)
     ENDIF
     MUMID=(MUMAX+MUMIN)/2.0D0
    ELSE IF ((NBMAX < NBMID).AND.(NBMID < NBMIN)) THEN
     IF (LPRINT) &
     WRITE(6,'(A,3(F10.6,A,F10.6,A))') 'DECREASING',NBMIN,'(',MUMIN,')',NBMID,'(',MUMID,')',NBMAX,'(',MUMAX,')'
     IF (NBAR < NBMAX) THEN
      MUMIN=MUMAX
      MUMAX=MUMAX+(MUMAX-MUMID)
     ELSE IF (NBAR < NBMID) THEN
      MUMIN=MUMID
     ELSE IF (NBAR < NBMIN) THEN
      MUMAX=MUMID
     ELSE
      MUMAX=MUMIN
      MUMIN=MUMIN-(MUMID-MUMIN)
     ENDIF
     MUMID=(MUMAX+MUMIN)/2.0D0
    ELSE
     IF (LPRINT) &
     WRITE(6,'(A,3(F10.6,A,F10.6,A))') 'CONCAV/VEX',NBMIN,'(',MUMIN,')',NBMID,'(',MUMID,')',NBMAX,'(',MUMAX,')'
     CALL WARNING('BISECTION FAILED')
     MUMIN=1.0D99
     EXIT
    ENDIF
    NBERR=DABS(NBAR-NBMID)
   ENDDO
   IF (LPRINT) &
   WRITE(6,'(A)') '----------------------------------------------------------------------------'
   MU=MUMIN

   CALL CALCTHERM(BETA,MU,NBAR,XI,OOO,UUU,SSS)

   IF (LPRINT) THEN
    WRITE(6,'(/,A,F20.10)')          'LAMBDA                        =',LAMBDA
    WRITE(6,'(A,E20.10,A)')          'TEMPERATURE                   =',DOPTN(98),' K'
    WRITE(6,'(A,F20.10,A)')          'BETA                          =',BETA,' HARTREE**(-1)'
    WRITE(6,'(A,F20.10,A)')          'CONVERGED MU                  =',MU,' HARTREE'
    WRITE(6,'(A,F20.10,A)')          'ESHIFT                        =',ESHIFT,' HARTREE'
    WRITE(6,'(A,E20.10,A,F15.10,A)') 'XI (GRAND PARTITION FUNCTION) =',XI,' x EXP(',-BETA*ESHIFT,')'
    WRITE(6,'(A,F20.10,A)')          'OMEGA (GRAND POTENTIAL)       =',OOO,' HARTREE'
    WRITE(6,'(A,F20.10,A)')          'U (INTERNAL ENERGY)           =',UUU,' HARTREE'
    WRITE(6,'(A,F20.10,A)')          'S (ENTROPY)                   =',SSS,' kB'
   ENDIF
     
   DEALLOCATE(ALLE,ALLN,H,G)

   RETURN
END SUBROUTINE



SUBROUTINE THERMAL_CANONICAL(LAMBDA,MU,OOO,UUU,SSS,LPRINT)
! PERFORM THERMAL FULL CI IN GRAND CANONICAL ENSEMBLE

   USE CONSTANTS
   USE CONTROL
   USE STRUCTURE
   USE INTEGRAL
   USE BASISSET
   USE GRADIENT
   USE THR_FULLCI

   IMPLICIT NONE
   LOGICAL :: LPRINT
   DOUBLE PRECISION :: LAMBDA
   INTEGER :: NALL_CHECK,I
   DOUBLE PRECISION :: NBAR  ! MEAN NUMBER OF ELECTRONS
   DOUBLE PRECISION :: XI    ! GRAND PARTITION FUNCTION
   DOUBLE PRECISION :: MU    ! CHEMICAL POTENTIAL
   DOUBLE PRECISION :: OOO   ! GRAND POTENTIAL
   DOUBLE PRECISION :: UUU   ! INTERNAL ENERGY
   DOUBLE PRECISION :: SSS   ! ENTROPY
   DOUBLE PRECISION :: BETA  ! 1/(kB T)

   IF ((KVCX /= 0).OR.(KVCY /= 0).OR.(KVCZ /= 0)) CALL PABORT('FOR MOLECULES ONLY')
   IF (LOPTN(25)) CALL PABORT('USE NON-DIRECT ALGORITHM')
   IF (IALL(0,0,0)-IOCC-IVIRTCORE <= 0) CALL PABORT('NO VIRTUAL ORBITAL')
   IF (ICORE > 0) CALL PABORT('ICORE LOGIC NOT TESTED YET')
   IF (IVIRTCORE > 0) CALL PABORT('IVIRTCORE LOGIC NOT TESTED YET')

   IF (LPRINT) THEN
    WRITE(6,'(/,A)') '============================='
    WRITE(6,'(A)')   '= THERMAL FULL CI CANONICAL ='
    WRITE(6,'(A)')   '============================='
    WRITE(6,'(A,F20.6,A)') 'LAMBDA    = ',LAMBDA
    WRITE(6,'(A,E20.6,A)') 'TEMP      = ',DOPTN(98),' K'
    WRITE(6,'(A,F20.6,A)') 'FERMI     = ',FERMI,' HARTREE'
   ENDIF

   ALLOCATE(H(IALLMAX-IVIRTCORE,IALLMAX-IVIRTCORE))
   ALLOCATE(G(IALLMAX-IVIRTCORE,IALLMAX-IVIRTCORE,IALLMAX-IVIRTCORE,IALLMAX-IVIRTCORE))
   CALL THERMAL_ONE_ELECTRON_INTEGRALS
   CALL THERMAL_TWO_ELECTRON_INTEGRALS

   NALL=2**(2*(IALL(0,0,0)-IVIRTCORE-ICORE))
   ALLOCATE(ALLE(NALL),ALLN(NALL))

   ! LOOP OVER NUMBER OF ELECTRONS
   NALL_CHECK=0
   ESHIFT=1.0D9
   DO NELE=2*ICORE,2*(IALL(0,0,0)-IVIRTCORE)
!   WRITE(6,'(/,A,I3)')   'TOTAL # ELECTRONS             = ',NELE
    ! LOOP OVER SZ
    DO NELEA=ICORE,NELE
     NELEB=NELE-NELEA
     IF (NELEA > IALL(0,0,0)-IVIRTCORE) CYCLE
     IF (NELEB > IALL(0,0,0)-IVIRTCORE) CYCLE
     IF (NELEA < ICORE) CYCLE
     IF (NELEB < ICORE) CYCLE
!===== CANONICAL ===================================================
     IF (NELE /= 2*IOCC) CYCLE
!===================================================================
!    WRITE(6,'(/,A,I3,A,I3)') ' # ALPHA-, BETA-ELECTRONS       = ',NELEA,'  ',NELEB
     CALL THERMAL_GENERATE_CONFIGURATIONSA(NELEA,MIN(NELEA,IALL(0,0,0)-IVIRTCORE-NELEA))
!    WRITE(6,'(A)') '     -----------------------'
     CALL THERMAL_GENERATE_CONFIGURATIONSB(NELEB,MIN(NELEB,IALL(0,0,0)-IVIRTCORE-NELEB))
!    WRITE(6,'(A,I3,A,I3,A,I4)') ' # ALPHA-, BETA-CONFIGURATIONS  = ',NCFA,' x',NCFB,'=',NCFA*NCFB
     CALL THERMAL_FULL_CI(LAMBDA,NALL_CHECK)
     DO I=1,NCFA*NCFB
      ALLN(NALL_CHECK+I)=NELE
      IF (ALLE(NALL_CHECK+I) < ESHIFT) ESHIFT=ALLE(NALL_CHECK+I) 
     ENDDO
     NALL_CHECK=NALL_CHECK+NCFA*NCFB
     DEALLOCATE(CFHALFA,ADDRSSA,NORDERA)
     DEALLOCATE(CFHALFB,ADDRSSB,NORDERB)
    ENDDO
   ENDDO
   NALL=NALL_CHECK
!  WRITE(6,'(A,2I6)') 'TOTAL # CONFIGURATIONS = ',NALL_CHECK

!  WRITE(6,'(A)') '----------------------------'
!  WRITE(6,'(A)') '       N        ENERGY'
!  WRITE(6,'(A)') '----------------------------'
!  DO I=1,NALL
!   WRITE(6,'(I5,I3,F20.15)') I,ALLN(I),ALLE(I)
!  ENDDO
!  WRITE(6,'(A)') '----------------------------'
!  WRITE(6,'(A,F20.15)') 'SHIFT = ',ESHIFT

   ! CALCULATE XI & MU
   NBAR=DFLOAT(IOCC*2)
   BETA=1.0D0/BOLTZMANN/DOPTN(98)
   MU=0.0D0

   CALL CALCTHERM(BETA,MU,NBAR,XI,OOO,UUU,SSS)

   IF (LPRINT) THEN
    WRITE(6,'(/,A,F20.10)')          'LAMBDA                        =',LAMBDA
    WRITE(6,'(A,E20.10,A)')          'TEMPERATURE                   =',DOPTN(98),' K'
    WRITE(6,'(A,F20.10,A)')          'BETA                          =',BETA,' HARTREE**(-1)'
    WRITE(6,'(A,F20.10,A)')          'ESHIFT                        =',ESHIFT,' HARTREE'
    WRITE(6,'(A,E20.10,A,F15.10,A)') 'Z (PARTITION FUNCTION)        =',XI,' x EXP(',-BETA*ESHIFT,')'
    WRITE(6,'(A,F20.10,A)')          'F (HELMHOLTZ ENERGY)          =',OOO,' HARTREE'
    WRITE(6,'(A,F20.10,A)')          'U (INTERNAL ENERGY)           =',UUU,' HARTREE'
    WRITE(6,'(A,F20.10,A)')          'S (ENTROPY)                   =',SSS,' kB'
   ENDIF
     
   DEALLOCATE(ALLE,ALLN,H,G)

   RETURN
END SUBROUTINE



SUBROUTINE THERMAL_MBPT_HYBRID
! PERFORM THERMAL MBPT USING LAMBDA-VARIATION HCPT

   USE CONSTANTS
   USE CONTROL
   USE STRUCTURE
   USE INTEGRAL
   USE BASISSET
   USE GRADIENT
   USE THR_FULLCI

   IMPLICIT NONE
   DOUBLE PRECISION,PARAMETER :: DELTALAMBDA=0.001D0
   INTEGER :: ILAMBDA
   DOUBLE PRECISION :: LAMBDA
   INTEGER :: NALL_CHECK,I,IA,IB
   DOUBLE PRECISION :: NBAR  ! MEAN NUMBER OF ELECTRONS
   DOUBLE PRECISION :: XI    ! GRAND PARTITION FUNCTION
   DOUBLE PRECISION :: MU    ! CHEMICAL POTENTIAL
   DOUBLE PRECISION :: OOO   ! GRAND POTENTIAL
   DOUBLE PRECISION :: UUU   ! INTERNAL ENERGY
   DOUBLE PRECISION :: SSS   ! ENTROPY
   DOUBLE PRECISION :: BETA  ! 1/(kB T)
   DOUBLE PRECISION :: MUMAX,MUMIN,MUMID
   DOUBLE PRECISION :: NBMAX,NBMIN,NBMID,NBERR
   DOUBLE PRECISION,ALLOCATABLE :: ALLE_LAMBDA(:,:),E0(:),E1(:),E2(:)
   DOUBLE PRECISION :: XI0,XI1,XI2
   DOUBLE PRECISION :: MU0,MU1,MU2
   DOUBLE PRECISION :: OOO0,OOO1,OOO2,OOO2_2,OOO2_3
   DOUBLE PRECISION :: UUU0,UUU1,UUU2,UUU2_2,UUU2_3
   DOUBLE PRECISION :: E0BAR,E1BAR,E2BAR,E01BAR,E02BAR,E11BAR,E011BAR,E1BAR2,E2BAR2,E11BAR2
   INTEGER :: IDEG
   DOUBLE PRECISION :: EDEG1,EDEG2
   DOUBLE PRECISION :: NUMER,DENOM
   DOUBLE PRECISION :: DEBUG
   DOUBLE PRECISION :: E0ANION,E0CATION,E1ANION,E1CATION,E2ANION,E2CATION
   INTEGER :: N0DEGANION,N0DEGCATION,N1DEGANION,N1DEGCATION,N2DEGANION,N2DEGCATION
   INTEGER :: ORDER
   DOUBLE PRECISION :: MU_R_N,MU_R_D,MU_L ! RIGHT AND LEFT HAND SIDES OF MU RECURSION
   DOUBLE PRECISION,ALLOCATABLE :: FPLUS2(:),FMINUS2(:)
   

   IF ((KVCX /= 0).OR.(KVCY /= 0).OR.(KVCZ /= 0)) CALL PABORT('FOR MOLECULES ONLY')
   IF (LOPTN(25)) CALL PABORT('USE NON-DIRECT ALGORITHM')
   IF (IALL(0,0,0)-IOCC-IVIRTCORE <= 0) CALL PABORT('NO VIRTUAL ORBITAL')
   IF (ICORE > 0) CALL PABORT('ICORE LOGIC NOT TESTED YET')
   IF (IVIRTCORE > 0) CALL PABORT('IVIRTCORE LOGIC NOT TESTED YET')

   ALLOCATE(H(IALLMAX-IVIRTCORE,IALLMAX-IVIRTCORE))
   ALLOCATE(G(IALLMAX-IVIRTCORE,IALLMAX-IVIRTCORE,IALLMAX-IVIRTCORE,IALLMAX-IVIRTCORE))
   CALL THERMAL_ONE_ELECTRON_INTEGRALS
   CALL THERMAL_TWO_ELECTRON_INTEGRALS

   NBAR=DFLOAT(IOCC*2)
   NALL=2**(2*(IALL(0,0,0)-IVIRTCORE-ICORE))
   ALLOCATE(ALLE(NALL),ALLN(NALL))
   ALLOCATE(ALLE_LAMBDA(NALL,0:8),E0(NALL),E1(NALL),E2(NALL))
   ALLOCATE(E0TEST(NALL),E1TEST(NALL),E2TEST(NALL),E3TEST(NALL))
   ALLOCATE(E0TEST2(NALL),E1TEST2(NALL),E2TEST2(NALL),E3TEST2(NALL))
   ALLOCATE(E2S(NALL),E2D(NALL))
   BETA=1.0D0/BOLTZMANN/DOPTN(98)

   ! THERMAL FULL CI LAMBDA=1

   LAMBDA=1.0D0

   WRITE(6,'(/,A)') '*******************'
   WRITE(6,'(A)')   '* THERMAL FULL CI *'
   WRITE(6,'(A)')   '*******************'
   WRITE(6,'(A,F20.6,A)') 'LAMBDA    = ',LAMBDA
   WRITE(6,'(A,E20.6,A)') 'TEMP      = ',DOPTN(98),' K'
   WRITE(6,'(A,F20.6,A)') 'FERMI     = ',FERMI,' HARTREE'

   ! LOOP OVER NUMBER OF ELECTRONS
   NALL_CHECK=0
   DO NELE=2*ICORE,2*(IALL(0,0,0)-IVIRTCORE)
    DO NELEA=ICORE,NELE
     NELEB=NELE-NELEA
     IF (NELEA > IALL(0,0,0)-IVIRTCORE) CYCLE
     IF (NELEB > IALL(0,0,0)-IVIRTCORE) CYCLE
     IF (NELEA < ICORE) CYCLE
     IF (NELEB < ICORE) CYCLE
     CALL THERMAL_GENERATE_CONFIGURATIONSA(NELEA,MIN(NELEA,IALL(0,0,0)-IVIRTCORE-NELEA))
     CALL THERMAL_GENERATE_CONFIGURATIONSB(NELEB,MIN(NELEB,IALL(0,0,0)-IVIRTCORE-NELEB))
     CALL THERMAL_FULL_CI(LAMBDA,NALL_CHECK)
     NALL_CHECK=NALL_CHECK+NCFA*NCFB
     DEALLOCATE(CFHALFA,ADDRSSA,NORDERA)
     DEALLOCATE(CFHALFB,ADDRSSB,NORDERB)
    ENDDO
   ENDDO

   ! LAMBDA-VARIATION HIRSCHFELDER-CERTAIN DEGENERATE PERTURBATION THEORY

!goto 2
   DO ILAMBDA=0,7

    LAMBDA=DFLOAT(ILAMBDA)*DELTALAMBDA

    WRITE(6,'(/,A)') '********************'
    WRITE(6,'(A)')   '* LAMBDA VARIATION *'
    WRITE(6,'(A)')   '********************'
    WRITE(6,'(A,F20.6,A)') 'LAMBDA    = ',LAMBDA
    WRITE(6,'(A,E20.6,A)') 'TEMP      = ',DOPTN(98),' K'
    WRITE(6,'(A,F20.6,A)') 'FERMI     = ',FERMI,' HARTREE'

    ! LOOP OVER NUMBER OF ELECTRONS
    NALL_CHECK=0
    DO NELE=2*ICORE,2*(IALL(0,0,0)-IVIRTCORE)
!    WRITE(6,'(/,A,I3)')   'TOTAL # ELECTRONS             = ',NELE
     ! LOOP OVER SZ
     DO NELEA=ICORE,NELE
      NELEB=NELE-NELEA
      IF (NELEA > IALL(0,0,0)-IVIRTCORE) CYCLE
      IF (NELEB > IALL(0,0,0)-IVIRTCORE) CYCLE
      IF (NELEA < ICORE) CYCLE
      IF (NELEB < ICORE) CYCLE
!     WRITE(6,'(/,A,I3,A,I3)') ' # ALPHA-, BETA-ELECTRONS       = ',NELEA,'  ',NELEB
      CALL THERMAL_GENERATE_CONFIGURATIONSA(NELEA,MIN(NELEA,IALL(0,0,0)-IVIRTCORE-NELEA))
!     WRITE(6,'(A)') '     -----------------------'
      CALL THERMAL_GENERATE_CONFIGURATIONSB(NELEB,MIN(NELEB,IALL(0,0,0)-IVIRTCORE-NELEB))
!     WRITE(6,'(A,I3,A,I3,A,I4)') ' # ALPHA-, BETA-CONFIGURATIONS  = ',NCFA,' x',NCFB,'=',NCFA*NCFB
      CALL THERMAL_FULL_CI(LAMBDA,NALL_CHECK)
      DO I=1,NCFA*NCFB
       ALLN(NALL_CHECK+I)=NELE
      ENDDO
      NALL_CHECK=NALL_CHECK+NCFA*NCFB
      DEALLOCATE(CFHALFA,ADDRSSA,NORDERA)
      DEALLOCATE(CFHALFB,ADDRSSB,NORDERB)
     ENDDO
    ENDDO
!   WRITE(6,'(A,2I6)') 'TOTAL # CONFIGURATIONS = ',NALL_CHECK
    IF (NALL_CHECK /= NALL) CALL PABORT('A BUG IN THERMAL_CORRELATION')

!   WRITE(6,'(A)') '----------------------------'
!   WRITE(6,'(A)') '       N        ENERGY'
!   WRITE(6,'(A)') '----------------------------'
    DO I=1,NALL
     ALLE_LAMBDA(I,ILAMBDA)=ALLE(I)
!    WRITE(6,'(I5,I3,F20.15)') I,ALLN(I),ALLE(I)
    ENDDO
!   WRITE(6,'(A)') '----------------------------'
!   WRITE(6,'(A,F20.15)') 'SHIFT = ',ESHIFT

   ENDDO
!2 continue

!  WRITE(6,'(A)') '---------------------------------------------------------------------------------------------'
!  WRITE(6,'(A)') '  #  LAMBDA=0.00       0.01       0.02       0.03       0.04       0.05       0.06       0.07'
!  WRITE(6,'(A)') '---------------------------------------------------------------------------------------------'
!  DO I=1,NALL
!   WRITE(6,'(I5,10F11.5)') I,ALLE_LAMBDA(I,0),ALLE_LAMBDA(I,1),ALLE_LAMBDA(I,2),ALLE_LAMBDA(I,3),&
!                             ALLE_LAMBDA(I,4),ALLE_LAMBDA(I,5),ALLE_LAMBDA(I,6),ALLE_LAMBDA(I,7)
!  ENDDO
!  WRITE(6,'(A)') '---------------------------------------------------------------------------------------------'

   WRITE(6,'(/,A,/)') '/\/\/\/\/\/\/\/\/\/\/\/\/\/\/\/\/\/\/\/\/\/\/\/\/\/\/\/\/\/\/\/\/\/\/\/\/\/\'
   WRITE(6,'(A)')     'LAMBDA-VARIATION FOR HIRSCHFELDER-CERTAIN PERTURBATION THEORY'
   WRITE(6,'(/,A,/)') 'FORWARD SEVEN- AND EIGHT-POINT FORMULA'
   WRITE(6,'(A)') '-----------------------------------------------------------------'
   WRITE(6,'(A)') 'STATE        E(0)                E(1)                E(2)        '
   WRITE(6,'(A)') '-----------------------------------------------------------------'
   ESHIFT=1.0D9
   DO I=1,NALL
    E0(I)=ALLE_LAMBDA(I,0)
    IF (E0(I) < ESHIFT) ESHIFT=E0(I)
    E1(I)=(-49.0D0/20.0D0*ALLE_LAMBDA(I,0)+6.0D0*ALLE_LAMBDA(I,1)-15.0D0/2.0D0*ALLE_LAMBDA(I,2) &
      +20.0D0/3.0D0*ALLE_LAMBDA(I,3)-15.0D0/4.0D0*ALLE_LAMBDA(I,4)+6.0D0/5.0D0*ALLE_LAMBDA(I,5) &
      -1.0D0/6.0D0*ALLE_LAMBDA(I,6))/DELTALAMBDA
    E2(I)=(+469.0D0/90.0D0*ALLE_LAMBDA(I,0)-223.0D0/10.0D0*ALLE_LAMBDA(I,1)+879.0D0/20.0D0*ALLE_LAMBDA(I,2) &
      -949.0D0/18.0D0*ALLE_LAMBDA(I,3)+41.0D0*ALLE_LAMBDA(I,4)-201.0D0/10.0D0*ALLE_LAMBDA(I,5) &
      +1019.0D0/180.0D0*ALLE_LAMBDA(I,6)-7.0D0/10.0D0*ALLE_LAMBDA(I,7))/(DELTALAMBDA**2)/2.0D0
    WRITE(6,'(I5,3F20.10)') I,E0(I),E1(I),E2(I)
   ENDDO
!  Output to file 40
!   WRITE(40,'(I3,35F10.5)') 1,(E0(I)-20.0D0,I=105,139)
!   WRITE(40,'(I3,35F10.5)') 3,(E0(I)-20.0D0,I=105,139)
!   WRITE(40,'(I3,35F10.5)') 4,(E0(I)+E1(I),I=105,139)
!   WRITE(40,'(I3,35F10.5)') 6,(E0(I)+E1(I),I=105,139)
!   WRITE(40,'(I3,35F10.5)') 7,(E0(I)+E1(I)+E2(I),I=105,139)
!   WRITE(40,'(I3,35F10.5)') 9,(E0(I)+E1(I)+E2(I),I=105,139)
   WRITE(6,'(A)') '-----------------------------------------------------------------'

   ! COMPARISON

   WRITE(6,'(/,A)') '/\/\/\/\/\/\/\/\/\/\/\/\/\/\/\/\/\/\'
   WRITE(6,'(A)')   '| SUM-OVER-STATES (HCPT NUMERICAL) |'
   WRITE(6,'(A)')   '\/\/\/\/\/\/\/\/\/\/\/\/\/\/\/\/\/\/'

   ! LOOP OVER NUMBER OF ELECTRONS
   NALL_CHECK=0
   DO NELE=2*ICORE,2*(IALL(0,0,0)-IVIRTCORE)
!   WRITE(6,'(/,A,I3)')   'TOTAL # ELECTRONS             = ',NELE
    ! LOOP OVER SZ
    DO NELEA=ICORE,NELE
     NELEB=NELE-NELEA
     IF (NELEA > IALL(0,0,0)-IVIRTCORE) CYCLE
     IF (NELEB > IALL(0,0,0)-IVIRTCORE) CYCLE
     IF (NELEA < ICORE) CYCLE
     IF (NELEB < ICORE) CYCLE
!    WRITE(6,'(/,A,I3,A,I3)') ' # ALPHA-, BETA-ELECTRONS       = ',NELEA,'  ',NELEB
     CALL THERMAL_GENERATE_CONFIGURATIONSA(NELEA,MIN(NELEA,IALL(0,0,0)-IVIRTCORE-NELEA))
!    WRITE(6,'(A)') '     -----------------------'
     CALL THERMAL_GENERATE_CONFIGURATIONSB(NELEB,MIN(NELEB,IALL(0,0,0)-IVIRTCORE-NELEB))
!    WRITE(6,'(A,I3,A,I3,A,I4)') ' # ALPHA-, BETA-CONFIGURATIONS  = ',NCFA,' x',NCFB,'=',NCFA*NCFB
     CALL THERMAL_COMPARISON(NALL_CHECK)
     NALL_CHECK=NALL_CHECK+NCFA*NCFB
     DEALLOCATE(CFHALFA,ADDRSSA,NORDERA)
     DEALLOCATE(CFHALFB,ADDRSSB,NORDERB)
    ENDDO
   ENDDO
   WRITE(6,'(A,2I6)') 'TOTAL # CONFIGURATIONS = ',NALL_CHECK
   IF (NALL_CHECK /= NALL) CALL PABORT('A BUG IN THERMAL_CORRELATION')
   WRITE(6,'(A)') &
    '-------------------------------------------------------------------------------------------------------------------'
   WRITE(6,'(A)')'STATE N   E(0)-LAMBDA E(0)-ANLCL     DIFF     E(1)-LAMBDA E(1)-ANLCL     DIFF     E(2)-LAMBDA E(2)-ANLCL     DIFF'
!! WRITE(6,'(A)')'STATE N   E(0)-LAMBDA E(0)-ANLCL     DIFF     E(1)-LAMBDA E(1)-ANLCL     DIFF   E(1)^2-LAMBDA E(1)^2-ANLCL   DIFF'
!  WRITE(6,'(A)')'STATE N   E(1)-LAMBDA E(1)-ANLCL     DIFF     E(2)-LAMBDA E(2)-SOS ANLCL DIFF     E(2)-LAMBDA E(2)-ANLCL     DIFF'
   WRITE(6,'(A)') &
    '-------------------------------------------------------------------------------------------------------------------'
   IDEG=0
   EDEG1=0.0D0
   EDEG2=0.0D0
   DO I=1,NALL
      WRITE(6,'(I4,I3,9F12.6)') I,ALLN(I),&
                               E0(I),E0TEST(I),E0(I)-E0TEST(I), &
                               E1(I),E1TEST2(I),E1(I)-E1TEST2(I), &
                               E2(I),E2TEST2(I),E2(I)-E2TEST2(I)
!                              E2(I),E2TEST2(I),E2(I)-E2TEST2(I) 
!!                             E1(I)**2,E3TEST2(I),E1(I)**2-E3TEST2(I) 
!!                             E1(I)**2,E3TEST(I),E1(I)**2-E3TEST(I) 
    IF ((I < NALL).AND.(DABS(E0(I+1)-E0(I)) < 1.0D-10)) THEN
     IDEG=IDEG+1
     EDEG1=EDEG1+E1(I+1)-E1TEST2(I+1)
     EDEG2=EDEG2+E2(I+1)-E2TEST2(I+1)
!    EDEG2=EDEG2+E2(I+1)-E2TEST2(I+1)
!    EDEG2=EDEG2+E1(I+1)**2-E3TEST2(I+1)
!    EDEG2=EDEG2+E1(I+1)**2-E3TEST(I+1)
    ELSE
     IF (IDEG > 0) THEN
      WRITE(6,'(A)') &
       '-------------------------------------------------------------------------------------------------------------------'
      WRITE(6,'(A,I2,62X,F12.6,24X,F12.6)') 'DEG',IDEG+1,EDEG1,EDEG2
      IF (DABS(EDEG1)+DABS(EDEG2) > 1.0D-5) WRITE(6,'(A)') '*************************************** NONZERO'
     ENDIF
     IDEG=0
     EDEG1=E1(I+1)-E1TEST2(I+1)
     EDEG2=E2(I+1)-E2TEST2(I+1)
!    EDEG2=E2(I+1)-E2TEST2(I+1)
!    EDEG2=E1(I+1)**2-E3TEST2(I+1)
!    EDEG2=E1(I+1)**2-E3TEST(I+1)
    ENDIF
   ENDDO
   WRITE(6,'(A)') &
    '-------------------------------------------------------------------------------------------------------------------'

   ! THERMAL PERTURBATION THEORY

   WRITE(6,'(A,E20.10,A)')          'TEMPERATURE                   =',DOPTN(98),' K'
   WRITE(6,'(A,F20.10,A)')          'BETA                          =',BETA,' HARTREE**(-1)'

   ! CALCULATE OMEGA WITH FIXED MU
goto 999
   WRITE(6,'(/,A)') '**********************************'
   WRITE(6,'(A)') '* MU(0) IS FIXED ; MU(1)=MU(2)=0 *'
   WRITE(6,'(A)') '**********************************'
   WRITE(6,'(A,F20.10,A)')          'ESHIFT                        =',ESHIFT,' HARTREE'

   MU0=FERMI
   XI0=0.0D0
   DO I=1,NALL
    XI0=XI0+DEXP(-BETA*(E0(I)-ESHIFT-MU0*DFLOAT(ALLN(I))))
   ENDDO
   OOO0=-DLOG(XI0)/BETA+ESHIFT
   UUU0=0.0D0
   DO I=1,NALL
    UUU0=UUU0+(E0(I)-ESHIFT-MU0*DFLOAT(ALLN(I)))*DEXP(-BETA*(E0(I)-ESHIFT-MU0*DFLOAT(ALLN(I))))
   ENDDO
   UUU0=UUU0/XI0+ESHIFT+MU0*NBAR
   WRITE(6,'(/,A,F20.10,A)')        'MU(0)                         =',MU0,' HARTREE'
   WRITE(6,'(A,E20.10,A,F15.10,A)') 'XI(0)                         =',XI0,' x EXP(',-BETA*ESHIFT,')'
   WRITE(6,'(A,F20.10,A)')          'OMEGA(0)                      =',OOO0,' HARTREE'
   WRITE(6,'(A,F20.10,A)')          'U(0)                          =',UUU0,' HARTREE'

   MU1=0.0D0
   XI1=0.0D0
   DO I=1,NALL
    XI1=XI1+DEXP(-BETA*(E0(I)-ESHIFT-MU0*DFLOAT(ALLN(I))))*(-BETA*E1(I))
   ENDDO
   OOO1=-XI1/XI0/BETA
   UUU1=0.0D0
   DO I=1,NALL
    UUU1=UUU1-DEXP(-BETA*(E0(I)-ESHIFT-MU0*DFLOAT(ALLN(I))))*(-BETA*(E1(I))) &
             *(-BETA*(E0(I)-ESHIFT-MU0*DFLOAT(ALLN(I))))/XI0/BETA
!            -DEXP(-BETA*(E0(I)-ESHIFT-MU0*DFLOAT(ALLN(I))))*(-BETA*(E0(I)-ESHIFT-MU0*DFLOAT(ALLN(I))))*OOO1/XI0
   ENDDO
!  UUU1=UUU1+OOO1+MU1*NBAR
   UUU1=UUU1+OOO1+BETA*OOO1*(UUU0-ESHIFT-MU0*NBAR)
   WRITE(6,'(/,A,F20.10,A)')        'MU(1)                         =',MU1,' HARTREE'
   WRITE(6,'(A,E20.10,A,F15.10,A)') 'XI(1)                         =',XI1,' x EXP(',-BETA*ESHIFT,')'
   WRITE(6,'(A,F20.10,A)')          'OMEGA(1)                      =',OOO1,' HARTREE'
   WRITE(6,'(A,F20.10,A)')          'U(1)                          =',UUU1,' HARTREE'

   MU2=0.0D0
   XI2=0.0D0
   DO I=1,NALL
    XI2=XI2+DEXP(-BETA*(E0(I)-ESHIFT-MU0*DFLOAT(ALLN(I))))*(-BETA*E2(I)+0.5D0*(-BETA*E1(I))**2)
   ENDDO
   OOO2=-XI2/XI0/BETA+((XI1/XI0)**2)/2.0D0/BETA
   WRITE(6,'(/,A,F20.10,A)')        'MU(2)                         =',MU2,' HARTREE'
   WRITE(6,'(A,E20.10,A,F15.10,A)') 'XI(2)                         =',XI2,' x EXP(',-BETA*ESHIFT,')'
   WRITE(6,'(A,F20.10,A)')          'OMEGA(2)                      =',OOO2,' HARTREE'
999 continue

   ! CALCULATE OMEGA WITH PERTURBED MU
   WRITE(6,'(/,A)') '*********************************'
   WRITE(6,'(A)') '* MU IS PERTURBATIVELY EXPANDED *'
   WRITE(6,'(A)') '*********************************'
   WRITE(6,'(A,F20.10,A)')          'ESHIFT                        =',ESHIFT,' HARTREE'
   MU0=FERMI
   XI0=0.0D0
   DO I=1,NALL
    XI0=XI0+DEXP(-BETA*(E0(I)-ESHIFT-MU0*DFLOAT(ALLN(I))))
   ENDDO
   OOO0=-DLOG(XI0)/BETA+ESHIFT
   UUU0=0.0D0
   DO I=1,NALL
    UUU0=UUU0+(E0(I)-ESHIFT-MU0*DFLOAT(ALLN(I)))*DEXP(-BETA*(E0(I)-ESHIFT-MU0*DFLOAT(ALLN(I))))
   ENDDO
   UUU0=UUU0/XI0+ESHIFT+MU0*NBAR
   WRITE(6,'(/,A,F20.10,A)')        'MU(0)                         =',MU0,' HARTREE'
   WRITE(6,'(A,E20.10,A,F15.10,A)') 'XI(0)                         =',XI0,' x EXP(',-BETA*ESHIFT,')'
   WRITE(6,'(A,F20.10,A)')          'OMEGA(0)                      =',OOO0,' HARTREE'
   WRITE(6,'(A,F20.10,A)')          'U(0)                          =',UUU0,' HARTREE'

   MU1=0.0D0
   MUMAX= DSQRT(DOPTN(98)/1.0D4)
   MUMIN=-DSQRT(DOPTN(98)/1.0D4)
   MUMID=(MUMAX+MUMIN)/2.0D0
   NBERR=1.0D9

!  WRITE(6,'(/,A)') '----------------------------------------------------------------------------'
!  WRITE(6,'(A)') '  TREND         N   (  MU MIN  )      N   (  MU MID  )      N   (  MU MAX  )'
!  WRITE(6,'(A)') '----------------------------------------------------------------------------'
!  DO WHILE ((NBERR > 1.0D-10).OR.(MUMAX-MUMIN > 1.0D-6))
!   CALL CALCNBAR1(BETA,MU0,MUMAX,E0,E1,NBMAX)
!   CALL CALCNBAR1(BETA,MU0,MUMIN,E0,E1,NBMIN)
!   CALL CALCNBAR1(BETA,MU0,MUMID,E0,E1,NBMID)
!   IF ((NBMAX > NBMID).AND.(NBMID > NBMIN)) THEN
!    WRITE(6,'(A,3(F10.6,A,F10.6,A))') 'INCREASING',NBMIN,'(',MUMIN,')',NBMID,'(',MUMID,')',NBMAX,'(',MUMAX,')'
!    IF (NBAR > NBMAX) THEN
!     MUMIN=MUMAX
!     MUMAX=MUMAX+(MUMAX-MUMID)
!    ELSE IF (NBAR > NBMID) THEN
!     MUMIN=MUMID
!    ELSE IF (NBAR > NBMIN) THEN
!     MUMAX=MUMID
!    ELSE
!     MUMAX=MUMIN
!     MUMIN=MUMIN-(MUMID-MUMIN)
!    ENDIF
!    MUMID=(MUMAX+MUMIN)/2.0D0
!   ELSE IF ((NBMAX < NBMID).AND.(NBMID < NBMIN)) THEN
!    WRITE(6,'(A,3(F10.6,A,F10.6,A))') 'DECREASING',NBMIN,'(',MUMIN,')',NBMID,'(',MUMID,')',NBMAX,'(',MUMAX,')'
!    IF (NBAR < NBMAX) THEN
!     MUMIN=MUMAX
!     MUMAX=MUMAX+(MUMAX-MUMID)
!    ELSE IF (NBAR < NBMID) THEN
!     MUMIN=MUMID
!    ELSE IF (NBAR < NBMIN) THEN
!     MUMAX=MUMID
!    ELSE
!     MUMAX=MUMIN
!     MUMIN=MUMIN-(MUMID-MUMIN)
!    ENDIF
!    MUMID=(MUMAX+MUMIN)/2.0D0
!   ELSE
!    WRITE(6,'(A,3(F10.6,A,F10.6,A))') 'CONCAV/VEX',NBMIN,'(',MUMIN,')',NBMID,'(',MUMID,')',NBMAX,'(',MUMAX,')'
!    CALL PABORT('BISECTION FAILED')
!   ENDIF
!   NBERR=DABS(NBAR-NBMID)
!  ENDDO
!  WRITE(6,'(A)') '----------------------------------------------------------------------------'
!  MU1=MUMIN

   NUMER=0.0D0
   DENOM=0.0D0
   DO I=1,NALL
    NUMER=NUMER+DEXP(-BETA*(E0(I)-ESHIFT-MU0*DFLOAT(ALLN(I))))*E1(I)*(DFLOAT(ALLN(I))-NBAR)
    DENOM=DENOM+DEXP(-BETA*(E0(I)-ESHIFT-MU0*DFLOAT(ALLN(I))))*DFLOAT(ALLN(I))*(DFLOAT(ALLN(I))-NBAR)
   ENDDO
   MU1=NUMER/DENOM
   XI1=0.0D0
   DO I=1,NALL
    XI1=XI1+DEXP(-BETA*(E0(I)-ESHIFT-MU0*DFLOAT(ALLN(I))))*(-BETA*(E1(I)-MU1*DFLOAT(ALLN(I))))
!if (dabs(DEXP(-BETA*(E0(I)-ESHIFT-MU0*DFLOAT(ALLN(I))))/xi0) > 1.0d-10) &
!write(*,'(I3,4F20.10)') I,E0(I),-DEXP(-BETA*(E0(I)-ESHIFT-MU0*DFLOAT(ALLN(I))))*(-BETA*(E1(I)-MU1*DFLOAT(ALLN(I))))/XI0/BETA,&
!    DEXP(-BETA*(E0(I)-ESHIFT-MU0*DFLOAT(ALLN(I))))/XI0,E0(I)-ESHIFT-MU0*DFLOAT(ALLN(I))
   ENDDO
   OOO1=-XI1/XI0/BETA
   UUU1=0.0D0
   DO I=1,NALL
    UUU1=UUU1-DEXP(-BETA*(E0(I)-ESHIFT-MU0*DFLOAT(ALLN(I))))*(-BETA*(E1(I)-MU1*DFLOAT(ALLN(I)))) &
             *(-BETA*(E0(I)-ESHIFT-MU0*DFLOAT(ALLN(I))))/XI0/BETA 
!            -DEXP(-BETA*(E0(I)-ESHIFT-MU0*DFLOAT(ALLN(I))))*(-BETA*(E0(I)-ESHIFT-MU0*DFLOAT(ALLN(I))))*OOO1/XI0
   ENDDO
!  UUU1=UUU1+OOO1+MU1*NBAR
   UUU1=UUU1+OOO1+BETA*OOO1*(UUU0-ESHIFT-MU0*NBAR)+MU1*NBAR
   WRITE(6,'(/,A,F20.10,A)')        'MU(1)                         =',MU1,' HARTREE'
   WRITE(6,'(A,E20.10,A,F15.10,A)') 'XI(1)                         =',XI1,' x EXP(',-BETA*ESHIFT,')'
   WRITE(6,'(A,F20.10,A)')          'OMEGA(1)                      =',OOO1,' HARTREE'
   WRITE(6,'(A,F20.10,A)')          'U(1)                          =',UUU1,' HARTREE'
   E0BAR=0.0D0
   E1BAR=0.0D0
   E01BAR=0.0D0
   DO I=1,NALL
    E0BAR=E0BAR+DEXP(-BETA*(E0(I)-ESHIFT-MU0*DFLOAT(ALLN(I))))*(E0(I)-ESHIFT)/XI0
    E1BAR=E1BAR+DEXP(-BETA*(E0(I)-ESHIFT-MU0*DFLOAT(ALLN(I))))*(E1(I)-MU1*DFLOAT(ALLN(I)))/XI0
    E01BAR=E01BAR+DEXP(-BETA*(E0(I)-ESHIFT-MU0*DFLOAT(ALLN(I))))*(E0(I)-ESHIFT)*(E1(I)-MU1*DFLOAT(ALLN(I)))/XI0
   ENDDO
   UUU1=E1BAR-BETA*E01BAR+BETA*E1BAR*E0BAR+MU1*NBAR
   WRITE(6,'(A,F20.10,A)')          'U(1)                          =',UUU1,' HARTREE'

!goto 1
   MU2=0.0D0
   MUMAX= DSQRT(DOPTN(98)/1.0D4)
   MUMIN=-DSQRT(DOPTN(98)/1.0D4)
   MUMID=(MUMAX+MUMIN)/2.0D0
   NBERR=1.0D9

!  WRITE(6,'(/,A)') '----------------------------------------------------------------------------'
!  WRITE(6,'(A)') '  TREND         N   (  MU MIN  )      N   (  MU MID  )      N   (  MU MAX  )'
!  WRITE(6,'(A)') '----------------------------------------------------------------------------'
!  DO WHILE ((NBERR > 1.0D-10).OR.(MUMAX-MUMIN > 1.0D-6))
!   CALL CALCNBAR2(BETA,MU0,MU1,MUMAX,E0,E1,E2,NBMAX)
!   CALL CALCNBAR2(BETA,MU0,MU1,MUMIN,E0,E1,E2,NBMIN)
!   CALL CALCNBAR2(BETA,MU0,MU1,MUMID,E0,E1,E2,NBMID)
!   IF ((NBMAX > NBMID).AND.(NBMID > NBMIN)) THEN
!    WRITE(6,'(A,3(F10.6,A,F10.6,A))') 'INCREASING',NBMIN,'(',MUMIN,')',NBMID,'(',MUMID,')',NBMAX,'(',MUMAX,')'
!    IF (NBAR > NBMAX) THEN
!     MUMIN=MUMAX
!     MUMAX=MUMAX+(MUMAX-MUMID)
!    ELSE IF (NBAR > NBMID) THEN
!     MUMIN=MUMID
!    ELSE IF (NBAR > NBMIN) THEN
!     MUMAX=MUMID
!    ELSE
!     MUMAX=MUMIN
!     MUMIN=MUMIN-(MUMID-MUMIN)
!    ENDIF
!    MUMID=(MUMAX+MUMIN)/2.0D0
!   ELSE IF ((NBMAX < NBMID).AND.(NBMID < NBMIN)) THEN
!    WRITE(6,'(A,3(F10.6,A,F10.6,A))') 'DECREASING',NBMIN,'(',MUMIN,')',NBMID,'(',MUMID,')',NBMAX,'(',MUMAX,')'
!    IF (NBAR < NBMAX) THEN
!     MUMIN=MUMAX
!     MUMAX=MUMAX+(MUMAX-MUMID)
!    ELSE IF (NBAR < NBMID) THEN
!     MUMIN=MUMID
!    ELSE IF (NBAR < NBMIN) THEN
!     MUMAX=MUMID
!    ELSE
!     MUMAX=MUMIN
!     MUMIN=MUMIN-(MUMID-MUMIN)
!    ENDIF
!    MUMID=(MUMAX+MUMIN)/2.0D0
!   ELSE
!    WRITE(6,'(A,3(F10.6,A,F10.6,A))') 'CONCAV/VEX',NBMIN,'(',MUMIN,')',NBMID,'(',MUMID,')',NBMAX,'(',MUMAX,')'
!    CALL PABORT('BISECTION FAILED')
!   ENDIF
!   NBERR=DABS(NBAR-NBMID)
!  ENDDO
!  WRITE(6,'(A)') '----------------------------------------------------------------------------'
!  MU2=MUMIN

!  NUMER=0.0D0
!  DENOM=0.0D0
!  DO I=1,NALL
!   NUMER=NUMER+DEXP(-BETA*(E0(I)-ESHIFT-MU0*DFLOAT(ALLN(I)))) &
!              *(E2(I))*(DFLOAT(ALLN(I))-NBAR)
!   DENOM=DENOM+DEXP(-BETA*(E0(I)-ESHIFT-MU0*DFLOAT(ALLN(I))))*DFLOAT(ALLN(I))*(DFLOAT(ALLN(I))-NBAR)
!  ENDDO
!  MU2=NUMER/DENOM
!write(*,*) 'Mu2=',Mu2,' E2 only'

   NUMER=0.0D0
   DENOM=0.0D0
   DO I=1,NALL
    NUMER=NUMER+DEXP(-BETA*(E0(I)-ESHIFT-MU0*DFLOAT(ALLN(I)))) &
      *(E2(I)-0.5D0*BETA*(E1(I)-MU1*DFLOAT(ALLN(I)))**2)*(DFLOAT(ALLN(I))-NBAR)
    DENOM=DENOM+DEXP(-BETA*(E0(I)-ESHIFT-MU0*DFLOAT(ALLN(I))))*DFLOAT(ALLN(I))*(DFLOAT(ALLN(I))-NBAR)
   ENDDO
   MU2=NUMER/DENOM

   XI2=0.0D0
   DO I=1,NALL
    XI2=XI2+DEXP(-BETA*(E0(I)-ESHIFT-MU0*DFLOAT(ALLN(I)))) &
       *(-BETA*(E2(I)-MU2*DFLOAT(ALLN(I))) &
       +0.5D0*BETA**2*(E1(I)-MU1*DFLOAT(ALLN(I)))**2) 
   ENDDO
   OOO2=-XI2/XI0/BETA+((XI1/XI0)**2)/2.0D0/BETA
   NUMER=0.0D0
   DENOM=0.0D0
   DO I=1,NALL
    NUMER=NUMER+DEXP(-BETA*(E0(I)-ESHIFT-MU0*DFLOAT(ALLN(I)))) &
               *((E2(I)-MU2*DFLOAT(ALLN(I)))-0.5D0*BETA*(E1(I)-MU1*DFLOAT(ALLN(I)))**2)
    DENOM=DENOM+DEXP(-BETA*(E0(I)-ESHIFT-MU0*DFLOAT(ALLN(I))))
!if (dabs(DEXP(-BETA*(E0(I)-ESHIFT-MU0*DFLOAT(ALLN(I))))/xi0) > 1.0d-10) &
!write(*,'(I3,4F20.10)') I,DEXP(-BETA*(E0(I)-ESHIFT-MU0*DFLOAT(ALLN(I))))/xi0, &
! numer/xi0,(E2(I)-MU2*DFLOAT(ALLN(I))),-0.5D0*BETA*(E1(I)-MU1*DFLOAT(ALLN(I)))**2
   ENDDO
   OOO2_2=NUMER/DENOM+0.5D0*BETA*OOO1**2

   E0BAR=0.0D0
   E1BAR=0.0D0
   E2BAR=0.0D0
   E01BAR=0.0D0
   E02BAR=0.0D0
   E11BAR=0.0D0
   E011BAR=0.0D0
   E1BAR2=0.0D0
   E2BAR2=0.0D0
   E11BAR2=0.0D0
   DO I=1,NALL
    E0BAR=E0BAR+DEXP(-BETA*(E0(I)-ESHIFT-MU0*DFLOAT(ALLN(I))))*(E0(I)-ESHIFT-MU0*DFLOAT(ALLN(I)))/XI0
    E1BAR=E1BAR+DEXP(-BETA*(E0(I)-ESHIFT-MU0*DFLOAT(ALLN(I))))*(E1(I)-MU1*DFLOAT(ALLN(I)))/XI0
    E2BAR=E2BAR+DEXP(-BETA*(E0(I)-ESHIFT-MU0*DFLOAT(ALLN(I))))*(E2(I)-MU2*DFLOAT(ALLN(I)))/XI0
    E01BAR=E01BAR+DEXP(-BETA*(E0(I)-ESHIFT-MU0*DFLOAT(ALLN(I))))*(E0(I)-ESHIFT-MU0*DFLOAT(ALLN(I))) &
      *(E1(I)-MU1*DFLOAT(ALLN(I)))/XI0
    E02BAR=E02BAR+DEXP(-BETA*(E0(I)-ESHIFT-MU0*DFLOAT(ALLN(I))))*(E0(I)-ESHIFT-MU0*DFLOAT(ALLN(I))) &
      *(E2(I)-MU2*DFLOAT(ALLN(I)))/XI0
    E11BAR=E11BAR+DEXP(-BETA*(E0(I)-ESHIFT-MU0*DFLOAT(ALLN(I))))*(E1(I)-MU1*DFLOAT(ALLN(I))) &
      *(E1(I)-MU1*DFLOAT(ALLN(I)))/XI0
    E011BAR=E011BAR+DEXP(-BETA*(E0(I)-ESHIFT-MU0*DFLOAT(ALLN(I)))) &
     *(E0(I)-ESHIFT-MU0*DFLOAT(ALLN(I)))*(E1(I)-MU1*DFLOAT(ALLN(I)))**2/XI0
    E1BAR2=E1BAR2+DEXP(-BETA*(E0(I)-ESHIFT-MU0*DFLOAT(ALLN(I))))*(E1(I)-MU1*DFLOAT(ALLN(I)))/XI0
    E2BAR2=E2BAR2+DEXP(-BETA*(E0(I)-ESHIFT-MU0*DFLOAT(ALLN(I))))*(E2(I)-MU2*DFLOAT(ALLN(I)))/XI0
    E11BAR2=E11BAR2+DEXP(-BETA*(E0(I)-ESHIFT-MU0*DFLOAT(ALLN(I))))*(E1(I)-MU1*DFLOAT(ALLN(I)))**2/XI0
   ENDDO
   UUU2=E2BAR &
        -BETA*E11BAR &
        +BETA*E1BAR*E1BAR2 &
        +0.5D0*BETA*BETA*E011BAR &
        -BETA*E02BAR &
        +BETA*BETA*E0BAR*E1BAR2**2 &
        +BETA*E0BAR*E2BAR2 &
        -BETA*BETA*E01BAR*E1BAR2 &
        -0.5D0*BETA*BETA*E0BAR*E11BAR2 &
        +MU2*NBAR
   E0BAR=0.0D0
   E1BAR=0.0D0
   E2BAR=0.0D0
   E01BAR=0.0D0
   E02BAR=0.0D0
   E11BAR=0.0D0
   E011BAR=0.0D0
   E1BAR2=0.0D0
   E2BAR2=0.0D0
   E11BAR2=0.0D0
   DO I=1,NALL
    E2BAR=E2BAR+DEXP(-BETA*(E0(I)-ESHIFT-MU0*DFLOAT(ALLN(I))))*(E2(I))/XI0
    E11BAR=E11BAR+DEXP(-BETA*(E0(I)-ESHIFT-MU0*DFLOAT(ALLN(I))))*E1(I)*(E1(I)-MU1*DFLOAT(ALLN(I)))/XI0
    E1BAR=E1BAR+DEXP(-BETA*(E0(I)-ESHIFT-MU0*DFLOAT(ALLN(I))))*(E1(I))/XI0
    E1BAR2=E1BAR2+DEXP(-BETA*(E0(I)-ESHIFT-MU0*DFLOAT(ALLN(I))))*(E1(I)-MU1*DFLOAT(ALLN(I)))/XI0
    E02BAR=E02BAR+DEXP(-BETA*(E0(I)-ESHIFT-MU0*DFLOAT(ALLN(I))))*(E0(I)-ESHIFT)*(E2(I)-MU2*DFLOAT(ALLN(I)))/XI0
    E0BAR=E0BAR+DEXP(-BETA*(E0(I)-ESHIFT-MU0*DFLOAT(ALLN(I))))*(E0(I)-ESHIFT)/XI0
    E2BAR2=E2BAR2+DEXP(-BETA*(E0(I)-ESHIFT-MU0*DFLOAT(ALLN(I))))*(E2(I)-MU2*DFLOAT(ALLN(I)))/XI0
    E011BAR=E011BAR+DEXP(-BETA*(E0(I)-ESHIFT-MU0*DFLOAT(ALLN(I))))*(E0(I)-ESHIFT)*(E1(I)-MU1*DFLOAT(ALLN(I)))**2/XI0
    E11BAR2=E11BAR2+DEXP(-BETA*(E0(I)-ESHIFT-MU0*DFLOAT(ALLN(I))))*(E1(I)-MU1*DFLOAT(ALLN(I)))**2/XI0
    E01BAR=E01BAR+DEXP(-BETA*(E0(I)-ESHIFT-MU0*DFLOAT(ALLN(I))))*(E0(I)-ESHIFT)*(E1(I)-MU1*DFLOAT(ALLN(I)))/XI0
   ENDDO
   UUU2_2=E2BAR &
        -BETA*E11BAR &
        +BETA*E1BAR*E1BAR2 &
        -BETA*E02BAR &
        +BETA*E0BAR*E2BAR2 &
        +0.5D0*BETA*BETA*E011BAR &
        -0.5D0*BETA*BETA*E0BAR*E11BAR2 &
        -BETA*BETA*E01BAR*E1BAR2 &
        +BETA*BETA*E0BAR*E1BAR2**2 
   UUU1=E1BAR-BETA*E01BAR+BETA*E0BAR*E1BAR2
   OOO2_3=E2BAR2-0.5D0*BETA*E11BAR2+0.5D0*BETA*E1BAR2**2
!  write(6,'(f20.10,2x,a)') E2BAR,'e2bar'
!  write(6,'(f20.10,2x,a)') E11BAR2,'e11bar2'
!  write(6,'(f20.10,2x,a)') -BETA*E11BAR,'-beta*e11'
!  write(6,'(f20.10,2x,a)') BETA*E1BAR*E1BAR2,'beta*e1*e1'
!  write(6,'(f20.10,2x,a)') 0.5D0*BETA*BETA*E011BAR,'0.5*beta*beta*e011'
!  write(6,'(f20.10,2x,a)') -BETA*E02BAR,'-beta*e02'
!  write(6,'(f20.10,2x,a)') BETA*BETA*E0BAR*E1BAR2**2,'beta*beta*e0*e1*e1'
!  write(6,'(f20.10,2x,a)') BETA*E0BAR*E2BAR2,'beta*e0*e2'
!  write(6,'(f20.10,2x,a)') -BETA*BETA*E01BAR*E1BAR2,'-beta*beta*e01*e1'
!  write(6,'(f20.10,2x,a)') -0.5D0*BETA*BETA*E0BAR*E11BAR2,'-0.5*beta*beta*e0*e11'
!  write(6,'(a,f20.10)') 'beta^0+beta^1',E2BAR-BETA*E11BAR+BETA*E1BAR*E1BAR2-BETA*E02BAR+BETA*E0BAR*E2BAR2+MU2*NBAR
   E0BAR=0.0D0
   E1BAR=0.0D0
   E2BAR=0.0D0
   E01BAR=0.0D0
   E02BAR=0.0D0
   E11BAR=0.0D0
   E011BAR=0.0D0
   E1BAR2=0.0D0
   E2BAR2=0.0D0
   E11BAR2=0.0D0
   DO I=1,NALL
    E2BAR=E2BAR+DEXP(-BETA*(E0(I)-ESHIFT-MU0*DFLOAT(ALLN(I))))*(E2(I))/XI0
    E11BAR=E11BAR+DEXP(-BETA*(E0(I)-ESHIFT-MU0*DFLOAT(ALLN(I))))*(E1(I)-MU1*DFLOAT(ALLN(I))) &
*(E1(I)-MU1*DFLOAT(ALLN(I)))/XI0
    E1BAR=E1BAR+DEXP(-BETA*(E0(I)-ESHIFT-MU0*DFLOAT(ALLN(I))))*(E1(I)-MU1*DFLOAT(ALLN(I)))/XI0
    E1BAR2=E1BAR2+DEXP(-BETA*(E0(I)-ESHIFT-MU0*DFLOAT(ALLN(I))))*(E1(I)-MU1*DFLOAT(ALLN(I)))/XI0
    E02BAR=E02BAR+DEXP(-BETA*(E0(I)-ESHIFT-MU0*DFLOAT(ALLN(I))))*(E0(I)-ESHIFT-MU0*DFLOAT(ALLN(I))) &
*(E2(I)-MU2*DFLOAT(ALLN(I)))/XI0
    E0BAR=E0BAR+DEXP(-BETA*(E0(I)-ESHIFT-MU0*DFLOAT(ALLN(I))))*(E0(I)-ESHIFT-MU0*DFLOAT(ALLN(I)))/XI0
    E2BAR2=E2BAR2+DEXP(-BETA*(E0(I)-ESHIFT-MU0*DFLOAT(ALLN(I))))*(E2(I)-MU2*DFLOAT(ALLN(I)))/XI0
    E011BAR=E011BAR+DEXP(-BETA*(E0(I)-ESHIFT-MU0*DFLOAT(ALLN(I))))*(E0(I)-ESHIFT-MU0*DFLOAT(ALLN(I))) &
*(E1(I)-MU1*DFLOAT(ALLN(I)))**2/XI0
    E11BAR2=E11BAR2+DEXP(-BETA*(E0(I)-ESHIFT-MU0*DFLOAT(ALLN(I))))*(E1(I)-MU1*DFLOAT(ALLN(I)))**2/XI0
    E01BAR=E01BAR+DEXP(-BETA*(E0(I)-ESHIFT-MU0*DFLOAT(ALLN(I))))*(E0(I)-ESHIFT-MU0*DFLOAT(ALLN(I))) &
*(E1(I)-MU1*DFLOAT(ALLN(I)))/XI0
   ENDDO
   UUU2_3=E2BAR &
        -BETA*E11BAR &
        +BETA*E1BAR*E1BAR2 &
        -BETA*E02BAR &
        +BETA*E0BAR*E2BAR2 &
        +0.5D0*BETA*BETA*E011BAR &
        -0.5D0*BETA*BETA*E0BAR*E11BAR2 &
        -BETA*BETA*E01BAR*E1BAR2 &
        +BETA*BETA*E0BAR*E1BAR2**2
   WRITE(6,'(/,A,F20.10,A)')        'MU(2)                         =',MU2,' HARTREE'
   WRITE(6,'(A,E20.10,A,F15.10,A)') 'XI(2)                         =',XI2,' x EXP(',-BETA*ESHIFT,')'
   WRITE(6,'(A,F20.10,A)')          'OMEGA(2)                      =',OOO2,' HARTREE'
   WRITE(6,'(A,F20.10,A)')          'OMEGA(2)                      =',OOO2_2,' HARTREE'
   WRITE(6,'(A,F20.10,A)')          'OMEGA(2)                      =',OOO2_3,' HARTREE'
!  WRITE(6,'(A,F20.10,A)')          'OMEGA(2)+MU2 NBAR             =',OOO2+MU2*NBAR,' HARTREE'
   WRITE(6,'(A,F20.10,A)')          'U(2)                          =',UUU2,' HARTREE'
   WRITE(6,'(A,F20.10,A)')          'U(2) AGAIN                    =',UUU2_2,' HARTREE'
   WRITE(6,'(A,F20.10,A)')          'U(2) BASED ON F               =',UUU2_3,' HARTREE'
   WRITE(6,'(A,F20.10,A)')          'U(2) CORRECT AT T=0 ONLY      =',E2BAR-BETA*E11BAR+BETA*E1BAR*E1BAR2,' HARTREE'
   WRITE(6,'(A,F20.10,A)')          'U(1) AGAIN                    =',UUU1,' HARTREE'

   ! Sum E(2)D
   NUMER=0.0D0
   DENOM=0.0D0
   DO I=1,NALL
    NUMER=NUMER+DEXP(-BETA*(E0(I)-ESHIFT-MU0*DFLOAT(ALLN(I))))*E2D(I)
    DENOM=DENOM+DEXP(-BETA*(E0(I)-ESHIFT-MU0*DFLOAT(ALLN(I))))
   ENDDO
   DEBUG=NUMER/DENOM
!  WRITE(6,'(/,A,F20.10,A)')        'Boltzmann sum E(2)D           =',DEBUG,' HARTREE'

   ! Sum E(2)S
   NUMER=0.0D0
   DENOM=0.0D0
   DO I=1,NALL
    NUMER=NUMER+DEXP(-BETA*(E0(I)-ESHIFT-MU0*DFLOAT(ALLN(I))))*E2S(I)
    DENOM=DENOM+DEXP(-BETA*(E0(I)-ESHIFT-MU0*DFLOAT(ALLN(I))))
   ENDDO
   DEBUG=NUMER/DENOM
!  WRITE(6,'(/,A,F20.10,A)')        'Boltzmann sum E(2)S           =',DEBUG,' HARTREE'

   ! Sum E(2)
   NUMER=0.0D0
   DENOM=0.0D0
   DO I=1,NALL
    NUMER=NUMER+DEXP(-BETA*(E0(I)-ESHIFT-MU0*DFLOAT(ALLN(I))))*E2TEST(I)
    DENOM=DENOM+DEXP(-BETA*(E0(I)-ESHIFT-MU0*DFLOAT(ALLN(I))))
   ENDDO
   DEBUG=NUMER/DENOM
!  WRITE(6,'(/,A,F20.10,A)')        'Boltzmann sum E(2)            =',DEBUG,' HARTREE'

   ! Sum E(2)
   NUMER=0.0D0
   DENOM=0.0D0
   DO I=1,NALL
    NUMER=NUMER+DEXP(-BETA*(E0(I)-ESHIFT-MU0*DFLOAT(ALLN(I))))*E2TEST2(I)
    DENOM=DENOM+DEXP(-BETA*(E0(I)-ESHIFT-MU0*DFLOAT(ALLN(I))))
   ENDDO
   DEBUG=NUMER/DENOM
!  WRITE(6,'(/,A,F20.10,A)')        'Boltzmann sum E(2) again      =',DEBUG,' HARTREE'

   ! Sum NONDEGENERATE E(1)**2
   NUMER=0.0D0
   DENOM=0.0D0
   DO I=1,NALL
    NUMER=NUMER+DEXP(-BETA*(E0(I)-ESHIFT-MU0*DFLOAT(ALLN(I))))*E1TEST2(I)**2
    DENOM=DENOM+DEXP(-BETA*(E0(I)-ESHIFT-MU0*DFLOAT(ALLN(I))))
   ENDDO
   DEBUG=NUMER/DENOM
!  WRITE(6,'(/,A,F20.10,A)')        'Boltzmann sum NONDEG E(1)**2  =',DEBUG,' HARTREE'

   ! Sum E(1)**2
   NUMER=0.0D0
   DENOM=0.0D0
   DO I=1,NALL
    NUMER=NUMER+DEXP(-BETA*(E0(I)-ESHIFT-MU0*DFLOAT(ALLN(I))))*E3TEST2(I)
    DENOM=DENOM+DEXP(-BETA*(E0(I)-ESHIFT-MU0*DFLOAT(ALLN(I))))
   ENDDO
   DEBUG=NUMER/DENOM
!  WRITE(6,'(/,A,F20.10,A)')        'Boltzmann sum E(1)**2         =',DEBUG,' HARTREE'

!1 continue

   E0CATION=1.0D9
   E0ANION =1.0D9
   E1CATION=1.0D9
   E1ANION =1.0D9
   E2CATION=1.0D9
   E2ANION =1.0D9
   DO I=1,NALL
    IF (ALLN(I)==NBAR-1) THEN
     IF (E0(I) < E0CATION) THEN
      E0CATION=E0(I)
      E1CATION=E1(I)
      E2CATION=E2(I)
     ENDIF
!    IF (E0(I) < E0CATION) E0CATION=E0(I)
!    IF (E0(I)+E1(I) < E1CATION) E1CATION=E0(I)+E1(I)
!    IF (E0(I)+E1(I)+E2(I) < E2CATION) E2CATION=E0(I)+E1(I)+E2(I)
    ELSE IF (ALLN(I)==NBAR+1) THEN
     IF (E0(I) < E0ANION) THEN
      E0ANION=E0(I)
      E1ANION=E1(I)
      E2ANION=E2(I)
     ENDIF
!    IF (E0(I) < E0ANION) E0ANION=E0(I)
!    IF (E0(I)+E1(I) < E1ANION) E1ANION=E0(I)+E1(I)
!    IF (E0(I)+E1(I)+E2(I) < E2ANION) E2ANION=E0(I)+E1(I)+E2(I)
    ENDIF
   ENDDO
   N0DEGCATION=0
   N0DEGANION =0
   N1DEGCATION=0
   N1DEGANION =0
   N2DEGCATION=0
   N2DEGANION =0
   DO I=1,NALL
    IF (ALLN(I)==NBAR-1) THEN
     IF (DABS(E0(I)-E0CATION) < 1.0D-6) then
     N0DEGCATION=N0DEGCATION+1
!    write(*,'(A,3F20.10)') 'CATION:',E0(I),E1(I),E2(I)
     endif
!    IF (DABS(E0(I)+E1(I)-E1CATION) < 1.0D-6) N1DEGCATION=N1DEGCATION+1
!    IF (DABS(E0(I)+E1(I)+E2(I)-E2CATION) < 1.0D-6) N2DEGCATION=N2DEGCATION+1
    ELSE IF (ALLN(I)==NBAR+1) THEN
     IF (DABS(E0(I)-E0ANION) < 1.0D-6) then  
     N0DEGANION=N0DEGANION+1
!    write(*,'(A,3F20.10)') 'ANION: ',E0(I),E1(I),E2(I)
     endif
!    IF (DABS(E0(I)+E1(I)-E1ANION) < 1.0D-6) N1DEGANION=N1DEGANION+1
!    IF (DABS(E0(I)+E1(I)+E2(I)-E2ANION) < 1.0D-6) N2DEGANION=N2DEGANION+1
    ENDIF
   ENDDO
   
   WRITE(6,'(/,A,F20.10,A,I2,A)') 'CATION GROUND STATE E(0)=',E0CATION,' (DEGENERACY:',N0DEGCATION,')'
   WRITE(6,'(  A,F20.10,A,I2,A)') 'ANION  GROUND STATE E(0)=',E0ANION ,' (DEGENERACY:',N0DEGANION ,')'
   WRITE(6,'(  A,F20.10       )') 'PREDICTED ZERO-T   MU(0)=',(E0ANION-E0CATION)/2.0D0
!  WRITE(6,'(/,A,F20.10,A,I2,A)') 'CATION GROUND STATE E(1)=',E1CATION,' (DEGENERACY:',N1DEGCATION,')'
!  WRITE(6,'(  A,F20.10,A,I2,A)') 'ANION  GROUND STATE E(1)=',E1ANION ,' (DEGENERACY:',N1DEGANION ,')'
!  WRITE(6,'(  A,F20.10       )') 'PREDICTED ZERO-T   MU(1)=',(E1ANION-E0ANION-E1CATION+E0CATION)/2.0D0
   WRITE(6,'(/,A,F20.10,A,I2,A)') 'CATION GROUND STATE E(1)=',E1CATION,' (DEGENERACY:',N0DEGCATION,')'
   WRITE(6,'(  A,F20.10,A,I2,A)') 'ANION  GROUND STATE E(1)=',E1ANION ,' (DEGENERACY:',N0DEGANION ,')'
   WRITE(6,'(  A,F20.10       )') 'PREDICTED ZERO-T   MU(1)=',(E1ANION-E1CATION)/2.0D0
!  WRITE(6,'(/,A,F20.10,A,I2,A)') 'CATION GROUND STATE E(2)=',E2CATION,' (DEGENERACY:',N2DEGCATION,')'
!  WRITE(6,'(  A,F20.10,A,I2,A)') 'ANION  GROUND STATE E(2)=',E2ANION ,' (DEGENERACY:',N2DEGANION ,')'
!  WRITE(6,'(  A,F20.10       )') 'PREDICTED ZERO-T   MU(2)=',&
!   (E2ANION-E1ANION-E0ANION-E2CATION+E1CATION+E0CATION)/2.0D0
   WRITE(6,'(/,A,F20.10,A,I2,A)') 'CATION GROUND STATE E(2)=',E2CATION,' (DEGENERACY:',N0DEGCATION,')'
   WRITE(6,'(  A,F20.10,A,I2,A)') 'ANION  GROUND STATE E(2)=',E2ANION ,' (DEGENERACY:',N0DEGANION ,')'
   WRITE(6,'(  A,F20.10       )') 'PREDICTED ZERO-T   MU(2)=',(E2ANION-E2CATION)/2.0D0

   WRITE(6,'(/,A,/)') '\/\/\/\/\/\/\/\/\/\/\/\/\/\/\/\/\/\/\/\/\/\/\/\/\/\/\/\/\/\/\/\/\/\/\/\/\/\/'

! ============= THE FOLLOWING IS THE DEBUG-PURPOSE CODE FOR RECURSION ==============
!        COMMENT OUT PIKSRT4 CALL IN THERMAL_COMPARISON TO VERIFY E0, E1, E2
!        COMMENT IN/OUT APPROPRIATE LINE IN THERMAL_HCPT TO COMPUTE E1, E2, E1*E1
!
!  ! ZEROTH-ORDER ENERGIES UNSORTED
!  !                       ========
!  NALL_CHECK=0
!  ESHIFT=1.0D9
!  DO NELE=2*ICORE,2*(IALL(0,0,0)-IVIRTCORE)
!   DO NELEA=ICORE,NELE
!    NELEB=NELE-NELEA
!    IF (NELEA > IALL(0,0,0)-IVIRTCORE) CYCLE
!    IF (NELEB > IALL(0,0,0)-IVIRTCORE) CYCLE
!    IF (NELEA < ICORE) CYCLE
!    IF (NELEB < ICORE) CYCLE
!    CALL THERMAL_GENERATE_CONFIGURATIONSA(NELEA,MIN(NELEA,IALL(0,0,0)-IVIRTCORE-NELEA))
!    CALL THERMAL_GENERATE_CONFIGURATIONSB(NELEB,MIN(NELEB,IALL(0,0,0)-IVIRTCORE-NELEB))
!    DO IA=1,NCFA
!     DO IB=1,NCFB
!      E0(NALL_CHECK+(IA-1)*NCFB+IB)=NUCLEAR_REPULSION
!      DO I=1,IALL(0,0,0)-IVIRTCORE
!       IF (BTEST(CFHALFA(IA),I-1)) &
!        E0(NALL_CHECK+(IA-1)*NCFB+IB)=E0(NALL_CHECK+(IA-1)*NCFB+IB)+EPSILON(I,0,0,0)
!       IF (BTEST(CFHALFB(IB),I-1)) &
!        E0(NALL_CHECK+(IA-1)*NCFB+IB)=E0(NALL_CHECK+(IA-1)*NCFB+IB)+EPSILON(I,0,0,0)
!      ENDDO
!     ENDDO
!    ENDDO
!    DO I=1,NCFA*NCFB
!     ALLN(NALL_CHECK+I)=NELE
!     IF (ALLE(NALL_CHECK+I) < ESHIFT) ESHIFT=ALLE(NALL_CHECK+I)
!    ENDDO
!    NALL_CHECK=NALL_CHECK+NCFA*NCFB
!    DEALLOCATE(CFHALFA,ADDRSSA,NORDERA)
!    DEALLOCATE(CFHALFB,ADDRSSB,NORDERB)
!   ENDDO
!  ENDDO
!  IF (NALL_CHECK /= NALL) CALL PABORT('A BUG IN THERMAL_MBPT_GENERALORDER')
!  WRITE(6,'(A)') '----------------------------'
!  WRITE(6,'(A,I2,A)') '       N      Tr HCPT(',0,')'
!  WRITE(6,'(A)') '----------------------------'
!  DO I=1,NALL
!   WRITE(6,'(I5,I3,3F20.15)') I,ALLN(I),E0(I),E0TEST(I),E0TEST(I)-E0(I)
!  ENDDO
!  WRITE(6,'(A)') '----------------------------'

!  ! MU RECURSION

!  ORDER=2
!  ALLOCATE(M_GEN(0:ORDER),O_GEN(0:ORDER),U_GEN(0:ORDER),S_GEN(0:ORDER))
!  ALLOCATE(ALL_M(NALL))

!  ALLOCATE(FMINUS2(1:2*(IALL(0,0,0)-IVIRTCORE)),FPLUS2(1:2*(IALL(0,0,0)-IVIRTCORE)))
!  DO I=1,IALL(0,0,0)-IVIRTCORE
!   FMINUS2(I)=1.0D0/(1.0D0+DEXP(BETA*(EPSILON(I,0,0,0)-FERMI)))
!   FPLUS2(I)=1.0D0-FMINUS2(I)
!   FMINUS2(I+IALL(0,0,0)-IVIRTCORE)=FMINUS2(I)
!   FPLUS2(I+IALL(0,0,0)-IVIRTCORE)=FPLUS2(I)
!  ENDDO

!  M_GEN(0)=FERMI
!  WRITE(6,'(/,A,I0,A,F20.10,A)')        'MU(',0,')                         =',M_GEN(0),' HARTREE'

!  DO ORDER=1,2
!  NALL_CHECK=0
!  DO NELE=2*ICORE,2*(IALL(0,0,0)-IVIRTCORE)
!   DO NELEA=ICORE,NELE
!    NELEB=NELE-NELEA
!    IF (NELEA > IALL(0,0,0)-IVIRTCORE) CYCLE
!    IF (NELEB > IALL(0,0,0)-IVIRTCORE) CYCLE
!    IF (NELEA < ICORE) CYCLE
!    IF (NELEB < ICORE) CYCLE
!    CALL THERMAL_GENERATE_CONFIGURATIONSA(NELEA,MIN(NELEA,IALL(0,0,0)-IVIRTCORE-NELEA))
!    CALL THERMAL_GENERATE_CONFIGURATIONSB(NELEB,MIN(NELEB,IALL(0,0,0)-IVIRTCORE-NELEB))
!    CALL THERMAL_HCPT(ORDER,NALL_CHECK)
!    NALL_CHECK=NALL_CHECK+NCFA*NCFB
!    DEALLOCATE(CFHALFA,ADDRSSA,NORDERA)
!    DEALLOCATE(CFHALFB,ADDRSSB,NORDERB)
!   ENDDO
!  ENDDO
!  MU_R_N=0.0D0
!  MU_R_D=0.0D0
!  DO I=1,NALL
!   MU_R_N=MU_R_N+ALL_M(I)*DEXP(-BETA*(E0(I)-ESHIFT-M_GEN(0)*DFLOAT(ALLN(I))))
!   MU_R_D=MU_R_D+DEXP(-BETA*(E0(I)-ESHIFT-M_GEN(0)*DFLOAT(ALLN(I))))
!  ENDDO
!  MU_L=0.0D0
!  DO I=1,2*(IALL(0,0,0)-IVIRTCORE)
!   MU_L=MU_L+FMINUS2(I)*FPLUS2(I)
!  ENDDO
!  M_GEN(ORDER)=MU_R_N/MU_R_D/MU_L
!  WRITE(6,'(/,A,I0,A,F20.10,A)')        'MU(',ORDER,')                         =',M_GEN(ORDER),' HARTREE'

!  WRITE(6,'(A)') '----------------------------'
!  WRITE(6,'(A,I2,A)') '       N      Tr HCPT(',ORDER,')'
!  WRITE(6,'(A)') '----------------------------'
!  DO I=1,NALL
!   if (order==1) WRITE(6,'(I5,I3,3F20.15)') I,ALLN(I),ALL_M(I),E1TEST(I),E1TEST(I)-ALL_M(I)
!   if (order==2) WRITE(6,'(I5,I3,3F20.15)') I,ALLN(I),ALL_M(I),E2TEST(I),E2TEST(I)-ALL_M(I)
!   if (order==2) WRITE(6,'(I5,I3,3F20.15)') I,ALLN(I),ALL_M(I),E3TEST(I),E3TEST(I)-ALL_M(I)
!  ENDDO
!  WRITE(6,'(A)') '----------------------------'

!  ENDDO
!  DEALLOCATE(FMINUS2,FPLUS2,ALL_M,M_GEN,O_GEN,U_GEN,S_GEN)
! ============= THE ABOVE     IS THE DEBUG-PURPOSE CODE FOR RECURSION ==============

   DEALLOCATE(E2S,E2D,E0TEST2,E1TEST2,E2TEST2,E3TEST2,E0TEST,E1TEST,E2TEST,E3TEST,ALLE_LAMBDA,E0,E1,E2,ALLE,ALLN,H,G)

   RETURN
END SUBROUTINE



SUBROUTINE THERMAL_MBPT_ANALYTICAL
! PERFORM THERMAL MBPT USING ANALYTICAL FORMULAS 

   USE CONSTANTS
   USE CONTROL
   USE STRUCTURE
   USE INTEGRAL
   USE BASISSET
   USE GRADIENT
   USE THR_FULLCI

   IMPLICIT NONE
   DOUBLE PRECISION :: NBAR  ! MEAN NUMBER OF ELECTRONS
   DOUBLE PRECISION :: XI    ! GRAND PARTITION FUNCTION
   DOUBLE PRECISION :: MU    ! CHEMICAL POTENTIAL
   DOUBLE PRECISION :: OOO   ! GRAND POTENTIAL
   DOUBLE PRECISION :: UUU   ! INTERNAL ENERGY
   DOUBLE PRECISION :: SSS   ! ENTROPY
   DOUBLE PRECISION :: BETA  ! 1/(kB T)
   DOUBLE PRECISION :: MUMAX,MUMIN,MUMID
   DOUBLE PRECISION :: NBMAX,NBMIN,NBMID,NBERR
   DOUBLE PRECISION :: XI0,XI1,XI2,XI3
   DOUBLE PRECISION :: MU0,MU1,MU2,MU3
   DOUBLE PRECISION :: OOO0,OOO1,OOO2,OOO3
   DOUBLE PRECISION :: UUU0,UUU1,UUU2,UUU1_2,UUU3
   DOUBLE PRECISION,ALLOCATABLE :: FMINUS(:),FPLUS(:),IIJJ(:)
   INTEGER :: I,J,K,L
   INTEGER :: P,Q,R,S,T,U
   DOUBLE PRECISION :: NUMER,DENOM,DENOM1,DENOM2
   DOUBLE PRECISION :: DEBUG,NSAVE,DEBUG2,DEBUG3
   INTEGER :: O
   DOUBLE PRECISION,ALLOCATABLE :: F2(:,:),EPS2(:),FOCKT(:,:),FOCKTMU(:,:),FOCKTDERIV(:,:)
   DOUBLE PRECISION,ALLOCATABLE :: MU1M(:,:),MU2M(:,:),MU3M(:,:)
   DOUBLE PRECISION,ALLOCATABLE :: G2(:,:,:,:),H2(:,:)
   DOUBLE PRECISION,ALLOCATABLE :: FMINUS2(:),FPLUS2(:),IIJJ2(:)
   DOUBLE PRECISION :: SIGMA_H,SIGMA_L
double precision :: tmp1,tmp2,tmp3,tmp4

   IF ((KVCX /= 0).OR.(KVCY /= 0).OR.(KVCZ /= 0)) CALL PABORT('FOR MOLECULES ONLY')
   IF (LOPTN(25)) CALL PABORT('USE NON-DIRECT ALGORITHM')
   IF (IALL(0,0,0)-IOCC-IVIRTCORE <= 0) CALL PABORT('NO VIRTUAL ORBITAL')
   IF (ICORE > 0) CALL PABORT('ICORE LOGIC NOT TESTED YET')
   IF (IVIRTCORE > 0) CALL PABORT('IVIRTCORE LOGIC NOT TESTED YET')

   NBAR=DFLOAT(IOCC*2)
   BETA=1.0D0/BOLTZMANN/DOPTN(98)

   ALLOCATE(H(IALLMAX-IVIRTCORE,IALLMAX-IVIRTCORE))
   ALLOCATE(G(IALLMAX-IVIRTCORE,IALLMAX-IVIRTCORE,IALLMAX-IVIRTCORE,IALLMAX-IVIRTCORE))
   CALL THERMAL_ONE_ELECTRON_INTEGRALS
   CALL THERMAL_TWO_ELECTRON_INTEGRALS
   ALLOCATE(FMINUS(1:IALL(0,0,0)-IVIRTCORE),FPLUS(1:IALL(0,0,0)-IVIRTCORE),IIJJ(1:IALL(0,0,0)-IVIRTCORE))
   DO I=1,IALL(0,0,0)-IVIRTCORE
    FMINUS(I)=1.0D0/(1.0D0+DEXP(BETA*(EPSILON(I,0,0,0)-FERMI)))
    FPLUS(I)=1.0D0-FMINUS(I)
   ENDDO
   IIJJ=0.0D0
   DO I=1,IALL(0,0,0)-IVIRTCORE
    IIJJ(I)=IIJJ(I)+EPSILON(I,0,0,0)-H(I,I)
   ENDDO

   ! SPIN-ORBITAL & ANTISYMMETRIZED INTEGRALS IN PHYSICIST NOTATION
   O=IALLMAX-IVIRTCORE
   ALLOCATE(F2(2*O,2*O),EPS2(2*O),FOCKT(2*O,2*O))
   ALLOCATE(G2(2*O,2*O,2*O,2*O),H2(2*O,2*O))
   ALLOCATE(FMINUS2(1:2*O),FPLUS2(1:2*O),IIJJ2(2*O))
   DO I=1,O
    EPS2(I)=EPSILON(I,0,0,0)
    EPS2(I+O)=EPSILON(I,0,0,0)
    FMINUS2(I)=FMINUS(I)
    FMINUS2(I+O)=FMINUS(I)
    FPLUS2(I)=FPLUS(I)
    FPLUS2(I+O)=FPLUS(I)
    IIJJ2(I)=IIJJ(I)
    IIJJ2(I+O)=IIJJ(I)
   ENDDO
   G2=0.0D0
   DO I=1,O
    DO J=1,O
     DO K=1,O
      DO L=1,O
       G2(I  ,J  ,K  ,L  )=G(I  ,K  ,J  ,L  )-G(I  ,L  ,J  ,K  ) ! <alpha,alpha||alpha,alpha>
       G2(I  ,J+O,K  ,L+O)=G(I  ,K  ,J  ,L  )                    ! <alpha,beta ||alpha,beta >
       G2(I  ,J+O,K+O,L  )=                  -G(I  ,L  ,J  ,K  ) ! <alpha,beta ||beta, alpha>
       G2(I+O,J  ,K+O,L  )=G(I  ,K  ,J  ,L  )                    ! <beta, alpha||beta, alpha>
       G2(I+O,J  ,K  ,L+O)=                  -G(I  ,L  ,J  ,K  ) ! <beta, alpha||alpha,beta >
       G2(I+O,J+O,K+O,L+O)=G(I  ,K  ,J  ,L  )-G(I  ,L  ,J  ,K  ) ! <beta, beta ||beta, beta >
      ENDDO
     ENDDO
    ENDDO
   ENDDO
   F2=0.0D0
   DO I=1,O
    DO J=1,O
     DO K=1,IOCC
      F2(I,J)=F2(I,J)+2.0D0*G(I,J,K,K)-G(I,K,K,J)
     ENDDO
     F2(I+O,J+O)=F2(I,J)
    ENDDO
   ENDDO
   FOCKT=0.0D0
   DO I=1,O
    DO J=1,O
     FOCKT(I,J)=H(I,J)
     DO K=1,O
      FOCKT(I,J)=FOCKT(I,J)+(2.0D0*G(I,J,K,K)-G(I,K,K,J))*FMINUS(K)
     ENDDO
!    FOCKT(I,J)=FOCKT(I,J)-F2(I,J)
     IF (I==J) FOCKT(I,I)=FOCKT(I,I)-EPSILON(I,0,0,0)
     FOCKT(I+O,J+O)=FOCKT(I,J)
    ENDDO
   ENDDO
   H2=0.0D0
   DO I=1,O
    DO J=1,O
     DO K=1,O
      H2(I,J)=H2(I,J)+(2.0D0*G(I,J,K,K)-G(I,K,K,J))*FMINUS(K)*FPLUS(K)
     ENDDO
     H2(I+O,J+O)=H2(I,J)
    ENDDO
   ENDDO


   ! THERMAL PERTURBATION THEORY

   WRITE(6,'(/,A)') '/\/\/\/\/\/\/\'
   WRITE(6,'(A)')   '| ANALYTICAL |'
   WRITE(6,'(A)')   '\/\/\/\/\/\/\/'

   WRITE(6,'(A,E20.10,A)')          'TEMPERATURE                   =',DOPTN(98),' K'
   WRITE(6,'(A,F20.10,A)')          'BETA                          =',BETA,' HARTREE**(-1)'

   ! CALCULATE OMEGA WITH TSDA
   WRITE(6,'(/,A)') '********************************************'
   WRITE(6,'(A)')   '* THERMAL SINGLE-DETERMINANT APPROXIMATION *'
   WRITE(6,'(A)')   '********************************************'

   ! ZEROTH ORDER (FERMI-DIRAC)
   MU0=FERMI
   OOO0=NUCLEAR_REPULSION
   UUU0=NUCLEAR_REPULSION
   DO I=1,IALL(0,0,0)-IVIRTCORE
    OOO0=OOO0+2.0D0*(EPSILON(I,0,0,0)-FERMI)+2.0D0*DLOG(FMINUS(I))/BETA
    UUU0=UUU0+2.0D0*EPSILON(I,0,0,0)*FMINUS(I)
   ENDDO

   WRITE(6,'(/,A,F20.10,A)')        'MU (FERMI-DIRAC)              =',MU0,' HARTREE'
   WRITE(6,'(A,F20.10,A)')          'OMEGA (FERMI-DIRAC)           =',OOO0,' HARTREE'
   WRITE(6,'(A,F20.10,A)')          'U (FERMI-DIRAC)               =',UUU0,' HARTREE'

   OOO1=OOO0
   UUU1=UUU0
   DO I=1,IALL(0,0,0)-IVIRTCORE
    DO J=1,IALL(0,0,0)-IVIRTCORE
     OOO1=OOO1-(2.0D0*G(I,I,J,J)-G(I,J,J,I))*FMINUS(I)*FMINUS(J)
     UUU1=UUU1-(2.0D0*G(I,I,J,J)-G(I,J,J,I))*FMINUS(I)*FMINUS(J)
    ENDDO
   ENDDO

   WRITE(6,'(/,A,F20.10,A)')        'MU (TSDA1)                    =',MU0,' HARTREE'
   WRITE(6,'(A,F20.10,A)')          'OMEGA (TSDA1)                 =',OOO1,' HARTREE'
   WRITE(6,'(A,F20.10,A)')          'U (TSDA1)                     =',UUU1,' HARTREE'

!  OOO2=0.0D0
!  DO I=1,IALL(0,0,0)-IVIRTCORE
!   DO J=1,IALL(0,0,0)-IVIRTCORE
!    OOO2=OOO2+(2.0D0*G(I,I,J,J)-G(I,J,J,I))*FMINUS(I)*FMINUS(J)
!   ENDDO
!  ENDDO
!  WRITE(6,'(A,F20.10,A)')          '1/2<pq||pq>fpfq               =',OOO2,' HARTREE'
!  WRITE(6,'(A,F20.10,A)')          '1/2<pq||pq>fpfq x beta        =',OOO2*BETA,' '
!  OOO2=DLOG(1.0D0+OOO2*BETA)/BETA
!  OOO1=OOO0-OOO2
!  UUU1=UUU0-OOO2

!  WRITE(6,'(/,A,F20.10,A)')        'MU (TSDA:HIGH-T)              =',MU0,' HARTREE'
!  WRITE(6,'(A,F20.10,A)')          'OMEGA (TSDA:HIGH-T)           =',OOO1,' HARTREE'
!  WRITE(6,'(A,F20.10,A)')          'U (TSDA:HIGH-T)               =',UUU1,' HARTREE'

goto 999
   ! CALCULATE OMEGA WITH FIXED MU
   WRITE(6,'(/,A)') '**********************************'
   WRITE(6,'(A)') '* MU(0) IS FIXED ; MU(1)=MU(2)=0 *'
   WRITE(6,'(A)') '**********************************'

   ! ZEROTH ORDER (FIXED MU)
   MU0=FERMI
   OOO0=NUCLEAR_REPULSION
   UUU0=NUCLEAR_REPULSION
   DO I=1,IALL(0,0,0)-IVIRTCORE
    OOO0=OOO0+2.0D0*(EPSILON(I,0,0,0)-FERMI)+2.0D0*DLOG(FMINUS(I))/BETA
    UUU0=UUU0+2.0D0*EPSILON(I,0,0,0)*FMINUS(I)
   ENDDO

   WRITE(6,'(/,A,F20.10,A)')        'MU(0)                         =',MU0,' HARTREE'
   WRITE(6,'(A,F20.10,A)')          'OMEGA(0)                      =',OOO0,' HARTREE'
   WRITE(6,'(A,F20.10,A)')          'U(0)                          =',UUU0,' HARTREE'

   ! FIRST ORDER (FIXED MU)
   MU1=0.0D0
   OOO1=0.0D0
   DO I=1,IALL(0,0,0)-IVIRTCORE
    DO J=1,IALL(0,0,0)-IVIRTCORE
     OOO1=OOO1+(2.0D0*G(I,I,J,J)-G(I,J,J,I))*FMINUS(I)*FMINUS(J)
    ENDDO
    OOO1=OOO1-2.0D0*IIJJ(I)*FMINUS(I)
   ENDDO
   UUU1=OOO1
   DO I=1,IALL(0,0,0)-IVIRTCORE
    DO J=1,IALL(0,0,0)-IVIRTCORE
     UUU1=UUU1-BETA*((EPSILON(I,0,0,0)-MU0)*FPLUS(I)+(EPSILON(J,0,0,0)-MU0)*FPLUS(J)) &
                   *(2.0D0*G(I,I,J,J)-G(I,J,J,I))*FMINUS(I)*FMINUS(J)
    ENDDO
    UUU1=UUU1+BETA*2.0D0*(EPSILON(I,0,0,0)-MU0)*(IIJJ(I))*FMINUS(I)*FPLUS(I)
   ENDDO

   WRITE(6,'(/,A,F20.10,A)')        'MU(1)                         =',MU1,' HARTREE'
   WRITE(6,'(A,F20.10,A)')          'OMEGA(1)                      =',OOO1,' HARTREE'
   WRITE(6,'(A,F20.10,A)')          'U(1)                          =',UUU1,' HARTREE'

   ! CALCULATE OMEGA WITH PERTURBED MU

999 continue
   WRITE(6,'(/,A)') '*********************************'
   WRITE(6,'(A)') '* MU IS PERTURBATIVELY EXPANDED *'
   WRITE(6,'(A)') '*********************************'

! =================== 0TH ORDER 

   ! ZEROTH ORDER (PERTURBED MU)
   MU0=FERMI
   OOO0=NUCLEAR_REPULSION
   UUU0=NUCLEAR_REPULSION
   DO I=1,IALL(0,0,0)-IVIRTCORE
    OOO0=OOO0+2.0D0*(EPSILON(I,0,0,0)-FERMI)+2.0D0*DLOG(FMINUS(I))/BETA
    UUU0=UUU0+2.0D0*EPSILON(I,0,0,0)*FMINUS(I)
   ENDDO

   WRITE(6,'(/,A,F20.10,A)')        'MU(0)                         =',MU0,' HARTREE'
   WRITE(6,'(A,F20.10,A)')          'OMEGA(0)                      =',OOO0,' HARTREE'
   WRITE(6,'(A,F20.10,A)')          'U(0)                          =',UUU0,' HARTREE'

   OOO0=NUCLEAR_REPULSION
   UUU0=NUCLEAR_REPULSION
   DO I=1,2*O
    IF (FMINUS2(I) > 1.0D-10) OOO0=OOO0+EPS2(I)-MU0+DLOG(FMINUS2(I))/BETA
    UUU0=UUU0+EPS2(I)*FMINUS2(I)
   ENDDO
   NUMER=0.0D0
   DO I=1,2*O
    NUMER=NUMER+FMINUS2(I)
   ENDDO
   WRITE(6,'(A,F20.10,A)')          'OMEGA(0)                      =',OOO0,' HARTREE'
   WRITE(6,'(A,F20.10,A)')          'U(0)                          =',UUU0,' HARTREE'
   WRITE(6,'(A,F20.10,A)')          'SUM F-                        =',NUMER,' HARTREE'

!  MU1=0.0D0
!  MUMAX= DSQRT(DOPTN(98)/1.0D4)
!  MUMIN=-DSQRT(DOPTN(98)/1.0D4)
!  MUMID=(MUMAX+MUMIN)/2.0D0
!  NBERR=1.0D9

!  WRITE(6,'(/,A)') '----------------------------------------------------------------------------'
!  WRITE(6,'(A)') '  TREND         N   (  MU MIN  )      N   (  MU MID  )      N   (  MU MAX  )'
!  WRITE(6,'(A)') '----------------------------------------------------------------------------'
!  DO WHILE ((NBERR > 1.0D-10).OR.(MUMAX-MUMIN > 1.0D-6))
! --- MAX
!   NUMER=0.0D0
!   DENOM=0.0D0
!   DO I=1,IALL(0,0,0)-IVIRTCORE
!    DO J=1,IALL(0,0,0)-IVIRTCORE
!     NUMER=NUMER+(2.0D0*G(I,I,J,J)-G(I,J,J,I))*FMINUS(I)*FMINUS(J)*(NBAR+FPLUS(I)+FPLUS(J))
!     DENOM=DENOM+(2.0D0*G(I,I,J,J)-G(I,J,J,I))*FMINUS(I)*FMINUS(J)
!    ENDDO
!    NUMER=NUMER-2.0D0*IIJJ(I)*FMINUS(I)*(NBAR+FPLUS(I))-2.0D0*MUMAX*FMINUS(I)*(NBAR+FPLUS(I))
!    DENOM=DENOM-2.0D0*IIJJ(I)*FMINUS(I)-2.0D0*MUMAX*FMINUS(I)
!   ENDDO
!   NBMAX=NUMER/DENOM
! --- MIN
!   NUMER=0.0D0
!   DENOM=0.0D0
!   DO I=1,IALL(0,0,0)-IVIRTCORE
!    DO J=1,IALL(0,0,0)-IVIRTCORE
!     NUMER=NUMER+(2.0D0*G(I,I,J,J)-G(I,J,J,I))*FMINUS(I)*FMINUS(J)*(NBAR+FPLUS(I)+FPLUS(J))
!     DENOM=DENOM+(2.0D0*G(I,I,J,J)-G(I,J,J,I))*FMINUS(I)*FMINUS(J)
!    ENDDO
!    NUMER=NUMER-2.0D0*IIJJ(I)*FMINUS(I)*(NBAR+FPLUS(I))-2.0D0*MUMIN*FMINUS(I)*(NBAR+FPLUS(I))
!    DENOM=DENOM-2.0D0*IIJJ(I)*FMINUS(I)-2.0D0*MUMIN*FMINUS(I)
!   ENDDO
!   NBMIN=NUMER/DENOM
! --- MID
!   NUMER=0.0D0
!   DENOM=0.0D0
!   DO I=1,IALL(0,0,0)-IVIRTCORE
!    DO J=1,IALL(0,0,0)-IVIRTCORE
!     NUMER=NUMER+(2.0D0*G(I,I,J,J)-G(I,J,J,I))*FMINUS(I)*FMINUS(J)*(NBAR+FPLUS(I)+FPLUS(J))
!     DENOM=DENOM+(2.0D0*G(I,I,J,J)-G(I,J,J,I))*FMINUS(I)*FMINUS(J)
!    ENDDO
!    NUMER=NUMER-2.0D0*IIJJ(I)*FMINUS(I)*(NBAR+FPLUS(I))-2.0D0*MUMID*FMINUS(I)*(NBAR+FPLUS(I))
!    DENOM=DENOM-2.0D0*IIJJ(I)*FMINUS(I)-2.0D0*MUMID*FMINUS(I)
!   ENDDO
!   NBMID=NUMER/DENOM
! ---
!   IF ((NBMAX > NBMID).AND.(NBMID > NBMIN)) THEN
!    WRITE(6,'(A,3(F10.6,A,F10.6,A))') 'INCREASING',NBMIN,'(',MUMIN,')',NBMID,'(',MUMID,')',NBMAX,'(',MUMAX,')'
!    IF (NBAR > NBMAX) THEN
!     MUMIN=MUMAX
!     MUMAX=MUMAX+(MUMAX-MUMID)
!    ELSE IF (NBAR > NBMID) THEN
!     MUMIN=MUMID
!    ELSE IF (NBAR > NBMIN) THEN
!     MUMAX=MUMID
!    ELSE
!     MUMAX=MUMIN
!     MUMIN=MUMIN-(MUMID-MUMIN)
!    ENDIF
!    MUMID=(MUMAX+MUMIN)/2.0D0
!   ELSE IF ((NBMAX < NBMID).AND.(NBMID < NBMIN)) THEN
!    WRITE(6,'(A,3(F10.6,A,F10.6,A))') 'DECREASING',NBMIN,'(',MUMIN,')',NBMID,'(',MUMID,')',NBMAX,'(',MUMAX,')'
!    IF (NBAR < NBMAX) THEN
!     MUMIN=MUMAX
!     MUMAX=MUMAX+(MUMAX-MUMID)
!    ELSE IF (NBAR < NBMID) THEN
!     MUMIN=MUMID
!    ELSE IF (NBAR < NBMIN) THEN
!     MUMAX=MUMID
!    ELSE
!     MUMAX=MUMIN
!     MUMIN=MUMIN-(MUMID-MUMIN)
!    ENDIF
!    MUMID=(MUMAX+MUMIN)/2.0D0
!   ELSE
!    WRITE(6,'(A,3(F10.6,A,F10.6,A))') 'CONCAV/VEX',NBMIN,'(',MUMIN,')',NBMID,'(',MUMID,')',NBMAX,'(',MUMAX,')'
!    CALL PABORT('BISECTION FAILED')
!   ENDIF
!   NBERR=DABS(NBAR-NBMID)
!  ENDDO
!  WRITE(6,'(A)') '----------------------------------------------------------------------------'
!  MU1=MUMIN

! =================== 1ST ORDER 

   ! FIRST ORDER (PERTURBED MU)
   NUMER=0.0D0
   DENOM=0.0D0
!  DO I=1,IALL(0,0,0)-IVIRTCORE
!   DO J=1,IALL(0,0,0)-IVIRTCORE
!    NUMER=NUMER+(2.0D0*G(I,I,J,J)-G(I,J,J,I))*FMINUS(I)*FMINUS(J)*(FPLUS(I)+FPLUS(J))
!   ENDDO
!   NUMER=NUMER-2.0D0*IIJJ(I)*FMINUS(I)*FPLUS(I)
!   DENOM=DENOM+2.0D0*FMINUS(I)*FPLUS(I)
!  ENDDO
   DO I=1,2*O
    DO J=1,2*O
     NUMER=NUMER+0.5D0*G2(I,J,I,J)*FMINUS2(I)*FMINUS2(J)*(FPLUS2(I)+FPLUS2(J))
    ENDDO
    NUMER=NUMER-IIJJ2(I)*FMINUS2(I)*FPLUS2(I)
    DENOM=DENOM+FMINUS2(I)*FPLUS2(I)
   ENDDO
   MU1=NUMER/DENOM
   OOO1=0.0D0
!  DO I=1,IALL(0,0,0)-IVIRTCORE
!   DO J=1,IALL(0,0,0)-IVIRTCORE
!    OOO1=OOO1+(2.0D0*G(I,I,J,J)-G(I,J,J,I))*FMINUS(I)*FMINUS(J)
!   ENDDO
!   OOO1=OOO1-2.0D0*IIJJ(I)*FMINUS(I)
!  ENDDO
   DO I=1,2*O
    DO J=1,2*O
     OOO1=OOO1+0.5D0*G2(I,J,I,J)*FMINUS2(I)*FMINUS2(J)
    ENDDO
    OOO1=OOO1-IIJJ2(I)*FMINUS2(I)
   ENDDO
!write(*,*) 'debug'
!write(*,*) '<E(1)>=',OOO1
   OOO1=OOO1-MU1*NBAR
   UUU1=OOO1+MU1*NBAR
   DO I=1,2*O
    DO J=1,2*O
     UUU1=UUU1-0.5D0*BETA*((EPS2(I)-MU0)*FPLUS2(I)+(EPS2(J)-MU0)*FPLUS2(J)) &
              *G2(I,J,I,J)*FMINUS2(I)*FMINUS2(J) 
    ENDDO
    UUU1=UUU1+BETA*(EPS2(I)-MU0)*(IIJJ2(I)+MU1)*FMINUS2(I)*FPLUS2(I)
   ENDDO

   WRITE(6,'(/,A,F20.10,A)')        'MU(1)                         =',MU1,' HARTREE'

!write(*,*) 'FockT diagonal'
!do i=1,O
! write(*,'(i3,f20.15)') i,fockt(i,i)
!enddo
   NUMER=0.0D0
   DENOM=0.0D0
!write(*,*) 'MU1 breakdown'
   DO I=1,2*O
    NUMER=NUMER+FOCKT(I,I)*FMINUS2(I)*FPLUS2(I)
    DENOM=DENOM+FMINUS2(I)*FPLUS2(I)
!write(*,'(i3,2f20.15)') i,FOCKT(I,I)*FMINUS2(I)*FPLUS2(I),FMINUS2(I)*FPLUS2(I)
   ENDDO
   MU1=NUMER/DENOM
!write(*,'(3x,2f20.15)') NUMER,DENOM
   
!write(*,*) 'U1 breakdown'
   numer=0.0d0
   denom=0.0d0
   UUU1_2=OOO1+MU1*NBAR
   DO I=1,2*O
    UUU1_2=UUU1_2-BETA*(FOCKT(I,I)-MU1)*EPS2(I)*FMINUS2(I)*FPLUS2(I)
    numer=numer-BETA*FOCKT(I,I)*EPS2(I)*FMINUS2(I)*FPLUS2(I)
    denom=denom+BETA*MU1*EPS2(I)*FMINUS2(I)*FPLUS2(I)
!write(*,'(i3,2f20.15)') i,-BETA*FOCKT(I,I)*EPS2(I)*FMINUS2(I)*FPLUS2(I),BETA*MU1*EPS2(I)*FMINUS2(I)*FPLUS2(I)
   ENDDO
!write(*,'(3x,2f20.15)') NUMER,DENOM

   WRITE(6,'(A,F20.10,A)')          'MU(1) AGAIN                   =',MU1,' HARTREE'
   WRITE(6,'(A,F20.10,A)')          'OMEGA(1)                      =',OOO1,' HARTREE'
   WRITE(6,'(A,F20.10,A)')          'U(1)                          =',UUU1,' HARTREE'
   WRITE(6,'(A,F20.10,A)')          'U(1) AGAIN                    =',UUU1_2,' HARTREE'

   OOO1=0.0D0
   DO I=1,2*O
    OOO1=OOO1+FOCKT(I,I)*FMINUS2(I)
   ENDDO
   DO I=1,2*O
    DO J=1,2*O
     OOO1=OOO1-0.5D0*G2(I,J,I,J)*FMINUS2(I)*FMINUS2(J)
    ENDDO
   ENDDO
   OOO1=OOO1-MU1*NBAR
   WRITE(6,'(A,F20.10,A)')          'OMEGA(1) AGAIN                =',OOO1,' HARTREE'

   WRITE(6,'(A,F20.10,A)')          'MU(0)+MU(1)                   =',MU0+MU1,' HARTREE'
   WRITE(6,'(A,F20.10,A)')          'OMEGA(0)+OMEGA(1)             =',OOO0+OOO1,' HARTREE'
   WRITE(6,'(A,F20.10,A)')          'U(0)+U(1)                     =',UUU0+UUU1,' HARTREE'
! =================== 2ND ORDER 

   ! SECOND ORDER (PERTURBED MU)
   NUMER=0.0D0
   DENOM=0.0D0
   DO I=1,2*O
    DO J=1,2*O
     DO K=1,2*O
      DO L=1,2*O
       IF ((I < J).AND.(J < K).AND.(K < L)) THEN
        DENOM=EPS2(I)+EPS2(J)-EPS2(K)-EPS2(L)
        IF ((DABS(DENOM) > 1.0D-10)) NUMER=NUMER+G2(I,J,K,L)**2/DENOM*FMINUS2(I)*FMINUS2(J)*FPLUS2(K)*FPLUS2(L)
        DENOM=EPS2(I)+EPS2(K)-EPS2(J)-EPS2(L)
        IF ((DABS(DENOM) > 1.0D-10)) NUMER=NUMER+G2(I,K,J,L)**2/DENOM*FMINUS2(I)*FMINUS2(K)*FPLUS2(J)*FPLUS2(L)
        DENOM=EPS2(I)+EPS2(L)-EPS2(J)-EPS2(K)
        IF ((DABS(DENOM) > 1.0D-10)) NUMER=NUMER+G2(I,L,J,K)**2/DENOM*FMINUS2(I)*FMINUS2(L)*FPLUS2(J)*FPLUS2(K)
        DENOM=EPS2(J)+EPS2(K)-EPS2(I)-EPS2(L)
        IF ((DABS(DENOM) > 1.0D-10)) NUMER=NUMER+G2(J,K,I,L)**2/DENOM*FMINUS2(J)*FMINUS2(K)*FPLUS2(I)*FPLUS2(L)
        DENOM=EPS2(J)+EPS2(L)-EPS2(I)-EPS2(K)
        IF ((DABS(DENOM) > 1.0D-10)) NUMER=NUMER+G2(J,L,I,K)**2/DENOM*FMINUS2(J)*FMINUS2(L)*FPLUS2(I)*FPLUS2(K)
        DENOM=EPS2(K)+EPS2(L)-EPS2(I)-EPS2(J)
        IF ((DABS(DENOM) > 1.0D-10)) NUMER=NUMER+G2(K,L,I,J)**2/DENOM*FMINUS2(K)*FMINUS2(L)*FPLUS2(I)*FPLUS2(J)
       ENDIF
      ENDDO
     ENDDO
    ENDDO
   ENDDO
!  WRITE(6,'(/,A,F20.10,A)')        'Boltzmann sum E(2)D           =',NUMER,' HARTREE'

   NUMER=0.0D0
   DENOM=0.0D0
   DO I=1,2*O
    DO J=1,2*O
     IF (I /= J) THEN
      DENOM=EPS2(I)-EPS2(J)
      IF ((DABS(DENOM) > 1.0D-10)) THEN
       ! <i||a>^2 term
       NUMER=NUMER+F2(I,J)**2/DENOM*FMINUS2(I)*FPLUS2(J)
       ! (-2)<ij||aj><i||a> term
       DO K=1,2*O
        NUMER=NUMER-2.0D0*G2(I,K,J,K)*F2(I,J)/DENOM*FMINUS2(I)*FPLUS2(J)*FMINUS2(K)
       ENDDO
       ! <ij||aj>^2 term
       DEBUG=0.0D0
       DO K=1,2*O
        DEBUG=DEBUG+G2(I,K,J,K)*FMINUS2(K)
       ENDDO
       NUMER=NUMER+DEBUG**2/DENOM*FMINUS2(I)*FPLUS2(J)
       DO K=1,2*O
        NUMER=NUMER+G2(I,K,J,K)**2/DENOM*FMINUS2(I)*FPLUS2(J)*FMINUS2(K)*FPLUS2(K)
       ENDDO
      ENDIF
     ENDIF
    ENDDO
   ENDDO
!  WRITE(6,'(/,A,F20.10,A)')        'Boltzmann sum E(2)S           =',NUMER,' HARTREE'

   NUMER=0.0D0
   DENOM=0.0D0
   DO I=1,2*O
    DO J=1,2*O
     IF (I /= J) THEN
!     ! DEBUG is finite-T Fock
!     DEBUG=-F2(I,J)
!     DO K=1,2*O
!      DEBUG=DEBUG+G2(I,K,J,K)*FMINUS2(K)
!     ENDDO
      DENOM=EPS2(I)-EPS2(J)
      IF ((DABS(DENOM) > 1.0D-10)) NUMER=NUMER+FOCKT(I,J)**2/DENOM*FMINUS2(I)*FPLUS2(J)
     ENDIF
    ENDDO
   ENDDO
   DO I=1,2*O
    DO J=1,2*O
     DO K=1,2*O
      DO L=1,2*O
       DENOM=EPS2(I)+EPS2(J)-EPS2(K)-EPS2(L)
       IF ((DABS(DENOM) > 1.0D-10)) NUMER=NUMER+0.25D0*G2(I,J,K,L)**2/DENOM*FMINUS2(I)*FMINUS2(J)*FPLUS2(K)*FPLUS2(L)
      ENDDO
     ENDDO
    ENDDO
   ENDDO
!  WRITE(6,'(/,A,F20.10,A)')        'Boltzmann sum E(2)            =',NUMER,' HARTREE'

   NUMER=0.0D0
   DENOM=0.0D0
   ! <i||i>^2 term
   DO I=1,2*O
    NUMER=NUMER+IIJJ2(I)*FMINUS2(I)
   ENDDO
   NUMER=NUMER**2
   DO I=1,2*O
    NUMER=NUMER+IIJJ2(I)**2*FMINUS2(I)*FPLUS2(I)
   ENDDO
   ! <ij||ij>^2 term
   DO I=1,2*O
    DO J=1,2*O
     IF (I < J) THEN
      NUMER=NUMER+G2(I,J,I,J)**2*FMINUS2(I)*FMINUS2(J)
      DO K=1,2*O
       IF (J < K) THEN
        NUMER=NUMER+G2(I,J,I,J)*G2(I,K,I,K)*FMINUS2(I)*FMINUS2(J)*FMINUS2(K)
        NUMER=NUMER+G2(I,K,I,K)*G2(I,J,I,J)*FMINUS2(I)*FMINUS2(J)*FMINUS2(K)
        NUMER=NUMER+G2(J,I,J,I)*G2(J,K,J,K)*FMINUS2(I)*FMINUS2(J)*FMINUS2(K)
        NUMER=NUMER+G2(J,K,J,K)*G2(J,I,J,I)*FMINUS2(I)*FMINUS2(J)*FMINUS2(K)
        NUMER=NUMER+G2(K,I,K,I)*G2(K,J,K,J)*FMINUS2(I)*FMINUS2(J)*FMINUS2(K)
        NUMER=NUMER+G2(K,J,K,J)*G2(K,I,K,I)*FMINUS2(I)*FMINUS2(J)*FMINUS2(K)
        DO L=1,2*O
         IF (K < L) THEN
          NUMER=NUMER+G2(I,J,I,J)*G2(K,L,K,L)*FMINUS2(I)*FMINUS2(J)*FMINUS2(K)*FMINUS2(L)
          NUMER=NUMER+G2(I,K,I,K)*G2(J,L,J,L)*FMINUS2(I)*FMINUS2(J)*FMINUS2(K)*FMINUS2(L)
          NUMER=NUMER+G2(I,L,I,L)*G2(J,K,J,K)*FMINUS2(I)*FMINUS2(J)*FMINUS2(K)*FMINUS2(L)
          NUMER=NUMER+G2(J,K,J,K)*G2(I,L,I,L)*FMINUS2(I)*FMINUS2(J)*FMINUS2(K)*FMINUS2(L)
          NUMER=NUMER+G2(J,L,J,L)*G2(I,K,I,K)*FMINUS2(I)*FMINUS2(J)*FMINUS2(K)*FMINUS2(L)
          NUMER=NUMER+G2(K,L,K,L)*G2(I,J,I,J)*FMINUS2(I)*FMINUS2(J)*FMINUS2(K)*FMINUS2(L)
         ENDIF
        ENDDO
       ENDIF
      ENDDO
     ENDIF
    ENDDO
   ENDDO
   ! (-2)<ij||ij><k||k> term
   DEBUG=0.0D0
   DO I=1,2*O
    DEBUG=DEBUG+IIJJ2(I)*FMINUS2(I)
   ENDDO
   DENOM=0.0D0
   DO I=1,2*O
    DO J=1,2*O
     IF (I < J) DENOM=DENOM+G2(I,J,I,J)*FMINUS2(I)*FMINUS2(J)
    ENDDO
   ENDDO
   NUMER=NUMER-2.0D0*DEBUG*DENOM
   DO I=1,2*O
    DO J=1,2*O
     IF (I < J) NUMER=NUMER-2.0D0*(IIJJ2(I)*FPLUS2(I)+IIJJ2(J)*FPLUS2(J))*G2(I,J,I,J)*FMINUS2(I)*FMINUS2(J)
    ENDDO
   ENDDO
      
!  WRITE(6,'(/,A,F20.10,A)')        'Boltzmann sum NONDEG E(1)**2  =',NUMER,' HARTREE'

   NSAVE=NUMER
   ! USE NUMER VALUE AT THIS POINT -- DO NOT CHANGE THE ORDER OF CODES
   ! CODE #1, #2, #3 are equivalent, and should give the same value
!  ========= CODE #1
   NUMER=NSAVE
   DO I=1,2*O
    DO J=1,2*O
     DO K=1,2*O
      DO L=1,2*O
       IF ((I < J).AND.(J < K).AND.(K < L)) THEN
        DENOM=EPS2(I)+EPS2(J)-EPS2(K)-EPS2(L)
        IF ((DABS(DENOM) < 1.0D-10)) NUMER=NUMER+G2(I,J,K,L)**2*FMINUS2(I)*FMINUS2(J)*FPLUS2(K)*FPLUS2(L)
        DENOM=EPS2(I)+EPS2(K)-EPS2(J)-EPS2(L)
        IF ((DABS(DENOM) < 1.0D-10)) NUMER=NUMER+G2(I,K,J,L)**2*FMINUS2(I)*FMINUS2(K)*FPLUS2(J)*FPLUS2(L)
        DENOM=EPS2(I)+EPS2(L)-EPS2(J)-EPS2(K)
        IF ((DABS(DENOM) < 1.0D-10)) NUMER=NUMER+G2(I,L,J,K)**2*FMINUS2(I)*FMINUS2(L)*FPLUS2(J)*FPLUS2(K)
        DENOM=EPS2(J)+EPS2(K)-EPS2(I)-EPS2(L)
        IF ((DABS(DENOM) < 1.0D-10)) NUMER=NUMER+G2(J,K,I,L)**2*FMINUS2(J)*FMINUS2(K)*FPLUS2(I)*FPLUS2(L)
        DENOM=EPS2(J)+EPS2(L)-EPS2(I)-EPS2(K)
        IF ((DABS(DENOM) < 1.0D-10)) NUMER=NUMER+G2(J,L,I,K)**2*FMINUS2(J)*FMINUS2(L)*FPLUS2(I)*FPLUS2(K)
        DENOM=EPS2(K)+EPS2(L)-EPS2(I)-EPS2(J)
        IF ((DABS(DENOM) < 1.0D-10)) NUMER=NUMER+G2(K,L,I,J)**2*FMINUS2(K)*FMINUS2(L)*FPLUS2(I)*FPLUS2(J)
       ENDIF
      ENDDO
     ENDDO
    ENDDO
   ENDDO
   DO I=1,2*O
    DO J=1,2*O
     IF (I /= J) THEN
      DENOM=EPS2(I)-EPS2(J)
      IF ((DABS(DENOM) < 1.0D-10)) THEN
       ! <i||a>^2 term
       NUMER=NUMER+F2(I,J)**2*FMINUS2(I)*FPLUS2(J)
       ! (-2)<ij||aj><i||a> term
       DO K=1,2*O
        NUMER=NUMER-2.0D0*G2(I,K,J,K)*F2(I,J)*FMINUS2(I)*FPLUS2(J)*FMINUS2(K)
       ENDDO
       ! <ij||aj>^2 term
       DEBUG=0.0D0
       DO K=1,2*O
        DEBUG=DEBUG+G2(I,K,J,K)*FMINUS2(K)
       ENDDO
       NUMER=NUMER+DEBUG**2*FMINUS2(I)*FPLUS2(J)
       DO K=1,2*O
        NUMER=NUMER+G2(I,K,J,K)**2*FMINUS2(I)*FPLUS2(J)*FMINUS2(K)*FPLUS2(K)
       ENDDO
      ENDIF
     ENDIF
    ENDDO
   ENDDO
!  WRITE(6,'(/,A,F20.10,A)')        'Boltzmann sum E(1)**2 (#1)    =',NUMER,' HARTREE'
!  ========= CODE #2
   NUMER=NSAVE
   DO I=1,2*O
    DO J=1,2*O
     DO K=1,2*O
      DO L=1,2*O
       IF ((I < J).AND.(J < K).AND.(K < L)) THEN
        DENOM=EPS2(I)+EPS2(J)-EPS2(K)-EPS2(L)
        IF ((DABS(DENOM) < 1.0D-10)) NUMER=NUMER+G2(I,J,K,L)**2*FMINUS2(I)*FMINUS2(J)*FPLUS2(K)*FPLUS2(L)
        DENOM=EPS2(I)+EPS2(K)-EPS2(J)-EPS2(L)
        IF ((DABS(DENOM) < 1.0D-10)) NUMER=NUMER+G2(I,K,J,L)**2*FMINUS2(I)*FMINUS2(K)*FPLUS2(J)*FPLUS2(L)
        DENOM=EPS2(I)+EPS2(L)-EPS2(J)-EPS2(K)
        IF ((DABS(DENOM) < 1.0D-10)) NUMER=NUMER+G2(I,L,J,K)**2*FMINUS2(I)*FMINUS2(L)*FPLUS2(J)*FPLUS2(K)
        DENOM=EPS2(J)+EPS2(K)-EPS2(I)-EPS2(L)
        IF ((DABS(DENOM) < 1.0D-10)) NUMER=NUMER+G2(J,K,I,L)**2*FMINUS2(J)*FMINUS2(K)*FPLUS2(I)*FPLUS2(L)
        DENOM=EPS2(J)+EPS2(L)-EPS2(I)-EPS2(K)
        IF ((DABS(DENOM) < 1.0D-10)) NUMER=NUMER+G2(J,L,I,K)**2*FMINUS2(J)*FMINUS2(L)*FPLUS2(I)*FPLUS2(K)
        DENOM=EPS2(K)+EPS2(L)-EPS2(I)-EPS2(J)
        IF ((DABS(DENOM) < 1.0D-10)) NUMER=NUMER+G2(K,L,I,J)**2*FMINUS2(K)*FMINUS2(L)*FPLUS2(I)*FPLUS2(J)
       ENDIF
      ENDDO
     ENDDO
    ENDDO
   ENDDO
   DO I=1,2*O
    DO J=1,2*O
     IF (I /= J) THEN
      DENOM=EPS2(I)-EPS2(J)
      IF ((DABS(DENOM) < 1.0D-10)) THEN
       NUMER=NUMER+FOCKT(I,J)**2*FMINUS2(I)*FPLUS2(J)
       DO K=1,2*O
        NUMER=NUMER+G2(I,K,J,K)**2*FMINUS2(I)*FPLUS2(J)*FMINUS2(K)*FPLUS2(K)
       ENDDO
       DO K=1,2*O
        NUMER=NUMER+G2(I,K,J,K)**2*FMINUS2(I)*FPLUS2(J)*FMINUS2(K)*FPLUS2(K)
       ENDDO
      ENDIF
     ENDIF
    ENDDO
   ENDDO
!  WRITE(6,'(A,F20.10,A)')        'Boltzmann sum E(1)**2 (#2)    =',NUMER,' HARTREE'
!  ========= CODE #3
   NUMER=NSAVE
   DO I=1,2*O
    DO J=1,2*O
     DO K=1,2*O
      DO L=1,2*O
       IF (.NOT.(((I==K).AND.(J==L)).OR.((I==L).AND.(J==K)))) THEN
        DENOM=EPS2(I)+EPS2(J)-EPS2(K)-EPS2(L)
        IF ((DABS(DENOM) < 1.0D-10)) NUMER=NUMER+0.25D0*G2(I,J,K,L)**2*FMINUS2(I)*FMINUS2(J)*FPLUS2(K)*FPLUS2(L)
       ENDIF
      ENDDO
     ENDDO
    ENDDO
   ENDDO
   DO I=1,2*O
    DO J=1,2*O
     IF (I /= J) THEN
      DENOM=EPS2(I)-EPS2(J)
      IF ((DABS(DENOM) < 1.0D-10)) THEN
       NUMER=NUMER+FOCKT(I,J)**2*FMINUS2(I)*FPLUS2(J)
      ENDIF
     ENDIF
    ENDDO
   ENDDO
!  WRITE(6,'(A,F20.10,A)')        'Boltzmann sum E(1)**2 (#3)    =',NUMER,' HARTREE'
!  ========= CODE #4
   NUMER=0.0D0
   DENOM=0.0D0
   ! <i||i>^2 term
   DO I=1,2*O
    NUMER=NUMER+IIJJ2(I)*FMINUS2(I)
   ENDDO
   NUMER=NUMER**2
!  DO I=1,2*O
!   NUMER=NUMER+IIJJ2(I)**2*FMINUS2(I)*FPLUS2(I)
!  ENDDO
   ! <ij||ij>^2 term
   DO I=1,2*O
    DO J=1,2*O
!    NUMER=NUMER-G2(I,J,I,J)**2*FMINUS2(I)*FMINUS2(J)*FMINUS2(J)*FPLUS2(I)
!    NUMER=NUMER-G2(I,J,I,J)**2*FMINUS2(I)*FPLUS2(I)*FMINUS2(J)*FPLUS2(J)
!    NUMER=NUMER+0.5D0*G2(I,J,I,J)**2*FMINUS2(I)*FMINUS2(J)
     DO K=1,2*O
!     IF ((I < J).AND.(J < K)) THEN
      IF (J /= K) THEN
!      NUMER=NUMER+G2(I,J,I,J)*G2(I,K,I,K)*FMINUS2(I)*FMINUS2(J)*FMINUS2(K)
!      NUMER=NUMER+G2(I,K,I,K)*G2(I,J,I,J)*FMINUS2(I)*FMINUS2(J)*FMINUS2(K)
!      NUMER=NUMER+G2(J,I,J,I)*G2(J,K,J,K)*FMINUS2(I)*FMINUS2(J)*FMINUS2(K)
!      NUMER=NUMER+G2(J,K,J,K)*G2(J,I,J,I)*FMINUS2(I)*FMINUS2(J)*FMINUS2(K)
!      NUMER=NUMER+G2(K,I,K,I)*G2(K,J,K,J)*FMINUS2(I)*FMINUS2(J)*FMINUS2(K)
!      NUMER=NUMER+G2(K,J,K,J)*G2(K,I,K,I)*FMINUS2(I)*FMINUS2(J)*FMINUS2(K)
!      NUMER=NUMER-G2(I,J,I,J)*G2(I,K,I,K)*FMINUS2(I)*FMINUS2(J)*FMINUS2(K)*FPLUS2(I)
!      NUMER=NUMER-G2(I,K,I,K)*G2(I,J,I,J)*FMINUS2(I)*FMINUS2(J)*FMINUS2(K)*FPLUS2(I)
!      NUMER=NUMER-G2(J,I,J,I)*G2(J,K,J,K)*FMINUS2(I)*FMINUS2(J)*FMINUS2(K)*FPLUS2(J)
!      NUMER=NUMER-G2(J,K,J,K)*G2(J,I,J,I)*FMINUS2(I)*FMINUS2(J)*FMINUS2(K)*FPLUS2(J)
!      NUMER=NUMER-G2(K,I,K,I)*G2(K,J,K,J)*FMINUS2(I)*FMINUS2(J)*FMINUS2(K)*FPLUS2(K)
!      NUMER=NUMER-G2(K,J,K,J)*G2(K,I,K,I)*FMINUS2(I)*FMINUS2(J)*FMINUS2(K)*FPLUS2(K)
      ENDIF
      DO L=1,2*O
!      IF ((I < J).AND.(J < K).AND.(K < L)) THEN
!      IF ((I/=K).AND.(I/=L).AND.(J/=K).AND.(J/=L)) THEN
        NUMER=NUMER+0.25D0*G2(I,J,I,J)*G2(K,L,K,L)*FMINUS2(I)*FMINUS2(J)*FMINUS2(K)*FMINUS2(L)
!       NUMER=NUMER+G2(I,K,I,K)*G2(J,L,J,L)*FMINUS2(I)*FMINUS2(J)*FMINUS2(K)*FMINUS2(L)
!       NUMER=NUMER+G2(I,L,I,L)*G2(J,K,J,K)*FMINUS2(I)*FMINUS2(J)*FMINUS2(K)*FMINUS2(L)
!       NUMER=NUMER+G2(J,K,J,K)*G2(I,L,I,L)*FMINUS2(I)*FMINUS2(J)*FMINUS2(K)*FMINUS2(L)
!       NUMER=NUMER+G2(J,L,J,L)*G2(I,K,I,K)*FMINUS2(I)*FMINUS2(J)*FMINUS2(K)*FMINUS2(L)
!       NUMER=NUMER+G2(K,L,K,L)*G2(I,J,I,J)*FMINUS2(I)*FMINUS2(J)*FMINUS2(K)*FMINUS2(L)
!      ENDIF
      ENDDO
     ENDDO
    ENDDO
   ENDDO
   ! (-2)<ij||ij><k||k> term
   DEBUG=0.0D0
   DO I=1,2*O
    DEBUG=DEBUG+IIJJ2(I)*FMINUS2(I)
   ENDDO
   DENOM=0.0D0
   DO I=1,2*O
    DO J=1,2*O
     IF (I < J) DENOM=DENOM+G2(I,J,I,J)*FMINUS2(I)*FMINUS2(J)
    ENDDO
   ENDDO
   NUMER=NUMER-2.0D0*DEBUG*DENOM
!  DO I=1,2*O
!   DO J=1,2*O
!    IF (I < J) NUMER=NUMER-2.0D0*(IIJJ2(I)*FPLUS2(I)+IIJJ2(J)*FPLUS2(J))*G2(I,J,I,J)*FMINUS2(I)*FMINUS2(J)
!   ENDDO
!  ENDDO
   DO I=1,2*O
    DO J=1,2*O
     DO K=1,2*O
      DO L=1,2*O
!      IF (.NOT.(((I==K).AND.(J==L)).OR.((I==L).AND.(J==K)))) THEN
        DENOM=EPS2(I)+EPS2(J)-EPS2(K)-EPS2(L)
        IF ((DABS(DENOM) < 1.0D-10)) NUMER=NUMER+0.25D0*G2(I,J,K,L)**2*FMINUS2(I)*FMINUS2(J)*FPLUS2(K)*FPLUS2(L)
!      ENDIF
      ENDDO
     ENDDO
    ENDDO
   ENDDO
   DO I=1,2*O
    DO J=1,2*O
!    IF (I /= J) THEN
      DENOM=EPS2(I)-EPS2(J)
      IF ((DABS(DENOM) < 1.0D-10)) THEN
       NUMER=NUMER+FOCKT(I,J)**2*FMINUS2(I)*FPLUS2(J)
      ENDIF
!    ENDIF
    ENDDO
   ENDDO
!   DO I=1,2*O
!    DO J=1,2*O
!     DENOM=EPS2(I)-EPS2(J)
!     IF ((DABS(DENOM) < 1.0D-10)) THEN
!     ! <i||a>^2 term
!!IF (I /= J) THEN
!      NUMER=NUMER+F2(I,J)**2*FMINUS2(I)*FPLUS2(J)
!!ENDIF
!     ! (-2)<ij||aj><i||a> term
!!IF (I /= J) THEN
!     DO K=1,2*O
!      NUMER=NUMER-2.0D0*G2(I,K,J,K)*F2(I,J)*FMINUS2(I)*FPLUS2(J)*FMINUS2(K)
!     ENDDO
!!ENDIF
!     ! <ij||aj>^2 term
!!IF (I /= J) THEN
!     DEBUG=0.0D0
!     DO K=1,2*O
!      DEBUG=DEBUG+G2(I,K,J,K)*FMINUS2(K)
!     ENDDO
!     NUMER=NUMER+DEBUG**2*FMINUS2(I)*FPLUS2(J)
!!ENDIF
!!IF (I /= J) THEN
!!    DO K=1,2*O
!!     NUMER=NUMER+G2(I,K,J,K)**2*FMINUS2(I)*FPLUS2(J)*FMINUS2(K)*FPLUS2(K)
!!    ENDDO
!!ENDIF
!     ENDIF
!    ENDDO
!   ENDDO

!  WRITE(6,'(A,F20.10,A)')        'Boltzmann sum E(1)**2 (#4)    =',NUMER,' HARTREE'

   MU2=0.0D0
   NUMER=0.0D0
   DO I=1,2*O
    DO J=1,2*O
     DENOM=EPS2(I)-EPS2(J)
     IF ((DABS(DENOM) > 1.0D-10)) NUMER=NUMER+FOCKT(I,J)**2/DENOM*FMINUS2(I)*FPLUS2(J)*(FPLUS2(I)-FMINUS2(J))
     IF ((DABS(DENOM) > 1.0D-10)) NUMER=NUMER+2.0D0*H2(I,J)*FOCKT(I,J)/DENOM*FMINUS2(I)*FPLUS2(J)
    ENDDO
   ENDDO
   DO I=1,2*O
    DO J=1,2*O
     DO K=1,2*O
      DO L=1,2*O
       DENOM=EPS2(I)+EPS2(J)-EPS2(K)-EPS2(L)
       IF ((DABS(DENOM) > 1.0D-10)) NUMER=NUMER+0.25D0*G2(I,J,K,L)**2/DENOM*FMINUS2(I)*FMINUS2(J)*FPLUS2(K)*FPLUS2(L) &
                                               *(FPLUS2(I)+FPLUS2(J)-FMINUS2(K)-FMINUS2(L))
      ENDDO
     ENDDO
    ENDDO
   ENDDO
   DO I=1,2*O
    DO J=1,2*O
     DENOM=EPS2(I)-EPS2(J)
     IF ((DABS(DENOM) < 1.0D-10)) NUMER=NUMER-0.5D0*BETA*FOCKT(I,J)**2*FMINUS2(I)*FPLUS2(J)*(FPLUS2(I)-FMINUS2(J))
     IF ((DABS(DENOM) < 1.0D-10)) NUMER=NUMER-0.5D0*BETA*2.0D0*H2(I,J)*FOCKT(I,J)*FMINUS2(I)*FPLUS2(J)
    ENDDO
   ENDDO
   DO I=1,2*O
    DO J=1,2*O
     DO K=1,2*O
      DO L=1,2*O
       DENOM=EPS2(I)+EPS2(J)-EPS2(K)-EPS2(L)
       IF ((DABS(DENOM) < 1.0D-10)) NUMER=NUMER-0.125D0*BETA*G2(I,J,K,L)**2*FMINUS2(I)*FMINUS2(J)*FPLUS2(K)*FPLUS2(L) &
                                               *(FPLUS2(I)+FPLUS2(J)-FMINUS2(K)-FMINUS2(L))
      ENDDO
     ENDDO
    ENDDO
   ENDDO
   DENOM=0.0D0
   DEBUG2=0.0D0
   DO I=1,2*O
    DENOM=DENOM+FMINUS2(I)*FPLUS2(I)
    DEBUG2=DEBUG2+FMINUS2(I)*FPLUS2(I)*(FPLUS2(I)-FMINUS2(I))
   ENDDO
   DEBUG=0.0D0 ! $\frac{-\partial}{\beta\partial\mu^{(0)}}\mu^{(1)}$
   DO I=1,2*O
    DEBUG=DEBUG+H2(I,I)*FMINUS2(I)*FPLUS2(I)/DENOM+FOCKT(I,I)*FMINUS2(I)*FPLUS2(I)*(FPLUS2(I)-FMINUS2(I))/DENOM &
               -FOCKT(I,I)*FMINUS2(I)*FPLUS2(I)*DEBUG2/DENOM/DENOM
   ENDDO
   DO I=1,2*O
    NUMER=NUMER+0.5D0*BETA*MU1**2*FMINUS2(I)*FPLUS2(I)*(FPLUS2(I)-FMINUS2(I)) &
               +0.5D0*BETA*2.0D0*DEBUG*MU1*FMINUS2(I)*FPLUS2(I)
   ENDDO
   MU2=NUMER/DENOM
   WRITE(6,'(/,A,F20.10,A)')        'MU(2)                         =',MU2,' HARTREE'

!write(*,*) 'MU2 breakdown'
   MU2=0.0D0
   NUMER=0.0D0
   DO I=1,2*O
    DO J=1,2*O
     DENOM=EPS2(I)-EPS2(J)
     IF ((DABS(DENOM) > 1.0D-10)) NUMER=NUMER+FOCKT(I,J)**2/DENOM*FMINUS2(I)*FPLUS2(J)*(FPLUS2(I)-FMINUS2(J))
     IF ((DABS(DENOM) > 1.0D-10)) NUMER=NUMER+2.0D0*H2(I,J)*FOCKT(I,J)/DENOM*FMINUS2(I)*FPLUS2(J)
    ENDDO
   ENDDO
   DO I=1,2*O
    DO J=1,2*O
     DO K=1,2*O
      DO L=1,2*O
       DENOM=EPS2(I)+EPS2(J)-EPS2(K)-EPS2(L)
       IF ((DABS(DENOM) > 1.0D-10)) NUMER=NUMER+0.25D0*G2(I,J,K,L)**2/DENOM*FMINUS2(I)*FMINUS2(J)*FPLUS2(K)*FPLUS2(L) &
                                               *(FPLUS2(I)+FPLUS2(J)-FMINUS2(K)-FMINUS2(L))
      ENDDO
     ENDDO
    ENDDO
   ENDDO
   DO I=1,2*O
    DO J=1,2*O
     DENOM=EPS2(I)-EPS2(J)
     IF ((DABS(DENOM) < 1.0D-10)) NUMER=NUMER-0.5D0*BETA*FOCKT(I,J)**2*FMINUS2(I)*FPLUS2(J)*(FPLUS2(I)-FMINUS2(J))
!IF ((DABS(DENOM) < 1.0D-10)) write(*,'(2i3,f20.15,a)') i,j, &
!-0.5D0*BETA*FOCKT(I,J)**2*FMINUS2(I)*FPLUS2(J)*(FPLUS2(I)-FMINUS2(J)),' beta Fpq'
     IF ((DABS(DENOM) < 1.0D-10)) NUMER=NUMER-0.5D0*BETA*2.0D0*H2(I,J)*FOCKT(I,J)*FMINUS2(I)*FPLUS2(J)
    ENDDO
   ENDDO
!tmp1=0.0d0
   DO I=1,2*O
    DO J=1,2*O
     DO K=1,2*O
      DO L=1,2*O
       DENOM=EPS2(I)+EPS2(J)-EPS2(K)-EPS2(L)
       IF ((DABS(DENOM) < 1.0D-10)) NUMER=NUMER-0.125D0*BETA*G2(I,J,K,L)**2*FMINUS2(I)*FMINUS2(J)*FPLUS2(K)*FPLUS2(L) &
                                               *(FPLUS2(I)+FPLUS2(J)-FMINUS2(K)-FMINUS2(L))
!IF ((DABS(DENOM) < 1.0D-10)) tmp1 =tmp1 -0.125D0*BETA*G2(I,J,K,L)**2*FMINUS2(I)*FMINUS2(J)*FPLUS2(K)*FPLUS2(L) &
!*(FPLUS2(I)+FPLUS2(J)-FMINUS2(K)-FMINUS2(L))
!IF ((DABS(DENOM) < 1.0D-10)) write(*,'(4i3,2f20.15,a)') i,j,k,l,&
!-0.125D0*G2(I,J,K,L)**2,FMINUS2(I)*FMINUS2(J)*FPLUS2(K)*FPLUS2(L) &
!*(FPLUS2(I)+FPLUS2(J)-FMINUS2(K)-FMINUS2(L)),' beta pq||rs ffff(f+f-f-f)'
      ENDDO
     ENDDO
    ENDDO
   ENDDO
!write(*,'(4i3,f20.15,a)') 0,0,0,0,tmp1,' beta pq||rs ffff(f+f-f-f) SUM'
!write(*,'(4f20.15)') fminus2(2),fminus2(6),fminus2(3),fminus2(7)
!write(*,'(f20.15)') fplus2(2)+fplus2(6)-fminus2(2)-fminus2(6)
!write(*,'(f20.15)') fplus2(3)+fplus2(7)-fminus2(3)-fminus2(7)
   DENOM=0.0D0
   DO I=1,2*O
    DENOM=DENOM+FMINUS2(I)*FPLUS2(I)
    NUMER=NUMER+BETA*MU1*FOCKT(I,I)*FMINUS2(I)*FPLUS2(I)*(FPLUS2(I)-FMINUS2(I))
    NUMER=NUMER+BETA*MU1*H2(I,I)*FMINUS2(I)*FPLUS2(I)
    NUMER=NUMER-0.5D0*BETA*MU1*MU1*FMINUS2(I)*FPLUS2(I)*(FPLUS2(I)-FMINUS2(I))
   ENDDO
   MU2=NUMER/DENOM
   WRITE(6,'(A,F20.10,A)')        'MU(2) AGAIN                   =',MU2,' HARTREE'

!write(*,*) 'Omega2 breakdown'
   OOO2=0.0D0
   NUMER=0.0D0
   DENOM=0.0D0
   DO I=1,2*O
    DO J=1,2*O
     DENOM=EPS2(I)-EPS2(J)
     IF ((DABS(DENOM) > 1.0D-10)) NUMER=NUMER+FOCKT(I,J)**2/DENOM*FMINUS2(I)*FPLUS2(J)
    ENDDO
   ENDDO
   DO I=1,2*O
    DO J=1,2*O
     DO K=1,2*O
      DO L=1,2*O
       DENOM=EPS2(I)+EPS2(J)-EPS2(K)-EPS2(L)
       IF ((DABS(DENOM) > 1.0D-10)) NUMER=NUMER+0.25D0*G2(I,J,K,L)**2/DENOM*FMINUS2(I)*FMINUS2(J)*FPLUS2(K)*FPLUS2(L)
      ENDDO
     ENDDO
    ENDDO
   ENDDO
!write(*,*) 'debug'
!write(*,*) '<E(2)>=',NUMER
!tmp1=0.0d0
   DO I=1,2*O
    DO J=1,2*O
     DENOM=EPS2(I)-EPS2(J)
     IF ((DABS(DENOM) < 1.0D-10)) NUMER=NUMER-0.5D0*BETA*FOCKT(I,J)**2*FMINUS2(I)*FPLUS2(J)
!IF ((DABS(DENOM) < 1.0D-10)) tmp1 =tmp1 -0.5D0*BETA*FOCKT(I,J)**2*FMINUS2(I)*FPLUS2(J)
!IF ((DABS(DENOM) < 1.0D-10).and.(dabs(-0.5D0*BETA*FOCKT(I,J)**2*FMINUS2(I)*FPLUS2(J)) > 1.0d-10)) &
!write(*,'(2i3,f20.15,a)') i,j,-0.5D0*BETA*FOCKT(I,J)**2*FMINUS2(I)*FPLUS2(J),' beta Fpq'
    ENDDO
   ENDDO
!write(*,'(2i3,f20.15,a)') 0,0,tmp1,' beta Fpq SUM'
!tmp2=0.0d0
   DO I=1,2*O
    DO J=1,2*O
     DO K=1,2*O
      DO L=1,2*O
       DENOM=EPS2(I)+EPS2(J)-EPS2(K)-EPS2(L)
       IF ((DABS(DENOM) < 1.0D-10)) NUMER=NUMER-0.125D0*BETA*G2(I,J,K,L)**2*FMINUS2(I)*FMINUS2(J)*FPLUS2(K)*FPLUS2(L)
!IF ((DABS(DENOM) < 1.0D-10)) tmp2 =tmp2 -0.125D0*BETA*G2(I,J,K,L)**2*FMINUS2(I)*FMINUS2(J)*FPLUS2(K)*FPLUS2(L)
!IF ((DABS(DENOM) < 1.0D-10).and.(dabs(-0.125D0*BETA*G2(I,J,K,L)**2*FMINUS2(I)*FMINUS2(J)*FPLUS2(K)*FPLUS2(L)) > 1.0d-10)) &
!write(*,'(4i3,f20.15,a)') i,j,k,l, -0.125D0*BETA*G2(I,J,K,L)**2*FMINUS2(I)*FMINUS2(J)*FPLUS2(K)*FPLUS2(L),' beta pq||rs'
      ENDDO
     ENDDO
    ENDDO
   ENDDO
!write(*,'(4i3,f20.15,a)') 0,0,0,0,tmp2,' beta pq||rs SUM'
!tmp3=0.0d0
   DO I=1,2*O
!   NUMER=NUMER+0.5D0*BETA*MU1**2*FMINUS2(I)*FPLUS2(I)
    NUMER=NUMER+BETA*MU1*FOCKT(I,I)*FMINUS2(I)*FPLUS2(I)-0.5D0*BETA*MU1**2*FMINUS2(I)*FPLUS2(I)
!tmp3 =tmp3 +BETA*MU1*FOCKT(I,I)*FMINUS2(I)*FPLUS2(I)-0.5D0*BETA*MU1**2*FMINUS2(I)*FPLUS2(I)
!write(*,'(i3,f20.15,a)') i,BETA*MU1*FOCKT(I,I)*FMINUS2(I)*FPLUS2(I)-0.5D0*BETA*MU1**2*FMINUS2(I)*FPLUS2(I),' mu1 terms'
   ENDDO
!write(*,'(i3,f20.15,a)') 0,tmp3,' mu1 terms SUM'
   OOO2=NUMER-MU2*NBAR
   WRITE(6,'(A,F20.10,A)')          'OMEGA(2)                      =',OOO2,' HARTREE'
   OOO2=NUMER
!  WRITE(6,'(A,F20.10,A)')          'OMEGA(2)+MU2 NBAR             =',OOO2,' HARTREE'

   UUU2=NUMER ! Contains Omega(2)+mu(2)Nbar
   H2=0.0D0
   DO I=1,O
    DO J=1,O
     DO K=1,O
      H2(I,J)=H2(I,J)+(2.0D0*G(I,J,K,K)-G(I,K,K,J))*FMINUS(K)*(MU0-EPS2(K))*FPLUS(K)
     ENDDO
     H2(I+O,J+O)=H2(I,J)
    ENDDO
   ENDDO
   NUMER=0.0D0
   DO I=1,2*O
    DO J=1,2*O
     DENOM=EPS2(I)-EPS2(J)
     IF ((DABS(DENOM) > 1.0D-10)) NUMER=NUMER+FOCKT(I,J)**2/DENOM*FMINUS2(I)*FPLUS2(J) &
                                             *((MU0-EPS2(I))*FPLUS2(I)-(MU0-EPS2(J))*FMINUS2(J))
     IF ((DABS(DENOM) > 1.0D-10)) NUMER=NUMER+2.0D0*H2(I,J)*FOCKT(I,J)/DENOM*FMINUS2(I)*FPLUS2(J)
    ENDDO
   ENDDO
   DO I=1,2*O
    DO J=1,2*O
     DO K=1,2*O
      DO L=1,2*O
       DENOM=EPS2(I)+EPS2(J)-EPS2(K)-EPS2(L)
       IF ((DABS(DENOM) > 1.0D-10)) NUMER=NUMER+0.25D0*G2(I,J,K,L)**2/DENOM*FMINUS2(I)*FMINUS2(J)*FPLUS2(K)*FPLUS2(L) &
                     *((MU0-EPS2(I))*FPLUS2(I)+(MU0-EPS2(J))*FPLUS2(J)-(MU0-EPS2(K))*FMINUS2(K)-(MU0-EPS2(L))*FMINUS2(L))
      ENDDO
     ENDDO
    ENDDO
   ENDDO
   DO I=1,2*O
    DO J=1,2*O
     DENOM=EPS2(I)-EPS2(J)
     IF ((DABS(DENOM) < 1.0D-10)) NUMER=NUMER-0.5D0*FOCKT(I,J)**2*FMINUS2(I)*FPLUS2(J) 
     IF ((DABS(DENOM) < 1.0D-10)) NUMER=NUMER-0.5D0*BETA*FOCKT(I,J)**2*FMINUS2(I)*FPLUS2(J) &
                                             *((MU0-EPS2(I))*FPLUS2(I)-(MU0-EPS2(J))*FMINUS2(J))
     IF ((DABS(DENOM) < 1.0D-10)) NUMER=NUMER-0.5D0*BETA*2.0D0*H2(I,J)*FOCKT(I,J)*FMINUS2(I)*FPLUS2(J)
    ENDDO
   ENDDO
   DO I=1,2*O
    DO J=1,2*O
     DO K=1,2*O
      DO L=1,2*O
       DENOM=EPS2(I)+EPS2(J)-EPS2(K)-EPS2(L)
       IF ((DABS(DENOM) < 1.0D-10)) NUMER=NUMER-0.125D0*G2(I,J,K,L)**2*FMINUS2(I)*FMINUS2(J)*FPLUS2(K)*FPLUS2(L) 
       IF ((DABS(DENOM) < 1.0D-10)) NUMER=NUMER-0.125D0*BETA*G2(I,J,K,L)**2*FMINUS2(I)*FMINUS2(J)*FPLUS2(K)*FPLUS2(L) &
                     *((MU0-EPS2(I))*FPLUS2(I)+(MU0-EPS2(J))*FPLUS2(J)-(MU0-EPS2(K))*FMINUS2(K)-(MU0-EPS2(L))*FMINUS2(L))
      ENDDO
     ENDDO
    ENDDO
   ENDDO
   DENOM=0.0D0
   DEBUG2=0.0D0
   DO I=1,2*O
    DENOM=DENOM+FMINUS2(I)*FPLUS2(I)
    DEBUG2=DEBUG2+FMINUS2(I)*FPLUS2(I)*((MU0-EPS2(I))*FPLUS2(I)-(MU0-EPS2(I))*FMINUS2(I))
   ENDDO
   DEBUG=0.0D0 ! $\frac{\partial}{\partial\beta}\mu^{(1)}$
   DO I=1,2*O
    DEBUG=DEBUG+H2(I,I)*FMINUS2(I)*FPLUS2(I)/DENOM &
               +FOCKT(I,I)*FMINUS2(I)*FPLUS2(I)*((MU0-EPS2(I))*FPLUS2(I)-(MU0-EPS2(I))*FMINUS2(I))/DENOM
   ENDDO
   DEBUG=DEBUG-MU1*DEBUG2/DENOM
   DO I=1,2*O
    NUMER=NUMER &
               +0.5D0*MU1**2*FMINUS2(I)*FPLUS2(I) &
               +0.5D0*BETA*MU1**2*FMINUS2(I)*FPLUS2(I)*((MU0-EPS2(I))*FPLUS2(I)-(MU0-EPS2(I))*FMINUS2(I)) &
               +0.5D0*BETA*2.0D0*DEBUG*MU1*FMINUS2(I)*FPLUS2(I)
   ENDDO
   DO I=1,2*O
    NUMER=NUMER-MU2*(MU0-EPS2(I))*FMINUS2(I)*FPLUS2(I)
   ENDDO
   UUU2=UUU2+BETA*NUMER
   WRITE(6,'(A,F20.10,A)')          'U(2)                          =',UUU2,' HARTREE'

!write(*,*) 'U2 breakdown'
   UUU2=0.0D0
   H2=0.0D0
   DO I=1,O
    DO J=1,O
     DO K=1,O
      H2(I,J)=H2(I,J)+(2.0D0*G(I,J,K,K)-G(I,K,K,J))*FMINUS(K)*EPS2(K)*FPLUS(K)
     ENDDO
     H2(I+O,J+O)=H2(I,J)
    ENDDO
   ENDDO
   NUMER=0.0D0
   DO I=1,2*O
    DO J=1,2*O
     DENOM=EPS2(I)-EPS2(J)
     IF ((DABS(DENOM) > 1.0D-10)) NUMER=NUMER+FOCKT(I,J)**2/DENOM*FMINUS2(I)*FPLUS2(J) &
                                             -BETA*FOCKT(I,J)**2/DENOM*FMINUS2(I)*FPLUS2(J) &
                                             *(EPS2(I)*FPLUS2(I)-EPS2(J)*FMINUS2(J))
     IF ((DABS(DENOM) > 1.0D-10)) NUMER=NUMER-2.0D0*BETA*H2(I,J)*FOCKT(I,J)/DENOM*FMINUS2(I)*FPLUS2(J)
    ENDDO
   ENDDO
   DO I=1,2*O
    DO J=1,2*O
     DO K=1,2*O
      DO L=1,2*O
       DENOM=EPS2(I)+EPS2(J)-EPS2(K)-EPS2(L)
       IF ((DABS(DENOM) > 1.0D-10)) NUMER=NUMER+0.25D0*G2(I,J,K,L)**2/DENOM*FMINUS2(I)*FMINUS2(J)*FPLUS2(K)*FPLUS2(L) &
                     -0.25D0*BETA*G2(I,J,K,L)**2/DENOM*FMINUS2(I)*FMINUS2(J)*FPLUS2(K)*FPLUS2(L) &
                     *(EPS2(I)*FPLUS2(I)+EPS2(J)*FPLUS2(J)-EPS2(K)*FMINUS2(K)-EPS2(L)*FMINUS2(L))
      ENDDO
     ENDDO
    ENDDO
   ENDDO
   DO I=1,2*O
    DO J=1,2*O
     DENOM=EPS2(I)-EPS2(J)
     IF ((DABS(DENOM) < 1.0D-10)) NUMER=NUMER-BETA*FOCKT(I,J)**2*FMINUS2(I)*FPLUS2(J)
!IF ((DABS(DENOM) < 1.0D-10)) write(*,'(2i3,f20.15,a)') i,j,-BETA*FOCKT(I,J)**2*FMINUS2(I)*FPLUS2(J),'beta Fpq f-f+'
     IF ((DABS(DENOM) < 1.0D-10)) NUMER=NUMER+0.5D0*BETA**2*FOCKT(I,J)**2*FMINUS2(I)*FPLUS2(J) &
                                             *(EPS2(I)*FPLUS2(I)-EPS2(J)*FMINUS2(J))
     IF ((DABS(DENOM) < 1.0D-10)) NUMER=NUMER+0.5D0*BETA**2*2.0D0*H2(I,J)*FOCKT(I,J)*FMINUS2(I)*FPLUS2(J)
    ENDDO
   ENDDO
   DO I=1,2*O
    DO J=1,2*O
     DO K=1,2*O
      DO L=1,2*O
       DENOM=EPS2(I)+EPS2(J)-EPS2(K)-EPS2(L)
       IF ((DABS(DENOM) < 1.0D-10)) NUMER=NUMER-0.25D0*BETA*G2(I,J,K,L)**2*FMINUS2(I)*FMINUS2(J)*FPLUS2(K)*FPLUS2(L)
       IF ((DABS(DENOM) < 1.0D-10)) NUMER=NUMER+0.125D0*BETA**2*G2(I,J,K,L)**2*FMINUS2(I)*FMINUS2(J)*FPLUS2(K)*FPLUS2(L) &
                     *(EPS2(I)*FPLUS2(I)+EPS2(J)*FPLUS2(J)-EPS2(K)*FMINUS2(K)-EPS2(L)*FMINUS2(L))
      ENDDO
     ENDDO
    ENDDO
   ENDDO
   DO I=1,2*O
    NUMER=NUMER+2.0D0*BETA*MU1*FOCKT(I,I)*FMINUS2(I)*FPLUS2(I)
    NUMER=NUMER-BETA*MU1**2*FMINUS2(I)*FPLUS2(I)
!write(*,'(i3,f20.15,a)') i,2.0D0*BETA*MU1*FOCKT(I,I)*FMINUS2(I)*FPLUS2(I)-BETA*MU1**2*FMINUS2(I)*FPLUS2(I),'beta(2mu1 Fpp - mu1**2)'
    NUMER=NUMER-BETA**2*MU1*FOCKT(I,I)*FMINUS2(I)*FPLUS2(I)*(EPS2(I)*FPLUS2(I)-EPS2(I)*FMINUS2(I))
    NUMER=NUMER-BETA**2*MU1*H2(I,I)*FMINUS2(I)*FPLUS2(I)
    NUMER=NUMER+0.5D0*BETA**2*MU1**2*FMINUS2(I)*FPLUS2(I)*(EPS2(I)*FPLUS2(I)-EPS2(I)*FMINUS2(I))
    NUMER=NUMER+BETA*MU2*EPS2(I)*FMINUS2(I)*FPLUS2(I)
   ENDDO
   UUU2=NUMER
   WRITE(6,'(A,F20.10,A)')          'U(2) AGAIN                    =',UUU2,' HARTREE'

! =================== 3RD ORDER 

   ! -----
   ! MU(3)
   ! -----

   ALLOCATE(MU1M(2*O,2*O),MU2M(2*O,2*O),MU3M(2*O,2*O),FOCKTMU(2*O,2*O),FOCKTDERIV(2*O,2*O))
   MU1M=0.0D0
   MU2M=0.0D0
   DO P=1,2*O
    MU1M(P,P)=MU1
    MU2M(P,P)=MU2
   ENDDO
   FOCKTMU=FOCKT
   DO P=1,2*O
    FOCKTMU(P,P)=FOCKT(P,P)-MU1M(P,P)
   ENDDO
   DO P=1,2*O
    DO Q=1,2*O
     FOCKTDERIV(P,Q)=0.0D0
     DO R=1,2*O
      FOCKTDERIV(P,Q)=FOCKTDERIV(P,Q)-G2(P,R,Q,R)*FMINUS2(R)*FPLUS2(R)
     ENDDO
    ENDDO
   ENDDO

   NUMER=0.0D0
   DENOM=0.0D0
   ! diagram 1
   DO P=1,2*O
    DO Q=1,2*O
     DO R=1,2*O
      DO S=1,2*O
       DO T=1,2*O
        DO U=1,2*O
         DENOM1=EPS2(P)+EPS2(S)-EPS2(Q)-EPS2(R)
         DENOM2=EPS2(P)+EPS2(S)-EPS2(T)-EPS2(U)
         IF ((DABS(DENOM1) > 1.0D-10).AND.(DABS(DENOM2) > 1.0D-10)) &
         NUMER=NUMER+0.125D0*G2(P,S,Q,R)*G2(Q,R,T,U)*G2(T,U,P,S) &
                    *FMINUS2(P)*FPLUS2(Q)*FPLUS2(R)*FMINUS2(S)*FPLUS2(T)*FPLUS2(U) &
                    *(-FPLUS2(P)+FMINUS2(Q)+FMINUS2(R)-FPLUS2(S)+FMINUS2(T)+FMINUS2(U)) &
                    /DENOM1/DENOM2
         IF ((DABS(DENOM1) < 1.0D-10).AND.(DABS(DENOM2) > 1.0D-10)) &
         NUMER=NUMER-0.125D0*G2(P,S,Q,R)*G2(Q,R,T,U)*G2(T,U,P,S) &
                    *FMINUS2(P)*FPLUS2(Q)*FPLUS2(R)*FMINUS2(S)*FPLUS2(T)*FPLUS2(U) &
                    *(-FPLUS2(P)+FMINUS2(Q)+FMINUS2(R)-FPLUS2(S)+FMINUS2(T)+FMINUS2(U)) &
                    /DENOM2/DENOM2
         IF ((DABS(DENOM1) < 1.0D-10).AND.(DABS(DENOM2) > 1.0D-10)) &
         NUMER=NUMER+0.125D0*G2(P,S,Q,R)*G2(Q,R,T,U)*G2(T,U,P,S) &
                    *FMINUS2(P)*FPLUS2(Q)*FPLUS2(R)*FMINUS2(S)*FPLUS2(T)*FPLUS2(U) &
                    *(-FPLUS2(P)+FMINUS2(Q)+FMINUS2(R)-FPLUS2(S)+FMINUS2(T)+FMINUS2(U)) &
                    /DENOM2*(-BETA)/2.0D0
         IF ((DABS(DENOM1) > 1.0D-10).AND.(DABS(DENOM2) < 1.0D-10)) &
         NUMER=NUMER+0.125D0*G2(P,S,Q,R)*G2(Q,R,T,U)*G2(T,U,P,S) &
                    *FMINUS2(P)*FPLUS2(Q)*FPLUS2(R)*FMINUS2(S)*FPLUS2(T)*FPLUS2(U) &
                    *(-FPLUS2(P)+FMINUS2(Q)+FMINUS2(R)-FPLUS2(S)+FMINUS2(T)+FMINUS2(U)) &
                    /DENOM1*(-BETA)/2.0D0
         IF ((DABS(DENOM1) < 1.0D-10).AND.(DABS(DENOM2) < 1.0D-10)) &
         NUMER=NUMER+0.125D0*G2(P,S,Q,R)*G2(Q,R,T,U)*G2(T,U,P,S) &
                    *FMINUS2(P)*FPLUS2(Q)*FPLUS2(R)*FMINUS2(S)*FPLUS2(T)*FPLUS2(U) &
                    *(-FPLUS2(P)+FMINUS2(Q)+FMINUS2(R)-FPLUS2(S)+FMINUS2(T)+FMINUS2(U)) &
                    *(-BETA)**2/6.0D0
        ENDDO
       ENDDO
      ENDDO
     ENDDO
    ENDDO
   ENDDO
!denom=denom+numer
!write(*,'(2F20.10)') numer,denom
!numer=0.0d0
   ! diagram 2
   DO P=1,2*O
    DO Q=1,2*O
     DO R=1,2*O
      DO S=1,2*O
       DO T=1,2*O
        DO U=1,2*O
         DENOM1=EPS2(Q)+EPS2(R)-EPS2(P)-EPS2(S)
         DENOM2=EPS2(T)+EPS2(U)-EPS2(P)-EPS2(S)
         IF ((DABS(DENOM1) > 1.0D-10).AND.(DABS(DENOM2) > 1.0D-10)) &
         NUMER=NUMER+0.125D0*G2(Q,R,P,S)*G2(T,U,Q,R)*G2(P,S,T,U) &
                    *FPLUS2(P)*FMINUS2(Q)*FMINUS2(R)*FPLUS2(S)*FMINUS2(T)*FMINUS2(U) &
                    *(FMINUS2(P)-FPLUS2(Q)-FPLUS2(R)+FMINUS2(S)-FPLUS2(T)-FPLUS2(U)) &
                    /DENOM1/DENOM2
         IF ((DABS(DENOM1) < 1.0D-10).AND.(DABS(DENOM2) > 1.0D-10)) &
         NUMER=NUMER-0.125D0*G2(Q,R,P,S)*G2(T,U,Q,R)*G2(P,S,T,U) &
                    *FPLUS2(P)*FMINUS2(Q)*FMINUS2(R)*FPLUS2(S)*FMINUS2(T)*FMINUS2(U) &
                    *(FMINUS2(P)-FPLUS2(Q)-FPLUS2(R)+FMINUS2(S)-FPLUS2(T)-FPLUS2(U)) &
                    /DENOM2/DENOM2
         IF ((DABS(DENOM1) < 1.0D-10).AND.(DABS(DENOM2) > 1.0D-10)) &
         NUMER=NUMER+0.125D0*G2(Q,R,P,S)*G2(T,U,Q,R)*G2(P,S,T,U) &
                    *FPLUS2(P)*FMINUS2(Q)*FMINUS2(R)*FPLUS2(S)*FMINUS2(T)*FMINUS2(U) &
                    *(FMINUS2(P)-FPLUS2(Q)-FPLUS2(R)+FMINUS2(S)-FPLUS2(T)-FPLUS2(U)) &
                    /DENOM2*(-BETA)/2.0D0
         IF ((DABS(DENOM1) > 1.0D-10).AND.(DABS(DENOM2) < 1.0D-10)) &
         NUMER=NUMER+0.125D0*G2(Q,R,P,S)*G2(T,U,Q,R)*G2(P,S,T,U) &
                    *FPLUS2(P)*FMINUS2(Q)*FMINUS2(R)*FPLUS2(S)*FMINUS2(T)*FMINUS2(U) &
                    *(FMINUS2(P)-FPLUS2(Q)-FPLUS2(R)+FMINUS2(S)-FPLUS2(T)-FPLUS2(U)) &
                    /DENOM1*(-BETA)/2.0D0
         IF ((DABS(DENOM1) < 1.0D-10).AND.(DABS(DENOM2) < 1.0D-10)) &
         NUMER=NUMER+0.125D0*G2(Q,R,P,S)*G2(T,U,Q,R)*G2(P,S,T,U) &
                    *FPLUS2(P)*FMINUS2(Q)*FMINUS2(R)*FPLUS2(S)*FMINUS2(T)*FMINUS2(U) &
                    *(FMINUS2(P)-FPLUS2(Q)-FPLUS2(R)+FMINUS2(S)-FPLUS2(T)-FPLUS2(U)) &
                    *(-BETA)**2/6.0D0
        ENDDO
       ENDDO
      ENDDO
     ENDDO
    ENDDO
   ENDDO
!denom=denom+numer
!write(*,'(2F20.10)') numer,denom
!numer=0.0d0
   ! diagram 3
   DO P=1,2*O
    DO Q=1,2*O
     DO R=1,2*O
      DO S=1,2*O
       DO T=1,2*O
        DO U=1,2*O
         DENOM1=EPS2(Q)+EPS2(S)-EPS2(P)-EPS2(R)
         DENOM2=EPS2(T)+EPS2(S)-EPS2(P)-EPS2(U)
         IF ((DABS(DENOM1) > 1.0D-10).AND.(DABS(DENOM2) > 1.0D-10)) &
         NUMER=NUMER-G2(Q,S,P,R)*G2(T,R,Q,U)*G2(P,U,T,S) &
                    *FPLUS2(P)*FMINUS2(Q)*FPLUS2(R)*FMINUS2(S)*FMINUS2(T)*FPLUS2(U) &
                    *(FMINUS2(P)-FPLUS2(Q)+FMINUS2(R)-FPLUS2(S)-FPLUS2(T)+FMINUS2(U)) &
                    /DENOM1/DENOM2
         IF ((DABS(DENOM1) < 1.0D-10).AND.(DABS(DENOM2) > 1.0D-10)) &
         NUMER=NUMER+G2(Q,S,P,R)*G2(T,R,Q,U)*G2(P,U,T,S) &
                    *FPLUS2(P)*FMINUS2(Q)*FPLUS2(R)*FMINUS2(S)*FMINUS2(T)*FPLUS2(U) &
                    *(FMINUS2(P)-FPLUS2(Q)+FMINUS2(R)-FPLUS2(S)-FPLUS2(T)+FMINUS2(U)) &
                    /DENOM2/DENOM2
         IF ((DABS(DENOM1) < 1.0D-10).AND.(DABS(DENOM2) > 1.0D-10)) &
         NUMER=NUMER-G2(Q,S,P,R)*G2(T,R,Q,U)*G2(P,U,T,S) &
                    *FPLUS2(P)*FMINUS2(Q)*FPLUS2(R)*FMINUS2(S)*FMINUS2(T)*FPLUS2(U) &
                    *(FMINUS2(P)-FPLUS2(Q)+FMINUS2(R)-FPLUS2(S)-FPLUS2(T)+FMINUS2(U)) &
                    /DENOM2*(-BETA)/2.0D0
         IF ((DABS(DENOM1) > 1.0D-10).AND.(DABS(DENOM2) < 1.0D-10)) &
         NUMER=NUMER-G2(Q,S,P,R)*G2(T,R,Q,U)*G2(P,U,T,S) &
                    *FPLUS2(P)*FMINUS2(Q)*FPLUS2(R)*FMINUS2(S)*FMINUS2(T)*FPLUS2(U) &
                    *(FMINUS2(P)-FPLUS2(Q)+FMINUS2(R)-FPLUS2(S)-FPLUS2(T)+FMINUS2(U)) &
                    /DENOM1*(-BETA)/2.0D0
         IF ((DABS(DENOM1) < 1.0D-10).AND.(DABS(DENOM2) < 1.0D-10)) &
         NUMER=NUMER-G2(Q,S,P,R)*G2(T,R,Q,U)*G2(P,U,T,S) &
                    *FPLUS2(P)*FMINUS2(Q)*FPLUS2(R)*FMINUS2(S)*FMINUS2(T)*FPLUS2(U) &
                    *(FMINUS2(P)-FPLUS2(Q)+FMINUS2(R)-FPLUS2(S)-FPLUS2(T)+FMINUS2(U)) &
                    *(-BETA)**2/6.0D0
        ENDDO
       ENDDO
      ENDDO
     ENDDO
    ENDDO
   ENDDO
!denom=denom+numer
!write(*,'(2F20.10)') numer,denom
!numer=0.0d0
!goto 888
   ! diagram 4
   DO P=1,2*O
    DO Q=1,2*O
     DO R=1,2*O
      DO S=1,2*O
       DO T=1,2*O
        DENOM1=EPS2(P)-EPS2(Q)
        DENOM2=EPS2(P)+EPS2(S)-EPS2(R)-EPS2(T)
        IF ((DABS(DENOM1) > 1.0D-10).AND.(DABS(DENOM2) > 1.0D-10)) THEN
        NUMER=NUMER+0.5D0*FOCKT(P,Q)*G2(Q,S,R,T)*G2(R,T,P,S) &
                   *FMINUS2(P)*FPLUS2(Q)*FPLUS2(R)*FMINUS2(S)*FPLUS2(T) &
                   *(-FPLUS2(P)+FMINUS2(Q)+FMINUS2(R)-FPLUS2(S)+FMINUS2(T)) &
                   /DENOM1/DENOM2
        NUMER=NUMER+0.5D0*FOCKTDERIV(P,Q)*G2(Q,S,R,T)*G2(R,T,P,S) &
                   *FMINUS2(P)*FPLUS2(Q)*FPLUS2(R)*FMINUS2(S)*FPLUS2(T) &
                   /DENOM1/DENOM2
        ENDIF
        IF ((DABS(DENOM1) < 1.0D-10).AND.(DABS(DENOM2) > 1.0D-10)) THEN
        NUMER=NUMER-0.5D0*FOCKT(P,Q)*G2(Q,S,R,T)*G2(R,T,P,S) &
                   *FMINUS2(P)*FPLUS2(Q)*FPLUS2(R)*FMINUS2(S)*FPLUS2(T) &
                   *(-FPLUS2(P)+FMINUS2(Q)+FMINUS2(R)-FPLUS2(S)+FMINUS2(T)) &
                   /DENOM2/DENOM2
        NUMER=NUMER-0.5D0*FOCKTDERIV(P,Q)*G2(Q,S,R,T)*G2(R,T,P,S) &
                   *FMINUS2(P)*FPLUS2(Q)*FPLUS2(R)*FMINUS2(S)*FPLUS2(T) &
                   /DENOM2/DENOM2
        ENDIF
        IF ((DABS(DENOM1) < 1.0D-10).AND.(DABS(DENOM2) > 1.0D-10)) THEN
        NUMER=NUMER+0.5D0*FOCKTMU(P,Q)*G2(Q,S,R,T)*G2(R,T,P,S) &
                   *FMINUS2(P)*FPLUS2(Q)*FPLUS2(R)*FMINUS2(S)*FPLUS2(T) &
                   *(-FPLUS2(P)+FMINUS2(Q)+FMINUS2(R)-FPLUS2(S)+FMINUS2(T)) &
                   /DENOM2*(-BETA)/2.0D0
        NUMER=NUMER+0.5D0*FOCKTDERIV(P,Q)*G2(Q,S,R,T)*G2(R,T,P,S) &
                   *FMINUS2(P)*FPLUS2(Q)*FPLUS2(R)*FMINUS2(S)*FPLUS2(T) &
                   /DENOM2*(-BETA)/2.0D0
        ENDIF
        IF ((DABS(DENOM1) > 1.0D-10).AND.(DABS(DENOM2) < 1.0D-10)) THEN
        NUMER=NUMER+0.5D0*FOCKTMU(P,Q)*G2(Q,S,R,T)*G2(R,T,P,S) &
                   *FMINUS2(P)*FPLUS2(Q)*FPLUS2(R)*FMINUS2(S)*FPLUS2(T) &
                   *(-FPLUS2(P)+FMINUS2(Q)+FMINUS2(R)-FPLUS2(S)+FMINUS2(T)) &
                   /DENOM1*(-BETA)/2.0D0
        NUMER=NUMER+0.5D0*FOCKTDERIV(P,Q)*G2(Q,S,R,T)*G2(R,T,P,S) &
                   *FMINUS2(P)*FPLUS2(Q)*FPLUS2(R)*FMINUS2(S)*FPLUS2(T) &
                   /DENOM1*(-BETA)/2.0D0
        ENDIF
        IF ((DABS(DENOM1) < 1.0D-10).AND.(DABS(DENOM2) < 1.0D-10)) THEN
        NUMER=NUMER+0.5D0*FOCKTMU(P,Q)*G2(Q,S,R,T)*G2(R,T,P,S) &
                   *FMINUS2(P)*FPLUS2(Q)*FPLUS2(R)*FMINUS2(S)*FPLUS2(T) &
                   *(-FPLUS2(P)+FMINUS2(Q)+FMINUS2(R)-FPLUS2(S)+FMINUS2(T)) &
                   *(-BETA)**2/6.0D0
        NUMER=NUMER+0.5D0*FOCKTDERIV(P,Q)*G2(Q,S,R,T)*G2(R,T,P,S) &
                   *FMINUS2(P)*FPLUS2(Q)*FPLUS2(R)*FMINUS2(S)*FPLUS2(T) &
                   *(-BETA)**2/6.0D0
        ENDIF
       ENDDO
      ENDDO
     ENDDO
    ENDDO
   ENDDO
!denom=denom+numer
!write(*,'(2F20.10)') numer,denom
!numer=0.0d0
   ! diagram 5
   DO P=1,2*O
    DO Q=1,2*O
     DO R=1,2*O
      DO S=1,2*O
       DO T=1,2*O
        DENOM1=EPS2(Q)-EPS2(P)
        DENOM2=EPS2(R)+EPS2(T)-EPS2(P)-EPS2(S)
        IF ((DABS(DENOM1) > 1.0D-10).AND.(DABS(DENOM2) > 1.0D-10)) THEN
        NUMER=NUMER-0.5D0*FOCKT(Q,P)*G2(R,T,Q,S)*G2(P,S,R,T) &
                   *FPLUS2(P)*FMINUS2(Q)*FMINUS2(R)*FPLUS2(S)*FMINUS2(T) &
                   *(FMINUS2(P)-FPLUS2(Q)-FPLUS2(R)+FMINUS2(S)-FPLUS2(T)) &
                   /DENOM1/DENOM2
        NUMER=NUMER-0.5D0*FOCKTDERIV(Q,P)*G2(R,T,Q,S)*G2(P,S,R,T) &
                   *FPLUS2(P)*FMINUS2(Q)*FMINUS2(R)*FPLUS2(S)*FMINUS2(T) &
                   /DENOM1/DENOM2
        ENDIF
        IF ((DABS(DENOM1) < 1.0D-10).AND.(DABS(DENOM2) > 1.0D-10)) THEN
        NUMER=NUMER+0.5D0*FOCKT(Q,P)*G2(R,T,Q,S)*G2(P,S,R,T) &
                   *FPLUS2(P)*FMINUS2(Q)*FMINUS2(R)*FPLUS2(S)*FMINUS2(T) &
                   *(FMINUS2(P)-FPLUS2(Q)-FPLUS2(R)+FMINUS2(S)-FPLUS2(T)) &
                   /DENOM2/DENOM2
        NUMER=NUMER+0.5D0*FOCKTDERIV(Q,P)*G2(R,T,Q,S)*G2(P,S,R,T) &
                   *FPLUS2(P)*FMINUS2(Q)*FMINUS2(R)*FPLUS2(S)*FMINUS2(T) &
                   /DENOM2/DENOM2
        ENDIF
        IF ((DABS(DENOM1) < 1.0D-10).AND.(DABS(DENOM2) > 1.0D-10)) THEN
        NUMER=NUMER-0.5D0*FOCKTMU(Q,P)*G2(R,T,Q,S)*G2(P,S,R,T) &
                   *FPLUS2(P)*FMINUS2(Q)*FMINUS2(R)*FPLUS2(S)*FMINUS2(T) &
                   *(FMINUS2(P)-FPLUS2(Q)-FPLUS2(R)+FMINUS2(S)-FPLUS2(T)) &
                   /DENOM2*(-BETA)/2.0D0
        NUMER=NUMER-0.5D0*FOCKTDERIV(Q,P)*G2(R,T,Q,S)*G2(P,S,R,T) &
                   *FPLUS2(P)*FMINUS2(Q)*FMINUS2(R)*FPLUS2(S)*FMINUS2(T) &
                   /DENOM2*(-BETA)/2.0D0
        ENDIF
        IF ((DABS(DENOM1) > 1.0D-10).AND.(DABS(DENOM2) < 1.0D-10)) THEN
        NUMER=NUMER-0.5D0*FOCKTMU(Q,P)*G2(R,T,Q,S)*G2(P,S,R,T) &
                   *FPLUS2(P)*FMINUS2(Q)*FMINUS2(R)*FPLUS2(S)*FMINUS2(T) &
                   *(FMINUS2(P)-FPLUS2(Q)-FPLUS2(R)+FMINUS2(S)-FPLUS2(T)) &
                   /DENOM1*(-BETA)/2.0D0
        NUMER=NUMER-0.5D0*FOCKTDERIV(Q,P)*G2(R,T,Q,S)*G2(P,S,R,T) &
                   *FPLUS2(P)*FMINUS2(Q)*FMINUS2(R)*FPLUS2(S)*FMINUS2(T) &
                   /DENOM1*(-BETA)/2.0D0
        ENDIF
        IF ((DABS(DENOM1) < 1.0D-10).AND.(DABS(DENOM2) < 1.0D-10)) THEN
        NUMER=NUMER-0.5D0*FOCKTMU(Q,P)*G2(R,T,Q,S)*G2(P,S,R,T) &
                   *FPLUS2(P)*FMINUS2(Q)*FMINUS2(R)*FPLUS2(S)*FMINUS2(T) &
                   *(FMINUS2(P)-FPLUS2(Q)-FPLUS2(R)+FMINUS2(S)-FPLUS2(T)) &
                   *(-BETA)**2/6.0D0
        NUMER=NUMER-0.5D0*FOCKTDERIV(Q,P)*G2(R,T,Q,S)*G2(P,S,R,T) &
                   *FPLUS2(P)*FMINUS2(Q)*FMINUS2(R)*FPLUS2(S)*FMINUS2(T) &
                   *(-BETA)**2/6.0D0
        ENDIF
       ENDDO
      ENDDO
     ENDDO
    ENDDO
   ENDDO
!denom=denom+numer
!write(*,'(2F20.10)') numer,denom
!numer=0.0d0
   ! diagram 6
   DO P=1,2*O
    DO Q=1,2*O
     DO R=1,2*O
      DO S=1,2*O
       DO T=1,2*O
        DENOM1=EPS2(P)+EPS2(R)-EPS2(Q)-EPS2(S)
        DENOM2=EPS2(P)+EPS2(R)-EPS2(Q)-EPS2(T)
        IF ((DABS(DENOM1) > 1.0D-10).AND.(DABS(DENOM2) > 1.0D-10)) THEN
        NUMER=NUMER+0.5D0*FOCKT(S,T)*G2(P,R,Q,S)*G2(Q,T,P,R) &
                   *FMINUS2(P)*FPLUS2(Q)*FMINUS2(R)*FPLUS2(S)*FPLUS2(T) &
                   *(-FPLUS2(P)+FMINUS2(Q)-FPLUS2(R)+FMINUS2(S)+FMINUS2(T)) &
                   /DENOM1/DENOM2
        NUMER=NUMER+0.5D0*FOCKTDERIV(S,T)*G2(P,R,Q,S)*G2(Q,T,P,R) &
                   *FMINUS2(P)*FPLUS2(Q)*FMINUS2(R)*FPLUS2(S)*FPLUS2(T) &
                   /DENOM1/DENOM2
        ENDIF
        IF ((DABS(DENOM1) < 1.0D-10).AND.(DABS(DENOM2) > 1.0D-10)) THEN
        NUMER=NUMER-0.5D0*FOCKT(S,T)*G2(P,R,Q,S)*G2(Q,T,P,R) &
                   *FMINUS2(P)*FPLUS2(Q)*FMINUS2(R)*FPLUS2(S)*FPLUS2(T) &
                   *(-FPLUS2(P)+FMINUS2(Q)-FPLUS2(R)+FMINUS2(S)+FMINUS2(T)) &
                   /DENOM2/DENOM2
        NUMER=NUMER-0.5D0*FOCKTDERIV(S,T)*G2(P,R,Q,S)*G2(Q,T,P,R) &
                   *FMINUS2(P)*FPLUS2(Q)*FMINUS2(R)*FPLUS2(S)*FPLUS2(T) &
                   /DENOM2/DENOM2
        ENDIF
        IF ((DABS(DENOM1) < 1.0D-10).AND.(DABS(DENOM2) > 1.0D-10)) THEN
        NUMER=NUMER+0.5D0*FOCKTMU(S,T)*G2(P,R,Q,S)*G2(Q,T,P,R) &
                   *FMINUS2(P)*FPLUS2(Q)*FMINUS2(R)*FPLUS2(S)*FPLUS2(T) &
                   *(-FPLUS2(P)+FMINUS2(Q)-FPLUS2(R)+FMINUS2(S)+FMINUS2(T)) &
                   /DENOM2*(-BETA)/2.0D0
        NUMER=NUMER+0.5D0*FOCKTDERIV(S,T)*G2(P,R,Q,S)*G2(Q,T,P,R) &
                   *FMINUS2(P)*FPLUS2(Q)*FMINUS2(R)*FPLUS2(S)*FPLUS2(T) &
                   /DENOM2*(-BETA)/2.0D0
        ENDIF
        IF ((DABS(DENOM1) > 1.0D-10).AND.(DABS(DENOM2) < 1.0D-10)) THEN
        NUMER=NUMER+0.5D0*FOCKTMU(S,T)*G2(P,R,Q,S)*G2(Q,T,P,R) &
                   *FMINUS2(P)*FPLUS2(Q)*FMINUS2(R)*FPLUS2(S)*FPLUS2(T) &
                   *(-FPLUS2(P)+FMINUS2(Q)-FPLUS2(R)+FMINUS2(S)+FMINUS2(T)) &
                   /DENOM1*(-BETA)/2.0D0
        NUMER=NUMER+0.5D0*FOCKTDERIV(S,T)*G2(P,R,Q,S)*G2(Q,T,P,R) &
                   *FMINUS2(P)*FPLUS2(Q)*FMINUS2(R)*FPLUS2(S)*FPLUS2(T) &
                   /DENOM1*(-BETA)/2.0D0
        ENDIF
        IF ((DABS(DENOM1) < 1.0D-10).AND.(DABS(DENOM2) < 1.0D-10)) THEN
        NUMER=NUMER+0.5D0*FOCKTMU(S,T)*G2(P,R,Q,S)*G2(Q,T,P,R) &
                   *FMINUS2(P)*FPLUS2(Q)*FMINUS2(R)*FPLUS2(S)*FPLUS2(T) &
                   *(-FPLUS2(P)+FMINUS2(Q)-FPLUS2(R)+FMINUS2(S)+FMINUS2(T)) &
                   *(-BETA)**2/6.0D0
        NUMER=NUMER+0.5D0*FOCKTDERIV(S,T)*G2(P,R,Q,S)*G2(Q,T,P,R) &
                   *FMINUS2(P)*FPLUS2(Q)*FMINUS2(R)*FPLUS2(S)*FPLUS2(T) &
                   *(-BETA)**2/6.0D0
        ENDIF
       ENDDO
      ENDDO
     ENDDO
    ENDDO
   ENDDO
!denom=denom+numer
!write(*,'(2F20.10)') numer,denom
!numer=0.0d0
   ! diagram 7
   DO P=1,2*O
    DO Q=1,2*O
     DO R=1,2*O
      DO S=1,2*O
       DO T=1,2*O
        DENOM1=EPS2(Q)+EPS2(S)-EPS2(P)-EPS2(R)
        DENOM2=EPS2(Q)+EPS2(T)-EPS2(P)-EPS2(R)
        IF ((DABS(DENOM1) > 1.0D-10).AND.(DABS(DENOM2) > 1.0D-10)) THEN
        NUMER=NUMER-0.5D0*FOCKT(T,S)*G2(Q,S,P,R)*G2(P,R,Q,T) &
                   *FPLUS2(P)*FMINUS2(Q)*FPLUS2(R)*FMINUS2(S)*FMINUS2(T) &
                   *(FMINUS2(P)-FPLUS2(Q)+FMINUS2(R)-FPLUS2(S)-FPLUS2(T)) &
                   /DENOM1/DENOM2
        NUMER=NUMER-0.5D0*FOCKTDERIV(T,S)*G2(Q,S,P,R)*G2(P,R,Q,T) &
                   *FPLUS2(P)*FMINUS2(Q)*FPLUS2(R)*FMINUS2(S)*FMINUS2(T) &
                   /DENOM1/DENOM2
        ENDIF
        IF ((DABS(DENOM1) < 1.0D-10).AND.(DABS(DENOM2) > 1.0D-10)) THEN
        NUMER=NUMER+0.5D0*FOCKT(T,S)*G2(Q,S,P,R)*G2(P,R,Q,T) &
                   *FPLUS2(P)*FMINUS2(Q)*FPLUS2(R)*FMINUS2(S)*FMINUS2(T) &
                   *(FMINUS2(P)-FPLUS2(Q)+FMINUS2(R)-FPLUS2(S)-FPLUS2(T)) &
                   /DENOM2/DENOM2
        NUMER=NUMER+0.5D0*FOCKTDERIV(T,S)*G2(Q,S,P,R)*G2(P,R,Q,T) &
                   *FPLUS2(P)*FMINUS2(Q)*FPLUS2(R)*FMINUS2(S)*FMINUS2(T) &
                   /DENOM2/DENOM2
        ENDIF
        IF ((DABS(DENOM1) < 1.0D-10).AND.(DABS(DENOM2) > 1.0D-10)) THEN
        NUMER=NUMER-0.5D0*FOCKTMU(T,S)*G2(Q,S,P,R)*G2(P,R,Q,T) &
                   *FPLUS2(P)*FMINUS2(Q)*FPLUS2(R)*FMINUS2(S)*FMINUS2(T) &
                   *(FMINUS2(P)-FPLUS2(Q)+FMINUS2(R)-FPLUS2(S)-FPLUS2(T)) &
                   /DENOM2*(-BETA)/2.0D0
        NUMER=NUMER-0.5D0*FOCKTDERIV(T,S)*G2(Q,S,P,R)*G2(P,R,Q,T) &
                   *FPLUS2(P)*FMINUS2(Q)*FPLUS2(R)*FMINUS2(S)*FMINUS2(T) &
                   /DENOM2*(-BETA)/2.0D0
        ENDIF
        IF ((DABS(DENOM1) > 1.0D-10).AND.(DABS(DENOM2) < 1.0D-10)) THEN
        NUMER=NUMER-0.5D0*FOCKTMU(T,S)*G2(Q,S,P,R)*G2(P,R,Q,T) &
                   *FPLUS2(P)*FMINUS2(Q)*FPLUS2(R)*FMINUS2(S)*FMINUS2(T) &
                   *(FMINUS2(P)-FPLUS2(Q)+FMINUS2(R)-FPLUS2(S)-FPLUS2(T)) &
                   /DENOM1*(-BETA)/2.0D0
        NUMER=NUMER-0.5D0*FOCKTDERIV(T,S)*G2(Q,S,P,R)*G2(P,R,Q,T) &
                   *FPLUS2(P)*FMINUS2(Q)*FPLUS2(R)*FMINUS2(S)*FMINUS2(T) &
                   /DENOM1*(-BETA)/2.0D0
        ENDIF
        IF ((DABS(DENOM1) < 1.0D-10).AND.(DABS(DENOM2) < 1.0D-10)) THEN
        NUMER=NUMER-0.5D0*FOCKTMU(T,S)*G2(Q,S,P,R)*G2(P,R,Q,T) &
                   *FPLUS2(P)*FMINUS2(Q)*FPLUS2(R)*FMINUS2(S)*FMINUS2(T) &
                   *(FMINUS2(P)-FPLUS2(Q)+FMINUS2(R)-FPLUS2(S)-FPLUS2(T)) &
                   *(-BETA)**2/6.0D0
        NUMER=NUMER-0.5D0*FOCKTDERIV(T,S)*G2(Q,S,P,R)*G2(P,R,Q,T) &
                   *FPLUS2(P)*FMINUS2(Q)*FPLUS2(R)*FMINUS2(S)*FMINUS2(T) &
                   *(-BETA)**2/6.0D0
        ENDIF
       ENDDO
      ENDDO
     ENDDO
    ENDDO
   ENDDO
!denom=denom+numer
!write(*,'(2F20.10)') numer,denom
!numer=0.0d0
   ! diagram 8
   DO P=1,2*O
    DO Q=1,2*O
     DO R=1,2*O
      DO S=1,2*O
       DO T=1,2*O
        DENOM1=EPS2(P)+EPS2(R)-EPS2(Q)-EPS2(S)
        DENOM2=EPS2(P)-EPS2(T)
        IF ((DABS(DENOM1) > 1.0D-10).AND.(DABS(DENOM2) > 1.0D-10)) THEN
        NUMER=NUMER+0.5D0*FOCKT(T,P)*G2(P,R,Q,S)*G2(Q,S,T,R) &
                   *FMINUS2(P)*FPLUS2(Q)*FMINUS2(R)*FPLUS2(S)*FPLUS2(T) &
                   *(-FPLUS2(P)+FMINUS2(Q)-FPLUS2(R)+FMINUS2(S)+FMINUS2(T)) &
                   /DENOM1/DENOM2
        NUMER=NUMER+0.5D0*FOCKTDERIV(T,P)*G2(P,R,Q,S)*G2(Q,S,T,R) &
                   *FMINUS2(P)*FPLUS2(Q)*FMINUS2(R)*FPLUS2(S)*FPLUS2(T) &
                   /DENOM1/DENOM2
        ENDIF
        IF ((DABS(DENOM1) < 1.0D-10).AND.(DABS(DENOM2) > 1.0D-10)) THEN
        NUMER=NUMER-0.5D0*FOCKT(T,P)*G2(P,R,Q,S)*G2(Q,S,T,R) &
                   *FMINUS2(P)*FPLUS2(Q)*FMINUS2(R)*FPLUS2(S)*FPLUS2(T) &
                   *(-FPLUS2(P)+FMINUS2(Q)-FPLUS2(R)+FMINUS2(S)+FMINUS2(T)) &
                   /DENOM2/DENOM2
        NUMER=NUMER-0.5D0*FOCKTDERIV(T,P)*G2(P,R,Q,S)*G2(Q,S,T,R) &
                   *FMINUS2(P)*FPLUS2(Q)*FMINUS2(R)*FPLUS2(S)*FPLUS2(T) &
                   /DENOM2/DENOM2
        ENDIF
        IF ((DABS(DENOM1) < 1.0D-10).AND.(DABS(DENOM2) > 1.0D-10)) THEN
        NUMER=NUMER+0.5D0*FOCKTMU(T,P)*G2(P,R,Q,S)*G2(Q,S,T,R) &
                   *FMINUS2(P)*FPLUS2(Q)*FMINUS2(R)*FPLUS2(S)*FPLUS2(T) &
                   *(-FPLUS2(P)+FMINUS2(Q)-FPLUS2(R)+FMINUS2(S)+FMINUS2(T)) &
                   /DENOM2*(-BETA)/2.0D0
        NUMER=NUMER+0.5D0*FOCKTDERIV(T,P)*G2(P,R,Q,S)*G2(Q,S,T,R) &
                   *FMINUS2(P)*FPLUS2(Q)*FMINUS2(R)*FPLUS2(S)*FPLUS2(T) &
                   /DENOM2*(-BETA)/2.0D0
        ENDIF
        IF ((DABS(DENOM1) > 1.0D-10).AND.(DABS(DENOM2) < 1.0D-10)) THEN
        NUMER=NUMER+0.5D0*FOCKTMU(T,P)*G2(P,R,Q,S)*G2(Q,S,T,R) &
                   *FMINUS2(P)*FPLUS2(Q)*FMINUS2(R)*FPLUS2(S)*FPLUS2(T) &
                   *(-FPLUS2(P)+FMINUS2(Q)-FPLUS2(R)+FMINUS2(S)+FMINUS2(T)) &
                   /DENOM1*(-BETA)/2.0D0
        NUMER=NUMER+0.5D0*FOCKTDERIV(T,P)*G2(P,R,Q,S)*G2(Q,S,T,R) &
                   *FMINUS2(P)*FPLUS2(Q)*FMINUS2(R)*FPLUS2(S)*FPLUS2(T) &
                   /DENOM1*(-BETA)/2.0D0
        ENDIF
        IF ((DABS(DENOM1) < 1.0D-10).AND.(DABS(DENOM2) < 1.0D-10)) THEN
        NUMER=NUMER+0.5D0*FOCKTMU(T,P)*G2(P,R,Q,S)*G2(Q,S,T,R) &
                   *FMINUS2(P)*FPLUS2(Q)*FMINUS2(R)*FPLUS2(S)*FPLUS2(T) &
                   *(-FPLUS2(P)+FMINUS2(Q)-FPLUS2(R)+FMINUS2(S)+FMINUS2(T)) &
                   *(-BETA)**2/6.0D0
        NUMER=NUMER+0.5D0*FOCKTDERIV(T,P)*G2(P,R,Q,S)*G2(Q,S,T,R) &
                   *FMINUS2(P)*FPLUS2(Q)*FMINUS2(R)*FPLUS2(S)*FPLUS2(T) &
                   *(-BETA)**2/6.0D0
        ENDIF
       ENDDO
      ENDDO
     ENDDO
    ENDDO
   ENDDO
!denom=denom+numer
!write(*,'(2F20.10)') numer,denom
!numer=0.0d0
   ! diagram 9
   DO P=1,2*O
    DO Q=1,2*O
     DO R=1,2*O
      DO S=1,2*O
       DO T=1,2*O
        DENOM1=EPS2(Q)+EPS2(S)-EPS2(P)-EPS2(R)
        DENOM2=EPS2(T)-EPS2(P)
        IF ((DABS(DENOM1) > 1.0D-10).AND.(DABS(DENOM2) > 1.0D-10)) THEN
        NUMER=NUMER-0.5D0*FOCKT(P,T)*G2(Q,S,P,R)*G2(T,R,Q,S) &
                   *FPLUS2(P)*FMINUS2(Q)*FPLUS2(R)*FMINUS2(S)*FMINUS2(T) &
                   *(FMINUS2(P)-FPLUS2(Q)+FMINUS2(R)-FPLUS2(S)-FPLUS2(T)) &
                   /DENOM1/DENOM2
        NUMER=NUMER-0.5D0*FOCKTDERIV(P,T)*G2(Q,S,P,R)*G2(T,R,Q,S) &
                   *FPLUS2(P)*FMINUS2(Q)*FPLUS2(R)*FMINUS2(S)*FMINUS2(T) &
                   /DENOM1/DENOM2
        ENDIF
        IF ((DABS(DENOM1) < 1.0D-10).AND.(DABS(DENOM2) > 1.0D-10)) THEN
        NUMER=NUMER+0.5D0*FOCKT(P,T)*G2(Q,S,P,R)*G2(T,R,Q,S) &
                   *FPLUS2(P)*FMINUS2(Q)*FPLUS2(R)*FMINUS2(S)*FMINUS2(T) &
                   *(FMINUS2(P)-FPLUS2(Q)+FMINUS2(R)-FPLUS2(S)-FPLUS2(T)) &
                   /DENOM2/DENOM2
        NUMER=NUMER+0.5D0*FOCKTDERIV(P,T)*G2(Q,S,P,R)*G2(T,R,Q,S) &
                   *FPLUS2(P)*FMINUS2(Q)*FPLUS2(R)*FMINUS2(S)*FMINUS2(T) &
                   /DENOM2/DENOM2
        ENDIF
        IF ((DABS(DENOM1) < 1.0D-10).AND.(DABS(DENOM2) > 1.0D-10)) THEN
        NUMER=NUMER-0.5D0*FOCKTMU(P,T)*G2(Q,S,P,R)*G2(T,R,Q,S) &
                   *FPLUS2(P)*FMINUS2(Q)*FPLUS2(R)*FMINUS2(S)*FMINUS2(T) &
                   *(FMINUS2(P)-FPLUS2(Q)+FMINUS2(R)-FPLUS2(S)-FPLUS2(T)) &
                   /DENOM2*(-BETA)/2.0D0
        NUMER=NUMER-0.5D0*FOCKTDERIV(P,T)*G2(Q,S,P,R)*G2(T,R,Q,S) &
                   *FPLUS2(P)*FMINUS2(Q)*FPLUS2(R)*FMINUS2(S)*FMINUS2(T) &
                   /DENOM2*(-BETA)/2.0D0
        ENDIF
        IF ((DABS(DENOM1) > 1.0D-10).AND.(DABS(DENOM2) < 1.0D-10)) THEN
        NUMER=NUMER-0.5D0*FOCKTMU(P,T)*G2(Q,S,P,R)*G2(T,R,Q,S) &
                   *FPLUS2(P)*FMINUS2(Q)*FPLUS2(R)*FMINUS2(S)*FMINUS2(T) &
                   *(FMINUS2(P)-FPLUS2(Q)+FMINUS2(R)-FPLUS2(S)-FPLUS2(T)) &
                   /DENOM1*(-BETA)/2.0D0
        NUMER=NUMER-0.5D0*FOCKTDERIV(P,T)*G2(Q,S,P,R)*G2(T,R,Q,S) &
                   *FPLUS2(P)*FMINUS2(Q)*FPLUS2(R)*FMINUS2(S)*FMINUS2(T) &
                   /DENOM1*(-BETA)/2.0D0
        ENDIF
        IF ((DABS(DENOM1) < 1.0D-10).AND.(DABS(DENOM2) < 1.0D-10)) THEN
        NUMER=NUMER-0.5D0*FOCKTMU(P,T)*G2(Q,S,P,R)*G2(T,R,Q,S) &
                   *FPLUS2(P)*FMINUS2(Q)*FPLUS2(R)*FMINUS2(S)*FMINUS2(T) &
                   *(FMINUS2(P)-FPLUS2(Q)+FMINUS2(R)-FPLUS2(S)-FPLUS2(T)) &
                   *(-BETA)**2/6.0D0
        NUMER=NUMER-0.5D0*FOCKTDERIV(P,T)*G2(Q,S,P,R)*G2(T,R,Q,S) &
                   *FPLUS2(P)*FMINUS2(Q)*FPLUS2(R)*FMINUS2(S)*FMINUS2(T) &
                   *(-BETA)**2/6.0D0
        ENDIF
       ENDDO
      ENDDO
     ENDDO
    ENDDO
   ENDDO
!denom=denom+numer
!write(*,'(2F20.10)') numer,denom
!numer=0.0d0
   ! diagram 10
   DO P=1,2*O
    DO Q=1,2*O
     DO R=1,2*O
      DO S=1,2*O
       DENOM1=EPS2(Q)-EPS2(P)
       DENOM2=EPS2(Q)+EPS2(R)-EPS2(P)-EPS2(S)
       IF ((DABS(DENOM1) > 1.0D-10).AND.(DABS(DENOM2) > 1.0D-10)) THEN
       NUMER=NUMER-FOCKT(Q,P)*FOCKT(R,S)*G2(P,S,R,Q) &
                  *FPLUS2(P)*FMINUS2(Q)*FMINUS2(R)*FPLUS2(S) &
                  *(FMINUS2(P)-FPLUS2(Q)-FPLUS2(R)+FMINUS2(S)) &
                  /DENOM1/DENOM2
       NUMER=NUMER-FOCKTDERIV(Q,P)*FOCKT(R,S)*G2(P,S,R,Q) &
                  *FPLUS2(P)*FMINUS2(Q)*FMINUS2(R)*FPLUS2(S) &
                  /DENOM1/DENOM2
       NUMER=NUMER-FOCKT(Q,P)*FOCKTDERIV(R,S)*G2(P,S,R,Q) &
                  *FPLUS2(P)*FMINUS2(Q)*FMINUS2(R)*FPLUS2(S) &
                  /DENOM1/DENOM2
       ENDIF
       IF ((DABS(DENOM1) < 1.0D-10).AND.(DABS(DENOM2) > 1.0D-10)) THEN
       NUMER=NUMER+FOCKT(Q,P)*FOCKT(R,S)*G2(P,S,R,Q) &
                  *FPLUS2(P)*FMINUS2(Q)*FMINUS2(R)*FPLUS2(S) &
                  *(FMINUS2(P)-FPLUS2(Q)-FPLUS2(R)+FMINUS2(S)) &
                  /DENOM2/DENOM2
       NUMER=NUMER+FOCKTDERIV(Q,P)*FOCKT(R,S)*G2(P,S,R,Q) &
                  *FPLUS2(P)*FMINUS2(Q)*FMINUS2(R)*FPLUS2(S) &
                  /DENOM2/DENOM2
       NUMER=NUMER+FOCKT(Q,P)*FOCKTDERIV(R,S)*G2(P,S,R,Q) &
                  *FPLUS2(P)*FMINUS2(Q)*FMINUS2(R)*FPLUS2(S) &
                  /DENOM2/DENOM2
       ENDIF
       IF ((DABS(DENOM1) < 1.0D-10).AND.(DABS(DENOM2) > 1.0D-10)) THEN
       NUMER=NUMER-FOCKTMU(Q,P)*FOCKTMU(R,S)*G2(P,S,R,Q) &
                  *FPLUS2(P)*FMINUS2(Q)*FMINUS2(R)*FPLUS2(S) &
                  *(FMINUS2(P)-FPLUS2(Q)-FPLUS2(R)+FMINUS2(S)) &
                  /DENOM2*(-BETA)/2.0D0
       NUMER=NUMER-FOCKTDERIV(Q,P)*FOCKTMU(R,S)*G2(P,S,R,Q) &
                  *FPLUS2(P)*FMINUS2(Q)*FMINUS2(R)*FPLUS2(S) &
                  /DENOM2*(-BETA)/2.0D0
       NUMER=NUMER-FOCKTMU(Q,P)*FOCKTDERIV(R,S)*G2(P,S,R,Q) &
                  *FPLUS2(P)*FMINUS2(Q)*FMINUS2(R)*FPLUS2(S) &
                  /DENOM2*(-BETA)/2.0D0
       ENDIF
       IF ((DABS(DENOM1) > 1.0D-10).AND.(DABS(DENOM2) < 1.0D-10)) THEN
       NUMER=NUMER-FOCKTMU(Q,P)*FOCKTMU(R,S)*G2(P,S,R,Q) &
                  *FPLUS2(P)*FMINUS2(Q)*FMINUS2(R)*FPLUS2(S) &
                  *(FMINUS2(P)-FPLUS2(Q)-FPLUS2(R)+FMINUS2(S)) &
                  /DENOM1*(-BETA)/2.0D0
       NUMER=NUMER-FOCKTDERIV(Q,P)*FOCKTMU(R,S)*G2(P,S,R,Q) &
                  *FPLUS2(P)*FMINUS2(Q)*FMINUS2(R)*FPLUS2(S) &
                  /DENOM1*(-BETA)/2.0D0
       NUMER=NUMER-FOCKTMU(Q,P)*FOCKTDERIV(R,S)*G2(P,S,R,Q) &
                  *FPLUS2(P)*FMINUS2(Q)*FMINUS2(R)*FPLUS2(S) &
                  /DENOM1*(-BETA)/2.0D0
       ENDIF
       IF ((DABS(DENOM1) < 1.0D-10).AND.(DABS(DENOM2) < 1.0D-10)) THEN
       NUMER=NUMER-FOCKTMU(Q,P)*FOCKTMU(R,S)*G2(P,S,R,Q) &
                  *FPLUS2(P)*FMINUS2(Q)*FMINUS2(R)*FPLUS2(S) &
                  *(FMINUS2(P)-FPLUS2(Q)-FPLUS2(R)+FMINUS2(S)) &
                  *(-BETA)**2/6.0D0
       NUMER=NUMER-FOCKTDERIV(Q,P)*FOCKTMU(R,S)*G2(P,S,R,Q) &
                  *FPLUS2(P)*FMINUS2(Q)*FMINUS2(R)*FPLUS2(S) &
                  *(-BETA)**2/6.0D0
       NUMER=NUMER-FOCKTMU(Q,P)*FOCKTDERIV(R,S)*G2(P,S,R,Q) &
                  *FPLUS2(P)*FMINUS2(Q)*FMINUS2(R)*FPLUS2(S) &
                  *(-BETA)**2/6.0D0
       ENDIF
      ENDDO
     ENDDO
    ENDDO
   ENDDO
!denom=denom+numer
!write(*,'(2F20.10)') numer,denom
!numer=0.0d0
   ! diagram 11
   DO P=1,2*O
    DO Q=1,2*O
     DO R=1,2*O
      DO S=1,2*O
       DENOM1=EPS2(P)-EPS2(Q)
       DENOM2=EPS2(R)-EPS2(S)
       IF ((DABS(DENOM1) > 1.0D-10).AND.(DABS(DENOM2) > 1.0D-10)) THEN
       NUMER=NUMER-FOCKT(P,Q)*G2(R,Q,P,S)*FOCKT(S,R) &
                  *FMINUS2(P)*FPLUS2(Q)*FMINUS2(R)*FPLUS2(S) &
                  *(-FPLUS2(P)+FMINUS2(Q)-FPLUS2(R)+FMINUS2(S)) &
                  /DENOM1/DENOM2
       NUMER=NUMER-FOCKTDERIV(P,Q)*G2(R,Q,P,S)*FOCKT(S,R) &
                  *FMINUS2(P)*FPLUS2(Q)*FMINUS2(R)*FPLUS2(S) &
                  /DENOM1/DENOM2
       NUMER=NUMER-FOCKT(P,Q)*G2(R,Q,P,S)*FOCKTDERIV(S,R) &
                  *FMINUS2(P)*FPLUS2(Q)*FMINUS2(R)*FPLUS2(S) &
                  /DENOM1/DENOM2
       ENDIF
       IF ((DABS(DENOM1) < 1.0D-10).AND.(DABS(DENOM2) > 1.0D-10)) THEN
       NUMER=NUMER+FOCKT(P,Q)*G2(R,Q,P,S)*FOCKT(S,R) &
                  *FMINUS2(P)*FPLUS2(Q)*FMINUS2(R)*FPLUS2(S) &
                  *(-FPLUS2(P)+FMINUS2(Q)-FPLUS2(R)+FMINUS2(S)) &
                  /DENOM2/DENOM2
       NUMER=NUMER+FOCKTDERIV(P,Q)*G2(R,Q,P,S)*FOCKT(S,R) &
                  *FMINUS2(P)*FPLUS2(Q)*FMINUS2(R)*FPLUS2(S) &
                  /DENOM2/DENOM2
       NUMER=NUMER+FOCKT(P,Q)*G2(R,Q,P,S)*FOCKTDERIV(S,R) &
                  *FMINUS2(P)*FPLUS2(Q)*FMINUS2(R)*FPLUS2(S) &
                  /DENOM2/DENOM2
       ENDIF
       IF ((DABS(DENOM1) < 1.0D-10).AND.(DABS(DENOM2) > 1.0D-10)) THEN
       NUMER=NUMER-FOCKTMU(P,Q)*G2(R,Q,P,S)*FOCKTMU(S,R) &
                  *FMINUS2(P)*FPLUS2(Q)*FMINUS2(R)*FPLUS2(S) &
                  *(-FPLUS2(P)+FMINUS2(Q)-FPLUS2(R)+FMINUS2(S)) &
                  /DENOM2*(-BETA)/2.0D0
       NUMER=NUMER-FOCKTDERIV(P,Q)*G2(R,Q,P,S)*FOCKTMU(S,R) &
                  *FMINUS2(P)*FPLUS2(Q)*FMINUS2(R)*FPLUS2(S) &
                  /DENOM2*(-BETA)/2.0D0
       NUMER=NUMER-FOCKTMU(P,Q)*G2(R,Q,P,S)*FOCKTDERIV(S,R) &
                  *FMINUS2(P)*FPLUS2(Q)*FMINUS2(R)*FPLUS2(S) &
                  /DENOM2*(-BETA)/2.0D0
       ENDIF
       IF ((DABS(DENOM1) > 1.0D-10).AND.(DABS(DENOM2) < 1.0D-10)) THEN
       NUMER=NUMER-FOCKTMU(P,Q)*G2(R,Q,P,S)*FOCKTMU(S,R) &
                  *FMINUS2(P)*FPLUS2(Q)*FMINUS2(R)*FPLUS2(S) &
                  *(-FPLUS2(P)+FMINUS2(Q)-FPLUS2(R)+FMINUS2(S)) &
                  /DENOM1*(-BETA)/2.0D0
       NUMER=NUMER-FOCKTDERIV(P,Q)*G2(R,Q,P,S)*FOCKTMU(S,R) &
                  *FMINUS2(P)*FPLUS2(Q)*FMINUS2(R)*FPLUS2(S) &
                  /DENOM1*(-BETA)/2.0D0
       NUMER=NUMER-FOCKTMU(P,Q)*G2(R,Q,P,S)*FOCKTDERIV(S,R) &
                  *FMINUS2(P)*FPLUS2(Q)*FMINUS2(R)*FPLUS2(S) &
                  /DENOM1*(-BETA)/2.0D0
       ENDIF
       IF ((DABS(DENOM1) < 1.0D-10).AND.(DABS(DENOM2) < 1.0D-10)) THEN
       NUMER=NUMER-FOCKTMU(P,Q)*G2(R,Q,P,S)*FOCKTMU(S,R) &
                  *FMINUS2(P)*FPLUS2(Q)*FMINUS2(R)*FPLUS2(S) &
                  *(-FPLUS2(P)+FMINUS2(Q)-FPLUS2(R)+FMINUS2(S)) &
                  *(-BETA)**2/6.0D0
       NUMER=NUMER-FOCKTDERIV(P,Q)*G2(R,Q,P,S)*FOCKTMU(S,R) &
                  *FMINUS2(P)*FPLUS2(Q)*FMINUS2(R)*FPLUS2(S) &
                  *(-BETA)**2/6.0D0
       NUMER=NUMER-FOCKTMU(P,Q)*G2(R,Q,P,S)*FOCKTDERIV(S,R) &
                  *FMINUS2(P)*FPLUS2(Q)*FMINUS2(R)*FPLUS2(S) &
                  *(-BETA)**2/6.0D0
       ENDIF
      ENDDO
     ENDDO
    ENDDO
   ENDDO
!denom=denom+numer
!write(*,'(2F20.10)') numer,denom
!numer=0.0d0
   ! diagram 12
   DO P=1,2*O
    DO Q=1,2*O
     DO R=1,2*O
      DO S=1,2*O
       DENOM1=EPS2(Q)+EPS2(R)-EPS2(P)-EPS2(S)
       DENOM2=EPS2(Q)-EPS2(P)
       IF ((DABS(DENOM1) > 1.0D-10).AND.(DABS(DENOM2) > 1.0D-10)) THEN
       NUMER=NUMER-FOCKT(S,R)*FOCKT(P,Q)*G2(R,Q,P,S) &
                  *FPLUS2(P)*FMINUS2(Q)*FMINUS2(R)*FPLUS2(S) &
                  *(FMINUS2(P)-FPLUS2(Q)-FPLUS2(R)+FMINUS2(S)) &
                  /DENOM1/DENOM2
       NUMER=NUMER-FOCKTDERIV(S,R)*FOCKT(P,Q)*G2(R,Q,P,S) &
                  *FPLUS2(P)*FMINUS2(Q)*FMINUS2(R)*FPLUS2(S) &
                  /DENOM1/DENOM2
       NUMER=NUMER-FOCKT(S,R)*FOCKTDERIV(P,Q)*G2(R,Q,P,S) &
                  *FPLUS2(P)*FMINUS2(Q)*FMINUS2(R)*FPLUS2(S) &
                  /DENOM1/DENOM2
       ENDIF
       IF ((DABS(DENOM1) < 1.0D-10).AND.(DABS(DENOM2) > 1.0D-10)) THEN
       NUMER=NUMER+FOCKT(S,R)*FOCKT(P,Q)*G2(R,Q,P,S) &
                  *FPLUS2(P)*FMINUS2(Q)*FMINUS2(R)*FPLUS2(S) &
                  *(FMINUS2(P)-FPLUS2(Q)-FPLUS2(R)+FMINUS2(S)) &
                  /DENOM2/DENOM2
       NUMER=NUMER+FOCKTDERIV(S,R)*FOCKT(P,Q)*G2(R,Q,P,S) &
                  *FPLUS2(P)*FMINUS2(Q)*FMINUS2(R)*FPLUS2(S) &
                  /DENOM2/DENOM2
       NUMER=NUMER+FOCKT(S,R)*FOCKTDERIV(P,Q)*G2(R,Q,P,S) &
                  *FPLUS2(P)*FMINUS2(Q)*FMINUS2(R)*FPLUS2(S) &
                  /DENOM2/DENOM2
       ENDIF
       IF ((DABS(DENOM1) < 1.0D-10).AND.(DABS(DENOM2) > 1.0D-10)) THEN
       NUMER=NUMER-FOCKTMU(S,R)*FOCKTMU(P,Q)*G2(R,Q,P,S) &
                  *FPLUS2(P)*FMINUS2(Q)*FMINUS2(R)*FPLUS2(S) &
                  *(FMINUS2(P)-FPLUS2(Q)-FPLUS2(R)+FMINUS2(S)) &
                  /DENOM2*(-BETA)/2.0D0
       NUMER=NUMER-FOCKTDERIV(S,R)*FOCKTMU(P,Q)*G2(R,Q,P,S) &
                  *FPLUS2(P)*FMINUS2(Q)*FMINUS2(R)*FPLUS2(S) &
                  /DENOM2*(-BETA)/2.0D0
       NUMER=NUMER-FOCKTMU(S,R)*FOCKTDERIV(P,Q)*G2(R,Q,P,S) &
                  *FPLUS2(P)*FMINUS2(Q)*FMINUS2(R)*FPLUS2(S) &
                  /DENOM2*(-BETA)/2.0D0
       ENDIF
       IF ((DABS(DENOM1) > 1.0D-10).AND.(DABS(DENOM2) < 1.0D-10)) THEN
       NUMER=NUMER-FOCKTMU(S,R)*FOCKTMU(P,Q)*G2(R,Q,P,S) &
                  *FPLUS2(P)*FMINUS2(Q)*FMINUS2(R)*FPLUS2(S) &
                  *(FMINUS2(P)-FPLUS2(Q)-FPLUS2(R)+FMINUS2(S)) &
                  /DENOM1*(-BETA)/2.0D0
       NUMER=NUMER-FOCKTDERIV(S,R)*FOCKTMU(P,Q)*G2(R,Q,P,S) &
                  *FPLUS2(P)*FMINUS2(Q)*FMINUS2(R)*FPLUS2(S) &
                  /DENOM1*(-BETA)/2.0D0
       NUMER=NUMER-FOCKTMU(S,R)*FOCKTDERIV(P,Q)*G2(R,Q,P,S) &
                  *FPLUS2(P)*FMINUS2(Q)*FMINUS2(R)*FPLUS2(S) &
                  /DENOM1*(-BETA)/2.0D0
       ENDIF
       IF ((DABS(DENOM1) < 1.0D-10).AND.(DABS(DENOM2) < 1.0D-10)) THEN
       NUMER=NUMER-FOCKTMU(S,R)*FOCKTMU(P,Q)*G2(R,Q,P,S) &
                  *FPLUS2(P)*FMINUS2(Q)*FMINUS2(R)*FPLUS2(S) &
                  *(FMINUS2(P)-FPLUS2(Q)-FPLUS2(R)+FMINUS2(S)) &
                  *(-BETA)**2/6.0D0
       NUMER=NUMER-FOCKTDERIV(S,R)*FOCKTMU(P,Q)*G2(R,Q,P,S) &
                  *FPLUS2(P)*FMINUS2(Q)*FMINUS2(R)*FPLUS2(S) &
                  *(-BETA)**2/6.0D0
       NUMER=NUMER-FOCKTMU(S,R)*FOCKTDERIV(P,Q)*G2(R,Q,P,S) &
                  *FPLUS2(P)*FMINUS2(Q)*FMINUS2(R)*FPLUS2(S) &
                  *(-BETA)**2/6.0D0
       ENDIF
      ENDDO
     ENDDO
    ENDDO
   ENDDO
!denom=denom+numer
!write(*,'(2F20.10)') numer,denom
!numer=0.0d0
   ! diagram 13
   DO P=1,2*O
    DO Q=1,2*O
     DO R=1,2*O
      DENOM1=EPS2(P)-EPS2(Q)
      DENOM2=EPS2(P)-EPS2(R)
      IF ((DABS(DENOM1) > 1.0D-10).AND.(DABS(DENOM2) > 1.0D-10)) THEN
      NUMER=NUMER+FOCKT(P,Q)*FOCKT(Q,R)*FOCKT(R,P) &
                 *FMINUS2(P)*FPLUS2(Q)*FPLUS2(R) &
                 *(-FPLUS2(P)+FMINUS2(Q)+FMINUS2(R)) &
                 /DENOM1/DENOM2
      NUMER=NUMER+FOCKTDERIV(P,Q)*FOCKT(Q,R)*FOCKT(R,P) &
                 *FMINUS2(P)*FPLUS2(Q)*FPLUS2(R) &
                 /DENOM1/DENOM2
      NUMER=NUMER+FOCKT(P,Q)*FOCKTDERIV(Q,R)*FOCKT(R,P) &
                 *FMINUS2(P)*FPLUS2(Q)*FPLUS2(R) &
                 /DENOM1/DENOM2
      NUMER=NUMER+FOCKT(P,Q)*FOCKT(Q,R)*FOCKTDERIV(R,P) &
                 *FMINUS2(P)*FPLUS2(Q)*FPLUS2(R) &
                 /DENOM1/DENOM2
      ENDIF
      IF ((DABS(DENOM1) < 1.0D-10).AND.(DABS(DENOM2) > 1.0D-10)) THEN
      NUMER=NUMER-FOCKT(P,Q)*FOCKT(Q,R)*FOCKT(R,P) &
                 *FMINUS2(P)*FPLUS2(Q)*FPLUS2(R) &
                 *(-FPLUS2(P)+FMINUS2(Q)+FMINUS2(R)) &
                 /DENOM2/DENOM2
      NUMER=NUMER-FOCKTDERIV(P,Q)*FOCKT(Q,R)*FOCKT(R,P) &
                 *FMINUS2(P)*FPLUS2(Q)*FPLUS2(R) &
                 /DENOM2/DENOM2
      NUMER=NUMER-FOCKT(P,Q)*FOCKTDERIV(Q,R)*FOCKT(R,P) &
                 *FMINUS2(P)*FPLUS2(Q)*FPLUS2(R) &
                 /DENOM2/DENOM2
      NUMER=NUMER-FOCKT(P,Q)*FOCKT(Q,R)*FOCKTDERIV(R,P) &
                 *FMINUS2(P)*FPLUS2(Q)*FPLUS2(R) &
                 /DENOM2/DENOM2
      ENDIF
      IF ((DABS(DENOM1) < 1.0D-10).AND.(DABS(DENOM2) > 1.0D-10)) THEN
      NUMER=NUMER+FOCKTMU(P,Q)*FOCKTMU(Q,R)*FOCKTMU(R,P) &
                 *FMINUS2(P)*FPLUS2(Q)*FPLUS2(R) &
                 *(-FPLUS2(P)+FMINUS2(Q)+FMINUS2(R)) &
                 /DENOM2*(-BETA)/2.0D0
      NUMER=NUMER+FOCKTDERIV(P,Q)*FOCKTMU(Q,R)*FOCKTMU(R,P) &
                 *FMINUS2(P)*FPLUS2(Q)*FPLUS2(R) &
                 /DENOM2*(-BETA)/2.0D0
      NUMER=NUMER+FOCKTMU(P,Q)*FOCKTDERIV(Q,R)*FOCKTMU(R,P) &
                 *FMINUS2(P)*FPLUS2(Q)*FPLUS2(R) &
                 /DENOM2*(-BETA)/2.0D0
      NUMER=NUMER+FOCKTMU(P,Q)*FOCKTMU(Q,R)*FOCKTDERIV(R,P) &
                 *FMINUS2(P)*FPLUS2(Q)*FPLUS2(R) &
                 /DENOM2*(-BETA)/2.0D0
      ENDIF
      IF ((DABS(DENOM1) > 1.0D-10).AND.(DABS(DENOM2) < 1.0D-10)) THEN
      NUMER=NUMER+FOCKTMU(P,Q)*FOCKTMU(Q,R)*FOCKTMU(R,P) &
                 *FMINUS2(P)*FPLUS2(Q)*FPLUS2(R) &
                 *(-FPLUS2(P)+FMINUS2(Q)+FMINUS2(R)) &
                 /DENOM1*(-BETA)/2.0D0
      NUMER=NUMER+FOCKTDERIV(P,Q)*FOCKTMU(Q,R)*FOCKTMU(R,P) &
                 *FMINUS2(P)*FPLUS2(Q)*FPLUS2(R) &
                 /DENOM1*(-BETA)/2.0D0
      NUMER=NUMER+FOCKTMU(P,Q)*FOCKTDERIV(Q,R)*FOCKTMU(R,P) &
                 *FMINUS2(P)*FPLUS2(Q)*FPLUS2(R) &
                 /DENOM1*(-BETA)/2.0D0
      NUMER=NUMER+FOCKTMU(P,Q)*FOCKTMU(Q,R)*FOCKTDERIV(R,P) &
                 *FMINUS2(P)*FPLUS2(Q)*FPLUS2(R) &
                 /DENOM1*(-BETA)/2.0D0
      ENDIF
      IF ((DABS(DENOM1) < 1.0D-10).AND.(DABS(DENOM2) < 1.0D-10)) THEN
      NUMER=NUMER+FOCKTMU(P,Q)*FOCKTMU(Q,R)*FOCKTMU(R,P) &
                 *FMINUS2(P)*FPLUS2(Q)*FPLUS2(R) &
                 *(-FPLUS2(P)+FMINUS2(Q)+FMINUS2(R)) &
                 *(-BETA)**2/6.0D0
      NUMER=NUMER+FOCKTDERIV(P,Q)*FOCKTMU(Q,R)*FOCKTMU(R,P) &
                 *FMINUS2(P)*FPLUS2(Q)*FPLUS2(R) &
                 *(-BETA)**2/6.0D0
      NUMER=NUMER+FOCKTMU(P,Q)*FOCKTDERIV(Q,R)*FOCKTMU(R,P) &
                 *FMINUS2(P)*FPLUS2(Q)*FPLUS2(R) &
                 *(-BETA)**2/6.0D0
      NUMER=NUMER+FOCKTMU(P,Q)*FOCKTMU(Q,R)*FOCKTDERIV(R,P) &
                 *FMINUS2(P)*FPLUS2(Q)*FPLUS2(R) &
                 *(-BETA)**2/6.0D0
      ENDIF
     ENDDO
    ENDDO
   ENDDO
!denom=denom+numer
!write(*,'(2F20.10)') numer,denom
!numer=0.0d0
   ! diagram 14
   DO P=1,2*O
    DO Q=1,2*O
     DO R=1,2*O
      DENOM1=EPS2(Q)-EPS2(P)
      DENOM2=EPS2(R)-EPS2(P)
      IF ((DABS(DENOM1) > 1.0D-10).AND.(DABS(DENOM2) > 1.0D-10)) THEN
      NUMER=NUMER-FOCKT(Q,P)*FOCKT(R,Q)*FOCKT(P,R) &
                 *FPLUS2(P)*FMINUS2(Q)*FMINUS2(R) &
                 *(FMINUS2(P)-FPLUS2(Q)-FPLUS2(R)) &
                 /DENOM1/DENOM2
      NUMER=NUMER-FOCKTDERIV(Q,P)*FOCKT(R,Q)*FOCKT(P,R) &
                 *FPLUS2(P)*FMINUS2(Q)*FMINUS2(R) &
                 /DENOM1/DENOM2
      NUMER=NUMER-FOCKT(Q,P)*FOCKTDERIV(R,Q)*FOCKT(P,R) &
                 *FPLUS2(P)*FMINUS2(Q)*FMINUS2(R) &
                 /DENOM1/DENOM2
      NUMER=NUMER-FOCKT(Q,P)*FOCKT(R,Q)*FOCKTDERIV(P,R) &
                 *FPLUS2(P)*FMINUS2(Q)*FMINUS2(R) &
                 /DENOM1/DENOM2
      ENDIF
      IF ((DABS(DENOM1) < 1.0D-10).AND.(DABS(DENOM2) > 1.0D-10)) THEN
      NUMER=NUMER+FOCKT(Q,P)*FOCKT(R,Q)*FOCKT(P,R) &
                 *FPLUS2(P)*FMINUS2(Q)*FMINUS2(R) &
                 *(FMINUS2(P)-FPLUS2(Q)-FPLUS2(R)) &
                 /DENOM2/DENOM2
      NUMER=NUMER+FOCKTDERIV(Q,P)*FOCKT(R,Q)*FOCKT(P,R) &
                 *FPLUS2(P)*FMINUS2(Q)*FMINUS2(R) &
                 /DENOM2/DENOM2
      NUMER=NUMER+FOCKT(Q,P)*FOCKTDERIV(R,Q)*FOCKT(P,R) &
                 *FPLUS2(P)*FMINUS2(Q)*FMINUS2(R) &
                 /DENOM2/DENOM2
      NUMER=NUMER+FOCKT(Q,P)*FOCKT(R,Q)*FOCKTDERIV(P,R) &
                 *FPLUS2(P)*FMINUS2(Q)*FMINUS2(R) &
                 /DENOM2/DENOM2
      ENDIF
      IF ((DABS(DENOM1) < 1.0D-10).AND.(DABS(DENOM2) > 1.0D-10)) THEN
      NUMER=NUMER-FOCKTMU(Q,P)*FOCKTMU(R,Q)*FOCKTMU(P,R) &
                 *FPLUS2(P)*FMINUS2(Q)*FMINUS2(R) &
                 *(FMINUS2(P)-FPLUS2(Q)-FPLUS2(R)) &
                 /DENOM2*(-BETA)/2.0D0
      NUMER=NUMER-FOCKTDERIV(Q,P)*FOCKTMU(R,Q)*FOCKTMU(P,R) &
                 *FPLUS2(P)*FMINUS2(Q)*FMINUS2(R) &
                 /DENOM2*(-BETA)/2.0D0
      NUMER=NUMER-FOCKTMU(Q,P)*FOCKTDERIV(R,Q)*FOCKTMU(P,R) &
                 *FPLUS2(P)*FMINUS2(Q)*FMINUS2(R) &
                 /DENOM2*(-BETA)/2.0D0
      NUMER=NUMER-FOCKTMU(Q,P)*FOCKTMU(R,Q)*FOCKTDERIV(P,R) &
                 *FPLUS2(P)*FMINUS2(Q)*FMINUS2(R) &
                 /DENOM2*(-BETA)/2.0D0
      ENDIF
      IF ((DABS(DENOM1) > 1.0D-10).AND.(DABS(DENOM2) < 1.0D-10)) THEN
      NUMER=NUMER-FOCKTMU(Q,P)*FOCKTMU(R,Q)*FOCKTMU(P,R) &
                 *FPLUS2(P)*FMINUS2(Q)*FMINUS2(R) &
                 *(FMINUS2(P)-FPLUS2(Q)-FPLUS2(R)) &
                 /DENOM1*(-BETA)/2.0D0
      NUMER=NUMER-FOCKTDERIV(Q,P)*FOCKTMU(R,Q)*FOCKTMU(P,R) &
                 *FPLUS2(P)*FMINUS2(Q)*FMINUS2(R) &
                 /DENOM1*(-BETA)/2.0D0
      NUMER=NUMER-FOCKTMU(Q,P)*FOCKTDERIV(R,Q)*FOCKTMU(P,R) &
                 *FPLUS2(P)*FMINUS2(Q)*FMINUS2(R) &
                 /DENOM1*(-BETA)/2.0D0
      NUMER=NUMER-FOCKTMU(Q,P)*FOCKTMU(R,Q)*FOCKTDERIV(P,R) &
                 *FPLUS2(P)*FMINUS2(Q)*FMINUS2(R) &
                 /DENOM1*(-BETA)/2.0D0
      ENDIF
      IF ((DABS(DENOM1) < 1.0D-10).AND.(DABS(DENOM2) < 1.0D-10)) THEN
      NUMER=NUMER-FOCKTMU(Q,P)*FOCKTMU(R,Q)*FOCKTMU(P,R) &
                 *FPLUS2(P)*FMINUS2(Q)*FMINUS2(R) &
                 *(FMINUS2(P)-FPLUS2(Q)-FPLUS2(R)) &
                 *(-BETA)**2/6.0D0
      NUMER=NUMER-FOCKTDERIV(Q,P)*FOCKTMU(R,Q)*FOCKTMU(P,R) &
                 *FPLUS2(P)*FMINUS2(Q)*FMINUS2(R) &
                 *(-BETA)**2/6.0D0
      NUMER=NUMER-FOCKTMU(Q,P)*FOCKTDERIV(R,Q)*FOCKTMU(P,R) &
                 *FPLUS2(P)*FMINUS2(Q)*FMINUS2(R) &
                 *(-BETA)**2/6.0D0
      NUMER=NUMER-FOCKTMU(Q,P)*FOCKTMU(R,Q)*FOCKTDERIV(P,R) &
                 *FPLUS2(P)*FMINUS2(Q)*FMINUS2(R) &
                 *(-BETA)**2/6.0D0
      ENDIF
     ENDDO
    ENDDO
   ENDDO
!denom=denom+numer
!write(*,'(2F20.10)') numer,denom
!numer=0.0d0
   ! diagram 98,99,100,101,102
   DO P=1,2*O
    NUMER=NUMER+FOCKT(P,P)*(-MU2M(P,P))*FMINUS2(P)*FPLUS2(P)*(-BETA)/2.0D0*2.0D0 &
                                       *(-FPLUS2(P)+FMINUS2(P))
    NUMER=NUMER+FOCKTDERIV(P,P)*(-MU2M(P,P))*FMINUS2(P)*FPLUS2(P)*(-BETA)/2.0D0*2.0D0
   ENDDO
!denom=denom+numer
!write(*,'(2F20.10)') numer,denom
!numer=0.0d0
   DO P=1,2*O
    NUMER=NUMER+(-MU1M(P,P))*(-MU2M(P,P))*FMINUS2(P)*FPLUS2(P)*(-BETA)/2.0D0*2.0D0 &
                                         *(-FPLUS2(P)+FMINUS2(P))
   ENDDO
   DO P=1,2*O
    DENOM=DENOM-FMINUS2(P)*FPLUS2(P)
   ENDDO
   MU3=NUMER/DENOM

!MU3=-0.4217748952D0
   WRITE(6,'(/,A,F20.10,A)')        'MU(3)                         =',MU3,' HARTREE'

! =========================================================================

   ! --------
   ! OMEGA(3)
   ! --------

   MU3M=0.0D0
   DO P=1,2*O
    MU3M(P,P)=MU3
   ENDDO

   NUMER=0.0D0
   DENOM=0.0D0
   ! diagram 1
   DO P=1,2*O
    DO Q=1,2*O
     DO R=1,2*O
      DO S=1,2*O
       DO T=1,2*O
        DO U=1,2*O
         DENOM1=EPS2(P)+EPS2(S)-EPS2(Q)-EPS2(R)
         DENOM2=EPS2(P)+EPS2(S)-EPS2(T)-EPS2(U)
         IF ((DABS(DENOM1) > 1.0D-10).AND.(DABS(DENOM2) > 1.0D-10)) &
         NUMER=NUMER+0.125D0*G2(P,S,Q,R)*G2(Q,R,T,U)*G2(T,U,P,S) &
                    *FMINUS2(P)*FPLUS2(Q)*FPLUS2(R)*FMINUS2(S)*FPLUS2(T)*FPLUS2(U) &
                    /DENOM1/DENOM2
         IF ((DABS(DENOM1) > 1.0D-10).AND.(DABS(DENOM2) < 1.0D-10)) &
         NUMER=NUMER-0.125D0*G2(P,S,Q,R)*G2(Q,R,T,U)*G2(T,U,P,S) &
                    *FMINUS2(P)*FPLUS2(Q)*FPLUS2(R)*FMINUS2(S)*FPLUS2(T)*FPLUS2(U) &
                    /DENOM1/DENOM1
         IF ((DABS(DENOM1) < 1.0D-10).AND.(DABS(DENOM2) > 1.0D-10)) &
         NUMER=NUMER+0.125D0*G2(P,S,Q,R)*G2(Q,R,T,U)*G2(T,U,P,S) &
                    *FMINUS2(P)*FPLUS2(Q)*FPLUS2(R)*FMINUS2(S)*FPLUS2(T)*FPLUS2(U) &
                    /DENOM2*(-BETA)/2.0D0
         IF ((DABS(DENOM1) > 1.0D-10).AND.(DABS(DENOM2) < 1.0D-10)) &
         NUMER=NUMER+0.125D0*G2(P,S,Q,R)*G2(Q,R,T,U)*G2(T,U,P,S) &
                    *FMINUS2(P)*FPLUS2(Q)*FPLUS2(R)*FMINUS2(S)*FPLUS2(T)*FPLUS2(U) &
                    /DENOM1*(-BETA)/2.0D0
         IF ((DABS(DENOM1) < 1.0D-10).AND.(DABS(DENOM2) < 1.0D-10)) &
         NUMER=NUMER+0.125D0*G2(P,S,Q,R)*G2(Q,R,T,U)*G2(T,U,P,S) &
                    *FMINUS2(P)*FPLUS2(Q)*FPLUS2(R)*FMINUS2(S)*FPLUS2(T)*FPLUS2(U) &
                    *(-BETA)**2/6.0D0
        ENDDO
       ENDDO
      ENDDO
     ENDDO
    ENDDO
   ENDDO
!denom=denom+numer
!write(*,'(2F20.10)') numer,denom
!numer=0.0d0
   ! diagram 2
   DO P=1,2*O
    DO Q=1,2*O
     DO R=1,2*O
      DO S=1,2*O
       DO T=1,2*O
        DO U=1,2*O
         DENOM1=EPS2(Q)+EPS2(R)-EPS2(P)-EPS2(S)
         DENOM2=EPS2(T)+EPS2(U)-EPS2(P)-EPS2(S)
         IF ((DABS(DENOM1) > 1.0D-10).AND.(DABS(DENOM2) > 1.0D-10)) &
         NUMER=NUMER+0.125D0*G2(Q,R,P,S)*G2(T,U,Q,R)*G2(P,S,T,U) &
                    *FPLUS2(P)*FMINUS2(Q)*FMINUS2(R)*FPLUS2(S)*FMINUS2(T)*FMINUS2(U) &
                    /DENOM1/DENOM2
         IF ((DABS(DENOM1) > 1.0D-10).AND.(DABS(DENOM2) < 1.0D-10)) &
         NUMER=NUMER-0.125D0*G2(Q,R,P,S)*G2(T,U,Q,R)*G2(P,S,T,U) &
                    *FPLUS2(P)*FMINUS2(Q)*FMINUS2(R)*FPLUS2(S)*FMINUS2(T)*FMINUS2(U) &
                    /DENOM1/DENOM1
         IF ((DABS(DENOM1) < 1.0D-10).AND.(DABS(DENOM2) > 1.0D-10)) &
         NUMER=NUMER+0.125D0*G2(Q,R,P,S)*G2(T,U,Q,R)*G2(P,S,T,U) &
                    *FPLUS2(P)*FMINUS2(Q)*FMINUS2(R)*FPLUS2(S)*FMINUS2(T)*FMINUS2(U) &
                    /DENOM2*(-BETA)/2.0D0
         IF ((DABS(DENOM1) > 1.0D-10).AND.(DABS(DENOM2) < 1.0D-10)) &
         NUMER=NUMER+0.125D0*G2(Q,R,P,S)*G2(T,U,Q,R)*G2(P,S,T,U) &
                    *FPLUS2(P)*FMINUS2(Q)*FMINUS2(R)*FPLUS2(S)*FMINUS2(T)*FMINUS2(U) &
                    /DENOM1*(-BETA)/2.0D0
         IF ((DABS(DENOM1) < 1.0D-10).AND.(DABS(DENOM2) < 1.0D-10)) &
         NUMER=NUMER+0.125D0*G2(Q,R,P,S)*G2(T,U,Q,R)*G2(P,S,T,U) &
                    *FPLUS2(P)*FMINUS2(Q)*FMINUS2(R)*FPLUS2(S)*FMINUS2(T)*FMINUS2(U) &
                    *(-BETA)**2/6.0D0
        ENDDO
       ENDDO
      ENDDO
     ENDDO
    ENDDO
   ENDDO
!denom=denom+numer
!write(*,'(2F20.10)') numer,denom
!numer=0.0d0
   ! diagram 3
   DO P=1,2*O
    DO Q=1,2*O
     DO R=1,2*O
      DO S=1,2*O
       DO T=1,2*O
        DO U=1,2*O
         DENOM1=EPS2(Q)+EPS2(S)-EPS2(P)-EPS2(R)
         DENOM2=EPS2(T)+EPS2(S)-EPS2(P)-EPS2(U)
         IF ((DABS(DENOM1) > 1.0D-10).AND.(DABS(DENOM2) > 1.0D-10)) &
         NUMER=NUMER-G2(Q,S,P,R)*G2(T,R,Q,U)*G2(P,U,T,S) &
                    *FPLUS2(P)*FMINUS2(Q)*FPLUS2(R)*FMINUS2(S)*FMINUS2(T)*FPLUS2(U) &
                    /DENOM1/DENOM2
         IF ((DABS(DENOM1) > 1.0D-10).AND.(DABS(DENOM2) < 1.0D-10)) &
         NUMER=NUMER+G2(Q,S,P,R)*G2(T,R,Q,U)*G2(P,U,T,S) &
                    *FPLUS2(P)*FMINUS2(Q)*FPLUS2(R)*FMINUS2(S)*FMINUS2(T)*FPLUS2(U) &
                    /DENOM1/DENOM1
         IF ((DABS(DENOM1) < 1.0D-10).AND.(DABS(DENOM2) > 1.0D-10)) &
         NUMER=NUMER-G2(Q,S,P,R)*G2(T,R,Q,U)*G2(P,U,T,S) &
                    *FPLUS2(P)*FMINUS2(Q)*FPLUS2(R)*FMINUS2(S)*FMINUS2(T)*FPLUS2(U) &
                    /DENOM2*(-BETA)/2.0D0
         IF ((DABS(DENOM1) > 1.0D-10).AND.(DABS(DENOM2) < 1.0D-10)) &
         NUMER=NUMER-G2(Q,S,P,R)*G2(T,R,Q,U)*G2(P,U,T,S) &
                    *FPLUS2(P)*FMINUS2(Q)*FPLUS2(R)*FMINUS2(S)*FMINUS2(T)*FPLUS2(U) &
                    /DENOM1*(-BETA)/2.0D0
         IF ((DABS(DENOM1) < 1.0D-10).AND.(DABS(DENOM2) < 1.0D-10)) &
         NUMER=NUMER-G2(Q,S,P,R)*G2(T,R,Q,U)*G2(P,U,T,S) &
                    *FPLUS2(P)*FMINUS2(Q)*FPLUS2(R)*FMINUS2(S)*FMINUS2(T)*FPLUS2(U) &
                    *(-BETA)**2/6.0D0
        ENDDO
       ENDDO
      ENDDO
     ENDDO
    ENDDO
   ENDDO
!denom=denom+numer
!write(*,'(2F20.10)') numer,denom
!numer=0.0d0
!goto 888
   ! diagram 4
   DO P=1,2*O
    DO Q=1,2*O
     DO R=1,2*O
      DO S=1,2*O
       DO T=1,2*O
        DENOM1=EPS2(P)-EPS2(Q)
        DENOM2=EPS2(P)+EPS2(S)-EPS2(R)-EPS2(T)
        IF ((DABS(DENOM1) > 1.0D-10).AND.(DABS(DENOM2) > 1.0D-10)) &
        NUMER=NUMER+0.5D0*FOCKT(P,Q)*G2(Q,S,R,T)*G2(R,T,P,S) &
                   *FMINUS2(P)*FPLUS2(Q)*FPLUS2(R)*FMINUS2(S)*FPLUS2(T) &
                   /DENOM1/DENOM2
        IF ((DABS(DENOM1) > 1.0D-10).AND.(DABS(DENOM2) < 1.0D-10)) &
        NUMER=NUMER-0.5D0*FOCKT(P,Q)*G2(Q,S,R,T)*G2(R,T,P,S) &
                   *FMINUS2(P)*FPLUS2(Q)*FPLUS2(R)*FMINUS2(S)*FPLUS2(T) &
                   /DENOM1/DENOM1
        IF ((DABS(DENOM1) < 1.0D-10).AND.(DABS(DENOM2) > 1.0D-10)) &
        NUMER=NUMER+0.5D0*FOCKTMU(P,Q)*G2(Q,S,R,T)*G2(R,T,P,S) &
                   *FMINUS2(P)*FPLUS2(Q)*FPLUS2(R)*FMINUS2(S)*FPLUS2(T) &
                   /DENOM2*(-BETA)/2.0D0
        IF ((DABS(DENOM1) > 1.0D-10).AND.(DABS(DENOM2) < 1.0D-10)) &
        NUMER=NUMER+0.5D0*FOCKTMU(P,Q)*G2(Q,S,R,T)*G2(R,T,P,S) &
                   *FMINUS2(P)*FPLUS2(Q)*FPLUS2(R)*FMINUS2(S)*FPLUS2(T) &
                   /DENOM1*(-BETA)/2.0D0
        IF ((DABS(DENOM1) < 1.0D-10).AND.(DABS(DENOM2) < 1.0D-10)) &
        NUMER=NUMER+0.5D0*FOCKTMU(P,Q)*G2(Q,S,R,T)*G2(R,T,P,S) &
                   *FMINUS2(P)*FPLUS2(Q)*FPLUS2(R)*FMINUS2(S)*FPLUS2(T) &
                   *(-BETA)**2/6.0D0
       ENDDO
      ENDDO
     ENDDO
    ENDDO
   ENDDO
!denom=denom+numer
!write(*,'(2F20.10)') numer,denom
!numer=0.0d0
   ! diagram 5
   DO P=1,2*O
    DO Q=1,2*O
     DO R=1,2*O
      DO S=1,2*O
       DO T=1,2*O
        DENOM1=EPS2(Q)-EPS2(P)
        DENOM2=EPS2(R)+EPS2(T)-EPS2(P)-EPS2(S)
        IF ((DABS(DENOM1) > 1.0D-10).AND.(DABS(DENOM2) > 1.0D-10)) &
        NUMER=NUMER-0.5D0*FOCKT(Q,P)*G2(R,T,Q,S)*G2(P,S,R,T) &
                   *FPLUS2(P)*FMINUS2(Q)*FMINUS2(R)*FPLUS2(S)*FMINUS2(T) &
                   /DENOM1/DENOM2
        IF ((DABS(DENOM1) > 1.0D-10).AND.(DABS(DENOM2) < 1.0D-10)) &
        NUMER=NUMER+0.5D0*FOCKT(Q,P)*G2(R,T,Q,S)*G2(P,S,R,T) &
                   *FPLUS2(P)*FMINUS2(Q)*FMINUS2(R)*FPLUS2(S)*FMINUS2(T) &
                   /DENOM1/DENOM1
        IF ((DABS(DENOM1) < 1.0D-10).AND.(DABS(DENOM2) > 1.0D-10)) &
        NUMER=NUMER-0.5D0*FOCKTMU(Q,P)*G2(R,T,Q,S)*G2(P,S,R,T) &
                   *FPLUS2(P)*FMINUS2(Q)*FMINUS2(R)*FPLUS2(S)*FMINUS2(T) &
                   /DENOM2*(-BETA)/2.0D0
        IF ((DABS(DENOM1) > 1.0D-10).AND.(DABS(DENOM2) < 1.0D-10)) &
        NUMER=NUMER-0.5D0*FOCKTMU(Q,P)*G2(R,T,Q,S)*G2(P,S,R,T) &
                   *FPLUS2(P)*FMINUS2(Q)*FMINUS2(R)*FPLUS2(S)*FMINUS2(T) &
                   /DENOM1*(-BETA)/2.0D0
        IF ((DABS(DENOM1) < 1.0D-10).AND.(DABS(DENOM2) < 1.0D-10)) &
        NUMER=NUMER-0.5D0*FOCKTMU(Q,P)*G2(R,T,Q,S)*G2(P,S,R,T) &
                   *FPLUS2(P)*FMINUS2(Q)*FMINUS2(R)*FPLUS2(S)*FMINUS2(T) &
                   *(-BETA)**2/6.0D0
       ENDDO
      ENDDO
     ENDDO
    ENDDO
   ENDDO
!denom=denom+numer
!write(*,'(2F20.10)') numer,denom
!numer=0.0d0
   ! diagram 6
   DO P=1,2*O
    DO Q=1,2*O
     DO R=1,2*O
      DO S=1,2*O
       DO T=1,2*O
        DENOM1=EPS2(P)+EPS2(R)-EPS2(Q)-EPS2(S)
        DENOM2=EPS2(P)+EPS2(R)-EPS2(Q)-EPS2(T)
        IF ((DABS(DENOM1) > 1.0D-10).AND.(DABS(DENOM2) > 1.0D-10)) &
        NUMER=NUMER+0.5D0*FOCKT(S,T)*G2(P,R,Q,S)*G2(Q,T,P,R) &
                   *FMINUS2(P)*FPLUS2(Q)*FMINUS2(R)*FPLUS2(S)*FPLUS2(T) &
                   /DENOM1/DENOM2
        IF ((DABS(DENOM1) > 1.0D-10).AND.(DABS(DENOM2) < 1.0D-10)) &
        NUMER=NUMER-0.5D0*FOCKT(S,T)*G2(P,R,Q,S)*G2(Q,T,P,R) &
                   *FMINUS2(P)*FPLUS2(Q)*FMINUS2(R)*FPLUS2(S)*FPLUS2(T) &
                   /DENOM1/DENOM1
        IF ((DABS(DENOM1) < 1.0D-10).AND.(DABS(DENOM2) > 1.0D-10)) &
        NUMER=NUMER+0.5D0*FOCKTMU(S,T)*G2(P,R,Q,S)*G2(Q,T,P,R) &
                   *FMINUS2(P)*FPLUS2(Q)*FMINUS2(R)*FPLUS2(S)*FPLUS2(T) &
                   /DENOM2*(-BETA)/2.0D0
        IF ((DABS(DENOM1) > 1.0D-10).AND.(DABS(DENOM2) < 1.0D-10)) &
        NUMER=NUMER+0.5D0*FOCKTMU(S,T)*G2(P,R,Q,S)*G2(Q,T,P,R) &
                   *FMINUS2(P)*FPLUS2(Q)*FMINUS2(R)*FPLUS2(S)*FPLUS2(T) &
                   /DENOM1*(-BETA)/2.0D0
        IF ((DABS(DENOM1) < 1.0D-10).AND.(DABS(DENOM2) < 1.0D-10)) &
        NUMER=NUMER+0.5D0*FOCKTMU(S,T)*G2(P,R,Q,S)*G2(Q,T,P,R) &
                   *FMINUS2(P)*FPLUS2(Q)*FMINUS2(R)*FPLUS2(S)*FPLUS2(T) &
                   *(-BETA)**2/6.0D0
       ENDDO
      ENDDO
     ENDDO
    ENDDO
   ENDDO
!denom=denom+numer
!write(*,'(2F20.10)') numer,denom
!numer=0.0d0
   ! diagram 7
   DO P=1,2*O
    DO Q=1,2*O
     DO R=1,2*O
      DO S=1,2*O
       DO T=1,2*O
        DENOM1=EPS2(Q)+EPS2(S)-EPS2(P)-EPS2(R)
        DENOM2=EPS2(Q)+EPS2(T)-EPS2(P)-EPS2(R)
        IF ((DABS(DENOM1) > 1.0D-10).AND.(DABS(DENOM2) > 1.0D-10)) &
        NUMER=NUMER-0.5D0*FOCKT(T,S)*G2(Q,S,P,R)*G2(P,R,Q,T) &
                   *FPLUS2(P)*FMINUS2(Q)*FPLUS2(R)*FMINUS2(S)*FMINUS2(T) &
                   /DENOM1/DENOM2
        IF ((DABS(DENOM1) > 1.0D-10).AND.(DABS(DENOM2) < 1.0D-10)) &
        NUMER=NUMER+0.5D0*FOCKT(T,S)*G2(Q,S,P,R)*G2(P,R,Q,T) &
                   *FPLUS2(P)*FMINUS2(Q)*FPLUS2(R)*FMINUS2(S)*FMINUS2(T) &
                   /DENOM1/DENOM1
        IF ((DABS(DENOM1) < 1.0D-10).AND.(DABS(DENOM2) > 1.0D-10)) &
        NUMER=NUMER-0.5D0*FOCKTMU(T,S)*G2(Q,S,P,R)*G2(P,R,Q,T) &
                   *FPLUS2(P)*FMINUS2(Q)*FPLUS2(R)*FMINUS2(S)*FMINUS2(T) &
                   /DENOM2*(-BETA)/2.0D0
        IF ((DABS(DENOM1) > 1.0D-10).AND.(DABS(DENOM2) < 1.0D-10)) &
        NUMER=NUMER-0.5D0*FOCKTMU(T,S)*G2(Q,S,P,R)*G2(P,R,Q,T) &
                   *FPLUS2(P)*FMINUS2(Q)*FPLUS2(R)*FMINUS2(S)*FMINUS2(T) &
                   /DENOM1*(-BETA)/2.0D0
        IF ((DABS(DENOM1) < 1.0D-10).AND.(DABS(DENOM2) < 1.0D-10)) &
        NUMER=NUMER-0.5D0*FOCKTMU(T,S)*G2(Q,S,P,R)*G2(P,R,Q,T) &
                   *FPLUS2(P)*FMINUS2(Q)*FPLUS2(R)*FMINUS2(S)*FMINUS2(T) &
                   *(-BETA)**2/6.0D0
       ENDDO
      ENDDO
     ENDDO
    ENDDO
   ENDDO
!denom=denom+numer
!write(*,'(2F20.10)') numer,denom
!numer=0.0d0
   ! diagram 8
   DO P=1,2*O
    DO Q=1,2*O
     DO R=1,2*O
      DO S=1,2*O
       DO T=1,2*O
        DENOM1=EPS2(P)+EPS2(R)-EPS2(Q)-EPS2(S)
        DENOM2=EPS2(P)-EPS2(T)
        IF ((DABS(DENOM1) > 1.0D-10).AND.(DABS(DENOM2) > 1.0D-10)) &
        NUMER=NUMER+0.5D0*FOCKT(T,P)*G2(P,R,Q,S)*G2(Q,S,T,R) &
                   *FMINUS2(P)*FPLUS2(Q)*FMINUS2(R)*FPLUS2(S)*FPLUS2(T) &
                   /DENOM1/DENOM2
        IF ((DABS(DENOM1) > 1.0D-10).AND.(DABS(DENOM2) < 1.0D-10)) &
        NUMER=NUMER-0.5D0*FOCKT(T,P)*G2(P,R,Q,S)*G2(Q,S,T,R) &
                   *FMINUS2(P)*FPLUS2(Q)*FMINUS2(R)*FPLUS2(S)*FPLUS2(T) &
                   /DENOM1/DENOM1
        IF ((DABS(DENOM1) < 1.0D-10).AND.(DABS(DENOM2) > 1.0D-10)) &
        NUMER=NUMER+0.5D0*FOCKTMU(T,P)*G2(P,R,Q,S)*G2(Q,S,T,R) &
                   *FMINUS2(P)*FPLUS2(Q)*FMINUS2(R)*FPLUS2(S)*FPLUS2(T) &
                   /DENOM2*(-BETA)/2.0D0
        IF ((DABS(DENOM1) > 1.0D-10).AND.(DABS(DENOM2) < 1.0D-10)) &
        NUMER=NUMER+0.5D0*FOCKTMU(T,P)*G2(P,R,Q,S)*G2(Q,S,T,R) &
                   *FMINUS2(P)*FPLUS2(Q)*FMINUS2(R)*FPLUS2(S)*FPLUS2(T) &
                   /DENOM1*(-BETA)/2.0D0
        IF ((DABS(DENOM1) < 1.0D-10).AND.(DABS(DENOM2) < 1.0D-10)) &
        NUMER=NUMER+0.5D0*FOCKTMU(T,P)*G2(P,R,Q,S)*G2(Q,S,T,R) &
                   *FMINUS2(P)*FPLUS2(Q)*FMINUS2(R)*FPLUS2(S)*FPLUS2(T) &
                   *(-BETA)**2/6.0D0
       ENDDO
      ENDDO
     ENDDO
    ENDDO
   ENDDO
!denom=denom+numer
!write(*,'(2F20.10)') numer,denom
!numer=0.0d0
   ! diagram 9
   DO P=1,2*O
    DO Q=1,2*O
     DO R=1,2*O
      DO S=1,2*O
       DO T=1,2*O
        DENOM1=EPS2(Q)+EPS2(S)-EPS2(P)-EPS2(R)
        DENOM2=EPS2(T)-EPS2(P)
        IF ((DABS(DENOM1) > 1.0D-10).AND.(DABS(DENOM2) > 1.0D-10)) &
        NUMER=NUMER-0.5D0*FOCKT(P,T)*G2(Q,S,P,R)*G2(T,R,Q,S) &
                   *FPLUS2(P)*FMINUS2(Q)*FPLUS2(R)*FMINUS2(S)*FMINUS2(T) &
                   /DENOM1/DENOM2
        IF ((DABS(DENOM1) > 1.0D-10).AND.(DABS(DENOM2) < 1.0D-10)) &
        NUMER=NUMER+0.5D0*FOCKT(P,T)*G2(Q,S,P,R)*G2(T,R,Q,S) &
                   *FPLUS2(P)*FMINUS2(Q)*FPLUS2(R)*FMINUS2(S)*FMINUS2(T) &
                   /DENOM1/DENOM1
        IF ((DABS(DENOM1) < 1.0D-10).AND.(DABS(DENOM2) > 1.0D-10)) &
        NUMER=NUMER-0.5D0*FOCKTMU(P,T)*G2(Q,S,P,R)*G2(T,R,Q,S) &
                   *FPLUS2(P)*FMINUS2(Q)*FPLUS2(R)*FMINUS2(S)*FMINUS2(T) &
                   /DENOM2*(-BETA)/2.0D0
        IF ((DABS(DENOM1) > 1.0D-10).AND.(DABS(DENOM2) < 1.0D-10)) &
        NUMER=NUMER-0.5D0*FOCKTMU(P,T)*G2(Q,S,P,R)*G2(T,R,Q,S) &
                   *FPLUS2(P)*FMINUS2(Q)*FPLUS2(R)*FMINUS2(S)*FMINUS2(T) &
                   /DENOM1*(-BETA)/2.0D0
        IF ((DABS(DENOM1) < 1.0D-10).AND.(DABS(DENOM2) < 1.0D-10)) &
        NUMER=NUMER-0.5D0*FOCKTMU(P,T)*G2(Q,S,P,R)*G2(T,R,Q,S) &
                   *FPLUS2(P)*FMINUS2(Q)*FPLUS2(R)*FMINUS2(S)*FMINUS2(T) &
                   *(-BETA)**2/6.0D0
       ENDDO
      ENDDO
     ENDDO
    ENDDO
   ENDDO
!denom=denom+numer
!write(*,'(2F20.10)') numer,denom
!numer=0.0d0
   ! diagram 10
   DO P=1,2*O
    DO Q=1,2*O
     DO R=1,2*O
      DO S=1,2*O
       DENOM1=EPS2(Q)-EPS2(P)
       DENOM2=EPS2(Q)+EPS2(R)-EPS2(P)-EPS2(S)
       IF ((DABS(DENOM1) > 1.0D-10).AND.(DABS(DENOM2) > 1.0D-10)) &
       NUMER=NUMER-FOCKT(Q,P)*FOCKT(R,S)*G2(P,S,R,Q) &
                  *FPLUS2(P)*FMINUS2(Q)*FMINUS2(R)*FPLUS2(S) &
                  /DENOM1/DENOM2
       IF ((DABS(DENOM1) > 1.0D-10).AND.(DABS(DENOM2) < 1.0D-10)) &
       NUMER=NUMER+FOCKT(Q,P)*FOCKT(R,S)*G2(P,S,R,Q) &
                  *FPLUS2(P)*FMINUS2(Q)*FMINUS2(R)*FPLUS2(S) &
                  /DENOM1/DENOM1
       IF ((DABS(DENOM1) < 1.0D-10).AND.(DABS(DENOM2) > 1.0D-10)) &
       NUMER=NUMER-FOCKTMU(Q,P)*FOCKTMU(R,S)*G2(P,S,R,Q) &
                  *FPLUS2(P)*FMINUS2(Q)*FMINUS2(R)*FPLUS2(S) &
                  /DENOM2*(-BETA)/2.0D0
       IF ((DABS(DENOM1) > 1.0D-10).AND.(DABS(DENOM2) < 1.0D-10)) &
       NUMER=NUMER-FOCKTMU(Q,P)*FOCKTMU(R,S)*G2(P,S,R,Q) &
                  *FPLUS2(P)*FMINUS2(Q)*FMINUS2(R)*FPLUS2(S) &
                  /DENOM1*(-BETA)/2.0D0
       IF ((DABS(DENOM1) < 1.0D-10).AND.(DABS(DENOM2) < 1.0D-10)) &
       NUMER=NUMER-FOCKTMU(Q,P)*FOCKTMU(R,S)*G2(P,S,R,Q) &
                  *FPLUS2(P)*FMINUS2(Q)*FMINUS2(R)*FPLUS2(S) &
                  *(-BETA)**2/6.0D0
      ENDDO
     ENDDO
    ENDDO
   ENDDO
!denom=denom+numer
!write(*,'(2F20.10)') numer,denom
!numer=0.0d0
   ! diagram 11
   DO P=1,2*O
    DO Q=1,2*O
     DO R=1,2*O
      DO S=1,2*O
       DENOM1=EPS2(P)-EPS2(Q)
       DENOM2=EPS2(R)-EPS2(S)
       IF ((DABS(DENOM1) > 1.0D-10).AND.(DABS(DENOM2) > 1.0D-10)) &
       NUMER=NUMER-FOCKT(P,Q)*G2(R,Q,P,S)*FOCKT(S,R) &
                  *FMINUS2(P)*FPLUS2(Q)*FMINUS2(R)*FPLUS2(S) &
                  /DENOM1/DENOM2
       IF ((DABS(DENOM1) > 1.0D-10).AND.(DABS(DENOM2) < 1.0D-10)) &
       NUMER=NUMER+FOCKT(P,Q)*G2(R,Q,P,S)*FOCKT(S,R) &
                  *FMINUS2(P)*FPLUS2(Q)*FMINUS2(R)*FPLUS2(S) &
                  /DENOM1/DENOM1
       IF ((DABS(DENOM1) < 1.0D-10).AND.(DABS(DENOM2) > 1.0D-10)) &
       NUMER=NUMER-FOCKTMU(P,Q)*G2(R,Q,P,S)*FOCKTMU(S,R) &
                  *FMINUS2(P)*FPLUS2(Q)*FMINUS2(R)*FPLUS2(S) &
                  /DENOM2*(-BETA)/2.0D0
       IF ((DABS(DENOM1) > 1.0D-10).AND.(DABS(DENOM2) < 1.0D-10)) &
       NUMER=NUMER-FOCKTMU(P,Q)*G2(R,Q,P,S)*FOCKTMU(S,R) &
                  *FMINUS2(P)*FPLUS2(Q)*FMINUS2(R)*FPLUS2(S) &
                  /DENOM1*(-BETA)/2.0D0
       IF ((DABS(DENOM1) < 1.0D-10).AND.(DABS(DENOM2) < 1.0D-10)) &
       NUMER=NUMER-FOCKTMU(P,Q)*G2(R,Q,P,S)*FOCKTMU(S,R) &
                  *FMINUS2(P)*FPLUS2(Q)*FMINUS2(R)*FPLUS2(S) &
                  *(-BETA)**2/6.0D0
      ENDDO
     ENDDO
    ENDDO
   ENDDO
!denom=denom+numer
!write(*,'(2F20.10)') numer,denom
!numer=0.0d0
   ! diagram 12
   DO P=1,2*O
    DO Q=1,2*O
     DO R=1,2*O
      DO S=1,2*O
       DENOM1=EPS2(Q)+EPS2(R)-EPS2(P)-EPS2(S)
       DENOM2=EPS2(Q)-EPS2(P)
       IF ((DABS(DENOM1) > 1.0D-10).AND.(DABS(DENOM2) > 1.0D-10)) &
       NUMER=NUMER-FOCKT(S,R)*FOCKT(P,Q)*G2(R,Q,P,S) &
                  *FPLUS2(P)*FMINUS2(Q)*FMINUS2(R)*FPLUS2(S) &
                  /DENOM1/DENOM2
       IF ((DABS(DENOM1) > 1.0D-10).AND.(DABS(DENOM2) < 1.0D-10)) &
       NUMER=NUMER+FOCKT(S,R)*FOCKT(P,Q)*G2(R,Q,P,S) &
                  *FPLUS2(P)*FMINUS2(Q)*FMINUS2(R)*FPLUS2(S) &
                  /DENOM1/DENOM1
       IF ((DABS(DENOM1) < 1.0D-10).AND.(DABS(DENOM2) > 1.0D-10)) &
       NUMER=NUMER-FOCKTMU(S,R)*FOCKTMU(P,Q)*G2(R,Q,P,S) &
                  *FPLUS2(P)*FMINUS2(Q)*FMINUS2(R)*FPLUS2(S) &
                  /DENOM2*(-BETA)/2.0D0
       IF ((DABS(DENOM1) > 1.0D-10).AND.(DABS(DENOM2) < 1.0D-10)) &
       NUMER=NUMER-FOCKTMU(S,R)*FOCKTMU(P,Q)*G2(R,Q,P,S) &
                  *FPLUS2(P)*FMINUS2(Q)*FMINUS2(R)*FPLUS2(S) &
                  /DENOM1*(-BETA)/2.0D0
       IF ((DABS(DENOM1) < 1.0D-10).AND.(DABS(DENOM2) < 1.0D-10)) &
       NUMER=NUMER-FOCKTMU(S,R)*FOCKTMU(P,Q)*G2(R,Q,P,S) &
                  *FPLUS2(P)*FMINUS2(Q)*FMINUS2(R)*FPLUS2(S) &
                  *(-BETA)**2/6.0D0
      ENDDO
     ENDDO
    ENDDO
   ENDDO
!denom=denom+numer
!write(*,'(2F20.10)') numer,denom
!numer=0.0d0
   ! diagram 13
   DO P=1,2*O
    DO Q=1,2*O
     DO R=1,2*O
      DENOM1=EPS2(P)-EPS2(Q)
      DENOM2=EPS2(P)-EPS2(R)
      IF ((DABS(DENOM1) > 1.0D-10).AND.(DABS(DENOM2) > 1.0D-10)) &
      NUMER=NUMER+FOCKT(P,Q)*FOCKT(Q,R)*FOCKT(R,P) &
                 *FMINUS2(P)*FPLUS2(Q)*FPLUS2(R) &
                 /DENOM1/DENOM2
      IF ((DABS(DENOM1) > 1.0D-10).AND.(DABS(DENOM2) < 1.0D-10)) &
      NUMER=NUMER-FOCKT(P,Q)*FOCKT(Q,R)*FOCKT(R,P) &
                 *FMINUS2(P)*FPLUS2(Q)*FPLUS2(R) &
                 /DENOM1/DENOM1
      IF ((DABS(DENOM1) < 1.0D-10).AND.(DABS(DENOM2) > 1.0D-10)) &
      NUMER=NUMER+FOCKTMU(P,Q)*FOCKTMU(Q,R)*FOCKTMU(R,P) &
                 *FMINUS2(P)*FPLUS2(Q)*FPLUS2(R) &
                 /DENOM2*(-BETA)/2.0D0
      IF ((DABS(DENOM1) > 1.0D-10).AND.(DABS(DENOM2) < 1.0D-10)) &
      NUMER=NUMER+FOCKTMU(P,Q)*FOCKTMU(Q,R)*FOCKTMU(R,P) &
                 *FMINUS2(P)*FPLUS2(Q)*FPLUS2(R) &
                 /DENOM1*(-BETA)/2.0D0
      IF ((DABS(DENOM1) < 1.0D-10).AND.(DABS(DENOM2) < 1.0D-10)) &
      NUMER=NUMER+FOCKTMU(P,Q)*FOCKTMU(Q,R)*FOCKTMU(R,P) &
                 *FMINUS2(P)*FPLUS2(Q)*FPLUS2(R) &
                 *(-BETA)**2/6.0D0
     ENDDO
    ENDDO
   ENDDO
!denom=denom+numer
!write(*,'(2F20.10)') numer,denom
!numer=0.0d0
   ! diagram 14
   DO P=1,2*O
    DO Q=1,2*O
     DO R=1,2*O
      DENOM1=EPS2(Q)-EPS2(P)
      DENOM2=EPS2(R)-EPS2(P)
      IF ((DABS(DENOM1) > 1.0D-10).AND.(DABS(DENOM2) > 1.0D-10)) &
      NUMER=NUMER-FOCKT(Q,P)*FOCKT(R,Q)*FOCKT(P,R) &
                 *FPLUS2(P)*FMINUS2(Q)*FMINUS2(R) &
                 /DENOM1/DENOM2
      IF ((DABS(DENOM1) > 1.0D-10).AND.(DABS(DENOM2) < 1.0D-10)) &
      NUMER=NUMER+FOCKT(Q,P)*FOCKT(R,Q)*FOCKT(P,R) &
                 *FPLUS2(P)*FMINUS2(Q)*FMINUS2(R) &
                 /DENOM1/DENOM1
      IF ((DABS(DENOM1) < 1.0D-10).AND.(DABS(DENOM2) > 1.0D-10)) &
      NUMER=NUMER-FOCKTMU(Q,P)*FOCKTMU(R,Q)*FOCKTMU(P,R) &
                 *FPLUS2(P)*FMINUS2(Q)*FMINUS2(R) &
                 /DENOM2*(-BETA)/2.0D0
      IF ((DABS(DENOM1) > 1.0D-10).AND.(DABS(DENOM2) < 1.0D-10)) &
      NUMER=NUMER-FOCKTMU(Q,P)*FOCKTMU(R,Q)*FOCKTMU(P,R) &
                 *FPLUS2(P)*FMINUS2(Q)*FMINUS2(R) &
                 /DENOM1*(-BETA)/2.0D0
      IF ((DABS(DENOM1) < 1.0D-10).AND.(DABS(DENOM2) < 1.0D-10)) &
      NUMER=NUMER-FOCKTMU(Q,P)*FOCKTMU(R,Q)*FOCKTMU(P,R) &
                 *FPLUS2(P)*FMINUS2(Q)*FMINUS2(R) &
                 *(-BETA)**2/6.0D0
     ENDDO
    ENDDO
   ENDDO
!denom=denom+numer
!write(*,'(2F20.10)') numer,denom
!numer=0.0d0
   ! diagram 98,99,100,101,102
   DO P=1,2*O
    NUMER=NUMER+FOCKT(P,P)*(-MU2M(P,P))*FMINUS2(P)*FPLUS2(P)*(-BETA)/2.0D0
    NUMER=NUMER+FOCKT(P,P)*(-MU2M(P,P))*FMINUS2(P)*FPLUS2(P)*(-BETA)/2.0D0
   ENDDO
!denom=denom+numer
!write(*,'(2F20.10)') numer,denom
!numer=0.0d0
   DO P=1,2*O
    NUMER=NUMER+(-MU1M(P,P))*(-MU2M(P,P))*FMINUS2(P)*FPLUS2(P)*(-BETA)/2.0D0
    NUMER=NUMER+(-MU1M(P,P))*(-MU2M(P,P))*FMINUS2(P)*FPLUS2(P)*(-BETA)/2.0D0
   ENDDO
!denom=denom+numer
!write(*,'(2F20.10)') numer,denom
!numer=0.0d0
   DO P=1,2*O
    NUMER=NUMER+(-MU3M(P,P))*FMINUS2(P)
   ENDDO
!denom=denom+numer
!write(*,'(2F20.10)') numer,denom
!numer=denom
888 continue

   OOO3=NUMER
   WRITE(6,'(A,F20.10,A)')          'OMEGA(3)                      =',OOO3,' HARTREE'

! =========================================================================

   ! ----
   ! U(3)
   ! ----

   DO P=1,2*O
    DO Q=1,2*O
     FOCKTDERIV(P,Q)=0.0D0
     DO R=1,2*O
      FOCKTDERIV(P,Q)=FOCKTDERIV(P,Q)-G2(P,R,Q,R)*FMINUS2(R)*(EPS2(R)-MU0)*FPLUS2(R)
     ENDDO
    ENDDO
   ENDDO

   NUMER=0.0D0
   DENOM=0.0D0

   ! Direct differentiation of betas

   ! diagram 1
   DO P=1,2*O
    DO Q=1,2*O
     DO R=1,2*O
      DO S=1,2*O
       DO T=1,2*O
        DO U=1,2*O
         DENOM1=EPS2(P)+EPS2(S)-EPS2(Q)-EPS2(R)
         DENOM2=EPS2(P)+EPS2(S)-EPS2(T)-EPS2(U)
         IF ((DABS(DENOM1) < 1.0D-10).AND.(DABS(DENOM2) > 1.0D-10)) &
         NUMER=NUMER+0.125D0*G2(P,S,Q,R)*G2(Q,R,T,U)*G2(T,U,P,S) &
                    *FMINUS2(P)*FPLUS2(Q)*FPLUS2(R)*FMINUS2(S)*FPLUS2(T)*FPLUS2(U) &
                    /DENOM2*(-1.0D0)/2.0D0
         IF ((DABS(DENOM1) > 1.0D-10).AND.(DABS(DENOM2) < 1.0D-10)) &
         NUMER=NUMER+0.125D0*G2(P,S,Q,R)*G2(Q,R,T,U)*G2(T,U,P,S) &
                    *FMINUS2(P)*FPLUS2(Q)*FPLUS2(R)*FMINUS2(S)*FPLUS2(T)*FPLUS2(U) &
                    /DENOM1*(-1.0D0)/2.0D0
         IF ((DABS(DENOM1) < 1.0D-10).AND.(DABS(DENOM2) < 1.0D-10)) &
         NUMER=NUMER+0.125D0*G2(P,S,Q,R)*G2(Q,R,T,U)*G2(T,U,P,S) &
                    *FMINUS2(P)*FPLUS2(Q)*FPLUS2(R)*FMINUS2(S)*FPLUS2(T)*FPLUS2(U) &
                    *(BETA)/3.0D0
        ENDDO
       ENDDO
      ENDDO
     ENDDO
    ENDDO
   ENDDO
!denom=denom+numer
!write(*,'(2F20.10)') numer,denom
!numer=0.0d0
   ! diagram 2
   DO P=1,2*O
    DO Q=1,2*O
     DO R=1,2*O
      DO S=1,2*O
       DO T=1,2*O
        DO U=1,2*O
         DENOM1=EPS2(Q)+EPS2(R)-EPS2(P)-EPS2(S)
         DENOM2=EPS2(T)+EPS2(U)-EPS2(P)-EPS2(S)
         IF ((DABS(DENOM1) < 1.0D-10).AND.(DABS(DENOM2) > 1.0D-10)) &
         NUMER=NUMER+0.125D0*G2(Q,R,P,S)*G2(T,U,Q,R)*G2(P,S,T,U) &
                    *FPLUS2(P)*FMINUS2(Q)*FMINUS2(R)*FPLUS2(S)*FMINUS2(T)*FMINUS2(U) &
                    /DENOM2*(-1.0D0)/2.0D0
         IF ((DABS(DENOM1) > 1.0D-10).AND.(DABS(DENOM2) < 1.0D-10)) &
         NUMER=NUMER+0.125D0*G2(Q,R,P,S)*G2(T,U,Q,R)*G2(P,S,T,U) &
                    *FPLUS2(P)*FMINUS2(Q)*FMINUS2(R)*FPLUS2(S)*FMINUS2(T)*FMINUS2(U) &
                    /DENOM1*(-1.0D0)/2.0D0
         IF ((DABS(DENOM1) < 1.0D-10).AND.(DABS(DENOM2) < 1.0D-10)) &
         NUMER=NUMER+0.125D0*G2(Q,R,P,S)*G2(T,U,Q,R)*G2(P,S,T,U) &
                    *FPLUS2(P)*FMINUS2(Q)*FMINUS2(R)*FPLUS2(S)*FMINUS2(T)*FMINUS2(U) &
                    *(BETA)/3.0D0
        ENDDO
       ENDDO
      ENDDO
     ENDDO
    ENDDO
   ENDDO
!denom=denom+numer
!write(*,'(2F20.10)') numer,denom
!numer=0.0d0
   ! diagram 3
   DO P=1,2*O
    DO Q=1,2*O
     DO R=1,2*O
      DO S=1,2*O
       DO T=1,2*O
        DO U=1,2*O
         DENOM1=EPS2(Q)+EPS2(S)-EPS2(P)-EPS2(R)
         DENOM2=EPS2(T)+EPS2(S)-EPS2(P)-EPS2(U)
         IF ((DABS(DENOM1) < 1.0D-10).AND.(DABS(DENOM2) > 1.0D-10)) &
         NUMER=NUMER-G2(Q,S,P,R)*G2(T,R,Q,U)*G2(P,U,T,S) &
                    *FPLUS2(P)*FMINUS2(Q)*FPLUS2(R)*FMINUS2(S)*FMINUS2(T)*FPLUS2(U) &
                    /DENOM2*(-1.0D0)/2.0D0
         IF ((DABS(DENOM1) > 1.0D-10).AND.(DABS(DENOM2) < 1.0D-10)) &
         NUMER=NUMER-G2(Q,S,P,R)*G2(T,R,Q,U)*G2(P,U,T,S) &
                    *FPLUS2(P)*FMINUS2(Q)*FPLUS2(R)*FMINUS2(S)*FMINUS2(T)*FPLUS2(U) &
                    /DENOM1*(-1.0D0)/2.0D0
         IF ((DABS(DENOM1) < 1.0D-10).AND.(DABS(DENOM2) < 1.0D-10)) &
         NUMER=NUMER-G2(Q,S,P,R)*G2(T,R,Q,U)*G2(P,U,T,S) &
                    *FPLUS2(P)*FMINUS2(Q)*FPLUS2(R)*FMINUS2(S)*FMINUS2(T)*FPLUS2(U) &
                    *(BETA)/3.0D0
        ENDDO
       ENDDO
      ENDDO
     ENDDO
    ENDDO
   ENDDO
!denom=denom+numer
!write(*,'(2F20.10)') numer,denom
!numer=0.0d0
!goto 888
   ! diagram 4
   DO P=1,2*O
    DO Q=1,2*O
     DO R=1,2*O
      DO S=1,2*O
       DO T=1,2*O
        DENOM1=EPS2(P)-EPS2(Q)
        DENOM2=EPS2(P)+EPS2(S)-EPS2(R)-EPS2(T)
        IF ((DABS(DENOM1) < 1.0D-10).AND.(DABS(DENOM2) > 1.0D-10)) &
        NUMER=NUMER+0.5D0*FOCKTMU(P,Q)*G2(Q,S,R,T)*G2(R,T,P,S) &
                   *FMINUS2(P)*FPLUS2(Q)*FPLUS2(R)*FMINUS2(S)*FPLUS2(T) &
                   /DENOM2*(-1.0D0)/2.0D0
        IF ((DABS(DENOM1) > 1.0D-10).AND.(DABS(DENOM2) < 1.0D-10)) &
        NUMER=NUMER+0.5D0*FOCKTMU(P,Q)*G2(Q,S,R,T)*G2(R,T,P,S) &
                   *FMINUS2(P)*FPLUS2(Q)*FPLUS2(R)*FMINUS2(S)*FPLUS2(T) &
                   /DENOM1*(-1.0D0)/2.0D0
        IF ((DABS(DENOM1) < 1.0D-10).AND.(DABS(DENOM2) < 1.0D-10)) &
        NUMER=NUMER+0.5D0*FOCKTMU(P,Q)*G2(Q,S,R,T)*G2(R,T,P,S) &
                   *FMINUS2(P)*FPLUS2(Q)*FPLUS2(R)*FMINUS2(S)*FPLUS2(T) &
                   *(BETA)/3.0D0
       ENDDO
      ENDDO
     ENDDO
    ENDDO
   ENDDO
!denom=denom+numer
!write(*,'(2F20.10)') numer,denom
!numer=0.0d0
   ! diagram 5
   DO P=1,2*O
    DO Q=1,2*O
     DO R=1,2*O
      DO S=1,2*O
       DO T=1,2*O
        DENOM1=EPS2(Q)-EPS2(P)
        DENOM2=EPS2(R)+EPS2(T)-EPS2(P)-EPS2(S)
        IF ((DABS(DENOM1) < 1.0D-10).AND.(DABS(DENOM2) > 1.0D-10)) &
        NUMER=NUMER-0.5D0*FOCKTMU(Q,P)*G2(R,T,Q,S)*G2(P,S,R,T) &
                   *FPLUS2(P)*FMINUS2(Q)*FMINUS2(R)*FPLUS2(S)*FMINUS2(T) &
                   /DENOM2*(-1.0D0)/2.0D0
        IF ((DABS(DENOM1) > 1.0D-10).AND.(DABS(DENOM2) < 1.0D-10)) &
        NUMER=NUMER-0.5D0*FOCKTMU(Q,P)*G2(R,T,Q,S)*G2(P,S,R,T) &
                   *FPLUS2(P)*FMINUS2(Q)*FMINUS2(R)*FPLUS2(S)*FMINUS2(T) &
                   /DENOM1*(-1.0D0)/2.0D0
        IF ((DABS(DENOM1) < 1.0D-10).AND.(DABS(DENOM2) < 1.0D-10)) &
        NUMER=NUMER-0.5D0*FOCKTMU(Q,P)*G2(R,T,Q,S)*G2(P,S,R,T) &
                   *FPLUS2(P)*FMINUS2(Q)*FMINUS2(R)*FPLUS2(S)*FMINUS2(T) &
                   *(BETA)/3.0D0
       ENDDO
      ENDDO
     ENDDO
    ENDDO
   ENDDO
!denom=denom+numer
!write(*,'(2F20.10)') numer,denom
!numer=0.0d0
   ! diagram 6
   DO P=1,2*O
    DO Q=1,2*O
     DO R=1,2*O
      DO S=1,2*O
       DO T=1,2*O
        DENOM1=EPS2(P)+EPS2(R)-EPS2(Q)-EPS2(S)
        DENOM2=EPS2(P)+EPS2(R)-EPS2(Q)-EPS2(T)
        IF ((DABS(DENOM1) < 1.0D-10).AND.(DABS(DENOM2) > 1.0D-10)) &
        NUMER=NUMER+0.5D0*FOCKTMU(S,T)*G2(P,R,Q,S)*G2(Q,T,P,R) &
                   *FMINUS2(P)*FPLUS2(Q)*FMINUS2(R)*FPLUS2(S)*FPLUS2(T) &
                   /DENOM2*(-1.0D0)/2.0D0
        IF ((DABS(DENOM1) > 1.0D-10).AND.(DABS(DENOM2) < 1.0D-10)) &
        NUMER=NUMER+0.5D0*FOCKTMU(S,T)*G2(P,R,Q,S)*G2(Q,T,P,R) &
                   *FMINUS2(P)*FPLUS2(Q)*FMINUS2(R)*FPLUS2(S)*FPLUS2(T) &
                   /DENOM1*(-1.0D0)/2.0D0
        IF ((DABS(DENOM1) < 1.0D-10).AND.(DABS(DENOM2) < 1.0D-10)) &
        NUMER=NUMER+0.5D0*FOCKTMU(S,T)*G2(P,R,Q,S)*G2(Q,T,P,R) &
                   *FMINUS2(P)*FPLUS2(Q)*FMINUS2(R)*FPLUS2(S)*FPLUS2(T) &
                   *(BETA)/3.0D0
       ENDDO
      ENDDO
     ENDDO
    ENDDO
   ENDDO
!denom=denom+numer
!write(*,'(2F20.10)') numer,denom
!numer=0.0d0
   ! diagram 7
   DO P=1,2*O
    DO Q=1,2*O
     DO R=1,2*O
      DO S=1,2*O
       DO T=1,2*O
        DENOM1=EPS2(Q)+EPS2(S)-EPS2(P)-EPS2(R)
        DENOM2=EPS2(Q)+EPS2(T)-EPS2(P)-EPS2(R)
        IF ((DABS(DENOM1) < 1.0D-10).AND.(DABS(DENOM2) > 1.0D-10)) &
        NUMER=NUMER-0.5D0*FOCKTMU(T,S)*G2(Q,S,P,R)*G2(P,R,Q,T) &
                   *FPLUS2(P)*FMINUS2(Q)*FPLUS2(R)*FMINUS2(S)*FMINUS2(T) &
                   /DENOM2*(-1.0D0)/2.0D0
        IF ((DABS(DENOM1) > 1.0D-10).AND.(DABS(DENOM2) < 1.0D-10)) &
        NUMER=NUMER-0.5D0*FOCKTMU(T,S)*G2(Q,S,P,R)*G2(P,R,Q,T) &
                   *FPLUS2(P)*FMINUS2(Q)*FPLUS2(R)*FMINUS2(S)*FMINUS2(T) &
                   /DENOM1*(-1.0D0)/2.0D0
        IF ((DABS(DENOM1) < 1.0D-10).AND.(DABS(DENOM2) < 1.0D-10)) &
        NUMER=NUMER-0.5D0*FOCKTMU(T,S)*G2(Q,S,P,R)*G2(P,R,Q,T) &
                   *FPLUS2(P)*FMINUS2(Q)*FPLUS2(R)*FMINUS2(S)*FMINUS2(T) &
                   *(BETA)/3.0D0
       ENDDO
      ENDDO
     ENDDO
    ENDDO
   ENDDO
!denom=denom+numer
!write(*,'(2F20.10)') numer,denom
!numer=0.0d0
   ! diagram 8
   DO P=1,2*O
    DO Q=1,2*O
     DO R=1,2*O
      DO S=1,2*O
       DO T=1,2*O
        DENOM1=EPS2(P)+EPS2(R)-EPS2(Q)-EPS2(S)
        DENOM2=EPS2(P)-EPS2(T)
        IF ((DABS(DENOM1) < 1.0D-10).AND.(DABS(DENOM2) > 1.0D-10)) &
        NUMER=NUMER+0.5D0*FOCKTMU(T,P)*G2(P,R,Q,S)*G2(Q,S,T,R) &
                   *FMINUS2(P)*FPLUS2(Q)*FMINUS2(R)*FPLUS2(S)*FPLUS2(T) &
                   /DENOM2*(-1.0D0)/2.0D0
        IF ((DABS(DENOM1) > 1.0D-10).AND.(DABS(DENOM2) < 1.0D-10)) &
        NUMER=NUMER+0.5D0*FOCKTMU(T,P)*G2(P,R,Q,S)*G2(Q,S,T,R) &
                   *FMINUS2(P)*FPLUS2(Q)*FMINUS2(R)*FPLUS2(S)*FPLUS2(T) &
                   /DENOM1*(-1.0D0)/2.0D0
        IF ((DABS(DENOM1) < 1.0D-10).AND.(DABS(DENOM2) < 1.0D-10)) &
        NUMER=NUMER+0.5D0*FOCKTMU(T,P)*G2(P,R,Q,S)*G2(Q,S,T,R) &
                   *FMINUS2(P)*FPLUS2(Q)*FMINUS2(R)*FPLUS2(S)*FPLUS2(T) &
                   *(BETA)/3.0D0
       ENDDO
      ENDDO
     ENDDO
    ENDDO
   ENDDO
!denom=denom+numer
!write(*,'(2F20.10)') numer,denom
!numer=0.0d0
   ! diagram 9
   DO P=1,2*O
    DO Q=1,2*O
     DO R=1,2*O
      DO S=1,2*O
       DO T=1,2*O
        DENOM1=EPS2(Q)+EPS2(S)-EPS2(P)-EPS2(R)
        DENOM2=EPS2(T)-EPS2(P)
        IF ((DABS(DENOM1) < 1.0D-10).AND.(DABS(DENOM2) > 1.0D-10)) &
        NUMER=NUMER-0.5D0*FOCKTMU(P,T)*G2(Q,S,P,R)*G2(T,R,Q,S) &
                   *FPLUS2(P)*FMINUS2(Q)*FPLUS2(R)*FMINUS2(S)*FMINUS2(T) &
                   /DENOM2*(-1.0D0)/2.0D0
        IF ((DABS(DENOM1) > 1.0D-10).AND.(DABS(DENOM2) < 1.0D-10)) &
        NUMER=NUMER-0.5D0*FOCKTMU(P,T)*G2(Q,S,P,R)*G2(T,R,Q,S) &
                   *FPLUS2(P)*FMINUS2(Q)*FPLUS2(R)*FMINUS2(S)*FMINUS2(T) &
                   /DENOM1*(-1.0D0)/2.0D0
        IF ((DABS(DENOM1) < 1.0D-10).AND.(DABS(DENOM2) < 1.0D-10)) &
        NUMER=NUMER-0.5D0*FOCKTMU(P,T)*G2(Q,S,P,R)*G2(T,R,Q,S) &
                   *FPLUS2(P)*FMINUS2(Q)*FPLUS2(R)*FMINUS2(S)*FMINUS2(T) &
                   *(BETA)/3.0D0
       ENDDO
      ENDDO
     ENDDO
    ENDDO
   ENDDO
!denom=denom+numer
!write(*,'(2F20.10)') numer,denom
!numer=0.0d0
   ! diagram 10
   DO P=1,2*O
    DO Q=1,2*O
     DO R=1,2*O
      DO S=1,2*O
       DENOM1=EPS2(Q)-EPS2(P)
       DENOM2=EPS2(Q)+EPS2(R)-EPS2(P)-EPS2(S)
       IF ((DABS(DENOM1) < 1.0D-10).AND.(DABS(DENOM2) > 1.0D-10)) &
       NUMER=NUMER-FOCKTMU(Q,P)*FOCKTMU(R,S)*G2(P,S,R,Q) &
                  *FPLUS2(P)*FMINUS2(Q)*FMINUS2(R)*FPLUS2(S) &
                  /DENOM2*(-1.0D0)/2.0D0
       IF ((DABS(DENOM1) > 1.0D-10).AND.(DABS(DENOM2) < 1.0D-10)) &
       NUMER=NUMER-FOCKTMU(Q,P)*FOCKTMU(R,S)*G2(P,S,R,Q) &
                  *FPLUS2(P)*FMINUS2(Q)*FMINUS2(R)*FPLUS2(S) &
                  /DENOM1*(-1.0D0)/2.0D0
       IF ((DABS(DENOM1) < 1.0D-10).AND.(DABS(DENOM2) < 1.0D-10)) &
       NUMER=NUMER-FOCKTMU(Q,P)*FOCKTMU(R,S)*G2(P,S,R,Q) &
                  *FPLUS2(P)*FMINUS2(Q)*FMINUS2(R)*FPLUS2(S) &
                  *(BETA)/3.0D0
      ENDDO
     ENDDO
    ENDDO
   ENDDO
!denom=denom+numer
!write(*,'(2F20.10)') numer,denom
!numer=0.0d0
   ! diagram 11
   DO P=1,2*O
    DO Q=1,2*O
     DO R=1,2*O
      DO S=1,2*O
       DENOM1=EPS2(P)-EPS2(Q)
       DENOM2=EPS2(R)-EPS2(S)
       IF ((DABS(DENOM1) < 1.0D-10).AND.(DABS(DENOM2) > 1.0D-10)) &
       NUMER=NUMER-FOCKTMU(P,Q)*G2(R,Q,P,S)*FOCKTMU(S,R) &
                  *FMINUS2(P)*FPLUS2(Q)*FMINUS2(R)*FPLUS2(S) &
                  /DENOM2*(-1.0D0)/2.0D0
       IF ((DABS(DENOM1) > 1.0D-10).AND.(DABS(DENOM2) < 1.0D-10)) &
       NUMER=NUMER-FOCKTMU(P,Q)*G2(R,Q,P,S)*FOCKTMU(S,R) &
                  *FMINUS2(P)*FPLUS2(Q)*FMINUS2(R)*FPLUS2(S) &
                  /DENOM1*(-1.0D0)/2.0D0
       IF ((DABS(DENOM1) < 1.0D-10).AND.(DABS(DENOM2) < 1.0D-10)) &
       NUMER=NUMER-FOCKTMU(P,Q)*G2(R,Q,P,S)*FOCKTMU(S,R) &
                  *FMINUS2(P)*FPLUS2(Q)*FMINUS2(R)*FPLUS2(S) &
                  *(BETA)/3.0D0
      ENDDO
     ENDDO
    ENDDO
   ENDDO
!denom=denom+numer
!write(*,'(2F20.10)') numer,denom
!numer=0.0d0
   ! diagram 12
   DO P=1,2*O
    DO Q=1,2*O
     DO R=1,2*O
      DO S=1,2*O
       DENOM1=EPS2(Q)+EPS2(R)-EPS2(P)-EPS2(S)
       DENOM2=EPS2(Q)-EPS2(P)
       IF ((DABS(DENOM1) < 1.0D-10).AND.(DABS(DENOM2) > 1.0D-10)) &
       NUMER=NUMER-FOCKTMU(S,R)*FOCKTMU(P,Q)*G2(R,Q,P,S) &
                  *FPLUS2(P)*FMINUS2(Q)*FMINUS2(R)*FPLUS2(S) &
                  /DENOM2*(-1.0D0)/2.0D0
       IF ((DABS(DENOM1) > 1.0D-10).AND.(DABS(DENOM2) < 1.0D-10)) &
       NUMER=NUMER-FOCKTMU(S,R)*FOCKTMU(P,Q)*G2(R,Q,P,S) &
                  *FPLUS2(P)*FMINUS2(Q)*FMINUS2(R)*FPLUS2(S) &
                  /DENOM1*(-1.0D0)/2.0D0
       IF ((DABS(DENOM1) < 1.0D-10).AND.(DABS(DENOM2) < 1.0D-10)) &
       NUMER=NUMER-FOCKTMU(S,R)*FOCKTMU(P,Q)*G2(R,Q,P,S) &
                  *FPLUS2(P)*FMINUS2(Q)*FMINUS2(R)*FPLUS2(S) &
                  *(BETA)/3.0D0
      ENDDO
     ENDDO
    ENDDO
   ENDDO
!denom=denom+numer
!write(*,'(2F20.10)') numer,denom
!numer=0.0d0
   ! diagram 13
   DO P=1,2*O
    DO Q=1,2*O
     DO R=1,2*O
      DENOM1=EPS2(P)-EPS2(Q)
      DENOM2=EPS2(P)-EPS2(R)
      IF ((DABS(DENOM1) < 1.0D-10).AND.(DABS(DENOM2) > 1.0D-10)) &
      NUMER=NUMER+FOCKTMU(P,Q)*FOCKTMU(Q,R)*FOCKTMU(R,P) &
                 *FMINUS2(P)*FPLUS2(Q)*FPLUS2(R) &
                 /DENOM2*(-1.0D0)/2.0D0
      IF ((DABS(DENOM1) > 1.0D-10).AND.(DABS(DENOM2) < 1.0D-10)) &
      NUMER=NUMER+FOCKTMU(P,Q)*FOCKTMU(Q,R)*FOCKTMU(R,P) &
                 *FMINUS2(P)*FPLUS2(Q)*FPLUS2(R) &
                 /DENOM1*(-1.0D0)/2.0D0
      IF ((DABS(DENOM1) < 1.0D-10).AND.(DABS(DENOM2) < 1.0D-10)) &
      NUMER=NUMER+FOCKTMU(P,Q)*FOCKTMU(Q,R)*FOCKTMU(R,P) &
                 *FMINUS2(P)*FPLUS2(Q)*FPLUS2(R) &
                 *(BETA)/3.0D0
     ENDDO
    ENDDO
   ENDDO
!denom=denom+numer
!write(*,'(2F20.10)') numer,denom
!numer=0.0d0
   ! diagram 14
   DO P=1,2*O
    DO Q=1,2*O
     DO R=1,2*O
      DENOM1=EPS2(Q)-EPS2(P)
      DENOM2=EPS2(R)-EPS2(P)
      IF ((DABS(DENOM1) < 1.0D-10).AND.(DABS(DENOM2) > 1.0D-10)) &
      NUMER=NUMER-FOCKTMU(Q,P)*FOCKTMU(R,Q)*FOCKTMU(P,R) &
                 *FPLUS2(P)*FMINUS2(Q)*FMINUS2(R) &
                 /DENOM2*(-1.0D0)/2.0D0
      IF ((DABS(DENOM1) > 1.0D-10).AND.(DABS(DENOM2) < 1.0D-10)) &
      NUMER=NUMER-FOCKTMU(Q,P)*FOCKTMU(R,Q)*FOCKTMU(P,R) &
                 *FPLUS2(P)*FMINUS2(Q)*FMINUS2(R) &
                 /DENOM1*(-1.0D0)/2.0D0
      IF ((DABS(DENOM1) < 1.0D-10).AND.(DABS(DENOM2) < 1.0D-10)) &
      NUMER=NUMER-FOCKTMU(Q,P)*FOCKTMU(R,Q)*FOCKTMU(P,R) &
                 *FPLUS2(P)*FMINUS2(Q)*FMINUS2(R) &
                 *(BETA)/3.0D0
     ENDDO
    ENDDO
   ENDDO
!denom=denom+numer
!write(*,'(2F20.10)') numer,denom
!numer=0.0d0
   ! diagram 98,99,100,101,102
   DO P=1,2*O
    NUMER=NUMER+FOCKT(P,P)*(-MU2M(P,P))*FMINUS2(P)*FPLUS2(P)*(-1.0D0)/2.0D0
    NUMER=NUMER+FOCKT(P,P)*(-MU2M(P,P))*FMINUS2(P)*FPLUS2(P)*(-1.0D0)/2.0D0
   ENDDO
!denom=denom+numer
!write(*,'(2F20.10)') numer,denom
!numer=0.0d0
   DO P=1,2*O
    NUMER=NUMER+(-MU1M(P,P))*(-MU2M(P,P))*FMINUS2(P)*FPLUS2(P)*(-1.0D0)/2.0D0
    NUMER=NUMER+(-MU1M(P,P))*(-MU2M(P,P))*FMINUS2(P)*FPLUS2(P)*(-1.0D0)/2.0D0
   ENDDO
!denom=denom+numer
!write(*,'(2F20.10)') numer,denom
!numer=0.0d0

   ! Indirect differentiation of f- and f+ with beta

   ! diagram 1
   DO P=1,2*O
    DO Q=1,2*O
     DO R=1,2*O
      DO S=1,2*O
       DO T=1,2*O
        DO U=1,2*O
         DENOM1=EPS2(P)+EPS2(S)-EPS2(Q)-EPS2(R)
         DENOM2=EPS2(P)+EPS2(S)-EPS2(T)-EPS2(U)
         IF ((DABS(DENOM1) > 1.0D-10).AND.(DABS(DENOM2) > 1.0D-10)) &
         NUMER=NUMER+0.125D0*G2(P,S,Q,R)*G2(Q,R,T,U)*G2(T,U,P,S) &
                    *FMINUS2(P)*FPLUS2(Q)*FPLUS2(R)*FMINUS2(S)*FPLUS2(T)*FPLUS2(U) &
                    *(-(EPS2(P)-MU0)*FPLUS2(P) &
+(EPS2(Q)-MU0)*FMINUS2(Q) &
+(EPS2(R)-MU0)*FMINUS2(R) &
-(EPS2(S)-MU0)*FPLUS2(S) &
+(EPS2(T)-MU0)*FMINUS2(T) &
+(EPS2(U)-MU0)*FMINUS2(U) &
) &
                    /DENOM1/DENOM2
         IF ((DABS(DENOM1) < 1.0D-10).AND.(DABS(DENOM2) > 1.0D-10)) &
         NUMER=NUMER-0.125D0*G2(P,S,Q,R)*G2(Q,R,T,U)*G2(T,U,P,S) &
                    *FMINUS2(P)*FPLUS2(Q)*FPLUS2(R)*FMINUS2(S)*FPLUS2(T)*FPLUS2(U) &
                    *(-(EPS2(P)-MU0)*FPLUS2(P) &
+(EPS2(Q)-MU0)*FMINUS2(Q) &
+(EPS2(R)-MU0)*FMINUS2(R) &
-(EPS2(S)-MU0)*FPLUS2(S) &
+(EPS2(T)-MU0)*FMINUS2(T) &
+(EPS2(U)-MU0)*FMINUS2(U) &
) &
                    /DENOM2/DENOM2
         IF ((DABS(DENOM1) < 1.0D-10).AND.(DABS(DENOM2) > 1.0D-10)) &
         NUMER=NUMER+0.125D0*G2(P,S,Q,R)*G2(Q,R,T,U)*G2(T,U,P,S) &
                    *FMINUS2(P)*FPLUS2(Q)*FPLUS2(R)*FMINUS2(S)*FPLUS2(T)*FPLUS2(U) &
                    *(-(EPS2(P)-MU0)*FPLUS2(P) &
+(EPS2(Q)-MU0)*FMINUS2(Q) &
+(EPS2(R)-MU0)*FMINUS2(R) &
-(EPS2(S)-MU0)*FPLUS2(S) &
+(EPS2(T)-MU0)*FMINUS2(T) &
+(EPS2(U)-MU0)*FMINUS2(U) &
) &
                    /DENOM2*(-BETA)/2.0D0
         IF ((DABS(DENOM1) > 1.0D-10).AND.(DABS(DENOM2) < 1.0D-10)) &
         NUMER=NUMER+0.125D0*G2(P,S,Q,R)*G2(Q,R,T,U)*G2(T,U,P,S) &
                    *FMINUS2(P)*FPLUS2(Q)*FPLUS2(R)*FMINUS2(S)*FPLUS2(T)*FPLUS2(U) &
                    *(-(EPS2(P)-MU0)*FPLUS2(P) &
+(EPS2(Q)-MU0)*FMINUS2(Q) &
+(EPS2(R)-MU0)*FMINUS2(R) &
-(EPS2(S)-MU0)*FPLUS2(S) &
+(EPS2(T)-MU0)*FMINUS2(T) &
+(EPS2(U)-MU0)*FMINUS2(U) &
) &
                    /DENOM1*(-BETA)/2.0D0
         IF ((DABS(DENOM1) < 1.0D-10).AND.(DABS(DENOM2) < 1.0D-10)) &
         NUMER=NUMER+0.125D0*G2(P,S,Q,R)*G2(Q,R,T,U)*G2(T,U,P,S) &
                    *FMINUS2(P)*FPLUS2(Q)*FPLUS2(R)*FMINUS2(S)*FPLUS2(T)*FPLUS2(U) &
                    *(-(EPS2(P)-MU0)*FPLUS2(P) &
+(EPS2(Q)-MU0)*FMINUS2(Q) &
+(EPS2(R)-MU0)*FMINUS2(R) &
-(EPS2(S)-MU0)*FPLUS2(S) &
+(EPS2(T)-MU0)*FMINUS2(T) &
+(EPS2(U)-MU0)*FMINUS2(U) &
) &
                    *(-BETA)**2/6.0D0
        ENDDO
       ENDDO
      ENDDO
     ENDDO
    ENDDO
   ENDDO
!denom=denom+numer
!write(*,'(2F20.10)') numer,denom
!numer=0.0d0
   ! diagram 2
   DO P=1,2*O
    DO Q=1,2*O
     DO R=1,2*O
      DO S=1,2*O
       DO T=1,2*O
        DO U=1,2*O
         DENOM1=EPS2(Q)+EPS2(R)-EPS2(P)-EPS2(S)
         DENOM2=EPS2(T)+EPS2(U)-EPS2(P)-EPS2(S)
         IF ((DABS(DENOM1) > 1.0D-10).AND.(DABS(DENOM2) > 1.0D-10)) &
         NUMER=NUMER+0.125D0*G2(Q,R,P,S)*G2(T,U,Q,R)*G2(P,S,T,U) &
                    *FPLUS2(P)*FMINUS2(Q)*FMINUS2(R)*FPLUS2(S)*FMINUS2(T)*FMINUS2(U) &
                    *((EPS2(P)-MU0)*FMINUS2(P) &
-(EPS2(Q)-MU0)*FPLUS2(Q) &
-(EPS2(R)-MU0)*FPLUS2(R) &
+(EPS2(S)-MU0)*FMINUS2(S) &
-(EPS2(T)-MU0)*FPLUS2(T) &
-(EPS2(U)-MU0)*FPLUS2(U) &
) &
                    /DENOM1/DENOM2
         IF ((DABS(DENOM1) < 1.0D-10).AND.(DABS(DENOM2) > 1.0D-10)) &
         NUMER=NUMER-0.125D0*G2(Q,R,P,S)*G2(T,U,Q,R)*G2(P,S,T,U) &
                    *FPLUS2(P)*FMINUS2(Q)*FMINUS2(R)*FPLUS2(S)*FMINUS2(T)*FMINUS2(U) &
                    *((EPS2(P)-MU0)*FMINUS2(P) &
-(EPS2(Q)-MU0)*FPLUS2(Q) &
-(EPS2(R)-MU0)*FPLUS2(R) &
+(EPS2(S)-MU0)*FMINUS2(S) &
-(EPS2(T)-MU0)*FPLUS2(T) &
-(EPS2(U)-MU0)*FPLUS2(U) &
) &
                    /DENOM2/DENOM2
         IF ((DABS(DENOM1) < 1.0D-10).AND.(DABS(DENOM2) > 1.0D-10)) &
         NUMER=NUMER+0.125D0*G2(Q,R,P,S)*G2(T,U,Q,R)*G2(P,S,T,U) &
                    *FPLUS2(P)*FMINUS2(Q)*FMINUS2(R)*FPLUS2(S)*FMINUS2(T)*FMINUS2(U) &
                    *((EPS2(P)-MU0)*FMINUS2(P) &
-(EPS2(Q)-MU0)*FPLUS2(Q) &
-(EPS2(R)-MU0)*FPLUS2(R) &
+(EPS2(S)-MU0)*FMINUS2(S) &
-(EPS2(T)-MU0)*FPLUS2(T) &
-(EPS2(U)-MU0)*FPLUS2(U) &
) &
                    /DENOM2*(-BETA)/2.0D0
         IF ((DABS(DENOM1) > 1.0D-10).AND.(DABS(DENOM2) < 1.0D-10)) &
         NUMER=NUMER+0.125D0*G2(Q,R,P,S)*G2(T,U,Q,R)*G2(P,S,T,U) &
                    *FPLUS2(P)*FMINUS2(Q)*FMINUS2(R)*FPLUS2(S)*FMINUS2(T)*FMINUS2(U) &
                    *((EPS2(P)-MU0)*FMINUS2(P) &
-(EPS2(Q)-MU0)*FPLUS2(Q) &
-(EPS2(R)-MU0)*FPLUS2(R) &
+(EPS2(S)-MU0)*FMINUS2(S) &
-(EPS2(T)-MU0)*FPLUS2(T) &
-(EPS2(U)-MU0)*FPLUS2(U) &
) &
                    /DENOM1*(-BETA)/2.0D0
         IF ((DABS(DENOM1) < 1.0D-10).AND.(DABS(DENOM2) < 1.0D-10)) &
         NUMER=NUMER+0.125D0*G2(Q,R,P,S)*G2(T,U,Q,R)*G2(P,S,T,U) &
                    *FPLUS2(P)*FMINUS2(Q)*FMINUS2(R)*FPLUS2(S)*FMINUS2(T)*FMINUS2(U) &
                    *((EPS2(P)-MU0)*FMINUS2(P) &
-(EPS2(Q)-MU0)*FPLUS2(Q) &
-(EPS2(R)-MU0)*FPLUS2(R) &
+(EPS2(S)-MU0)*FMINUS2(S) &
-(EPS2(T)-MU0)*FPLUS2(T) &
-(EPS2(U)-MU0)*FPLUS2(U) &
) &
                    *(-BETA)**2/6.0D0
        ENDDO
       ENDDO
      ENDDO
     ENDDO
    ENDDO
   ENDDO
!denom=denom+numer
!write(*,'(2F20.10)') numer,denom
!numer=0.0d0
   ! diagram 3
   DO P=1,2*O
    DO Q=1,2*O
     DO R=1,2*O
      DO S=1,2*O
       DO T=1,2*O
        DO U=1,2*O
         DENOM1=EPS2(Q)+EPS2(S)-EPS2(P)-EPS2(R)
         DENOM2=EPS2(T)+EPS2(S)-EPS2(P)-EPS2(U)
         IF ((DABS(DENOM1) > 1.0D-10).AND.(DABS(DENOM2) > 1.0D-10)) &
         NUMER=NUMER-G2(Q,S,P,R)*G2(T,R,Q,U)*G2(P,U,T,S) &
                    *FPLUS2(P)*FMINUS2(Q)*FPLUS2(R)*FMINUS2(S)*FMINUS2(T)*FPLUS2(U) &
                    *((EPS2(P)-MU0)*FMINUS2(P) &
-(EPS2(Q)-MU0)*FPLUS2(Q) &
+(EPS2(R)-MU0)*FMINUS2(R) &
-(EPS2(S)-MU0)*FPLUS2(S) &
-(EPS2(T)-MU0)*FPLUS2(T) &
+(EPS2(U)-MU0)*FMINUS2(U) &
) &
                    /DENOM1/DENOM2
         IF ((DABS(DENOM1) < 1.0D-10).AND.(DABS(DENOM2) > 1.0D-10)) &
         NUMER=NUMER+G2(Q,S,P,R)*G2(T,R,Q,U)*G2(P,U,T,S) &
                    *FPLUS2(P)*FMINUS2(Q)*FPLUS2(R)*FMINUS2(S)*FMINUS2(T)*FPLUS2(U) &
                    *((EPS2(P)-MU0)*FMINUS2(P) &
-(EPS2(Q)-MU0)*FPLUS2(Q) &
+(EPS2(R)-MU0)*FMINUS2(R) &
-(EPS2(S)-MU0)*FPLUS2(S) &
-(EPS2(T)-MU0)*FPLUS2(T) &
+(EPS2(U)-MU0)*FMINUS2(U) &
) &
                    /DENOM2/DENOM2
         IF ((DABS(DENOM1) < 1.0D-10).AND.(DABS(DENOM2) > 1.0D-10)) &
         NUMER=NUMER-G2(Q,S,P,R)*G2(T,R,Q,U)*G2(P,U,T,S) &
                    *FPLUS2(P)*FMINUS2(Q)*FPLUS2(R)*FMINUS2(S)*FMINUS2(T)*FPLUS2(U) &
                    *((EPS2(P)-MU0)*FMINUS2(P) &
-(EPS2(Q)-MU0)*FPLUS2(Q) &
+(EPS2(R)-MU0)*FMINUS2(R) &
-(EPS2(S)-MU0)*FPLUS2(S) &
-(EPS2(T)-MU0)*FPLUS2(T) &
+(EPS2(U)-MU0)*FMINUS2(U) &
) &
                    /DENOM2*(-BETA)/2.0D0
         IF ((DABS(DENOM1) > 1.0D-10).AND.(DABS(DENOM2) < 1.0D-10)) &
         NUMER=NUMER-G2(Q,S,P,R)*G2(T,R,Q,U)*G2(P,U,T,S) &
                    *FPLUS2(P)*FMINUS2(Q)*FPLUS2(R)*FMINUS2(S)*FMINUS2(T)*FPLUS2(U) &
                    *((EPS2(P)-MU0)*FMINUS2(P) &
-(EPS2(Q)-MU0)*FPLUS2(Q) &
+(EPS2(R)-MU0)*FMINUS2(R) &
-(EPS2(S)-MU0)*FPLUS2(S) &
-(EPS2(T)-MU0)*FPLUS2(T) &
+(EPS2(U)-MU0)*FMINUS2(U) &
) &
                    /DENOM1*(-BETA)/2.0D0
         IF ((DABS(DENOM1) < 1.0D-10).AND.(DABS(DENOM2) < 1.0D-10)) &
         NUMER=NUMER-G2(Q,S,P,R)*G2(T,R,Q,U)*G2(P,U,T,S) &
                    *FPLUS2(P)*FMINUS2(Q)*FPLUS2(R)*FMINUS2(S)*FMINUS2(T)*FPLUS2(U) &
                    *((EPS2(P)-MU0)*FMINUS2(P) &
-(EPS2(Q)-MU0)*FPLUS2(Q) &
+(EPS2(R)-MU0)*FMINUS2(R) &
-(EPS2(S)-MU0)*FPLUS2(S) &
-(EPS2(T)-MU0)*FPLUS2(T) &
+(EPS2(U)-MU0)*FMINUS2(U) &
) &
                    *(-BETA)**2/6.0D0
        ENDDO
       ENDDO
      ENDDO
     ENDDO
    ENDDO
   ENDDO
!denom=denom+numer
!write(*,'(2F20.10)') numer,denom
!numer=0.0d0
!goto 888
   ! diagram 4
   DO P=1,2*O
    DO Q=1,2*O
     DO R=1,2*O
      DO S=1,2*O
       DO T=1,2*O
        DENOM1=EPS2(P)-EPS2(Q)
        DENOM2=EPS2(P)+EPS2(S)-EPS2(R)-EPS2(T)
        IF ((DABS(DENOM1) > 1.0D-10).AND.(DABS(DENOM2) > 1.0D-10)) THEN
        NUMER=NUMER+0.5D0*FOCKT(P,Q)*G2(Q,S,R,T)*G2(R,T,P,S) &
                   *FMINUS2(P)*FPLUS2(Q)*FPLUS2(R)*FMINUS2(S)*FPLUS2(T) &
                   *(-(EPS2(P)-MU0)*FPLUS2(P) &
+(EPS2(Q)-MU0)*FMINUS2(Q) &
+(EPS2(R)-MU0)*FMINUS2(R) &
-(EPS2(S)-MU0)*FPLUS2(S) &
+(EPS2(T)-MU0)*FMINUS2(T) &
) &
                   /DENOM1/DENOM2
        NUMER=NUMER+0.5D0*FOCKTDERIV(P,Q)*G2(Q,S,R,T)*G2(R,T,P,S) &
                   *FMINUS2(P)*FPLUS2(Q)*FPLUS2(R)*FMINUS2(S)*FPLUS2(T) &
                   /DENOM1/DENOM2
        ENDIF
        IF ((DABS(DENOM1) < 1.0D-10).AND.(DABS(DENOM2) > 1.0D-10)) THEN
        NUMER=NUMER-0.5D0*FOCKT(P,Q)*G2(Q,S,R,T)*G2(R,T,P,S) &
                   *FMINUS2(P)*FPLUS2(Q)*FPLUS2(R)*FMINUS2(S)*FPLUS2(T) &
                   *(-(EPS2(P)-MU0)*FPLUS2(P) &
+(EPS2(Q)-MU0)*FMINUS2(Q) &
+(EPS2(R)-MU0)*FMINUS2(R) &
-(EPS2(S)-MU0)*FPLUS2(S) &
+(EPS2(T)-MU0)*FMINUS2(T) &
) &
                   /DENOM2/DENOM2
        NUMER=NUMER-0.5D0*FOCKTDERIV(P,Q)*G2(Q,S,R,T)*G2(R,T,P,S) &
                   *FMINUS2(P)*FPLUS2(Q)*FPLUS2(R)*FMINUS2(S)*FPLUS2(T) &
                   /DENOM2/DENOM2
        ENDIF
        IF ((DABS(DENOM1) < 1.0D-10).AND.(DABS(DENOM2) > 1.0D-10)) THEN
        NUMER=NUMER+0.5D0*FOCKTMU(P,Q)*G2(Q,S,R,T)*G2(R,T,P,S) &
                   *FMINUS2(P)*FPLUS2(Q)*FPLUS2(R)*FMINUS2(S)*FPLUS2(T) &
                   *(-(EPS2(P)-MU0)*FPLUS2(P) &
+(EPS2(Q)-MU0)*FMINUS2(Q) &
+(EPS2(R)-MU0)*FMINUS2(R) &
-(EPS2(S)-MU0)*FPLUS2(S) &
+(EPS2(T)-MU0)*FMINUS2(T) &
) &
                   /DENOM2*(-BETA)/2.0D0
        NUMER=NUMER+0.5D0*FOCKTDERIV(P,Q)*G2(Q,S,R,T)*G2(R,T,P,S) &
                   *FMINUS2(P)*FPLUS2(Q)*FPLUS2(R)*FMINUS2(S)*FPLUS2(T) &
                   /DENOM2*(-BETA)/2.0D0
        ENDIF
        IF ((DABS(DENOM1) > 1.0D-10).AND.(DABS(DENOM2) < 1.0D-10)) THEN
        NUMER=NUMER+0.5D0*FOCKTMU(P,Q)*G2(Q,S,R,T)*G2(R,T,P,S) &
                   *FMINUS2(P)*FPLUS2(Q)*FPLUS2(R)*FMINUS2(S)*FPLUS2(T) &
                   *(-(EPS2(P)-MU0)*FPLUS2(P) &
+(EPS2(Q)-MU0)*FMINUS2(Q) &
+(EPS2(R)-MU0)*FMINUS2(R) &
-(EPS2(S)-MU0)*FPLUS2(S) &
+(EPS2(T)-MU0)*FMINUS2(T) &
) &
                   /DENOM1*(-BETA)/2.0D0
        NUMER=NUMER+0.5D0*FOCKTDERIV(P,Q)*G2(Q,S,R,T)*G2(R,T,P,S) &
                   *FMINUS2(P)*FPLUS2(Q)*FPLUS2(R)*FMINUS2(S)*FPLUS2(T) &
                   /DENOM1*(-BETA)/2.0D0
        ENDIF
        IF ((DABS(DENOM1) < 1.0D-10).AND.(DABS(DENOM2) < 1.0D-10)) THEN
        NUMER=NUMER+0.5D0*FOCKTMU(P,Q)*G2(Q,S,R,T)*G2(R,T,P,S) &
                   *FMINUS2(P)*FPLUS2(Q)*FPLUS2(R)*FMINUS2(S)*FPLUS2(T) &
                   *(-(EPS2(P)-MU0)*FPLUS2(P) &
+(EPS2(Q)-MU0)*FMINUS2(Q) &
+(EPS2(R)-MU0)*FMINUS2(R) &
-(EPS2(S)-MU0)*FPLUS2(S) &
+(EPS2(T)-MU0)*FMINUS2(T) &
) &
                   *(-BETA)**2/6.0D0
        NUMER=NUMER+0.5D0*FOCKTDERIV(P,Q)*G2(Q,S,R,T)*G2(R,T,P,S) &
                   *FMINUS2(P)*FPLUS2(Q)*FPLUS2(R)*FMINUS2(S)*FPLUS2(T) &
                   *(-BETA)**2/6.0D0
        ENDIF
       ENDDO
      ENDDO
     ENDDO
    ENDDO
   ENDDO
!denom=denom+numer
!write(*,'(2F20.10)') numer,denom
!numer=0.0d0
   ! diagram 5
   DO P=1,2*O
    DO Q=1,2*O
     DO R=1,2*O
      DO S=1,2*O
       DO T=1,2*O
        DENOM1=EPS2(Q)-EPS2(P)
        DENOM2=EPS2(R)+EPS2(T)-EPS2(P)-EPS2(S)
        IF ((DABS(DENOM1) > 1.0D-10).AND.(DABS(DENOM2) > 1.0D-10)) THEN
        NUMER=NUMER-0.5D0*FOCKT(Q,P)*G2(R,T,Q,S)*G2(P,S,R,T) &
                   *FPLUS2(P)*FMINUS2(Q)*FMINUS2(R)*FPLUS2(S)*FMINUS2(T) &
                   *((EPS2(P)-MU0)*FMINUS2(P) &
-(EPS2(Q)-MU0)*FPLUS2(Q) &
-(EPS2(R)-MU0)*FPLUS2(R) &
+(EPS2(S)-MU0)*FMINUS2(S) &
-(EPS2(T)-MU0)*FPLUS2(T) &
) &
                   /DENOM1/DENOM2
        NUMER=NUMER-0.5D0*FOCKTDERIV(Q,P)*G2(R,T,Q,S)*G2(P,S,R,T) &
                   *FPLUS2(P)*FMINUS2(Q)*FMINUS2(R)*FPLUS2(S)*FMINUS2(T) &
                   /DENOM1/DENOM2
        ENDIF
        IF ((DABS(DENOM1) < 1.0D-10).AND.(DABS(DENOM2) > 1.0D-10)) THEN
        NUMER=NUMER+0.5D0*FOCKT(Q,P)*G2(R,T,Q,S)*G2(P,S,R,T) &
                   *FPLUS2(P)*FMINUS2(Q)*FMINUS2(R)*FPLUS2(S)*FMINUS2(T) &
                   *((EPS2(P)-MU0)*FMINUS2(P) &
-(EPS2(Q)-MU0)*FPLUS2(Q) &
-(EPS2(R)-MU0)*FPLUS2(R) &
+(EPS2(S)-MU0)*FMINUS2(S) &
-(EPS2(T)-MU0)*FPLUS2(T) &
) &
                   /DENOM2/DENOM2
        NUMER=NUMER+0.5D0*FOCKTDERIV(Q,P)*G2(R,T,Q,S)*G2(P,S,R,T) &
                   *FPLUS2(P)*FMINUS2(Q)*FMINUS2(R)*FPLUS2(S)*FMINUS2(T) &
                   /DENOM2/DENOM2
        ENDIF
        IF ((DABS(DENOM1) < 1.0D-10).AND.(DABS(DENOM2) > 1.0D-10)) THEN
        NUMER=NUMER-0.5D0*FOCKTMU(Q,P)*G2(R,T,Q,S)*G2(P,S,R,T) &
                   *FPLUS2(P)*FMINUS2(Q)*FMINUS2(R)*FPLUS2(S)*FMINUS2(T) &
                   *((EPS2(P)-MU0)*FMINUS2(P) &
-(EPS2(Q)-MU0)*FPLUS2(Q) &
-(EPS2(R)-MU0)*FPLUS2(R) &
+(EPS2(S)-MU0)*FMINUS2(S) &
-(EPS2(T)-MU0)*FPLUS2(T) &
) &
                   /DENOM2*(-BETA)/2.0D0
        NUMER=NUMER-0.5D0*FOCKTDERIV(Q,P)*G2(R,T,Q,S)*G2(P,S,R,T) &
                   *FPLUS2(P)*FMINUS2(Q)*FMINUS2(R)*FPLUS2(S)*FMINUS2(T) &
                   /DENOM2*(-BETA)/2.0D0
        ENDIF
        IF ((DABS(DENOM1) > 1.0D-10).AND.(DABS(DENOM2) < 1.0D-10)) THEN
        NUMER=NUMER-0.5D0*FOCKTMU(Q,P)*G2(R,T,Q,S)*G2(P,S,R,T) &
                   *FPLUS2(P)*FMINUS2(Q)*FMINUS2(R)*FPLUS2(S)*FMINUS2(T) &
                   *((EPS2(P)-MU0)*FMINUS2(P) &
-(EPS2(Q)-MU0)*FPLUS2(Q) &
-(EPS2(R)-MU0)*FPLUS2(R) &
+(EPS2(S)-MU0)*FMINUS2(S) &
-(EPS2(T)-MU0)*FPLUS2(T) &
) &
                   /DENOM1*(-BETA)/2.0D0
        NUMER=NUMER-0.5D0*FOCKTDERIV(Q,P)*G2(R,T,Q,S)*G2(P,S,R,T) &
                   *FPLUS2(P)*FMINUS2(Q)*FMINUS2(R)*FPLUS2(S)*FMINUS2(T) &
                   /DENOM1*(-BETA)/2.0D0
        ENDIF
        IF ((DABS(DENOM1) < 1.0D-10).AND.(DABS(DENOM2) < 1.0D-10)) THEN
        NUMER=NUMER-0.5D0*FOCKTMU(Q,P)*G2(R,T,Q,S)*G2(P,S,R,T) &
                   *FPLUS2(P)*FMINUS2(Q)*FMINUS2(R)*FPLUS2(S)*FMINUS2(T) &
                   *((EPS2(P)-MU0)*FMINUS2(P) &
-(EPS2(Q)-MU0)*FPLUS2(Q) &
-(EPS2(R)-MU0)*FPLUS2(R) &
+(EPS2(S)-MU0)*FMINUS2(S) &
-(EPS2(T)-MU0)*FPLUS2(T) &
) &
                   *(-BETA)**2/6.0D0
        NUMER=NUMER-0.5D0*FOCKTDERIV(Q,P)*G2(R,T,Q,S)*G2(P,S,R,T) &
                   *FPLUS2(P)*FMINUS2(Q)*FMINUS2(R)*FPLUS2(S)*FMINUS2(T) &
                   *(-BETA)**2/6.0D0
        ENDIF
       ENDDO
      ENDDO
     ENDDO
    ENDDO
   ENDDO
!denom=denom+numer
!write(*,'(2F20.10)') numer,denom
!numer=0.0d0
   ! diagram 6
   DO P=1,2*O
    DO Q=1,2*O
     DO R=1,2*O
      DO S=1,2*O
       DO T=1,2*O
        DENOM1=EPS2(P)+EPS2(R)-EPS2(Q)-EPS2(S)
        DENOM2=EPS2(P)+EPS2(R)-EPS2(Q)-EPS2(T)
        IF ((DABS(DENOM1) > 1.0D-10).AND.(DABS(DENOM2) > 1.0D-10)) THEN
        NUMER=NUMER+0.5D0*FOCKT(S,T)*G2(P,R,Q,S)*G2(Q,T,P,R) &
                   *FMINUS2(P)*FPLUS2(Q)*FMINUS2(R)*FPLUS2(S)*FPLUS2(T) &
                   *(-(EPS2(P)-MU0)*FPLUS2(P) &
+(EPS2(Q)-MU0)*FMINUS2(Q) &
-(EPS2(R)-MU0)*FPLUS2(R) &
+(EPS2(S)-MU0)*FMINUS2(S) &
+(EPS2(T)-MU0)*FMINUS2(T) &
) &
                   /DENOM1/DENOM2
        NUMER=NUMER+0.5D0*FOCKTDERIV(S,T)*G2(P,R,Q,S)*G2(Q,T,P,R) &
                   *FMINUS2(P)*FPLUS2(Q)*FMINUS2(R)*FPLUS2(S)*FPLUS2(T) &
                   /DENOM1/DENOM2
        ENDIF
        IF ((DABS(DENOM1) < 1.0D-10).AND.(DABS(DENOM2) > 1.0D-10)) THEN
        NUMER=NUMER-0.5D0*FOCKT(S,T)*G2(P,R,Q,S)*G2(Q,T,P,R) &
                   *FMINUS2(P)*FPLUS2(Q)*FMINUS2(R)*FPLUS2(S)*FPLUS2(T) &
                   *(-(EPS2(P)-MU0)*FPLUS2(P) &
+(EPS2(Q)-MU0)*FMINUS2(Q) &
-(EPS2(R)-MU0)*FPLUS2(R) &
+(EPS2(S)-MU0)*FMINUS2(S) &
+(EPS2(T)-MU0)*FMINUS2(T) &
) &
                   /DENOM2/DENOM2
        NUMER=NUMER-0.5D0*FOCKTDERIV(S,T)*G2(P,R,Q,S)*G2(Q,T,P,R) &
                   *FMINUS2(P)*FPLUS2(Q)*FMINUS2(R)*FPLUS2(S)*FPLUS2(T) &
                   /DENOM2/DENOM2
        ENDIF
        IF ((DABS(DENOM1) < 1.0D-10).AND.(DABS(DENOM2) > 1.0D-10)) THEN
        NUMER=NUMER+0.5D0*FOCKTMU(S,T)*G2(P,R,Q,S)*G2(Q,T,P,R) &
                   *FMINUS2(P)*FPLUS2(Q)*FMINUS2(R)*FPLUS2(S)*FPLUS2(T) &
                   *(-(EPS2(P)-MU0)*FPLUS2(P) &
+(EPS2(Q)-MU0)*FMINUS2(Q) &
-(EPS2(R)-MU0)*FPLUS2(R) &
+(EPS2(S)-MU0)*FMINUS2(S) &
+(EPS2(T)-MU0)*FMINUS2(T) &
) &
                   /DENOM2*(-BETA)/2.0D0
        NUMER=NUMER+0.5D0*FOCKTDERIV(S,T)*G2(P,R,Q,S)*G2(Q,T,P,R) &
                   *FMINUS2(P)*FPLUS2(Q)*FMINUS2(R)*FPLUS2(S)*FPLUS2(T) &
                   /DENOM2*(-BETA)/2.0D0
        ENDIF
        IF ((DABS(DENOM1) > 1.0D-10).AND.(DABS(DENOM2) < 1.0D-10)) THEN
        NUMER=NUMER+0.5D0*FOCKTMU(S,T)*G2(P,R,Q,S)*G2(Q,T,P,R) &
                   *FMINUS2(P)*FPLUS2(Q)*FMINUS2(R)*FPLUS2(S)*FPLUS2(T) &
                   *(-(EPS2(P)-MU0)*FPLUS2(P) &
+(EPS2(Q)-MU0)*FMINUS2(Q) &
-(EPS2(R)-MU0)*FPLUS2(R) &
+(EPS2(S)-MU0)*FMINUS2(S) &
+(EPS2(T)-MU0)*FMINUS2(T) &
) &
                   /DENOM1*(-BETA)/2.0D0
        NUMER=NUMER+0.5D0*FOCKTDERIV(S,T)*G2(P,R,Q,S)*G2(Q,T,P,R) &
                   *FMINUS2(P)*FPLUS2(Q)*FMINUS2(R)*FPLUS2(S)*FPLUS2(T) &
                   /DENOM1*(-BETA)/2.0D0
        ENDIF
        IF ((DABS(DENOM1) < 1.0D-10).AND.(DABS(DENOM2) < 1.0D-10)) THEN
        NUMER=NUMER+0.5D0*FOCKTMU(S,T)*G2(P,R,Q,S)*G2(Q,T,P,R) &
                   *FMINUS2(P)*FPLUS2(Q)*FMINUS2(R)*FPLUS2(S)*FPLUS2(T) &
                   *(-(EPS2(P)-MU0)*FPLUS2(P) &
+(EPS2(Q)-MU0)*FMINUS2(Q) &
-(EPS2(R)-MU0)*FPLUS2(R) &
+(EPS2(S)-MU0)*FMINUS2(S) &
+(EPS2(T)-MU0)*FMINUS2(T) &
) &
                   *(-BETA)**2/6.0D0
        NUMER=NUMER+0.5D0*FOCKTDERIV(S,T)*G2(P,R,Q,S)*G2(Q,T,P,R) &
                   *FMINUS2(P)*FPLUS2(Q)*FMINUS2(R)*FPLUS2(S)*FPLUS2(T) &
                   *(-BETA)**2/6.0D0
        ENDIF
       ENDDO
      ENDDO
     ENDDO
    ENDDO
   ENDDO
!denom=denom+numer
!write(*,'(2F20.10)') numer,denom
!numer=0.0d0
   ! diagram 7
   DO P=1,2*O
    DO Q=1,2*O
     DO R=1,2*O
      DO S=1,2*O
       DO T=1,2*O
        DENOM1=EPS2(Q)+EPS2(S)-EPS2(P)-EPS2(R)
        DENOM2=EPS2(Q)+EPS2(T)-EPS2(P)-EPS2(R)
        IF ((DABS(DENOM1) > 1.0D-10).AND.(DABS(DENOM2) > 1.0D-10)) THEN
        NUMER=NUMER-0.5D0*FOCKT(T,S)*G2(Q,S,P,R)*G2(P,R,Q,T) &
                   *FPLUS2(P)*FMINUS2(Q)*FPLUS2(R)*FMINUS2(S)*FMINUS2(T) &
                   *((EPS2(P)-MU0)*FMINUS2(P) &
-(EPS2(Q)-MU0)*FPLUS2(Q) &
+(EPS2(R)-MU0)*FMINUS2(R) &
-(EPS2(S)-MU0)*FPLUS2(S) &
-(EPS2(T)-MU0)*FPLUS2(T) &
) &
                   /DENOM1/DENOM2
        NUMER=NUMER-0.5D0*FOCKTDERIV(T,S)*G2(Q,S,P,R)*G2(P,R,Q,T) &
                   *FPLUS2(P)*FMINUS2(Q)*FPLUS2(R)*FMINUS2(S)*FMINUS2(T) &
                   /DENOM1/DENOM2
        ENDIF
        IF ((DABS(DENOM1) < 1.0D-10).AND.(DABS(DENOM2) > 1.0D-10)) THEN
        NUMER=NUMER+0.5D0*FOCKT(T,S)*G2(Q,S,P,R)*G2(P,R,Q,T) &
                   *FPLUS2(P)*FMINUS2(Q)*FPLUS2(R)*FMINUS2(S)*FMINUS2(T) &
                   *((EPS2(P)-MU0)*FMINUS2(P) &
-(EPS2(Q)-MU0)*FPLUS2(Q) &
+(EPS2(R)-MU0)*FMINUS2(R) &
-(EPS2(S)-MU0)*FPLUS2(S) &
-(EPS2(T)-MU0)*FPLUS2(T) &
) &
                   /DENOM2/DENOM2
        NUMER=NUMER+0.5D0*FOCKTDERIV(T,S)*G2(Q,S,P,R)*G2(P,R,Q,T) &
                   *FPLUS2(P)*FMINUS2(Q)*FPLUS2(R)*FMINUS2(S)*FMINUS2(T) &
                   /DENOM2/DENOM2
        ENDIF
        IF ((DABS(DENOM1) < 1.0D-10).AND.(DABS(DENOM2) > 1.0D-10)) THEN
        NUMER=NUMER-0.5D0*FOCKTMU(T,S)*G2(Q,S,P,R)*G2(P,R,Q,T) &
                   *FPLUS2(P)*FMINUS2(Q)*FPLUS2(R)*FMINUS2(S)*FMINUS2(T) &
                   *((EPS2(P)-MU0)*FMINUS2(P) &
-(EPS2(Q)-MU0)*FPLUS2(Q) &
+(EPS2(R)-MU0)*FMINUS2(R) &
-(EPS2(S)-MU0)*FPLUS2(S) &
-(EPS2(T)-MU0)*FPLUS2(T) &
) &
                   /DENOM2*(-BETA)/2.0D0
        NUMER=NUMER-0.5D0*FOCKTDERIV(T,S)*G2(Q,S,P,R)*G2(P,R,Q,T) &
                   *FPLUS2(P)*FMINUS2(Q)*FPLUS2(R)*FMINUS2(S)*FMINUS2(T) &
                   /DENOM2*(-BETA)/2.0D0
        ENDIF
        IF ((DABS(DENOM1) > 1.0D-10).AND.(DABS(DENOM2) < 1.0D-10)) THEN
        NUMER=NUMER-0.5D0*FOCKTMU(T,S)*G2(Q,S,P,R)*G2(P,R,Q,T) &
                   *FPLUS2(P)*FMINUS2(Q)*FPLUS2(R)*FMINUS2(S)*FMINUS2(T) &
                   *((EPS2(P)-MU0)*FMINUS2(P) &
-(EPS2(Q)-MU0)*FPLUS2(Q) &
+(EPS2(R)-MU0)*FMINUS2(R) &
-(EPS2(S)-MU0)*FPLUS2(S) &
-(EPS2(T)-MU0)*FPLUS2(T) &
) &
                   /DENOM1*(-BETA)/2.0D0
        NUMER=NUMER-0.5D0*FOCKTDERIV(T,S)*G2(Q,S,P,R)*G2(P,R,Q,T) &
                   *FPLUS2(P)*FMINUS2(Q)*FPLUS2(R)*FMINUS2(S)*FMINUS2(T) &
                   /DENOM1*(-BETA)/2.0D0
        ENDIF
        IF ((DABS(DENOM1) < 1.0D-10).AND.(DABS(DENOM2) < 1.0D-10)) THEN
        NUMER=NUMER-0.5D0*FOCKTMU(T,S)*G2(Q,S,P,R)*G2(P,R,Q,T) &
                   *FPLUS2(P)*FMINUS2(Q)*FPLUS2(R)*FMINUS2(S)*FMINUS2(T) &
                   *((EPS2(P)-MU0)*FMINUS2(P) &
-(EPS2(Q)-MU0)*FPLUS2(Q) &
+(EPS2(R)-MU0)*FMINUS2(R) &
-(EPS2(S)-MU0)*FPLUS2(S) &
-(EPS2(T)-MU0)*FPLUS2(T) &
) &
                   *(-BETA)**2/6.0D0
        NUMER=NUMER-0.5D0*FOCKTDERIV(T,S)*G2(Q,S,P,R)*G2(P,R,Q,T) &
                   *FPLUS2(P)*FMINUS2(Q)*FPLUS2(R)*FMINUS2(S)*FMINUS2(T) &
                   *(-BETA)**2/6.0D0
        ENDIF
       ENDDO
      ENDDO
     ENDDO
    ENDDO
   ENDDO
!denom=denom+numer
!write(*,'(2F20.10)') numer,denom
!numer=0.0d0
   ! diagram 8
   DO P=1,2*O
    DO Q=1,2*O
     DO R=1,2*O
      DO S=1,2*O
       DO T=1,2*O
        DENOM1=EPS2(P)+EPS2(R)-EPS2(Q)-EPS2(S)
        DENOM2=EPS2(P)-EPS2(T)
        IF ((DABS(DENOM1) > 1.0D-10).AND.(DABS(DENOM2) > 1.0D-10)) THEN
        NUMER=NUMER+0.5D0*FOCKT(T,P)*G2(P,R,Q,S)*G2(Q,S,T,R) &
                   *FMINUS2(P)*FPLUS2(Q)*FMINUS2(R)*FPLUS2(S)*FPLUS2(T) &
                   *(-(EPS2(P)-MU0)*FPLUS2(P) &
+(EPS2(Q)-MU0)*FMINUS2(Q) &
-(EPS2(R)-MU0)*FPLUS2(R) &
+(EPS2(S)-MU0)*FMINUS2(S) &
+(EPS2(T)-MU0)*FMINUS2(T) &
) &
                   /DENOM1/DENOM2
        NUMER=NUMER+0.5D0*FOCKTDERIV(T,P)*G2(P,R,Q,S)*G2(Q,S,T,R) &
                   *FMINUS2(P)*FPLUS2(Q)*FMINUS2(R)*FPLUS2(S)*FPLUS2(T) &
                   /DENOM1/DENOM2
        ENDIF
        IF ((DABS(DENOM1) < 1.0D-10).AND.(DABS(DENOM2) > 1.0D-10)) THEN
        NUMER=NUMER-0.5D0*FOCKT(T,P)*G2(P,R,Q,S)*G2(Q,S,T,R) &
                   *FMINUS2(P)*FPLUS2(Q)*FMINUS2(R)*FPLUS2(S)*FPLUS2(T) &
                   *(-(EPS2(P)-MU0)*FPLUS2(P) &
+(EPS2(Q)-MU0)*FMINUS2(Q) &
-(EPS2(R)-MU0)*FPLUS2(R) &
+(EPS2(S)-MU0)*FMINUS2(S) &
+(EPS2(T)-MU0)*FMINUS2(T) &
) &
                   /DENOM2/DENOM2
        NUMER=NUMER-0.5D0*FOCKTDERIV(T,P)*G2(P,R,Q,S)*G2(Q,S,T,R) &
                   *FMINUS2(P)*FPLUS2(Q)*FMINUS2(R)*FPLUS2(S)*FPLUS2(T) &
                   /DENOM2/DENOM2
        ENDIF
        IF ((DABS(DENOM1) < 1.0D-10).AND.(DABS(DENOM2) > 1.0D-10)) THEN
        NUMER=NUMER+0.5D0*FOCKTMU(T,P)*G2(P,R,Q,S)*G2(Q,S,T,R) &
                   *FMINUS2(P)*FPLUS2(Q)*FMINUS2(R)*FPLUS2(S)*FPLUS2(T) &
                   *(-(EPS2(P)-MU0)*FPLUS2(P) &
+(EPS2(Q)-MU0)*FMINUS2(Q) &
-(EPS2(R)-MU0)*FPLUS2(R) &
+(EPS2(S)-MU0)*FMINUS2(S) &
+(EPS2(T)-MU0)*FMINUS2(T) &
) &
                   /DENOM2*(-BETA)/2.0D0
        NUMER=NUMER+0.5D0*FOCKTDERIV(T,P)*G2(P,R,Q,S)*G2(Q,S,T,R) &
                   *FMINUS2(P)*FPLUS2(Q)*FMINUS2(R)*FPLUS2(S)*FPLUS2(T) &
                   /DENOM2*(-BETA)/2.0D0
        ENDIF
        IF ((DABS(DENOM1) > 1.0D-10).AND.(DABS(DENOM2) < 1.0D-10)) THEN
        NUMER=NUMER+0.5D0*FOCKTMU(T,P)*G2(P,R,Q,S)*G2(Q,S,T,R) &
                   *FMINUS2(P)*FPLUS2(Q)*FMINUS2(R)*FPLUS2(S)*FPLUS2(T) &
                   *(-(EPS2(P)-MU0)*FPLUS2(P) &
+(EPS2(Q)-MU0)*FMINUS2(Q) &
-(EPS2(R)-MU0)*FPLUS2(R) &
+(EPS2(S)-MU0)*FMINUS2(S) &
+(EPS2(T)-MU0)*FMINUS2(T) &
) &
                   /DENOM1*(-BETA)/2.0D0
        NUMER=NUMER+0.5D0*FOCKTDERIV(T,P)*G2(P,R,Q,S)*G2(Q,S,T,R) &
                   *FMINUS2(P)*FPLUS2(Q)*FMINUS2(R)*FPLUS2(S)*FPLUS2(T) &
                   /DENOM1*(-BETA)/2.0D0
        ENDIF
        IF ((DABS(DENOM1) < 1.0D-10).AND.(DABS(DENOM2) < 1.0D-10)) THEN
        NUMER=NUMER+0.5D0*FOCKTMU(T,P)*G2(P,R,Q,S)*G2(Q,S,T,R) &
                   *FMINUS2(P)*FPLUS2(Q)*FMINUS2(R)*FPLUS2(S)*FPLUS2(T) &
                   *(-(EPS2(P)-MU0)*FPLUS2(P) &
+(EPS2(Q)-MU0)*FMINUS2(Q) &
-(EPS2(R)-MU0)*FPLUS2(R) &
+(EPS2(S)-MU0)*FMINUS2(S) &
+(EPS2(T)-MU0)*FMINUS2(T) &
) &
                   *(-BETA)**2/6.0D0
        NUMER=NUMER+0.5D0*FOCKTDERIV(T,P)*G2(P,R,Q,S)*G2(Q,S,T,R) &
                   *FMINUS2(P)*FPLUS2(Q)*FMINUS2(R)*FPLUS2(S)*FPLUS2(T) &
                   *(-BETA)**2/6.0D0
        ENDIF
       ENDDO
      ENDDO
     ENDDO
    ENDDO
   ENDDO
!denom=denom+numer
!write(*,'(2F20.10)') numer,denom
!numer=0.0d0
   ! diagram 9
   DO P=1,2*O
    DO Q=1,2*O
     DO R=1,2*O
      DO S=1,2*O
       DO T=1,2*O
        DENOM1=EPS2(Q)+EPS2(S)-EPS2(P)-EPS2(R)
        DENOM2=EPS2(T)-EPS2(P)
        IF ((DABS(DENOM1) > 1.0D-10).AND.(DABS(DENOM2) > 1.0D-10)) THEN
        NUMER=NUMER-0.5D0*FOCKT(P,T)*G2(Q,S,P,R)*G2(T,R,Q,S) &
                   *FPLUS2(P)*FMINUS2(Q)*FPLUS2(R)*FMINUS2(S)*FMINUS2(T) &
                   *((EPS2(P)-MU0)*FMINUS2(P) &
-(EPS2(Q)-MU0)*FPLUS2(Q) &
+(EPS2(R)-MU0)*FMINUS2(R) &
-(EPS2(S)-MU0)*FPLUS2(S) &
-(EPS2(T)-MU0)*FPLUS2(T) &
) &
                   /DENOM1/DENOM2
        NUMER=NUMER-0.5D0*FOCKTDERIV(P,T)*G2(Q,S,P,R)*G2(T,R,Q,S) &
                   *FPLUS2(P)*FMINUS2(Q)*FPLUS2(R)*FMINUS2(S)*FMINUS2(T) &
                   /DENOM1/DENOM2
        ENDIF
        IF ((DABS(DENOM1) < 1.0D-10).AND.(DABS(DENOM2) > 1.0D-10)) THEN
        NUMER=NUMER+0.5D0*FOCKT(P,T)*G2(Q,S,P,R)*G2(T,R,Q,S) &
                   *FPLUS2(P)*FMINUS2(Q)*FPLUS2(R)*FMINUS2(S)*FMINUS2(T) &
                   *((EPS2(P)-MU0)*FMINUS2(P) &
-(EPS2(Q)-MU0)*FPLUS2(Q) &
+(EPS2(R)-MU0)*FMINUS2(R) &
-(EPS2(S)-MU0)*FPLUS2(S) &
-(EPS2(T)-MU0)*FPLUS2(T) &
) &
                   /DENOM2/DENOM2
        NUMER=NUMER+0.5D0*FOCKTDERIV(P,T)*G2(Q,S,P,R)*G2(T,R,Q,S) &
                   *FPLUS2(P)*FMINUS2(Q)*FPLUS2(R)*FMINUS2(S)*FMINUS2(T) &
                   /DENOM2/DENOM2
        ENDIF
        IF ((DABS(DENOM1) < 1.0D-10).AND.(DABS(DENOM2) > 1.0D-10)) THEN
        NUMER=NUMER-0.5D0*FOCKTMU(P,T)*G2(Q,S,P,R)*G2(T,R,Q,S) &
                   *FPLUS2(P)*FMINUS2(Q)*FPLUS2(R)*FMINUS2(S)*FMINUS2(T) &
                   *((EPS2(P)-MU0)*FMINUS2(P) &
-(EPS2(Q)-MU0)*FPLUS2(Q) &
+(EPS2(R)-MU0)*FMINUS2(R) &
-(EPS2(S)-MU0)*FPLUS2(S) &
-(EPS2(T)-MU0)*FPLUS2(T) &
) &
                   /DENOM2*(-BETA)/2.0D0
        NUMER=NUMER-0.5D0*FOCKTDERIV(P,T)*G2(Q,S,P,R)*G2(T,R,Q,S) &
                   *FPLUS2(P)*FMINUS2(Q)*FPLUS2(R)*FMINUS2(S)*FMINUS2(T) &
                   /DENOM2*(-BETA)/2.0D0
        ENDIF
        IF ((DABS(DENOM1) > 1.0D-10).AND.(DABS(DENOM2) < 1.0D-10)) THEN
        NUMER=NUMER-0.5D0*FOCKTMU(P,T)*G2(Q,S,P,R)*G2(T,R,Q,S) &
                   *FPLUS2(P)*FMINUS2(Q)*FPLUS2(R)*FMINUS2(S)*FMINUS2(T) &
                   *((EPS2(P)-MU0)*FMINUS2(P) &
-(EPS2(Q)-MU0)*FPLUS2(Q) &
+(EPS2(R)-MU0)*FMINUS2(R) &
-(EPS2(S)-MU0)*FPLUS2(S) &
-(EPS2(T)-MU0)*FPLUS2(T) &
) &
                   /DENOM1*(-BETA)/2.0D0
        NUMER=NUMER-0.5D0*FOCKTDERIV(P,T)*G2(Q,S,P,R)*G2(T,R,Q,S) &
                   *FPLUS2(P)*FMINUS2(Q)*FPLUS2(R)*FMINUS2(S)*FMINUS2(T) &
                   /DENOM1*(-BETA)/2.0D0
        ENDIF
        IF ((DABS(DENOM1) < 1.0D-10).AND.(DABS(DENOM2) < 1.0D-10)) THEN
        NUMER=NUMER-0.5D0*FOCKTMU(P,T)*G2(Q,S,P,R)*G2(T,R,Q,S) &
                   *FPLUS2(P)*FMINUS2(Q)*FPLUS2(R)*FMINUS2(S)*FMINUS2(T) &
                   *((EPS2(P)-MU0)*FMINUS2(P) &
-(EPS2(Q)-MU0)*FPLUS2(Q) &
+(EPS2(R)-MU0)*FMINUS2(R) &
-(EPS2(S)-MU0)*FPLUS2(S) &
-(EPS2(T)-MU0)*FPLUS2(T) &
) &
                   *(-BETA)**2/6.0D0
        NUMER=NUMER-0.5D0*FOCKTDERIV(P,T)*G2(Q,S,P,R)*G2(T,R,Q,S) &
                   *FPLUS2(P)*FMINUS2(Q)*FPLUS2(R)*FMINUS2(S)*FMINUS2(T) &
                   *(-BETA)**2/6.0D0
        ENDIF
       ENDDO
      ENDDO
     ENDDO
    ENDDO
   ENDDO
!denom=denom+numer
!write(*,'(2F20.10)') numer,denom
!numer=0.0d0
   ! diagram 10
   DO P=1,2*O
    DO Q=1,2*O
     DO R=1,2*O
      DO S=1,2*O
       DENOM1=EPS2(Q)-EPS2(P)
       DENOM2=EPS2(Q)+EPS2(R)-EPS2(P)-EPS2(S)
       IF ((DABS(DENOM1) > 1.0D-10).AND.(DABS(DENOM2) > 1.0D-10)) THEN
       NUMER=NUMER-FOCKT(Q,P)*FOCKT(R,S)*G2(P,S,R,Q) &
                  *FPLUS2(P)*FMINUS2(Q)*FMINUS2(R)*FPLUS2(S) &
                  *((EPS2(P)-MU0)*FMINUS2(P) &
-(EPS2(Q)-MU0)*FPLUS2(Q) &
-(EPS2(R)-MU0)*FPLUS2(R) &
+(EPS2(S)-MU0)*FMINUS2(S) &
) &
                  /DENOM1/DENOM2
       NUMER=NUMER-FOCKTDERIV(Q,P)*FOCKT(R,S)*G2(P,S,R,Q) &
                  *FPLUS2(P)*FMINUS2(Q)*FMINUS2(R)*FPLUS2(S) &
                  /DENOM1/DENOM2
       NUMER=NUMER-FOCKT(Q,P)*FOCKTDERIV(R,S)*G2(P,S,R,Q) &
                  *FPLUS2(P)*FMINUS2(Q)*FMINUS2(R)*FPLUS2(S) &
                  /DENOM1/DENOM2
       ENDIF
       IF ((DABS(DENOM1) < 1.0D-10).AND.(DABS(DENOM2) > 1.0D-10)) THEN
       NUMER=NUMER+FOCKT(Q,P)*FOCKT(R,S)*G2(P,S,R,Q) &
                  *FPLUS2(P)*FMINUS2(Q)*FMINUS2(R)*FPLUS2(S) &
                  *((EPS2(P)-MU0)*FMINUS2(P) &
-(EPS2(Q)-MU0)*FPLUS2(Q) &
-(EPS2(R)-MU0)*FPLUS2(R) &
+(EPS2(S)-MU0)*FMINUS2(S) &
) &
                  /DENOM2/DENOM2
       NUMER=NUMER+FOCKTDERIV(Q,P)*FOCKT(R,S)*G2(P,S,R,Q) &
                  *FPLUS2(P)*FMINUS2(Q)*FMINUS2(R)*FPLUS2(S) &
                  /DENOM2/DENOM2
       NUMER=NUMER+FOCKT(Q,P)*FOCKTDERIV(R,S)*G2(P,S,R,Q) &
                  *FPLUS2(P)*FMINUS2(Q)*FMINUS2(R)*FPLUS2(S) &
                  /DENOM2/DENOM2
       ENDIF
       IF ((DABS(DENOM1) < 1.0D-10).AND.(DABS(DENOM2) > 1.0D-10)) THEN
       NUMER=NUMER-FOCKTMU(Q,P)*FOCKTMU(R,S)*G2(P,S,R,Q) &
                  *FPLUS2(P)*FMINUS2(Q)*FMINUS2(R)*FPLUS2(S) &
                  *((EPS2(P)-MU0)*FMINUS2(P) &
-(EPS2(Q)-MU0)*FPLUS2(Q) &
-(EPS2(R)-MU0)*FPLUS2(R) &
+(EPS2(S)-MU0)*FMINUS2(S) &
) &
                  /DENOM2*(-BETA)/2.0D0
       NUMER=NUMER-FOCKTDERIV(Q,P)*FOCKTMU(R,S)*G2(P,S,R,Q) &
                  *FPLUS2(P)*FMINUS2(Q)*FMINUS2(R)*FPLUS2(S) &
                  /DENOM2*(-BETA)/2.0D0
       NUMER=NUMER-FOCKTMU(Q,P)*FOCKTDERIV(R,S)*G2(P,S,R,Q) &
                  *FPLUS2(P)*FMINUS2(Q)*FMINUS2(R)*FPLUS2(S) &
                  /DENOM2*(-BETA)/2.0D0
       ENDIF
       IF ((DABS(DENOM1) > 1.0D-10).AND.(DABS(DENOM2) < 1.0D-10)) THEN
       NUMER=NUMER-FOCKTMU(Q,P)*FOCKTMU(R,S)*G2(P,S,R,Q) &
                  *FPLUS2(P)*FMINUS2(Q)*FMINUS2(R)*FPLUS2(S) &
                  *((EPS2(P)-MU0)*FMINUS2(P) &
-(EPS2(Q)-MU0)*FPLUS2(Q) &
-(EPS2(R)-MU0)*FPLUS2(R) &
+(EPS2(S)-MU0)*FMINUS2(S) &
) &
                  /DENOM1*(-BETA)/2.0D0
       NUMER=NUMER-FOCKTDERIV(Q,P)*FOCKTMU(R,S)*G2(P,S,R,Q) &
                  *FPLUS2(P)*FMINUS2(Q)*FMINUS2(R)*FPLUS2(S) &
                  /DENOM1*(-BETA)/2.0D0
       NUMER=NUMER-FOCKTMU(Q,P)*FOCKTDERIV(R,S)*G2(P,S,R,Q) &
                  *FPLUS2(P)*FMINUS2(Q)*FMINUS2(R)*FPLUS2(S) &
                  /DENOM1*(-BETA)/2.0D0
       ENDIF
       IF ((DABS(DENOM1) < 1.0D-10).AND.(DABS(DENOM2) < 1.0D-10)) THEN
       NUMER=NUMER-FOCKTMU(Q,P)*FOCKTMU(R,S)*G2(P,S,R,Q) &
                  *FPLUS2(P)*FMINUS2(Q)*FMINUS2(R)*FPLUS2(S) &
                  *((EPS2(P)-MU0)*FMINUS2(P) &
-(EPS2(Q)-MU0)*FPLUS2(Q) &
-(EPS2(R)-MU0)*FPLUS2(R) &
+(EPS2(S)-MU0)*FMINUS2(S) &
) &
                  *(-BETA)**2/6.0D0
       NUMER=NUMER-FOCKTDERIV(Q,P)*FOCKTMU(R,S)*G2(P,S,R,Q) &
                  *FPLUS2(P)*FMINUS2(Q)*FMINUS2(R)*FPLUS2(S) &
                  *(-BETA)**2/6.0D0
       NUMER=NUMER-FOCKTMU(Q,P)*FOCKTDERIV(R,S)*G2(P,S,R,Q) &
                  *FPLUS2(P)*FMINUS2(Q)*FMINUS2(R)*FPLUS2(S) &
                  *(-BETA)**2/6.0D0
       ENDIF
      ENDDO
     ENDDO
    ENDDO
   ENDDO
!denom=denom+numer
!write(*,'(2F20.10)') numer,denom
!numer=0.0d0
   ! diagram 11
   DO P=1,2*O
    DO Q=1,2*O
     DO R=1,2*O
      DO S=1,2*O
       DENOM1=EPS2(P)-EPS2(Q)
       DENOM2=EPS2(R)-EPS2(S)
       IF ((DABS(DENOM1) > 1.0D-10).AND.(DABS(DENOM2) > 1.0D-10)) THEN
       NUMER=NUMER-FOCKT(P,Q)*G2(R,Q,P,S)*FOCKT(S,R) &
                  *FMINUS2(P)*FPLUS2(Q)*FMINUS2(R)*FPLUS2(S) &
                  *(-(EPS2(P)-MU0)*FPLUS2(P) &
+(EPS2(Q)-MU0)*FMINUS2(Q) &
-(EPS2(R)-MU0)*FPLUS2(R) &
+(EPS2(S)-MU0)*FMINUS2(S) &
) &
                  /DENOM1/DENOM2
       NUMER=NUMER-FOCKTDERIV(P,Q)*G2(R,Q,P,S)*FOCKT(S,R) &
                  *FMINUS2(P)*FPLUS2(Q)*FMINUS2(R)*FPLUS2(S) &
                  /DENOM1/DENOM2
       NUMER=NUMER-FOCKT(P,Q)*G2(R,Q,P,S)*FOCKTDERIV(S,R) &
                  *FMINUS2(P)*FPLUS2(Q)*FMINUS2(R)*FPLUS2(S) &
                  /DENOM1/DENOM2
       ENDIF
       IF ((DABS(DENOM1) < 1.0D-10).AND.(DABS(DENOM2) > 1.0D-10)) THEN
       NUMER=NUMER+FOCKT(P,Q)*G2(R,Q,P,S)*FOCKT(S,R) &
                  *FMINUS2(P)*FPLUS2(Q)*FMINUS2(R)*FPLUS2(S) &
                  *(-(EPS2(P)-MU0)*FPLUS2(P) &
+(EPS2(Q)-MU0)*FMINUS2(Q) &
-(EPS2(R)-MU0)*FPLUS2(R) &
+(EPS2(S)-MU0)*FMINUS2(S) &
) &
                  /DENOM2/DENOM2
       NUMER=NUMER+FOCKTDERIV(P,Q)*G2(R,Q,P,S)*FOCKT(S,R) &
                  *FMINUS2(P)*FPLUS2(Q)*FMINUS2(R)*FPLUS2(S) &
                  /DENOM2/DENOM2
       NUMER=NUMER+FOCKT(P,Q)*G2(R,Q,P,S)*FOCKTDERIV(S,R) &
                  *FMINUS2(P)*FPLUS2(Q)*FMINUS2(R)*FPLUS2(S) &
                  /DENOM2/DENOM2
       ENDIF
       IF ((DABS(DENOM1) < 1.0D-10).AND.(DABS(DENOM2) > 1.0D-10)) THEN
       NUMER=NUMER-FOCKTMU(P,Q)*G2(R,Q,P,S)*FOCKTMU(S,R) &
                  *FMINUS2(P)*FPLUS2(Q)*FMINUS2(R)*FPLUS2(S) &
                  *(-(EPS2(P)-MU0)*FPLUS2(P) &
+(EPS2(Q)-MU0)*FMINUS2(Q) &
-(EPS2(R)-MU0)*FPLUS2(R) &
+(EPS2(S)-MU0)*FMINUS2(S) &
) &
                  /DENOM2*(-BETA)/2.0D0
       NUMER=NUMER-FOCKTDERIV(P,Q)*G2(R,Q,P,S)*FOCKTMU(S,R) &
                  *FMINUS2(P)*FPLUS2(Q)*FMINUS2(R)*FPLUS2(S) &
                  /DENOM2*(-BETA)/2.0D0
       NUMER=NUMER-FOCKTMU(P,Q)*G2(R,Q,P,S)*FOCKTDERIV(S,R) &
                  *FMINUS2(P)*FPLUS2(Q)*FMINUS2(R)*FPLUS2(S) &
                  /DENOM2*(-BETA)/2.0D0
       ENDIF
       IF ((DABS(DENOM1) > 1.0D-10).AND.(DABS(DENOM2) < 1.0D-10)) THEN
       NUMER=NUMER-FOCKTMU(P,Q)*G2(R,Q,P,S)*FOCKTMU(S,R) &
                  *FMINUS2(P)*FPLUS2(Q)*FMINUS2(R)*FPLUS2(S) &
                  *(-(EPS2(P)-MU0)*FPLUS2(P) &
+(EPS2(Q)-MU0)*FMINUS2(Q) &
-(EPS2(R)-MU0)*FPLUS2(R) &
+(EPS2(S)-MU0)*FMINUS2(S) &
) &
                  /DENOM1*(-BETA)/2.0D0
       NUMER=NUMER-FOCKTDERIV(P,Q)*G2(R,Q,P,S)*FOCKTMU(S,R) &
                  *FMINUS2(P)*FPLUS2(Q)*FMINUS2(R)*FPLUS2(S) &
                  /DENOM1*(-BETA)/2.0D0
       NUMER=NUMER-FOCKTMU(P,Q)*G2(R,Q,P,S)*FOCKTDERIV(S,R) &
                  *FMINUS2(P)*FPLUS2(Q)*FMINUS2(R)*FPLUS2(S) &
                  /DENOM1*(-BETA)/2.0D0
       ENDIF
       IF ((DABS(DENOM1) < 1.0D-10).AND.(DABS(DENOM2) < 1.0D-10)) THEN
       NUMER=NUMER-FOCKTMU(P,Q)*G2(R,Q,P,S)*FOCKTMU(S,R) &
                  *FMINUS2(P)*FPLUS2(Q)*FMINUS2(R)*FPLUS2(S) &
                  *(-(EPS2(P)-MU0)*FPLUS2(P) &
+(EPS2(Q)-MU0)*FMINUS2(Q) &
-(EPS2(R)-MU0)*FPLUS2(R) &
+(EPS2(S)-MU0)*FMINUS2(S) &
) &
                  *(-BETA)**2/6.0D0
       NUMER=NUMER-FOCKTDERIV(P,Q)*G2(R,Q,P,S)*FOCKTMU(S,R) &
                  *FMINUS2(P)*FPLUS2(Q)*FMINUS2(R)*FPLUS2(S) &
                  *(-BETA)**2/6.0D0
       NUMER=NUMER-FOCKTMU(P,Q)*G2(R,Q,P,S)*FOCKTDERIV(S,R) &
                  *FMINUS2(P)*FPLUS2(Q)*FMINUS2(R)*FPLUS2(S) &
                  *(-BETA)**2/6.0D0
       ENDIF
      ENDDO
     ENDDO
    ENDDO
   ENDDO
!denom=denom+numer
!write(*,'(2F20.10)') numer,denom
!numer=0.0d0
   ! diagram 12
   DO P=1,2*O
    DO Q=1,2*O
     DO R=1,2*O
      DO S=1,2*O
       DENOM1=EPS2(Q)+EPS2(R)-EPS2(P)-EPS2(S)
       DENOM2=EPS2(Q)-EPS2(P)
       IF ((DABS(DENOM1) > 1.0D-10).AND.(DABS(DENOM2) > 1.0D-10)) THEN
       NUMER=NUMER-FOCKT(S,R)*FOCKT(P,Q)*G2(R,Q,P,S) &
                  *FPLUS2(P)*FMINUS2(Q)*FMINUS2(R)*FPLUS2(S) &
                  *((EPS2(P)-MU0)*FMINUS2(P) &
-(EPS2(Q)-MU0)*FPLUS2(Q) &
-(EPS2(R)-MU0)*FPLUS2(R) &
+(EPS2(S)-MU0)*FMINUS2(S) &
) &
                  /DENOM1/DENOM2
       NUMER=NUMER-FOCKTDERIV(S,R)*FOCKT(P,Q)*G2(R,Q,P,S) &
                  *FPLUS2(P)*FMINUS2(Q)*FMINUS2(R)*FPLUS2(S) &
                  /DENOM1/DENOM2
       NUMER=NUMER-FOCKT(S,R)*FOCKTDERIV(P,Q)*G2(R,Q,P,S) &
                  *FPLUS2(P)*FMINUS2(Q)*FMINUS2(R)*FPLUS2(S) &
                  /DENOM1/DENOM2
       ENDIF
       IF ((DABS(DENOM1) < 1.0D-10).AND.(DABS(DENOM2) > 1.0D-10)) THEN
       NUMER=NUMER+FOCKT(S,R)*FOCKT(P,Q)*G2(R,Q,P,S) &
                  *FPLUS2(P)*FMINUS2(Q)*FMINUS2(R)*FPLUS2(S) &
                  *((EPS2(P)-MU0)*FMINUS2(P) &
-(EPS2(Q)-MU0)*FPLUS2(Q) &
-(EPS2(R)-MU0)*FPLUS2(R) &
+(EPS2(S)-MU0)*FMINUS2(S) &
) &
                  /DENOM2/DENOM2
       NUMER=NUMER+FOCKTDERIV(S,R)*FOCKT(P,Q)*G2(R,Q,P,S) &
                  *FPLUS2(P)*FMINUS2(Q)*FMINUS2(R)*FPLUS2(S) &
                  /DENOM2/DENOM2
       NUMER=NUMER+FOCKT(S,R)*FOCKTDERIV(P,Q)*G2(R,Q,P,S) &
                  *FPLUS2(P)*FMINUS2(Q)*FMINUS2(R)*FPLUS2(S) &
                  /DENOM2/DENOM2
       ENDIF
       IF ((DABS(DENOM1) < 1.0D-10).AND.(DABS(DENOM2) > 1.0D-10)) THEN
       NUMER=NUMER-FOCKTMU(S,R)*FOCKTMU(P,Q)*G2(R,Q,P,S) &
                  *FPLUS2(P)*FMINUS2(Q)*FMINUS2(R)*FPLUS2(S) &
                  *((EPS2(P)-MU0)*FMINUS2(P) &
-(EPS2(Q)-MU0)*FPLUS2(Q) &
-(EPS2(R)-MU0)*FPLUS2(R) &
+(EPS2(S)-MU0)*FMINUS2(S) &
) &
                  /DENOM2*(-BETA)/2.0D0
       NUMER=NUMER-FOCKTDERIV(S,R)*FOCKTMU(P,Q)*G2(R,Q,P,S) &
                  *FPLUS2(P)*FMINUS2(Q)*FMINUS2(R)*FPLUS2(S) &
                  /DENOM2*(-BETA)/2.0D0
       NUMER=NUMER-FOCKTMU(S,R)*FOCKTDERIV(P,Q)*G2(R,Q,P,S) &
                  *FPLUS2(P)*FMINUS2(Q)*FMINUS2(R)*FPLUS2(S) &
                  /DENOM2*(-BETA)/2.0D0
       ENDIF
       IF ((DABS(DENOM1) > 1.0D-10).AND.(DABS(DENOM2) < 1.0D-10)) THEN
       NUMER=NUMER-FOCKTMU(S,R)*FOCKTMU(P,Q)*G2(R,Q,P,S) &
                  *FPLUS2(P)*FMINUS2(Q)*FMINUS2(R)*FPLUS2(S) &
                  *((EPS2(P)-MU0)*FMINUS2(P) &
-(EPS2(Q)-MU0)*FPLUS2(Q) &
-(EPS2(R)-MU0)*FPLUS2(R) &
+(EPS2(S)-MU0)*FMINUS2(S) &
) &
                  /DENOM1*(-BETA)/2.0D0
       NUMER=NUMER-FOCKTDERIV(S,R)*FOCKTMU(P,Q)*G2(R,Q,P,S) &
                  *FPLUS2(P)*FMINUS2(Q)*FMINUS2(R)*FPLUS2(S) &
                  /DENOM1*(-BETA)/2.0D0
       NUMER=NUMER-FOCKTMU(S,R)*FOCKTDERIV(P,Q)*G2(R,Q,P,S) &
                  *FPLUS2(P)*FMINUS2(Q)*FMINUS2(R)*FPLUS2(S) &
                  /DENOM1*(-BETA)/2.0D0
       ENDIF
       IF ((DABS(DENOM1) < 1.0D-10).AND.(DABS(DENOM2) < 1.0D-10)) THEN
       NUMER=NUMER-FOCKTMU(S,R)*FOCKTMU(P,Q)*G2(R,Q,P,S) &
                  *FPLUS2(P)*FMINUS2(Q)*FMINUS2(R)*FPLUS2(S) &
                  *((EPS2(P)-MU0)*FMINUS2(P) &
-(EPS2(Q)-MU0)*FPLUS2(Q) &
-(EPS2(R)-MU0)*FPLUS2(R) &
+(EPS2(S)-MU0)*FMINUS2(S) &
) &
                  *(-BETA)**2/6.0D0
       NUMER=NUMER-FOCKTDERIV(S,R)*FOCKTMU(P,Q)*G2(R,Q,P,S) &
                  *FPLUS2(P)*FMINUS2(Q)*FMINUS2(R)*FPLUS2(S) &
                  *(-BETA)**2/6.0D0
       NUMER=NUMER-FOCKTMU(S,R)*FOCKTDERIV(P,Q)*G2(R,Q,P,S) &
                  *FPLUS2(P)*FMINUS2(Q)*FMINUS2(R)*FPLUS2(S) &
                  *(-BETA)**2/6.0D0
       ENDIF
      ENDDO
     ENDDO
    ENDDO
   ENDDO
!denom=denom+numer
!write(*,'(2F20.10)') numer,denom
!numer=0.0d0
   ! diagram 13
   DO P=1,2*O
    DO Q=1,2*O
     DO R=1,2*O
      DENOM1=EPS2(P)-EPS2(Q)
      DENOM2=EPS2(P)-EPS2(R)
      IF ((DABS(DENOM1) > 1.0D-10).AND.(DABS(DENOM2) > 1.0D-10)) THEN
      NUMER=NUMER+FOCKT(P,Q)*FOCKT(Q,R)*FOCKT(R,P) &
                 *FMINUS2(P)*FPLUS2(Q)*FPLUS2(R) &
                 *(-(EPS2(P)-MU0)*FPLUS2(P) &
+(EPS2(Q)-MU0)*FMINUS2(Q) &
+(EPS2(R)-MU0)*FMINUS2(R) &
) &
                 /DENOM1/DENOM2
      NUMER=NUMER+FOCKTDERIV(P,Q)*FOCKT(Q,R)*FOCKT(R,P) &
                 *FMINUS2(P)*FPLUS2(Q)*FPLUS2(R) &
                 /DENOM1/DENOM2
      NUMER=NUMER+FOCKT(P,Q)*FOCKTDERIV(Q,R)*FOCKT(R,P) &
                 *FMINUS2(P)*FPLUS2(Q)*FPLUS2(R) &
                 /DENOM1/DENOM2
      NUMER=NUMER+FOCKT(P,Q)*FOCKT(Q,R)*FOCKTDERIV(R,P) &
                 *FMINUS2(P)*FPLUS2(Q)*FPLUS2(R) &
                 /DENOM1/DENOM2
      ENDIF
      IF ((DABS(DENOM1) < 1.0D-10).AND.(DABS(DENOM2) > 1.0D-10)) THEN
      NUMER=NUMER-FOCKT(P,Q)*FOCKT(Q,R)*FOCKT(R,P) &
                 *FMINUS2(P)*FPLUS2(Q)*FPLUS2(R) &
                 *(-(EPS2(P)-MU0)*FPLUS2(P) &
+(EPS2(Q)-MU0)*FMINUS2(Q) &
+(EPS2(R)-MU0)*FMINUS2(R) &
) &
                 /DENOM2/DENOM2
      NUMER=NUMER-FOCKTDERIV(P,Q)*FOCKT(Q,R)*FOCKT(R,P) &
                 *FMINUS2(P)*FPLUS2(Q)*FPLUS2(R) &
                 /DENOM2/DENOM2
      NUMER=NUMER-FOCKT(P,Q)*FOCKTDERIV(Q,R)*FOCKT(R,P) &
                 *FMINUS2(P)*FPLUS2(Q)*FPLUS2(R) &
                 /DENOM2/DENOM2
      NUMER=NUMER-FOCKT(P,Q)*FOCKT(Q,R)*FOCKTDERIV(R,P) &
                 *FMINUS2(P)*FPLUS2(Q)*FPLUS2(R) &
                 /DENOM2/DENOM2
      ENDIF
      IF ((DABS(DENOM1) < 1.0D-10).AND.(DABS(DENOM2) > 1.0D-10)) THEN
      NUMER=NUMER+FOCKTMU(P,Q)*FOCKTMU(Q,R)*FOCKTMU(R,P) &
                 *FMINUS2(P)*FPLUS2(Q)*FPLUS2(R) &
                 *(-(EPS2(P)-MU0)*FPLUS2(P) &
+(EPS2(Q)-MU0)*FMINUS2(Q) &
+(EPS2(R)-MU0)*FMINUS2(R) &
) &
                 /DENOM2*(-BETA)/2.0D0
      NUMER=NUMER+FOCKTDERIV(P,Q)*FOCKTMU(Q,R)*FOCKTMU(R,P) &
                 *FMINUS2(P)*FPLUS2(Q)*FPLUS2(R) &
                 /DENOM2*(-BETA)/2.0D0
      NUMER=NUMER+FOCKTMU(P,Q)*FOCKTDERIV(Q,R)*FOCKTMU(R,P) &
                 *FMINUS2(P)*FPLUS2(Q)*FPLUS2(R) &
                 /DENOM2*(-BETA)/2.0D0
      NUMER=NUMER+FOCKTMU(P,Q)*FOCKTMU(Q,R)*FOCKTDERIV(R,P) &
                 *FMINUS2(P)*FPLUS2(Q)*FPLUS2(R) &
                 /DENOM2*(-BETA)/2.0D0
      ENDIF
      IF ((DABS(DENOM1) > 1.0D-10).AND.(DABS(DENOM2) < 1.0D-10)) THEN
      NUMER=NUMER+FOCKTMU(P,Q)*FOCKTMU(Q,R)*FOCKTMU(R,P) &
                 *FMINUS2(P)*FPLUS2(Q)*FPLUS2(R) &
                 *(-(EPS2(P)-MU0)*FPLUS2(P) &
+(EPS2(Q)-MU0)*FMINUS2(Q) &
+(EPS2(R)-MU0)*FMINUS2(R) &
) &
                 /DENOM1*(-BETA)/2.0D0
      NUMER=NUMER+FOCKTDERIV(P,Q)*FOCKTMU(Q,R)*FOCKTMU(R,P) &
                 *FMINUS2(P)*FPLUS2(Q)*FPLUS2(R) &
                 /DENOM1*(-BETA)/2.0D0
      NUMER=NUMER+FOCKTMU(P,Q)*FOCKTDERIV(Q,R)*FOCKTMU(R,P) &
                 *FMINUS2(P)*FPLUS2(Q)*FPLUS2(R) &
                 /DENOM1*(-BETA)/2.0D0
      NUMER=NUMER+FOCKTMU(P,Q)*FOCKTMU(Q,R)*FOCKTDERIV(R,P) &
                 *FMINUS2(P)*FPLUS2(Q)*FPLUS2(R) &
                 /DENOM1*(-BETA)/2.0D0
      ENDIF
      IF ((DABS(DENOM1) < 1.0D-10).AND.(DABS(DENOM2) < 1.0D-10)) THEN
      NUMER=NUMER+FOCKTMU(P,Q)*FOCKTMU(Q,R)*FOCKTMU(R,P) &
                 *FMINUS2(P)*FPLUS2(Q)*FPLUS2(R) &
                 *(-(EPS2(P)-MU0)*FPLUS2(P) &
+(EPS2(Q)-MU0)*FMINUS2(Q) &
+(EPS2(R)-MU0)*FMINUS2(R) &
) &
                 *(-BETA)**2/6.0D0
      NUMER=NUMER+FOCKTDERIV(P,Q)*FOCKTMU(Q,R)*FOCKTMU(R,P) &
                 *FMINUS2(P)*FPLUS2(Q)*FPLUS2(R) &
                 *(-BETA)**2/6.0D0
      NUMER=NUMER+FOCKTMU(P,Q)*FOCKTDERIV(Q,R)*FOCKTMU(R,P) &
                 *FMINUS2(P)*FPLUS2(Q)*FPLUS2(R) &
                 *(-BETA)**2/6.0D0
      NUMER=NUMER+FOCKTMU(P,Q)*FOCKTMU(Q,R)*FOCKTDERIV(R,P) &
                 *FMINUS2(P)*FPLUS2(Q)*FPLUS2(R) &
                 *(-BETA)**2/6.0D0
      ENDIF
     ENDDO
    ENDDO
   ENDDO
!denom=denom+numer
!write(*,'(2F20.10)') numer,denom
!numer=0.0d0
   ! diagram 14
   DO P=1,2*O
    DO Q=1,2*O
     DO R=1,2*O
      DENOM1=EPS2(Q)-EPS2(P)
      DENOM2=EPS2(R)-EPS2(P)
      IF ((DABS(DENOM1) > 1.0D-10).AND.(DABS(DENOM2) > 1.0D-10)) THEN
      NUMER=NUMER-FOCKT(Q,P)*FOCKT(R,Q)*FOCKT(P,R) &
                 *FPLUS2(P)*FMINUS2(Q)*FMINUS2(R) &
                 *((EPS2(P)-MU0)*FMINUS2(P) &
-(EPS2(Q)-MU0)*FPLUS2(Q) &
-(EPS2(R)-MU0)*FPLUS2(R) &
) &
                 /DENOM1/DENOM2
      NUMER=NUMER-FOCKTDERIV(Q,P)*FOCKT(R,Q)*FOCKT(P,R) &
                 *FPLUS2(P)*FMINUS2(Q)*FMINUS2(R) &
                 /DENOM1/DENOM2
      NUMER=NUMER-FOCKT(Q,P)*FOCKTDERIV(R,Q)*FOCKT(P,R) &
                 *FPLUS2(P)*FMINUS2(Q)*FMINUS2(R) &
                 /DENOM1/DENOM2
      NUMER=NUMER-FOCKT(Q,P)*FOCKT(R,Q)*FOCKTDERIV(P,R) &
                 *FPLUS2(P)*FMINUS2(Q)*FMINUS2(R) &
                 /DENOM1/DENOM2
      ENDIF
      IF ((DABS(DENOM1) < 1.0D-10).AND.(DABS(DENOM2) > 1.0D-10)) THEN
      NUMER=NUMER+FOCKT(Q,P)*FOCKT(R,Q)*FOCKT(P,R) &
                 *FPLUS2(P)*FMINUS2(Q)*FMINUS2(R) &
                 *((EPS2(P)-MU0)*FMINUS2(P) &
-(EPS2(Q)-MU0)*FPLUS2(Q) &
-(EPS2(R)-MU0)*FPLUS2(R) &
) &
                 /DENOM2/DENOM2
      NUMER=NUMER+FOCKTDERIV(Q,P)*FOCKT(R,Q)*FOCKT(P,R) &
                 *FPLUS2(P)*FMINUS2(Q)*FMINUS2(R) &
                 /DENOM2/DENOM2
      NUMER=NUMER+FOCKT(Q,P)*FOCKTDERIV(R,Q)*FOCKT(P,R) &
                 *FPLUS2(P)*FMINUS2(Q)*FMINUS2(R) &
                 /DENOM2/DENOM2
      NUMER=NUMER+FOCKT(Q,P)*FOCKT(R,Q)*FOCKTDERIV(P,R) &
                 *FPLUS2(P)*FMINUS2(Q)*FMINUS2(R) &
                 /DENOM2/DENOM2
      ENDIF
      IF ((DABS(DENOM1) < 1.0D-10).AND.(DABS(DENOM2) > 1.0D-10)) THEN
      NUMER=NUMER-FOCKTMU(Q,P)*FOCKTMU(R,Q)*FOCKTMU(P,R) &
                 *FPLUS2(P)*FMINUS2(Q)*FMINUS2(R) &
                 *((EPS2(P)-MU0)*FMINUS2(P) &
-(EPS2(Q)-MU0)*FPLUS2(Q) &
-(EPS2(R)-MU0)*FPLUS2(R) &
) &
                 /DENOM2*(-BETA)/2.0D0
      NUMER=NUMER-FOCKTDERIV(Q,P)*FOCKTMU(R,Q)*FOCKTMU(P,R) &
                 *FPLUS2(P)*FMINUS2(Q)*FMINUS2(R) &
                 /DENOM2*(-BETA)/2.0D0
      NUMER=NUMER-FOCKTMU(Q,P)*FOCKTDERIV(R,Q)*FOCKTMU(P,R) &
                 *FPLUS2(P)*FMINUS2(Q)*FMINUS2(R) &
                 /DENOM2*(-BETA)/2.0D0
      NUMER=NUMER-FOCKTMU(Q,P)*FOCKTMU(R,Q)*FOCKTDERIV(P,R) &
                 *FPLUS2(P)*FMINUS2(Q)*FMINUS2(R) &
                 /DENOM2*(-BETA)/2.0D0
      ENDIF
      IF ((DABS(DENOM1) > 1.0D-10).AND.(DABS(DENOM2) < 1.0D-10)) THEN
      NUMER=NUMER-FOCKTMU(Q,P)*FOCKTMU(R,Q)*FOCKTMU(P,R) &
                 *FPLUS2(P)*FMINUS2(Q)*FMINUS2(R) &
                 *((EPS2(P)-MU0)*FMINUS2(P) &
-(EPS2(Q)-MU0)*FPLUS2(Q) &
-(EPS2(R)-MU0)*FPLUS2(R) &
) &
                 /DENOM1*(-BETA)/2.0D0
      NUMER=NUMER-FOCKTDERIV(Q,P)*FOCKTMU(R,Q)*FOCKTMU(P,R) &
                 *FPLUS2(P)*FMINUS2(Q)*FMINUS2(R) &
                 /DENOM1*(-BETA)/2.0D0
      NUMER=NUMER-FOCKTMU(Q,P)*FOCKTDERIV(R,Q)*FOCKTMU(P,R) &
                 *FPLUS2(P)*FMINUS2(Q)*FMINUS2(R) &
                 /DENOM1*(-BETA)/2.0D0
      NUMER=NUMER-FOCKTMU(Q,P)*FOCKTMU(R,Q)*FOCKTDERIV(P,R) &
                 *FPLUS2(P)*FMINUS2(Q)*FMINUS2(R) &
                 /DENOM1*(-BETA)/2.0D0
      ENDIF
      IF ((DABS(DENOM1) < 1.0D-10).AND.(DABS(DENOM2) < 1.0D-10)) THEN
      NUMER=NUMER-FOCKTMU(Q,P)*FOCKTMU(R,Q)*FOCKTMU(P,R) &
                 *FPLUS2(P)*FMINUS2(Q)*FMINUS2(R) &
                 *((EPS2(P)-MU0)*FMINUS2(P) &
-(EPS2(Q)-MU0)*FPLUS2(Q) &
-(EPS2(R)-MU0)*FPLUS2(R) &
) &
                 *(-BETA)**2/6.0D0
      NUMER=NUMER-FOCKTDERIV(Q,P)*FOCKTMU(R,Q)*FOCKTMU(P,R) &
                 *FPLUS2(P)*FMINUS2(Q)*FMINUS2(R) &
                 *(-BETA)**2/6.0D0
      NUMER=NUMER-FOCKTMU(Q,P)*FOCKTDERIV(R,Q)*FOCKTMU(P,R) &
                 *FPLUS2(P)*FMINUS2(Q)*FMINUS2(R) &
                 *(-BETA)**2/6.0D0
      NUMER=NUMER-FOCKTMU(Q,P)*FOCKTMU(R,Q)*FOCKTDERIV(P,R) &
                 *FPLUS2(P)*FMINUS2(Q)*FMINUS2(R) &
                 *(-BETA)**2/6.0D0
      ENDIF
     ENDDO
    ENDDO
   ENDDO
!denom=denom+numer
!write(*,'(2F20.10)') numer,denom
!numer=0.0d0
   ! diagram 98,99,100,101,102
   DO P=1,2*O
    NUMER=NUMER+FOCKT(P,P)*(-MU2M(P,P))*FMINUS2(P)*FPLUS2(P)*(-BETA)/2.0D0*2.0D0 &
                                       *(-(EPS2(P)-MU0)*FPLUS2(P) &
+(EPS2(P)-MU0)*FMINUS2(P) &
)
    NUMER=NUMER+FOCKTDERIV(P,P)*(-MU2M(P,P))*FMINUS2(P)*FPLUS2(P)*(-BETA)/2.0D0*2.0D0
   ENDDO
!denom=denom+numer
!write(*,'(2F20.10)') numer,denom
!numer=0.0d0
   DO P=1,2*O
    NUMER=NUMER+(-MU1M(P,P))*(-MU2M(P,P))*FMINUS2(P)*FPLUS2(P)*(-BETA)/2.0D0*2.0D0 &
                                         *(-(EPS2(P)-MU0)*FPLUS2(P) &
+(EPS2(P)-MU0)*FMINUS2(P) &
)
   ENDDO
!denom=denom+numer
!write(*,'(2F20.10)') numer,denom
!numer=0.0d0
   DO P=1,2*O
    NUMER=NUMER-MU3M(P,P)*FMINUS2(P) &
               *(-(EPS2(P)-MU0)*FPLUS2(P))
   ENDDO
!denom=denom+numer
!write(*,'(2F20.10)') numer,denom
!numer=denom

   UUU3=OOO3+MU3*NBAR+NUMER*BETA

   WRITE(6,'(A,F20.10,A)')        'U(3)                          =',UUU3,' HARTREE'
   WRITE(6,'(A,F20.10,A)')        'S(3)                          =',NUMER*BETA*BETA,' kB'

   DEALLOCATE(MU1M,MU2M,MU3M,FOCKTMU,FOCKTDERIV)

! =================== PREDICTED ZERO-TEMPERATURE

   SIGMA_H=0.0D0
   SIGMA_L=0.0D0
   DO I=1,2*O
    IF (((I <= O).AND.(I > IOCC)).OR.(I > O+IOCC)) CYCLE
    DO J=1,2*O
     IF ((J <= IOCC).OR.((J > O).AND.(J <= O+IOCC))) CYCLE
     DO K=1,2*O
      IF ((K <= IOCC).OR.((K > O).AND.(K <= O+IOCC))) CYCLE
      IF (DABS(EPS2(IOCC  )+EPS2(I)-EPS2(J)-EPS2(K)) > 1.0D-10) &
      SIGMA_H=SIGMA_H+0.5D0*G2(IOCC  ,I,J,K)*G2(J,K,IOCC  ,I)/(EPS2(IOCC  )+EPS2(I)-EPS2(J)-EPS2(K))
      IF (DABS(EPS2(IOCC  )+EPS2(I)-EPS2(J)-EPS2(K)) > 1.0D-10) &
      SIGMA_L=SIGMA_L+0.5D0*G2(IOCC+1,I,J,K)*G2(J,K,IOCC+1,I)/(EPS2(IOCC+1)+EPS2(I)-EPS2(J)-EPS2(K))
     ENDDO
    ENDDO 
   ENDDO
   DO I=1,2*O
    IF (((I <= O).AND.(I > IOCC)).OR.(I > O+IOCC)) CYCLE
    DO J=1,2*O
     IF (((J <= O).AND.(J > IOCC)).OR.(J > O+IOCC)) CYCLE
     DO K=1,2*O
      IF ((K <= IOCC).OR.((K > O).AND.(K <= O+IOCC))) CYCLE
      IF (DABS(EPS2(IOCC  )+EPS2(K)-EPS2(I)-EPS2(J)) > 1.0D-10) &
      SIGMA_H=SIGMA_H+0.5D0*G2(I,J,K,IOCC  )*G2(K,IOCC  ,I,J)/(EPS2(IOCC  )+EPS2(K)-EPS2(I)-EPS2(J))
      IF (DABS(EPS2(IOCC+1)+EPS2(K)-EPS2(I)-EPS2(J)) > 1.0D-10) &
      SIGMA_L=SIGMA_L+0.5D0*G2(I,J,K,IOCC+1)*G2(K,IOCC+1,I,J)/(EPS2(IOCC+1)+EPS2(K)-EPS2(I)-EPS2(J))
     ENDDO
    ENDDO 
   ENDDO
   WRITE(6,'(/,A,F20.10       )') 'PREDICTED ZERO-T   MU(0)=',(EPS2(IOCC)+EPS2(IOCC+1))/2.0D0
   WRITE(6,'(  A,F20.10       )') 'PREDICTED ZERO-T   MU(1)=',0.0D0
   WRITE(6,'(  A,F20.10       )') 'PREDICTED ZERO-T   MU(2)=',(SIGMA_H+SIGMA_L)/2.0D0
   WRITE(6,'(  A,F20.10       )') '                 SIGMA_H=',SIGMA_H
   WRITE(6,'(  A,F20.10       )') '                 SIGMA_L=',SIGMA_L

! === HOMO & LUMO reversed === comment out from here ...
!  WRITE(6,'(  A,2F20.10       )') 'homo-1=',H(1,1)+G2(1,2,1,2)+G2(1,5,1,5)+G2(1,6,1,6),EPS2(1)
!  WRITE(6,'(  A,2F20.10       )') 'homo  =',H(2,2)+G2(2,1,2,1)+G2(2,5,2,5)+G2(2,6,2,6),EPS2(2)
!  WRITE(6,'(  A,2F20.10       )') 'lumo  =',H(3,3)+G2(3,1,3,1)+G2(3,2,3,2)+G2(3,5,3,5)+G2(3,6,3,6),EPS2(3)
!  WRITE(6,'(  A,2F20.10       )') 'lumo+1=',H(4,4)+G2(4,1,4,1)+G2(4,2,4,2)+G2(4,5,4,5)+G2(4,6,4,6),EPS2(4)
!  WRITE(6,'(  A,2F20.10       )') 'h+l/2 =',(H(2,2)+G2(2,1,2,1)+G2(2,5,2,5)+G2(2,6,2,6) &
!                                            +H(3,3)+G2(3,1,3,1)+G2(3,2,3,2)+G2(3,5,3,5)+G2(3,6,3,6))/2.0d0,EPS2(2)
! ... to here


   DEALLOCATE(FPLUS,FMINUS,IIJJ,H,G,IIJJ2,FPLUS2,FMINUS2,F2,G2,EPS2,FOCKT,H2)

   RETURN
END SUBROUTINE



SUBROUTINE CALCNBAR2(BETA,MU0,MU1,MU2,E0,E1,E2,NBAR)
! CALCULATE NBAR FOR A GIVEN BETA & MU(2) ACCORDING TO THE 2ND-ORDER PERTURBATION THEORY

   USE THR_FULLCI

   DOUBLE PRECISION :: BETA
   DOUBLE PRECISION :: MU0
   DOUBLE PRECISION :: MU1
   DOUBLE PRECISION :: MU2
   DOUBLE PRECISION :: E0(NALL)
   DOUBLE PRECISION :: E1(NALL)
   DOUBLE PRECISION :: E2(NALL)
   DOUBLE PRECISION :: NBAR
   DOUBLE PRECISION :: XI
   INTEGER :: I

   XI=0.0D0
   DO I=1,NALL
    XI=XI+DEXP(-BETA*(E0(I)-ESHIFT-MU0*DFLOAT(ALLN(I)))) &
       *(-BETA*(E2(I)-MU2*DFLOAT(ALLN(I)))+0.5D0*(-BETA*(E1(I)-MU1*DFLOAT(ALLN(I))))**2)
   ENDDO
   NBAR=0.0D0
   DO I=1,NALL
    NBAR=NBAR+DFLOAT(ALLN(I))*DEXP(-BETA*(E0(I)-ESHIFT-MU0*DFLOAT(ALLN(I)))) &
       *(-BETA*(E2(I)-MU2*DFLOAT(ALLN(I)))+0.5D0*(-BETA*(E1(I)-MU1*DFLOAT(ALLN(I))))**2)
   ENDDO
   NBAR=NBAR/XI

   RETURN
END SUBROUTINE



SUBROUTINE CALCNBAR1(BETA,MU0,MU1,E0,E1,NBAR)
! CALCULATE NBAR FOR A GIVEN BETA & MU(1) ACCORDING TO THE 1ST-ORDER PERTURBATION THEORY

   USE THR_FULLCI

   DOUBLE PRECISION :: BETA
   DOUBLE PRECISION :: MU0
   DOUBLE PRECISION :: MU1
   DOUBLE PRECISION :: E0(NALL)
   DOUBLE PRECISION :: E1(NALL)
   DOUBLE PRECISION :: NBAR
   DOUBLE PRECISION :: XI
   INTEGER :: I

   XI=0.0D0
   DO I=1,NALL
    XI=XI+DEXP(-BETA*(E0(I)-ESHIFT-MU0*DFLOAT(ALLN(I))))*(-BETA*(E1(I)-MU1*DFLOAT(ALLN(I))))
   ENDDO
   NBAR=0.0D0
   DO I=1,NALL
    NBAR=NBAR+DFLOAT(ALLN(I))*DEXP(-BETA*(E0(I)-ESHIFT-MU0*DFLOAT(ALLN(I))))*(-BETA*(E1(I)-MU1*DFLOAT(ALLN(I))))
   ENDDO
   NBAR=NBAR/XI

   RETURN
END SUBROUTINE



SUBROUTINE CALCNBAR(BETA,MU,NBAR)
! CALCULATE NBAR FOR A GIVEN BETA & MU

   USE THR_FULLCI

   DOUBLE PRECISION :: BETA
   DOUBLE PRECISION :: MU
   DOUBLE PRECISION :: NBAR
   DOUBLE PRECISION :: XI
   INTEGER :: I

   XI=0.0D0
   DO I=1,NALL
    XI=XI+DEXP(-BETA*(ALLE(I)-ESHIFT-MU*DFLOAT(ALLN(I))))
   ENDDO
   NBAR=0.0D0
   DO I=1,NALL
    NBAR=NBAR+DFLOAT(ALLN(I))*DEXP(-BETA*(ALLE(I)-ESHIFT-MU*DFLOAT(ALLN(I))))
   ENDDO
   NBAR=NBAR/XI

   RETURN
END SUBROUTINE



SUBROUTINE CALCTHERM(BETA,MU,NBAR,XI,OOO,UUU,SSS)
! CALCULATE XI, OMEGA, U, AND S

   USE THR_FULLCI

   DOUBLE PRECISION :: BETA
   DOUBLE PRECISION :: MU
   DOUBLE PRECISION :: NBAR
   DOUBLE PRECISION :: XI
   DOUBLE PRECISION :: OOO
   DOUBLE PRECISION :: UUU
   DOUBLE PRECISION :: SSS
   INTEGER :: I

   XI=0.0D0
   DO I=1,NALL
    XI=XI+DEXP(-BETA*(ALLE(I)-ESHIFT-MU*DFLOAT(ALLN(I))))
   ENDDO

   OOO=-DLOG(XI)/BETA+ESHIFT

   UUU=MU*NBAR
   DO I=1,NALL
    UUU=UUU+(ALLE(I)-MU*ALLN(I))*DEXP(-BETA*(ALLE(I)-ESHIFT-MU*DFLOAT(ALLN(I))))/XI
   ENDDO

   SSS=0.0D0
   DO I=1,NALL
    SSS=SSS-DEXP(-BETA*(ALLE(I)-ESHIFT-MU*DFLOAT(ALLN(I))))/XI*DLOG(DEXP(-BETA*(ALLE(I)-ESHIFT-MU*DFLOAT(ALLN(I))))/XI)
   ENDDO

   RETURN
END SUBROUTINE



SUBROUTINE THERMAL_GENERATE_CONFIGURATIONSA(NE,ORDER)
! GENERATE CONFIGURATIONS FOR ALPHA ELECTRONS

   USE CONTROL
   USE STRUCTURE
   USE INTEGRAL
   USE BASISSET
   USE THR_FULLCI
  
   IMPLICIT NONE
   INTEGER :: NE
   INTEGER :: ORDER
   INTEGER :: I,J,K,L,M
   INTEGER :: I1,I2,I3,I4,I5,I6,I7,I8
   INTEGER(4) :: ICF
   INTEGER :: COMBINATION
   
   IF (ICORE > 0) WRITE(6,'(A,I3,A)') '***** WARNING : ',ICORE,' CORE ALPHA ORBITALS ARE ALWAYS OCCUPIED'
   IF (IVIRTCORE > 0) WRITE(6,'(A,I3,A)') '***** WARNING : ',IVIRTCORE,' HIGHEST VIRTUAL ALPHA ORBITALS ARE ALWAYS UNOCCUPIED'
!  WRITE(6,'(A,I3,A,I3,A)') '  THERE ARE ',NE-ICORE,' ACTIVE ALPHA ELECTRONS IN ',IALL(0,0,0)-ICORE-IVIRTCORE,' ACTIVE ORBITALS'
   NCFA=0
   DO I=0,ORDER
    J=COMBINATION(NE-ICORE,NE-ICORE-I)*COMBINATION(IALL(0,0,0)-NE-IVIRTCORE,I)
!   WRITE(6,'(I4,A,I7)') I,' EXCITATION CONFIGURATIONS ',J
    NCFA=NCFA+J
   ENDDO
!  WRITE(6,'(A,I7)') '    TOTAL ALPHA CONFIGURATIONS ',NCFA
   IF (NCFA /= COMBINATION(IALL(0,0,0)-ICORE-IVIRTCORE,NE-ICORE)) CALL PABORT('AN ERROR OCCURRED IN COMBINATION FUNCTION')

   ALLOCATE(CFHALFA(NCFA),NORDERA(NCFA),ADDRSSA(0:2**(IALLMAX-IVIRTCORE)))

 
   ADDRSSA=0
   I=0
   IF (NE == 0) THEN
    ICF=0
    I=I+1
    J=0
    CFHALFA(I)=ICF
    NORDERA(I)=J
    ADDRSSA(ICF)=I
    K=0
    M=0
    DO L=0,IALL(0,0,0)-IVIRTCORE-1
     IF (BTEST(ICF,L)) K=K+10**L
     IF (BTEST(ICF,L)) M=L
    ENDDO
!   WRITE(6,'(I6,A,I3,A,I6,A,I12)') I,' ORDER = ',J,' CF(NUM) = ',ICF,' CF(BIT) = ',K
   ELSE IF (NE == 1) THEN
    DO I1=1,IALL(0,0,0)-IVIRTCORE
     J=0
     IF (I1 <= ICORE) J=J+1
     IF (J /= ICORE) CYCLE
     J=0
     IF (I1 > NE) J=J+1
     IF (J > ORDER) CYCLE
     ICF=0
     ICF=IBSET(ICF,I1-1)
     I=I+1
     CFHALFA(I)=ICF
     NORDERA(I)=J
     ADDRSSA(ICF)=I
     K=0
     DO L=0,IALL(0,0,0)-IVIRTCORE-1
      IF (BTEST(ICF,L)) K=K+10**L
      IF (BTEST(ICF,L)) M=L
     ENDDO
!    WRITE(6,'(I6,A,I3,A,I6,A,I12)') I,' ORDER = ',J,' CF(NUM) = ',ICF,' CF(BIT) = ',K
    ENDDO
   ELSE IF (NE == 2) THEN
    DO I1=1,IALL(0,0,0)-IVIRTCORE-1
     DO I2=I1+1,IALL(0,0,0)-IVIRTCORE
      J=0
      IF (I1 <= ICORE) J=J+1
      IF (I2 <= ICORE) J=J+1
      IF (J /= ICORE) CYCLE
      J=0
      IF (I1 > NE) J=J+1
      IF (I2 > NE) J=J+1
      IF (J > ORDER) CYCLE
      ICF=0
      ICF=IBSET(ICF,I1-1)
      ICF=IBSET(ICF,I2-1)
      I=I+1
      CFHALFA(I)=ICF
      NORDERA(I)=J
      ADDRSSA(ICF)=I
      K=0
      DO L=0,IALL(0,0,0)-IVIRTCORE-1
       IF (BTEST(ICF,L)) K=K+10**L
       IF (BTEST(ICF,L)) M=L
      ENDDO
!     WRITE(6,'(I6,A,I3,A,I6,A,I12)') I,' ORDER = ',J,' CF(NUM) = ',ICF,' CF(BIT) = ',K
     ENDDO
    ENDDO
   ELSE IF (NE == 3) THEN
    DO I1=1,IALL(0,0,0)-IVIRTCORE-2
     DO I2=I1+1,IALL(0,0,0)-IVIRTCORE-1
      DO I3=I2+1,IALL(0,0,0)-IVIRTCORE
       J=0
       IF (I1 <= ICORE) J=J+1
       IF (I2 <= ICORE) J=J+1
       IF (I3 <= ICORE) J=J+1
       IF (J /= ICORE) CYCLE
       J=0
       IF (I1 > NE) J=J+1
       IF (I2 > NE) J=J+1
       IF (I3 > NE) J=J+1
       IF (J > ORDER) CYCLE
       ICF=0
       ICF=IBSET(ICF,I1-1)
       ICF=IBSET(ICF,I2-1)
       ICF=IBSET(ICF,I3-1)
       I=I+1
       CFHALFA(I)=ICF
       NORDERA(I)=J
       ADDRSSA(ICF)=I
       K=0
       DO L=0,IALL(0,0,0)-IVIRTCORE-1
        IF (BTEST(ICF,L)) K=K+10**L
        IF (BTEST(ICF,L)) M=L
       ENDDO
!      WRITE(6,'(I6,A,I3,A,I6,A,I12)') I,' ORDER = ',J,' CF(NUM) = ',ICF,' CF(BIT) = ',K
      ENDDO
     ENDDO
    ENDDO
   ELSE IF (NE == 4) THEN
    DO I1=1,IALL(0,0,0)-IVIRTCORE-3
     DO I2=I1+1,IALL(0,0,0)-IVIRTCORE-2
      DO I3=I2+1,IALL(0,0,0)-IVIRTCORE-1
       DO I4=I3+1,IALL(0,0,0)-IVIRTCORE
        J=0
        IF (I1 <= ICORE) J=J+1
        IF (I2 <= ICORE) J=J+1
        IF (I3 <= ICORE) J=J+1
        IF (I4 <= ICORE) J=J+1
        IF (J /= ICORE) CYCLE
        J=0
        IF (I1 > NE) J=J+1
        IF (I2 > NE) J=J+1
        IF (I3 > NE) J=J+1
        IF (I4 > NE) J=J+1
        IF (J > ORDER) CYCLE
        ICF=0
        ICF=IBSET(ICF,I1-1)
        ICF=IBSET(ICF,I2-1)
        ICF=IBSET(ICF,I3-1)
        ICF=IBSET(ICF,I4-1)
        I=I+1
        CFHALFA(I)=ICF
        NORDERA(I)=J
        ADDRSSA(ICF)=I
        K=0
        DO L=0,IALL(0,0,0)-IVIRTCORE-1
         IF (BTEST(ICF,L)) K=K+10**L
         IF (BTEST(ICF,L)) M=L
        ENDDO
!       WRITE(6,'(I6,A,I3,A,I6,A,I12)') I,' ORDER = ',J,' CF(NUM) = ',ICF,' CF(BIT) = ',K
       ENDDO
      ENDDO
     ENDDO
    ENDDO
   ELSE IF (NE == 5) THEN
    DO I1=1,IALL(0,0,0)-IVIRTCORE-4
     DO I2=I1+1,IALL(0,0,0)-IVIRTCORE-3
      DO I3=I2+1,IALL(0,0,0)-IVIRTCORE-2
       DO I4=I3+1,IALL(0,0,0)-IVIRTCORE-1
        DO I5=I4+1,IALL(0,0,0)-IVIRTCORE
         J=0
         IF (I1 <= ICORE) J=J+1
         IF (I2 <= ICORE) J=J+1
         IF (I3 <= ICORE) J=J+1
         IF (I4 <= ICORE) J=J+1
         IF (I5 <= ICORE) J=J+1
         IF (J /= ICORE) CYCLE
         J=0
         IF (I1 > NE) J=J+1
         IF (I2 > NE) J=J+1
         IF (I3 > NE) J=J+1
         IF (I4 > NE) J=J+1
         IF (I5 > NE) J=J+1
         IF (J > ORDER) CYCLE
         ICF=0
         ICF=IBSET(ICF,I1-1)
         ICF=IBSET(ICF,I2-1)
         ICF=IBSET(ICF,I3-1)
         ICF=IBSET(ICF,I4-1)
         ICF=IBSET(ICF,I5-1)
         I=I+1
         CFHALFA(I)=ICF
         NORDERA(I)=J
         ADDRSSA(ICF)=I
         K=0
         DO L=0,IALL(0,0,0)-IVIRTCORE-1
          IF (BTEST(ICF,L)) K=K+10**L
          IF (BTEST(ICF,L)) M=L
         ENDDO
!        WRITE(6,'(I6,A,I3,A,I6,A,I12)') I,' ORDER = ',J,' CF(NUM) = ',ICF,' CF(BIT) = ',K
        ENDDO
       ENDDO
      ENDDO
     ENDDO
    ENDDO
   ELSE IF (NE == 6) THEN
    DO I1=1,IALL(0,0,0)-IVIRTCORE-5
     DO I2=I1+1,IALL(0,0,0)-IVIRTCORE-4
      DO I3=I2+1,IALL(0,0,0)-IVIRTCORE-3
       DO I4=I3+1,IALL(0,0,0)-IVIRTCORE-2
        DO I5=I4+1,IALL(0,0,0)-IVIRTCORE-1
         DO I6=I5+1,IALL(0,0,0)-IVIRTCORE
          J=0
          IF (I1 <= ICORE) J=J+1
          IF (I2 <= ICORE) J=J+1
          IF (I3 <= ICORE) J=J+1
          IF (I4 <= ICORE) J=J+1
          IF (I5 <= ICORE) J=J+1
          IF (I6 <= ICORE) J=J+1
          IF (J /= ICORE) CYCLE
          J=0
          IF (I1 > NE) J=J+1
          IF (I2 > NE) J=J+1
          IF (I3 > NE) J=J+1
          IF (I4 > NE) J=J+1
          IF (I5 > NE) J=J+1
          IF (I6 > NE) J=J+1
          IF (J > ORDER) CYCLE
          ICF=0
          ICF=IBSET(ICF,I1-1)
          ICF=IBSET(ICF,I2-1)
          ICF=IBSET(ICF,I3-1)
          ICF=IBSET(ICF,I4-1)
          ICF=IBSET(ICF,I5-1)
          ICF=IBSET(ICF,I6-1)
          I=I+1
          CFHALFA(I)=ICF
          NORDERA(I)=J
          ADDRSSA(ICF)=I
          K=0
          DO L=0,IALL(0,0,0)-IVIRTCORE-1
           IF (BTEST(ICF,L)) K=K+10**L
           IF (BTEST(ICF,L)) M=L
          ENDDO
!         WRITE(6,'(I6,A,I3,A,I6,A,I12)') I,' ORDER = ',J,' CF(NUM) = ',ICF,' CF(BIT) = ',K
         ENDDO
        ENDDO
       ENDDO
      ENDDO
     ENDDO
    ENDDO
   ELSE IF (NE == 7) THEN
    DO I1=1,IALL(0,0,0)-IVIRTCORE-6
     DO I2=I1+1,IALL(0,0,0)-IVIRTCORE-5
      DO I3=I2+1,IALL(0,0,0)-IVIRTCORE-4
       DO I4=I3+1,IALL(0,0,0)-IVIRTCORE-3
        DO I5=I4+1,IALL(0,0,0)-IVIRTCORE-2
         DO I6=I5+1,IALL(0,0,0)-IVIRTCORE-1
          DO I7=I6+1,IALL(0,0,0)-IVIRTCORE
           J=0
           IF (I1 <= ICORE) J=J+1
           IF (I2 <= ICORE) J=J+1
           IF (I3 <= ICORE) J=J+1
           IF (I4 <= ICORE) J=J+1
           IF (I5 <= ICORE) J=J+1
           IF (I6 <= ICORE) J=J+1
           IF (I7 <= ICORE) J=J+1
           IF (J /= ICORE) CYCLE
           J=0
           IF (I1 > NE) J=J+1
           IF (I2 > NE) J=J+1
           IF (I3 > NE) J=J+1
           IF (I4 > NE) J=J+1
           IF (I5 > NE) J=J+1
           IF (I6 > NE) J=J+1
           IF (I7 > NE) J=J+1
           IF (J > ORDER) CYCLE
           ICF=0
           ICF=IBSET(ICF,I1-1)
           ICF=IBSET(ICF,I2-1)
           ICF=IBSET(ICF,I3-1)
           ICF=IBSET(ICF,I4-1)
           ICF=IBSET(ICF,I5-1)
           ICF=IBSET(ICF,I6-1)
           ICF=IBSET(ICF,I7-1)
           I=I+1
           CFHALFA(I)=ICF
           NORDERA(I)=J
           ADDRSSA(ICF)=I
           K=0
           DO L=0,IALL(0,0,0)-IVIRTCORE-1
            IF (BTEST(ICF,L)) K=K+10**L
            IF (BTEST(ICF,L)) M=L
           ENDDO
!          WRITE(6,'(I6,A,I3,A,I6,A,I12)') I,' ORDER = ',J,' CF(NUM) = ',ICF,' CF(BIT) = ',K
          ENDDO
         ENDDO
        ENDDO
       ENDDO
      ENDDO
     ENDDO
    ENDDO
   ELSE IF (NE == 8) THEN
    DO I1=1,IALL(0,0,0)-IVIRTCORE-7
     DO I2=I1+1,IALL(0,0,0)-IVIRTCORE-6
      DO I3=I2+1,IALL(0,0,0)-IVIRTCORE-5
       DO I4=I3+1,IALL(0,0,0)-IVIRTCORE-4
        DO I5=I4+1,IALL(0,0,0)-IVIRTCORE-3
         DO I6=I5+1,IALL(0,0,0)-IVIRTCORE-2
          DO I7=I6+1,IALL(0,0,0)-IVIRTCORE-1
           DO I8=I7+1,IALL(0,0,0)-IVIRTCORE
            J=0
            IF (I1 <= ICORE) J=J+1
            IF (I2 <= ICORE) J=J+1
            IF (I3 <= ICORE) J=J+1
            IF (I4 <= ICORE) J=J+1
            IF (I5 <= ICORE) J=J+1
            IF (I6 <= ICORE) J=J+1
            IF (I7 <= ICORE) J=J+1
            IF (I8 <= ICORE) J=J+1
            IF (J /= ICORE) CYCLE
            J=0
            IF (I1 > NE) J=J+1
            IF (I2 > NE) J=J+1
            IF (I3 > NE) J=J+1
            IF (I4 > NE) J=J+1
            IF (I5 > NE) J=J+1
            IF (I6 > NE) J=J+1
            IF (I7 > NE) J=J+1
            IF (I8 > NE) J=J+1
            IF (J > ORDER) CYCLE
            ICF=0
            ICF=IBSET(ICF,I1-1)
            ICF=IBSET(ICF,I2-1)
            ICF=IBSET(ICF,I3-1)
            ICF=IBSET(ICF,I4-1)
            ICF=IBSET(ICF,I5-1)
            ICF=IBSET(ICF,I6-1)
            ICF=IBSET(ICF,I7-1)
            ICF=IBSET(ICF,I8-1)
            I=I+1
            CFHALFA(I)=ICF
            NORDERA(I)=J
            ADDRSSA(ICF)=I
            K=0
            DO L=0,IALL(0,0,0)-IVIRTCORE-1
             IF (BTEST(ICF,L)) K=K+10**L
             IF (BTEST(ICF,L)) M=L
            ENDDO
!           WRITE(6,'(I6,A,I3,A,I6,A,I12)') I,' ORDER = ',J,' CF(NUM) = ',ICF,' CF(BIT) = ',K
           ENDDO
          ENDDO
         ENDDO
        ENDDO
       ENDDO
      ENDDO
     ENDDO
    ENDDO
   ELSE
    CALL PABORT('NUMBER OF ELECTRONS IS TOO LARGE')
   ENDIF

   RETURN
END SUBROUTINE



SUBROUTINE THERMAL_GENERATE_CONFIGURATIONSB(NE,ORDER)
! GENERATE CONFIGURATIONS FOR BETA ELECTRONS

   USE CONTROL
   USE STRUCTURE
   USE INTEGRAL
   USE BASISSET
   USE THR_FULLCI
  
   IMPLICIT NONE
   INTEGER :: NE
   INTEGER :: ORDER
   INTEGER :: I,J,K,L,M
   INTEGER :: I1,I2,I3,I4,I5,I6,I7,I8
   INTEGER(4) :: ICF
   INTEGER :: COMBINATION
   
   IF (ICORE > 0) WRITE(6,'(A,I3,A)') '***** WARNING : ',ICORE,' CORE BETA ORBITALS ARE ALWAYS OCCUPIED'
   IF (IVIRTCORE > 0) WRITE(6,'(A,I3,A)') '***** WARNING : ',IVIRTCORE,' HIGHEST VIRTUAL BETA ORBITALS ARE ALWAYS UNOCCUPIED'
!  WRITE(6,'(A,I3,A,I3,A)') '  THERE ARE ',NE-ICORE,' ACTIVE BETA ELECTRONS IN ',IALL(0,0,0)-ICORE-IVIRTCORE,' ACTIVE ORBITALS'
   NCFB=0
   DO I=0,ORDER
    J=COMBINATION(NE-ICORE,NE-ICORE-I)*COMBINATION(IALL(0,0,0)-NE-IVIRTCORE,I)
!   WRITE(6,'(I4,A,I7)') I,' EXCITATION CONFIGURATIONS ',J
    NCFB=NCFB+J
   ENDDO
!  WRITE(6,'(A,I7)') '    TOTAL ALPHA CONFIGURATIONS ',NCFB
   IF (NCFB /= COMBINATION(IALL(0,0,0)-ICORE-IVIRTCORE,NE-ICORE)) CALL PABORT('AN ERROR OCCURRED IN COMBINATION FUNCTION')

   ALLOCATE(CFHALFB(NCFB),NORDERB(NCFB),ADDRSSB(0:2**(IALLMAX-IVIRTCORE)))
 
   ADDRSSB=0
   I=0
   IF (NE == 0) THEN
    ICF=0
    I=I+1
    J=0
    CFHALFB(I)=ICF
    NORDERB(I)=J
    ADDRSSB(ICF)=I
    K=0
    M=0
    DO L=0,IALL(0,0,0)-IVIRTCORE-1
     IF (BTEST(ICF,L)) K=K+10**L
     IF (BTEST(ICF,L)) M=L
    ENDDO
!   WRITE(6,'(I6,A,I3,A,I6,A,I12)') I,' ORDER = ',J,' CF(NUM) = ',ICF,' CF(BIT) = ',K
   ELSE IF (NE == 1) THEN
    DO I1=1,IALL(0,0,0)-IVIRTCORE
     J=0
     IF (I1 <= ICORE) J=J+1
     IF (J /= ICORE) CYCLE
     J=0
     IF (I1 > NE) J=J+1
     IF (J > ORDER) CYCLE
     ICF=0
     ICF=IBSET(ICF,I1-1)
     I=I+1
     CFHALFB(I)=ICF
     NORDERB(I)=J
     ADDRSSB(ICF)=I
     K=0
     DO L=0,IALL(0,0,0)-IVIRTCORE-1
      IF (BTEST(ICF,L)) K=K+10**L
      IF (BTEST(ICF,L)) M=L
     ENDDO
!    WRITE(6,'(I6,A,I3,A,I6,A,I12)') I,' ORDER = ',J,' CF(NUM) = ',ICF,' CF(BIT) = ',K
    ENDDO
   ELSE IF (NE == 2) THEN
    DO I1=1,IALL(0,0,0)-IVIRTCORE-1
     DO I2=I1+1,IALL(0,0,0)-IVIRTCORE
      J=0
      IF (I1 <= ICORE) J=J+1
      IF (I2 <= ICORE) J=J+1
      IF (J /= ICORE) CYCLE
      J=0
      IF (I1 > NE) J=J+1
      IF (I2 > NE) J=J+1
      IF (J > ORDER) CYCLE
      ICF=0
      ICF=IBSET(ICF,I1-1)
      ICF=IBSET(ICF,I2-1)
      I=I+1
      CFHALFB(I)=ICF
      NORDERB(I)=J
      ADDRSSB(ICF)=I
      K=0
      DO L=0,IALL(0,0,0)-IVIRTCORE-1
       IF (BTEST(ICF,L)) K=K+10**L
       IF (BTEST(ICF,L)) M=L
      ENDDO
!     WRITE(6,'(I6,A,I3,A,I6,A,I12)') I,' ORDER = ',J,' CF(NUM) = ',ICF,' CF(BIT) = ',K
     ENDDO
    ENDDO
   ELSE IF (NE == 3) THEN
    DO I1=1,IALL(0,0,0)-IVIRTCORE-2
     DO I2=I1+1,IALL(0,0,0)-IVIRTCORE-1
      DO I3=I2+1,IALL(0,0,0)-IVIRTCORE
       J=0
       IF (I1 <= ICORE) J=J+1
       IF (I2 <= ICORE) J=J+1
       IF (I3 <= ICORE) J=J+1
       IF (J /= ICORE) CYCLE
       J=0
       IF (I1 > NE) J=J+1
       IF (I2 > NE) J=J+1
       IF (I3 > NE) J=J+1
       IF (J > ORDER) CYCLE
       ICF=0
       ICF=IBSET(ICF,I1-1)
       ICF=IBSET(ICF,I2-1)
       ICF=IBSET(ICF,I3-1)
       I=I+1
       CFHALFB(I)=ICF
       NORDERB(I)=J
       ADDRSSB(ICF)=I
       K=0
       DO L=0,IALL(0,0,0)-IVIRTCORE-1
        IF (BTEST(ICF,L)) K=K+10**L
        IF (BTEST(ICF,L)) M=L
       ENDDO
!      WRITE(6,'(I6,A,I3,A,I6,A,I12)') I,' ORDER = ',J,' CF(NUM) = ',ICF,' CF(BIT) = ',K
      ENDDO
     ENDDO
    ENDDO
   ELSE IF (NE == 4) THEN
    DO I1=1,IALL(0,0,0)-IVIRTCORE-3
     DO I2=I1+1,IALL(0,0,0)-IVIRTCORE-2
      DO I3=I2+1,IALL(0,0,0)-IVIRTCORE-1
       DO I4=I3+1,IALL(0,0,0)-IVIRTCORE
        J=0
        IF (I1 <= ICORE) J=J+1
        IF (I2 <= ICORE) J=J+1
        IF (I3 <= ICORE) J=J+1
        IF (I4 <= ICORE) J=J+1
        IF (J /= ICORE) CYCLE
        J=0
        IF (I1 > NE) J=J+1
        IF (I2 > NE) J=J+1
        IF (I3 > NE) J=J+1
        IF (I4 > NE) J=J+1
        IF (J > ORDER) CYCLE
        ICF=0
        ICF=IBSET(ICF,I1-1)
        ICF=IBSET(ICF,I2-1)
        ICF=IBSET(ICF,I3-1)
        ICF=IBSET(ICF,I4-1)
        I=I+1
        CFHALFB(I)=ICF
        NORDERB(I)=J
        ADDRSSB(ICF)=I
        K=0
        DO L=0,IALL(0,0,0)-IVIRTCORE-1
         IF (BTEST(ICF,L)) K=K+10**L
         IF (BTEST(ICF,L)) M=L
        ENDDO
!       WRITE(6,'(I6,A,I3,A,I6,A,I12)') I,' ORDER = ',J,' CF(NUM) = ',ICF,' CF(BIT) = ',K
       ENDDO
      ENDDO
     ENDDO
    ENDDO
   ELSE IF (NE == 5) THEN
    DO I1=1,IALL(0,0,0)-IVIRTCORE-4
     DO I2=I1+1,IALL(0,0,0)-IVIRTCORE-3
      DO I3=I2+1,IALL(0,0,0)-IVIRTCORE-2
       DO I4=I3+1,IALL(0,0,0)-IVIRTCORE-1
        DO I5=I4+1,IALL(0,0,0)-IVIRTCORE
         J=0
         IF (I1 <= ICORE) J=J+1
         IF (I2 <= ICORE) J=J+1
         IF (I3 <= ICORE) J=J+1
         IF (I4 <= ICORE) J=J+1
         IF (I5 <= ICORE) J=J+1
         IF (J /= ICORE) CYCLE
         J=0
         IF (I1 > NE) J=J+1
         IF (I2 > NE) J=J+1
         IF (I3 > NE) J=J+1
         IF (I4 > NE) J=J+1
         IF (I5 > NE) J=J+1
         IF (J > ORDER) CYCLE
         ICF=0
         ICF=IBSET(ICF,I1-1)
         ICF=IBSET(ICF,I2-1)
         ICF=IBSET(ICF,I3-1)
         ICF=IBSET(ICF,I4-1)
         ICF=IBSET(ICF,I5-1)
         I=I+1
         CFHALFB(I)=ICF
         NORDERB(I)=J
         ADDRSSB(ICF)=I
         K=0
         DO L=0,IALL(0,0,0)-IVIRTCORE-1
          IF (BTEST(ICF,L)) K=K+10**L
          IF (BTEST(ICF,L)) M=L
         ENDDO
!        WRITE(6,'(I6,A,I3,A,I6,A,I12)') I,' ORDER = ',J,' CF(NUM) = ',ICF,' CF(BIT) = ',K
        ENDDO
       ENDDO
      ENDDO
     ENDDO
    ENDDO
   ELSE IF (NE == 6) THEN
    DO I1=1,IALL(0,0,0)-IVIRTCORE-5
     DO I2=I1+1,IALL(0,0,0)-IVIRTCORE-4
      DO I3=I2+1,IALL(0,0,0)-IVIRTCORE-3
       DO I4=I3+1,IALL(0,0,0)-IVIRTCORE-2
        DO I5=I4+1,IALL(0,0,0)-IVIRTCORE-1
         DO I6=I5+1,IALL(0,0,0)-IVIRTCORE
          J=0
          IF (I1 <= ICORE) J=J+1
          IF (I2 <= ICORE) J=J+1
          IF (I3 <= ICORE) J=J+1
          IF (I4 <= ICORE) J=J+1
          IF (I5 <= ICORE) J=J+1
          IF (I6 <= ICORE) J=J+1
          IF (J /= ICORE) CYCLE
          J=0
          IF (I1 > NE) J=J+1
          IF (I2 > NE) J=J+1
          IF (I3 > NE) J=J+1
          IF (I4 > NE) J=J+1
          IF (I5 > NE) J=J+1
          IF (I6 > NE) J=J+1
          IF (J > ORDER) CYCLE
          ICF=0
          ICF=IBSET(ICF,I1-1)
          ICF=IBSET(ICF,I2-1)
          ICF=IBSET(ICF,I3-1)
          ICF=IBSET(ICF,I4-1)
          ICF=IBSET(ICF,I5-1)
          ICF=IBSET(ICF,I6-1)
          I=I+1
          CFHALFB(I)=ICF
          NORDERB(I)=J
          ADDRSSB(ICF)=I
          K=0
          DO L=0,IALL(0,0,0)-IVIRTCORE-1
           IF (BTEST(ICF,L)) K=K+10**L
           IF (BTEST(ICF,L)) M=L
          ENDDO
!         WRITE(6,'(I6,A,I3,A,I6,A,I12)') I,' ORDER = ',J,' CF(NUM) = ',ICF,' CF(BIT) = ',K
         ENDDO
        ENDDO
       ENDDO
      ENDDO
     ENDDO
    ENDDO
   ELSE IF (NE == 7) THEN
    DO I1=1,IALL(0,0,0)-IVIRTCORE-6
     DO I2=I1+1,IALL(0,0,0)-IVIRTCORE-5
      DO I3=I2+1,IALL(0,0,0)-IVIRTCORE-4
       DO I4=I3+1,IALL(0,0,0)-IVIRTCORE-3
        DO I5=I4+1,IALL(0,0,0)-IVIRTCORE-2
         DO I6=I5+1,IALL(0,0,0)-IVIRTCORE-1
          DO I7=I6+1,IALL(0,0,0)-IVIRTCORE
           J=0
           IF (I1 <= ICORE) J=J+1
           IF (I2 <= ICORE) J=J+1
           IF (I3 <= ICORE) J=J+1
           IF (I4 <= ICORE) J=J+1
           IF (I5 <= ICORE) J=J+1
           IF (I6 <= ICORE) J=J+1
           IF (I7 <= ICORE) J=J+1
           IF (J /= ICORE) CYCLE
           J=0
           IF (I1 > NE) J=J+1
           IF (I2 > NE) J=J+1
           IF (I3 > NE) J=J+1
           IF (I4 > NE) J=J+1
           IF (I5 > NE) J=J+1
           IF (I6 > NE) J=J+1
           IF (I7 > NE) J=J+1
           IF (J > ORDER) CYCLE
           ICF=0
           ICF=IBSET(ICF,I1-1)
           ICF=IBSET(ICF,I2-1)
           ICF=IBSET(ICF,I3-1)
           ICF=IBSET(ICF,I4-1)
           ICF=IBSET(ICF,I5-1)
           ICF=IBSET(ICF,I6-1)
           ICF=IBSET(ICF,I7-1)
           I=I+1
           CFHALFB(I)=ICF
           NORDERB(I)=J
           ADDRSSB(ICF)=I
           K=0
           DO L=0,IALL(0,0,0)-IVIRTCORE-1
            IF (BTEST(ICF,L)) K=K+10**L
            IF (BTEST(ICF,L)) M=L
           ENDDO
!          WRITE(6,'(I6,A,I3,A,I6,A,I12)') I,' ORDER = ',J,' CF(NUM) = ',ICF,' CF(BIT) = ',K
          ENDDO
         ENDDO
        ENDDO
       ENDDO
      ENDDO
     ENDDO
    ENDDO
   ELSE IF (NE == 8) THEN
    DO I1=1,IALL(0,0,0)-IVIRTCORE-7
     DO I2=I1+1,IALL(0,0,0)-IVIRTCORE-6
      DO I3=I2+1,IALL(0,0,0)-IVIRTCORE-5
       DO I4=I3+1,IALL(0,0,0)-IVIRTCORE-4
        DO I5=I4+1,IALL(0,0,0)-IVIRTCORE-3
         DO I6=I5+1,IALL(0,0,0)-IVIRTCORE-2
          DO I7=I6+1,IALL(0,0,0)-IVIRTCORE-1
           DO I8=I7+1,IALL(0,0,0)-IVIRTCORE
            J=0
            IF (I1 <= ICORE) J=J+1
            IF (I2 <= ICORE) J=J+1
            IF (I3 <= ICORE) J=J+1
            IF (I4 <= ICORE) J=J+1
            IF (I5 <= ICORE) J=J+1
            IF (I6 <= ICORE) J=J+1
            IF (I7 <= ICORE) J=J+1
            IF (I8 <= ICORE) J=J+1
            IF (J /= ICORE) CYCLE
            J=0
            IF (I1 > NE) J=J+1
            IF (I2 > NE) J=J+1
            IF (I3 > NE) J=J+1
            IF (I4 > NE) J=J+1
            IF (I5 > NE) J=J+1
            IF (I6 > NE) J=J+1
            IF (I7 > NE) J=J+1
            IF (I8 > NE) J=J+1
            IF (J > ORDER) CYCLE
            ICF=0
            ICF=IBSET(ICF,I1-1)
            ICF=IBSET(ICF,I2-1)
            ICF=IBSET(ICF,I3-1)
            ICF=IBSET(ICF,I4-1)
            ICF=IBSET(ICF,I5-1)
            ICF=IBSET(ICF,I6-1)
            ICF=IBSET(ICF,I7-1)
            ICF=IBSET(ICF,I8-1)
            I=I+1
            CFHALFB(I)=ICF
            NORDERB(I)=J
            ADDRSSB(ICF)=I
            K=0
            DO L=0,IALL(0,0,0)-IVIRTCORE-1
             IF (BTEST(ICF,L)) K=K+10**L
             IF (BTEST(ICF,L)) M=L
            ENDDO
!           WRITE(6,'(I6,A,I3,A,I6,A,I12)') I,' ORDER = ',J,' CF(NUM) = ',ICF,' CF(BIT) = ',K
           ENDDO
          ENDDO
         ENDDO
        ENDDO
       ENDDO
      ENDDO
     ENDDO
    ENDDO
   ELSE
    CALL PABORT('NUMBER OF ELECTRONS IS TOO LARGE')
   ENDIF

   RETURN
END SUBROUTINE



SUBROUTINE THERMAL_HAMILTONIAN_PRODUCT(INFILE,OUTFILE,OFFSET,LAMBDA)
! FORM THE PRODUCT OF HAMILTONIAN MATRIX AND A TRIAL VECTOR IN INFILE
! AND STORE THE PRODUCT VECTOR IN OUTFILE.  THE ORDER LIMITS THE NUMBER
! EXCITATION IN THE CONFIGURATIONS CONSIDERED.

   USE CONTROL
   USE STRUCTURE
   USE INTEGRAL
   USE BASISSET
   USE THR_FULLCI

   IMPLICIT NONE
   DOUBLE PRECISION :: LAMBDA
   INTEGER :: INFILE,OUTFILE,OFFSET
   INTEGER :: ISIGN,JSIGN
   INTEGER :: I,J,K,L,M
   INTEGER :: IA,IB,IC,ID
   INTEGER :: NIA,NIB,NJA,NJB
   INTEGER(4) :: CFONE,CFTWO
   REAL :: MEM,ICPUS,ICPUE,EST
   DOUBLE PRECISION :: X,Y
   DOUBLE PRECISION,ALLOCATABLE :: TRL(:,:),PRD(:,:)
   INTEGER,ALLOCATABLE :: PSIGNB(:,:,:),PADRSB(:,:,:)
integer :: ibsave,iasave

   CALL CPU_TIME(ICPUS)
   MEM=16.0*2.0*NCFA*NCFB+4.0*(NCFA+NCFB)*(IALL(0,0,0)-IVIRTCORE)**2
!  IF (MEM > 1000000.0) THEN
!   WRITE(6,'(A,F7.1,A)') 'ESTIMATED MEMORY USAGE WILL BE ',MEM/1000000.0,' MB'
!  ELSE IF (MEM > 1000.0) THEN
!   WRITE(6,'(A,F7.1,A)') 'ESTIMATED MEMORY USAGE WILL BE ',MEM/1000.0,' KB'
!  ELSE
!   WRITE(6,'(A,F7.1,A)') 'ESTIMATED MEMORY USAGE WILL BE ',MEM,' B'
!  ENDIF
   IF (MEM > DOPTN(28)*1000000.0) CALL PABORT('OUT OF MEMORY')

   ALLOCATE(TRL(NCFB,NCFA),PRD(NCFB,NCFA))
   ALLOCATE(PSIGNB(IALLMAX-IVIRTCORE,IALLMAX-IVIRTCORE,NCFB),PADRSB(IALLMAX-IVIRTCORE,IALLMAX-IVIRTCORE,NCFB))

   ! READ TRIAL VECTOR FROM FILE INFILE
   REWIND(INFILE)
   DO I=0,OFFSET
    READ(INFILE) TRL
   ENDDO

   ! ZERO SCRATCH PRODUCT VECTOR
   PRD=0.0D0

   ! H0
   DO IA=1,NCFA
    DO IB=1,NCFB
     DO I=1,IALL(0,0,0)-IVIRTCORE
      IF (BTEST(CFHALFA(IA),I-1)) PRD(IB,IA)=PRD(IB,IA)+EPSILON(I,0,0,0)*TRL(IB,IA)
      IF (BTEST(CFHALFB(IB),I-1)) PRD(IB,IA)=PRD(IB,IA)+EPSILON(I,0,0,0)*TRL(IB,IA)
     ENDDO
    ENDDO
   ENDDO

   ! H1 DIAGONAL ELEMENTS
   DO IA=1,NCFA
    DO IB=1,NCFB
     DO I=1,IALL(0,0,0)-IVIRTCORE
      IF (BTEST(CFHALFA(IA),I-1)) PRD(IB,IA)=PRD(IB,IA)+LAMBDA*(H(I,I)-EPSILON(I,0,0,0))*TRL(IB,IA)
      IF (BTEST(CFHALFB(IB),I-1)) PRD(IB,IA)=PRD(IB,IA)+LAMBDA*(H(I,I)-EPSILON(I,0,0,0))*TRL(IB,IA)
     ENDDO
    ENDDO
   ENDDO
   DO IA=1,NCFA
    DO IB=1,NCFB
     DO I=1,IALL(0,0,0)-IVIRTCORE
      DO J=1,IALL(0,0,0)-IVIRTCORE
       IF (BTEST(CFHALFA(IA),I-1)) THEN
        NIA=1
       ELSE
        NIA=0
       ENDIF
       IF (BTEST(CFHALFA(IA),J-1)) THEN
        NJA=1
       ELSE
        NJA=0
       ENDIF
       IF (BTEST(CFHALFB(IB),I-1)) THEN
        NIB=1
       ELSE
        NIB=0
       ENDIF
       IF (BTEST(CFHALFB(IB),J-1)) THEN
        NJB=1
       ELSE
        NJB=0
       ENDIF
       PRD(IB,IA)=PRD(IB,IA)+LAMBDA*0.5D0*(DFLOAT((NJA+NJB)*(NIA+NIB))*G(J,J,I,I) &
                 -DFLOAT(NJA*NIA+NJB*NIB)*G(J,I,I,J))*TRL(IB,IA)
      ENDDO
     ENDDO
    ENDDO
   ENDDO

   ! ONE SPIN ORBITAL DIFFERENCE
   DO IA=1,NCFA
    DO I=ICORE+1,IALL(0,0,0)-IVIRTCORE
     IF (BTEST(CFHALFA(IA),I-1)) THEN
      DO K=1,IALL(0,0,0)-IVIRTCORE
       IF (.NOT.(BTEST(CFHALFA(IA),K-1))) THEN
        CFONE=IBCLR(CFHALFA(IA),I-1)
        CFONE=IBSET(CFONE,K-1)
        IC=ADDRSSA(CFONE)
        X=H(K,I)
        DO J=1,IALL(0,0,0)-IVIRTCORE
         IF ((J /= I).AND.(J /= K).AND.(BTEST(CFONE,J-1))) X=X+G(K,I,J,J)-G(K,J,J,I)
        ENDDO
        ISIGN=1
        DO J=1,I
         IF (BTEST(CFHALFA(IA),J-1)) ISIGN=-ISIGN
        ENDDO
        DO J=1,K
         IF (BTEST(CFONE,J-1)) ISIGN=-ISIGN
        ENDDO
        DO IB=1,NCFB
         IF (DABS(TRL(IB,IA)) > 1.0D-15) THEN
          Y=0.0D0
          DO J=1,IALL(0,0,0)-IVIRTCORE
           IF (BTEST(CFHALFB(IB),J-1)) Y=Y+G(K,I,J,J)
          ENDDO
          PRD(IB,IC)=PRD(IB,IC)+LAMBDA*(X+Y)*DFLOAT(ISIGN)*TRL(IB,IA)
         ENDIF
        ENDDO
       ENDIF
      ENDDO
     ENDIF
    ENDDO
   ENDDO
   DO IB=1,NCFB
    DO I=ICORE+1,IALL(0,0,0)-IVIRTCORE
     IF (BTEST(CFHALFB(IB),I-1)) THEN
      DO K=1,IALL(0,0,0)-IVIRTCORE
       IF (.NOT.(BTEST(CFHALFB(IB),K-1))) THEN
        CFONE=IBCLR(CFHALFB(IB),I-1)
        CFONE=IBSET(CFONE,K-1)
        IC=ADDRSSB(CFONE)
        X=H(K,I)
        DO J=1,IALL(0,0,0)-IVIRTCORE
         IF ((J /= I).AND.(J /= K).AND.(BTEST(CFONE,J-1))) X=X+G(K,I,J,J)-G(K,J,J,I)
        ENDDO
        ISIGN=1
        DO J=1,I
         IF (BTEST(CFHALFB(IB),J-1)) ISIGN=-ISIGN
        ENDDO
        DO J=1,K
         IF (BTEST(CFONE,J-1)) ISIGN=-ISIGN
        ENDDO
        DO IA=1,NCFA
         IF (DABS(TRL(IB,IA)) > 1.0D-15) THEN
          Y=0.0D0
          DO J=1,IALL(0,0,0)-IVIRTCORE
           IF (BTEST(CFHALFA(IA),J-1)) Y=Y+G(K,I,J,J)
          ENDDO
          PRD(IC,IA)=PRD(IC,IA)+LAMBDA*(X+Y)*DFLOAT(ISIGN)*TRL(IB,IA)
         ENDIF
        ENDDO
       ENDIF
      ENDDO
     ENDIF
    ENDDO
   ENDDO

   ! TWO SPIN ORBITAL DIFFERENCES, CASE 1
   DO IA=1,NCFA
    DO I=ICORE+1,IALL(0,0,0)-IVIRTCORE-1
     IF (BTEST(CFHALFA(IA),I-1)) THEN
      DO J=I+1,IALL(0,0,0)-IVIRTCORE
       IF (BTEST(CFHALFA(IA),J-1)) THEN
        DO K=1,IALL(0,0,0)-IVIRTCORE-1
         IF (.NOT.(BTEST(CFHALFA(IA),K-1))) THEN
          DO L=K+1,IALL(0,0,0)-IVIRTCORE
           IF (.NOT.(BTEST(CFHALFA(IA),L-1))) THEN
            CFTWO=IBCLR(CFHALFA(IA),I-1)
            CFTWO=IBCLR(CFTWO,J-1)
            CFTWO=IBSET(CFTWO,K-1)
            CFTWO=IBSET(CFTWO,L-1)
            IC=ADDRSSA(CFTWO)
            ISIGN=1
            DO M=1,I
             IF (BTEST(CFHALFA(IA),M-1)) ISIGN=-ISIGN
            ENDDO
            DO M=1,J
             IF (BTEST(CFHALFA(IA),M-1)) ISIGN=-ISIGN
            ENDDO
            DO M=1,K
             IF (BTEST(CFTWO,M-1)) ISIGN=-ISIGN
            ENDDO
            DO M=1,L
             IF (BTEST(CFTWO,M-1)) ISIGN=-ISIGN
            ENDDO
            Y=DFLOAT(ISIGN)*(G(K,I,L,J)-G(K,J,L,I))
            DO IB=1,NCFB
             PRD(IB,IC)=PRD(IB,IC)+LAMBDA*Y*TRL(IB,IA)
            ENDDO
           ENDIF
          ENDDO
         ENDIF
        ENDDO
       ENDIF
      ENDDO
     ENDIF
    ENDDO
   ENDDO
   DO IB=1,NCFB
    DO I=ICORE+1,IALL(0,0,0)-IVIRTCORE-1
     IF (BTEST(CFHALFB(IB),I-1)) THEN
      DO J=I+1,IALL(0,0,0)-IVIRTCORE
       IF (BTEST(CFHALFB(IB),J-1)) THEN
        DO K=1,IALL(0,0,0)-IVIRTCORE-1
         IF (.NOT.(BTEST(CFHALFB(IB),K-1))) THEN
          DO L=K+1,IALL(0,0,0)-IVIRTCORE
           IF (.NOT.(BTEST(CFHALFB(IB),L-1))) THEN
            CFTWO=IBCLR(CFHALFB(IB),I-1)
            CFTWO=IBCLR(CFTWO,J-1)
            CFTWO=IBSET(CFTWO,K-1)
            CFTWO=IBSET(CFTWO,L-1)
            IC=ADDRSSB(CFTWO)
            ISIGN=1
            DO M=1,I
             IF (BTEST(CFHALFB(IB),M-1)) ISIGN=-ISIGN
            ENDDO
            DO M=1,J
             IF (BTEST(CFHALFB(IB),M-1)) ISIGN=-ISIGN
            ENDDO
            DO M=1,K
             IF (BTEST(CFTWO,M-1)) ISIGN=-ISIGN
            ENDDO
            DO M=1,L
             IF (BTEST(CFTWO,M-1)) ISIGN=-ISIGN
            ENDDO
            Y=DFLOAT(ISIGN)*(G(K,I,L,J)-G(K,J,L,I))
            DO IA=1,NCFA
             PRD(IC,IA)=PRD(IC,IA)+LAMBDA*Y*TRL(IB,IA)
            ENDDO
           ENDIF
          ENDDO
         ENDIF
        ENDDO
       ENDIF
      ENDDO
     ENDIF
    ENDDO
   ENDDO
!  CALL CPU_TIME(ICPUE)
!  EST=ICPUE-ICPUS
!  CALL CPU_TIME(ICPUS)

   ! TWO SPIN ORBITAL DIFFERENCES, CASE 2
   DO IB=1,NCFB
    DO K=ICORE+1,IALL(0,0,0)-IVIRTCORE
     DO L=1,IALL(0,0,0)-IVIRTCORE
      PSIGNB(L,K,IB)=0
      PADRSB(L,K,IB)=0
      IF ((BTEST(CFHALFB(IB),K-1)).AND.(.NOT.(BTEST(CFHALFB(IB),L-1)))) THEN
       CFONE=IBCLR(CFHALFB(IB),K-1)
       CFONE=IBSET(CFONE,L-1)
       PADRSB(L,K,IB)=ADDRSSB(CFONE)
       JSIGN=1
       DO M=1,K
        IF (BTEST(CFHALFB(IB),M-1)) JSIGN=-JSIGN
       ENDDO
       DO M=1,L
        IF (BTEST(CFONE,M-1)) JSIGN=-JSIGN
       ENDDO
       PSIGNB(L,K,IB)=JSIGN
      ENDIF
     ENDDO
    ENDDO
   ENDDO
   DO IA=1,NCFA
    DO I=ICORE+1,IALL(0,0,0)-IVIRTCORE
     DO J=1,IALL(0,0,0)-IVIRTCORE
      IF ((BTEST(CFHALFA(IA),I-1)).AND.(.NOT.(BTEST(CFHALFA(IA),J-1)))) THEN
       CFONE=IBCLR(CFHALFA(IA),I-1)
       CFONE=IBSET(CFONE,J-1)
       IC=ADDRSSA(CFONE)
       ISIGN=1
       DO K=1,I
        IF (BTEST(CFHALFA(IA),K-1)) ISIGN=-ISIGN
       ENDDO
       DO K=1,J
        IF (BTEST(CFONE,K-1)) ISIGN=-ISIGN
       ENDDO
       DO IB=1,NCFB
        IF (DABS(TRL(IB,IA)) > 1.0D-15) THEN
         DO K=ICORE+1,IALL(0,0,0)-IVIRTCORE
          DO L=1,IALL(0,0,0)-IVIRTCORE
           IF (PADRSB(L,K,IB) /= 0) PRD(PADRSB(L,K,IB),IC)=PRD(PADRSB(L,K,IB),IC)+LAMBDA*DFLOAT(ISIGN*PSIGNB(L,K,IB)) &
                                                          *G(J,I,L,K)*TRL(IB,IA)
          ENDDO
         ENDDO
        ENDIF
       ENDDO
      ENDIF
     ENDDO
    ENDDO
!   CALL CPU_TIME(ICPUE)
!   IF (IA == 1) THEN
!    EST=EST+(ICPUE-ICPUS)*NCF
!    EST=EST/3600.0
!    IF (EST > 0.1) WRITE(6,'(A,F20.1,A)') '***** WARNING : ESTIMATED PRODUCT FORMATION TIME = ',EST,' HOURS'
!   ENDIF
   ENDDO

   ! STORE PRODUCT VECTOR
   REWIND(OUTFILE)
   IF (OFFSET == 0) THEN
    WRITE(OUTFILE) PRD
   ELSE
    DO I=1,OFFSET
     READ(OUTFILE) TRL
    ENDDO
    WRITE(OUTFILE) PRD
   ENDIF

   DEALLOCATE(TRL,PRD,PSIGNB,PADRSB)

   RETURN
END SUBROUTINE



SUBROUTINE THERMAL_FULL_CI(LAMBDA,N)
! FORM FULL HAMILTONIAN AND DIAGONALIZE IT FOR ALL EIGENVALUES.

   USE CONTROL
   USE GRADIENT
   USE STRUCTURE
   USE INTEGRAL
   USE BASISSET
   USE THR_FULLCI

   IMPLICIT NONE
   DOUBLE PRECISION :: LAMBDA
   INTEGER :: N
   LOGICAL,PARAMETER :: LEVEC = .FALSE.
   INTEGER :: IA,IB,IC,ID
   INTEGER :: INFO
   REAL :: MEM,DEV
   DOUBLE PRECISION,ALLOCATABLE :: HAM(:,:)
   DOUBLE PRECISION,ALLOCATABLE :: VL(:,:),VR(:,:),ER(:),EI(:),WK(:)
   DOUBLE PRECISION,ALLOCATABLE :: TRL(:,:)

   IF (LEVEC) THEN
    MEM=16.0*(2.0*NCFA*NCFB*NCFA*NCFB+8.0*NCFA*NCFB)
   ELSE
    MEM=16.0*(NCFA*NCFB*NCFA*NCFB+9.0*NCFA*NCFB)
   ENDIF
!  IF (MEM > 1000000.0) THEN
!   WRITE(6,'(A,F7.1,A)') 'ESTIMATED MEMORY USAGE WILL BE ',MEM/1000000.0,' MB'
!  ELSE IF (MEM > 1000.0) THEN
!   WRITE(6,'(A,F7.1,A)') 'ESTIMATED MEMORY USAGE WILL BE ',MEM/1000.0,' KB'
!  ELSE
!   WRITE(6,'(A,F7.1,A)') 'ESTIMATED MEMORY USAGE WILL BE ',MEM,' B'
!  ENDIF
   IF (MEM > DOPTN(28)*1000000.0) CALL PABORT('OUT OF MEMORY')
   ALLOCATE(HAM(NCFA*NCFB,NCFA*NCFB),VL(1,NCFA*NCFB),ER(NCFA*NCFB),EI(NCFA*NCFB),WK(4*NCFA*NCFB))
   IF (LEVEC) THEN
    ALLOCATE(VR(NCFA*NCFB,NCFA*NCFB))
   ELSE
    ALLOCATE(VR(1,NCFA*NCFB))
   ENDIF
   ALLOCATE(TRL(NCFB,NCFA))

   OPEN(50,FILE=TRIM(COPTN(1))//'.fi0',FORM='UNFORMATTED')
   OPEN(60,FILE=TRIM(COPTN(1))//'.fo0',FORM='UNFORMATTED')

   ! FORM HAMILTONIAN AND KEEP IT IN MEMORY
   DO IA=1,NCFA
    DO IB=1,NCFB
     TRL=0.0D0
     TRL(IB,IA)=1.0D0
     REWIND(50)
     WRITE(50) TRL
     CALL THERMAL_HAMILTONIAN_PRODUCT(50,60,0,LAMBDA)
     REWIND(60)
     READ(60) TRL
     DO IC=1,NCFA
      DO ID=1,NCFB
       HAM((IA-1)*NCFB+IB,(IC-1)*NCFB+ID)=TRL(ID,IC)
      ENDDO
     ENDDO
    ENDDO
   ENDDO
!  CALL DUMP5(HAM,NCFA*NCFB)

   IC=N
   DO IA=1,NCFA
    DO IB=1,NCFB
     IC=IC+1
!    WRITE(6,'(A,I3,A,F20.15,A,2I5)') 'STATE ',IC,' DIAGONAL = ', HAM((IA-1)*NCFB+IB,(IA-1)*NCFB+IB)+NUCLEAR_REPULSION,&
!                                     ' HARTREE',CFHALFA(IA),CFHALFB(IB)
    ENDDO
   ENDDO

   DEALLOCATE(TRL)
   CLOSE(50)
   CLOSE(60)

   ! DIAGONALIZE HAMILTONIAN
   IF (LEVEC) THEN
    CALL DGEEV('N','V',NCFA*NCFB,HAM,NCFA*NCFB,ER,EI,VL,1,VR,NCFA*NCFB,WK,4*NCFA*NCFB,INFO)
    IF (INFO /= 0) CALL PABORT('DGEEV FAILED TO DIAGONALIZE A MATRIX')
    DEV=0.0D0
    DO IA=1,NCFA*NCFB
     DEV=DEV+EI(IA)**2
    ENDDO
    IF (DEV > 1.0E-5) THEN
     CALL WARNING('THE IMAGINARY PART OF THE EIGENVALUES IS NOT ZERO')
     WRITE(6,'(A,F20.10)') 'DEVIATION = ',DEV
    ENDIF
    CALL PIKSRT(NCFA*NCFB,NCFA*NCFB,ER,VR,EI)
    DO IA=1,NCFA*NCFB
!    WRITE(6,'(A,I3,A,F20.15,A)') 'STATE ',N+IA,' ENERGY = ', ER(IA)+NUCLEAR_REPULSION,' HARTREE'
     DO IB=1,NCFA*NCFB
!     WRITE(6,'(I10,F20.15)') IB,VR(IB,IA)
     ENDDO
    ENDDO
    DO IA=1,NCFA*NCFB
     ALLE(N+IA)=ER(IA)+NUCLEAR_REPULSION
    ENDDO
    DO IA=1,NCFA*NCFB
!    WRITE(6,'(A,I3,A,F20.15,A)') 'STATE ',N+IA,' ENERGY = ', ER(IA)+NUCLEAR_REPULSION,' HARTREE'
    ENDDO
   ELSE
    CALL DGEEV('N','N',NCFA*NCFB,HAM,NCFA*NCFB,ER,EI,VL,1,VR,1,WK,4*NCFA*NCFB,INFO)
    IF (INFO /= 0) CALL PABORT('DGEEV FAILED TO DIAGONALIZE A MATRIX')
    DEV=0.0D0
    DO IA=1,NCFA*NCFB
     DEV=DEV+EI(IA)**2
    ENDDO
    IF (DEV > 1.0E-5) THEN
     CALL WARNING('THE IMAGINARY PART OF THE EIGENVALUES IS NOT ZERO')
     WRITE(6,'(A,F20.10)') 'DEVIATION = ',DEV
    ENDIF
    CALL PIKSRT_EVALONLY(NCFA*NCFB,ER)
    DO IA=1,NCFA*NCFB
     ALLE(N+IA)=ER(IA)+NUCLEAR_REPULSION
    ENDDO
    DO IA=1,NCFA*NCFB
!    WRITE(6,'(A,I3,A,F20.15,A)') 'STATE ',N+IA,' ENERGY = ', ER(IA)+NUCLEAR_REPULSION,' HARTREE'
    ENDDO
   ENDIF
   CALL PFLUSH(6)

   DEALLOCATE(HAM,VL,VR,ER,EI,WK)

   RETURN
END SUBROUTINE



SUBROUTINE THERMAL_ONE_ELECTRON_INTEGRALS
! FORM ONE ELECTRON PART OF THE HAMILTONIAN MATRIX.

   USE CONTROL
   USE STRUCTURE
   USE INTEGRAL
   USE BASISSET
   USE THR_FULLCI

   IMPLICIT NONE
   INTEGER :: I,J,MOP,MOQ
   DOUBLE PRECISION,ALLOCATABLE :: WR(:,:)

!  WRITE(6,'(A)') 'INTEGRAL TRANSFORMATION OF ONE-ELECTRON INTEGRALS WILL BE PERFORMED'

   ALLOCATE(WR(IALLMAX-IVIRTCORE,NCGS))
   DO I=1,NCGS
    DO MOP=1,IALL(0,0,0)-IVIRTCORE
     WR(MOP,I)=0.0D0
     DO J=1,NCGS
      WR(MOP,I)=WR(MOP,I)+DREAL(CO(J,MOP,0,0,0))*(T_C(J,I,0,0,0)+N_C(J,I,0,0,0))
     ENDDO
    ENDDO
   ENDDO
   DO MOP=1,IALL(0,0,0)-IVIRTCORE
    DO MOQ=1,IALL(0,0,0)-IVIRTCORE
     H(MOP,MOQ)=0.0D0
     DO I=1,NCGS
      H(MOP,MOQ)=H(MOP,MOQ)+DREAL(CO(I,MOQ,0,0,0))*WR(MOP,I)
     ENDDO
    ENDDO
   ENDDO
   DEALLOCATE(WR)

   IF (IOPTN(9) == 3) THEN
    WRITE(6,'(A)') 'ONE-ELECTRON PART OF THE HAMILTONIAN MATRIX'
    CALL DUMP5(H,IALL(0,0,0)-IVIRTCORE)
   ENDIF

   RETURN
END SUBROUTINE



SUBROUTINE THERMAL_TWO_ELECTRON_INTEGRALS
! FORM TWO ELECTRON PART OF THE HAMILTONIAN MATRIX.

   USE CONTROL
   USE STRUCTURE
   USE INTEGRAL
   USE BASISSET
   USE THR_FULLCI

   IMPLICIT NONE
   INTEGER,PARAMETER :: CASHESIZE = 1000 ! CASHE SIZE MUST BE EXACTLY THE SAME IN THE STORE & RESTORE SUBROUTINES
   INTEGER :: I,J,K,L
   INTEGER :: MOP,MOQ,MOR,MOS,MOI,MOJ,MOA,MOB
   INTEGER :: EOF
   INTEGER :: ICASHECOUNT,ICOUNT
   INTEGER(4),ALLOCATABLE :: ICASHE1X(:),ICASHE1Y(:),ICASHE1Z(:),ICASHE2(:)
   DOUBLE PRECISION,ALLOCATABLE :: DCASHE(:)
   DOUBLE PRECISION,ALLOCATABLE :: WR1(:,:,:),WR2(:,:,:)
   DOUBLE PRECISION :: EMP2

!  WRITE(6,'(A)') 'INTEGRAL TRANSFORMATION OF TWO-ELECTRON INTEGRALS WILL BE PERFORMED'

   ALLOCATE(ICASHE1X(CASHESIZE),ICASHE1Y(CASHESIZE),ICASHE1Z(CASHESIZE),ICASHE2(CASHESIZE),DCASHE(CASHESIZE))
   ALLOCATE(WR1(NCGS,NCGS,NCGS),WR2(NCGS,NCGS,NCGS))
   OPEN(31,FILE=TRIM(COPTN(1))//'.ao.00000',FORM='UNFORMATTED')
   DO MOP=1,IALL(0,0,0)-IVIRTCORE
    REWIND(31)
    ICOUNT=0
    WR1=0.0D0
    DO
     READ(31,IOSTAT=EOF) ICASHE1X,ICASHE1Y,ICASHE1Z,ICASHE2,DCASHE
     IF (EOF /= 0) EXIT
     DO ICASHECOUNT=1,CASHESIZE
      IF (ICASHE1X(ICASHECOUNT) == -1) EXIT
      ICOUNT=ICOUNT+1
      I=0
      J=0
      K=0
      L=0
      CALL MVBITS(ICASHE2(ICASHECOUNT),24,8,I,0)
      CALL MVBITS(ICASHE2(ICASHECOUNT),16,8,J,0)
      CALL MVBITS(ICASHE2(ICASHECOUNT), 8,8,K,0)
      CALL MVBITS(ICASHE2(ICASHECOUNT), 0,8,L,0)
      WR1(I,J,K)=WR1(I,J,K)+DREAL(CO(L,MOP,0,0,0))*DCASHE(ICASHECOUNT)
     ENDDO
    ENDDO
    DO J=1,NCGS
     DO I=1,NCGS
      DO MOQ=1,IALL(0,0,0)-IVIRTCORE
       WR2(I,J,MOQ)=0.0D0
       DO K=1,NCGS
        WR2(I,J,MOQ)=WR2(I,J,MOQ)+DREAL(CO(K,MOQ,0,0,0))*WR1(I,J,K)
       ENDDO
      ENDDO
     ENDDO
    ENDDO
    DO MOQ=1,IALL(0,0,0)-IVIRTCORE
     DO I=1,NCGS
      DO MOR=1,IALL(0,0,0)-IVIRTCORE
       WR1(I,MOR,MOQ)=0.0D0
       DO J=1,NCGS
        WR1(I,MOR,MOQ)=WR1(I,MOR,MOQ)+DREAL(CO(J,MOR,0,0,0))*WR2(I,J,MOQ)
       ENDDO
      ENDDO
     ENDDO
    ENDDO
    DO MOQ=1,IALL(0,0,0)-IVIRTCORE
     DO MOR=1,IALL(0,0,0)-IVIRTCORE
      DO MOS=1,IALL(0,0,0)-IVIRTCORE
       G(MOS,MOR,MOQ,MOP)=0.0D0
       DO I=1,NCGS
        G(MOS,MOR,MOQ,MOP)=G(MOS,MOR,MOQ,MOP)+DREAL(CO(I,MOS,0,0,0))*WR1(I,MOR,MOQ)
       ENDDO
      ENDDO
     ENDDO
    ENDDO
   ENDDO
   CLOSE(31)
   DEALLOCATE(ICASHE1X,ICASHE1Y,ICASHE1Z,ICASHE2,DCASHE)
   DEALLOCATE(WR1,WR2)

   EMP2=0.0D0
   DO MOI=ICORE+1,IOCC
    DO MOA=IOCC+1,IALL(0,0,0)-IVIRTCORE
     DO MOJ=ICORE+1,IOCC
      DO MOB=IOCC+1,IALL(0,0,0)-IVIRTCORE
       EMP2=EMP2+(2.0D0*G(MOI,MOA,MOJ,MOB)**2-G(MOI,MOA,MOJ,MOB)*G(MOI,MOB,MOJ,MOA)) &
       /(EPSILON(MOI,0,0,0)+EPSILON(MOJ,0,0,0)-EPSILON(MOA,0,0,0)-EPSILON(MOB,0,0,0))
      ENDDO
     ENDDO
    ENDDO
   ENDDO
!  WRITE(6,'(A,F20.15)') 'MP2 ENERGY = ',EMP2

   RETURN
END SUBROUTINE



SUBROUTINE THERMAL_COMPARISON(N)
! FORM FULL HAMILTONIAN AND DIAGONALIZE IT FOR ALL EIGENVALUES.

   USE CONTROL
   USE GRADIENT
   USE STRUCTURE
   USE INTEGRAL
   USE BASISSET
   USE THR_FULLCI

   IMPLICIT NONE
   INTEGER :: N
   INTEGER :: IA,IB,IC,ID
   INTEGER :: I,J,ISPIN,JSPIN
   INTEGER :: P,Q,PSPIN,QSPIN
   INTEGER :: R,S,RSPIN,SSPIN
   DOUBLE PRECISION,ALLOCATABLE :: HAM(:,:)
   DOUBLE PRECISION,ALLOCATABLE :: TRL(:,:)
   DOUBLE PRECISION,ALLOCATABLE :: E0TEMP(:),E1TEMP(:),E2TEMP(:),E3TEMP(:)
   DOUBLE PRECISION,ALLOCATABLE :: E2STEMP(:),E2DTEMP(:)
   DOUBLE PRECISION,ALLOCATABLE :: IIJJ(:)
   DOUBLE PRECISION :: FPQ,PQRS,DENOM

   ALLOCATE(E0TEMP(NCFA*NCFB),E1TEMP(NCFA*NCFB),E2TEMP(NCFA*NCFB),E3TEMP(NCFA*NCFB))
   ALLOCATE(E2STEMP(NCFA*NCFB),E2DTEMP(NCFA*NCFB))
   ALLOCATE(HAM(NCFA*NCFB,NCFA*NCFB))
   ALLOCATE(TRL(NCFB,NCFA))
   ALLOCATE(IIJJ(IALL(0,0,0)-IVIRTCORE))

   OPEN(50,FILE=TRIM(COPTN(1))//'.fi0',FORM='UNFORMATTED')
   OPEN(60,FILE=TRIM(COPTN(1))//'.fo0',FORM='UNFORMATTED')

   ! ZEROTH ORDER (DETERMINANTAL)
   DO IA=1,NCFA
    DO IB=1,NCFB
     TRL=0.0D0
     TRL(IB,IA)=1.0D0
     REWIND(50)
     WRITE(50) TRL
     CALL THERMAL_HAMILTONIAN_PRODUCT(50,60,0,0.0D0) ! LAMBDA=0.0D0
     REWIND(60)
     READ(60) TRL
     E0TEMP((IA-1)*NCFB+IB)=TRL(IB,IA)
    ENDDO
   ENDDO
   DO IA=1,NCFA*NCFB
   ENDDO
!  CALL DUMP5(HAM,NCFA*NCFB)

   ! FIRST ORDER (DETERMINANTAL)
   DO IA=1,NCFA
    DO IB=1,NCFB
     TRL=0.0D0
     TRL(IB,IA)=1.0D0
     REWIND(50)
     WRITE(50) TRL
     CALL THERMAL_HAMILTONIAN_PRODUCT(50,60,0,1.0D0) ! LAMBDA=1.0D0
     REWIND(60)
     READ(60) TRL
     E1TEMP((IA-1)*NCFB+IB)=TRL(IB,IA)-E0TEMP((IA-1)*NCFB+IB)
    ENDDO
   ENDDO

   ! SECOND ORDER (DETERMINANTAL)
   DO IA=1,NCFA
    DO IB=1,NCFB
     TRL=0.0D0
     TRL(IB,IA)=1.0D0
     REWIND(50)
     WRITE(50) TRL
     CALL THERMAL_HAMILTONIAN_PRODUCT(50,60,0,1.0D0) ! LAMBDA=1.0D0
     REWIND(60)
     READ(60) TRL
     E2TEMP((IA-1)*NCFB+IB)=0.0D0
     DO IC=1,NCFA
      DO ID=1,NCFB
!(i/2) reports the number of differences between two Slater determinants.
!i=0
!do j=1,iall(0)-ivirtcore
! if ((BTEST(CFHALFA(IA),J-1)).neqv.(BTEST(CFHALFA(IC),J-1))) i=i+1
! if ((BTEST(CFHALFB(IB),J-1)).neqv.(BTEST(CFHALFB(ID),J-1))) i=i+1
!enddo
!if (i /= 4) cycle
       DENOM=E0TEMP((IA-1)*NCFB+IB)-E0TEMP((IC-1)*NCFB+ID)
       IF (DABS(DENOM) > 1.0D-10) &
        E2TEMP((IA-1)*NCFB+IB)=E2TEMP((IA-1)*NCFB+IB)+TRL(ID,IC)*TRL(ID,IC)/DENOM
      ENDDO
     ENDDO
    ENDDO
   ENDDO

   ! FIRST ORDER SQUARED (DETERMINANTAL)
   DO IA=1,NCFA
    DO IB=1,NCFB
     TRL=0.0D0
     TRL(IB,IA)=1.0D0
     REWIND(50)
     WRITE(50) TRL
     CALL THERMAL_HAMILTONIAN_PRODUCT(50,60,0,1.0D0) ! LAMBDA=1.0D0
     REWIND(60)
     READ(60) TRL
     TRL(IB,IA)=TRL(IB,IA)-E0TEMP((IA-1)*NCFB+IB)
     E3TEMP((IA-1)*NCFB+IB)=0.0D0
     DO IC=1,NCFA
      DO ID=1,NCFB
       DENOM=E0TEMP((IA-1)*NCFB+IB)-E0TEMP((IC-1)*NCFB+ID)
       IF (DABS(DENOM) < 1.0D-10) &
        E3TEMP((IA-1)*NCFB+IB)=E3TEMP((IA-1)*NCFB+IB)+TRL(ID,IC)**2
      ENDDO
     ENDDO
    ENDDO
   ENDDO

   DO IA=1,NCFA*NCFB
    E0TEMP(IA)=E0TEMP(IA)+NUCLEAR_REPULSION
   ENDDO
   CALL PIKSRT4(NCFA*NCFB,NCFA*NCFB,E0TEMP,E1TEMP,E2TEMP,E3TEMP)
   DO IA=1,NCFA*NCFB
    E0TEST(N+IA)=E0TEMP(IA)
    E1TEST(N+IA)=E1TEMP(IA)
    E2TEST(N+IA)=E2TEMP(IA)
    E3TEST(N+IA)=E3TEMP(IA)
   ENDDO

   ! ZEROTH ORDER (MOLECULAR INTEGRAL)
   E0TEMP=0.0D0
   DO IA=1,NCFA
    DO IB=1,NCFB
     DO ISPIN=1,2
      DO I=1,IALL(0,0,0)-IVIRTCORE
       IF ((ISPIN==1).AND.(BTEST(CFHALFA(IA),I-1))) E0TEMP((IA-1)*NCFB+IB)=E0TEMP((IA-1)*NCFB+IB)+EPSILON(I,0,0,0)
       IF ((ISPIN==2).AND.(BTEST(CFHALFB(IB),I-1))) E0TEMP((IA-1)*NCFB+IB)=E0TEMP((IA-1)*NCFB+IB)+EPSILON(I,0,0,0)
      ENDDO
     ENDDO
    ENDDO
   ENDDO

   ! FIRST ORDER (MOLECULAR INTEGRAL)
!  IIJJ=0.0D0
!  DO I=1,IALL(0,0,0)-IVIRTCORE
!   DO J=1,IOCC
!    IIJJ(I)=IIJJ(I)+2.0D0*G(I,I,J,J)-G(I,J,J,I)
!   ENDDO
!  ENDDO
   E1TEMP=0.0D0
   DO IA=1,NCFA
    DO IB=1,NCFB
     DO ISPIN=1,2
      DO I=1,IALL(0,0,0)-IVIRTCORE
       IF ((ISPIN==1).AND.(BTEST(CFHALFA(IA),I-1))) &
        E1TEMP((IA-1)*NCFB+IB)=E1TEMP((IA-1)*NCFB+IB)+H(I,I)-EPSILON(I,0,0,0)
       IF ((ISPIN==2).AND.(BTEST(CFHALFB(IB),I-1))) &
        E1TEMP((IA-1)*NCFB+IB)=E1TEMP((IA-1)*NCFB+IB)+H(I,I)-EPSILON(I,0,0,0)
      ENDDO
     ENDDO
    ENDDO
   ENDDO
   DO IA=1,NCFA
    DO IB=1,NCFB
     DO ISPIN=1,2
      DO I=1,IALL(0,0,0)-IVIRTCORE
       DO JSPIN=1,2
        DO J=1,IALL(0,0,0)-IVIRTCORE
         IF ((ISPIN==1).AND.(BTEST(CFHALFA(IA),I-1)).AND.(JSPIN==1).AND.(BTEST(CFHALFA(IA),J-1))) &
          E1TEMP((IA-1)*NCFB+IB)=E1TEMP((IA-1)*NCFB+IB)+0.5D0*(G(I,I,J,J)-G(I,J,J,I))
         IF ((ISPIN==1).AND.(BTEST(CFHALFA(IA),I-1)).AND.(JSPIN==2).AND.(BTEST(CFHALFB(IB),J-1))) &
          E1TEMP((IA-1)*NCFB+IB)=E1TEMP((IA-1)*NCFB+IB)+0.5D0*G(I,I,J,J)
         IF ((ISPIN==2).AND.(BTEST(CFHALFB(IB),I-1)).AND.(JSPIN==1).AND.(BTEST(CFHALFA(IA),J-1))) &
          E1TEMP((IA-1)*NCFB+IB)=E1TEMP((IA-1)*NCFB+IB)+0.5D0*G(I,I,J,J)
         IF ((ISPIN==2).AND.(BTEST(CFHALFB(IB),I-1)).AND.(JSPIN==2).AND.(BTEST(CFHALFB(IB),J-1))) &
          E1TEMP((IA-1)*NCFB+IB)=E1TEMP((IA-1)*NCFB+IB)+0.5D0*(G(I,I,J,J)-G(I,J,J,I))
        ENDDO
       ENDDO
      ENDDO
     ENDDO
    ENDDO
   ENDDO

   ! SECOND ORDER (MOLECULAR INTEGRAL)
   E2STEMP=0.0D0
   E2DTEMP=0.0D0
   DO IA=1,NCFA
    DO IB=1,NCFB
     DO PSPIN=1,2
      DO P=1,IALL(0,0,0)-IVIRTCORE
       DO Q=1,IALL(0,0,0)-IVIRTCORE
        IF ((PSPIN==1).AND.(BTEST(CFHALFA(IA),P-1)).AND.(.NOT.BTEST(CFHALFA(IA),Q-1))) THEN
!        FPQ=0.0D0
         FPQ=H(P,Q)
         IF (P==Q) FPQ=FPQ-EPSILON(P,0,0,0)
!        DO J=1,IOCC
!         FPQ=FPQ-2.0D0*G(P,Q,J,J)+G(P,J,J,Q)
!        ENDDO
         DO RSPIN=1,2
          DO R=1,IALL(0,0,0)-IVIRTCORE
           IF ((RSPIN==1).AND.(BTEST(CFHALFA(IA),R-1))) FPQ=FPQ+G(P,Q,R,R)-G(P,R,R,Q)
           IF ((RSPIN==2).AND.(BTEST(CFHALFB(IB),R-1))) FPQ=FPQ+G(P,Q,R,R)
          ENDDO
         ENDDO
         DENOM=EPSILON(P,0,0,0)-EPSILON(Q,0,0,0)
         IF (DABS(DENOM) > 1.0D-10) &
          E2STEMP((IA-1)*NCFB+IB)=E2STEMP((IA-1)*NCFB+IB)+FPQ**2/DENOM
        ENDIF
        IF ((PSPIN==2).AND.(BTEST(CFHALFB(IB),P-1)).AND.(.NOT.BTEST(CFHALFB(IB),Q-1))) THEN
!        FPQ=0.0D0
         FPQ=H(P,Q)
         IF (P==Q) FPQ=FPQ-EPSILON(P,0,0,0)
!        DO J=1,IOCC
!         FPQ=FPQ-2.0D0*G(P,Q,J,J)+G(P,J,J,Q)
!        ENDDO
         DO RSPIN=1,2
          DO R=1,IALL(0,0,0)-IVIRTCORE
           IF ((RSPIN==1).AND.(BTEST(CFHALFA(IA),R-1))) FPQ=FPQ+G(P,Q,R,R)
           IF ((RSPIN==2).AND.(BTEST(CFHALFB(IB),R-1))) FPQ=FPQ+G(P,Q,R,R)-G(P,R,R,Q)
          ENDDO
         ENDDO
         DENOM=EPSILON(P,0,0,0)-EPSILON(Q,0,0,0)
         IF (DABS(DENOM) > 1.0D-10) &
          E2STEMP((IA-1)*NCFB+IB)=E2STEMP((IA-1)*NCFB+IB)+FPQ**2/DENOM
        ENDIF
       ENDDO
      ENDDO
     ENDDO
     DO PSPIN=1,2
     DO P=1,IALL(0,0,0)-IVIRTCORE
      IF ((PSPIN==1).AND.(.NOT.BTEST(CFHALFA(IA),P-1))) CYCLE
      IF ((PSPIN==2).AND.(.NOT.BTEST(CFHALFB(IB),P-1))) CYCLE
      DO RSPIN=1,2
      DO R=1,IALL(0,0,0)-IVIRTCORE
       IF ((RSPIN==1).AND.(BTEST(CFHALFA(IA),R-1))) CYCLE
       IF ((RSPIN==2).AND.(BTEST(CFHALFB(IB),R-1))) CYCLE
       DO QSPIN=1,2
       DO Q=1,IALL(0,0,0)-IVIRTCORE
        IF ((QSPIN==1).AND.(.NOT.BTEST(CFHALFA(IA),Q-1))) CYCLE
        IF ((QSPIN==2).AND.(.NOT.BTEST(CFHALFB(IB),Q-1))) CYCLE
        DO SSPIN=1,2
        DO S=1,IALL(0,0,0)-IVIRTCORE
         IF ((SSPIN==1).AND.(BTEST(CFHALFA(IA),S-1))) CYCLE
         IF ((SSPIN==2).AND.(BTEST(CFHALFB(IB),S-1))) CYCLE
         DENOM=EPSILON(P,0,0,0)+EPSILON(Q,0,0,0)-EPSILON(R,0,0,0)-EPSILON(S,0,0,0)
         IF (DABS(DENOM) < 1.0D-10) CYCLE
         PQRS=0.0D0
         IF ((PSPIN==RSPIN).AND.(QSPIN==SSPIN)) PQRS=PQRS+G(P,R,Q,S)
         IF ((PSPIN==SSPIN).AND.(QSPIN==RSPIN)) PQRS=PQRS-G(P,S,Q,R)
         E2DTEMP((IA-1)*NCFB+IB)=E2DTEMP((IA-1)*NCFB+IB)+0.25D0*PQRS**2/DENOM
        ENDDO
        ENDDO
       ENDDO
       ENDDO
      ENDDO
      ENDDO
     ENDDO
     ENDDO
    ENDDO
   ENDDO

   ! FIRST ORDER SQUARED (MOLECULAR INTEGRAL)
   DO IA=1,NCFA*NCFB
    E3TEMP(IA)=E1TEMP(IA)**2
   ENDDO
   DO IA=1,NCFA
    DO IB=1,NCFB
     DO PSPIN=1,2
      DO P=1,IALL(0,0,0)-IVIRTCORE
       DO Q=1,IALL(0,0,0)-IVIRTCORE
        IF ((PSPIN==1).AND.(BTEST(CFHALFA(IA),P-1)).AND.(.NOT.BTEST(CFHALFA(IA),Q-1))) THEN
!        FPQ=0.0D0
         FPQ=H(P,Q)
         IF (P==Q) FPQ=FPQ-EPSILON(P,0,0,0)
!        DO J=1,IOCC
!         FPQ=FPQ-2.0D0*G(P,Q,J,J)+G(P,J,J,Q)
!        ENDDO
         DO RSPIN=1,2
          DO R=1,IALL(0,0,0)-IVIRTCORE
           IF ((RSPIN==1).AND.(BTEST(CFHALFA(IA),R-1))) FPQ=FPQ+G(P,Q,R,R)-G(P,R,R,Q)
           IF ((RSPIN==2).AND.(BTEST(CFHALFB(IB),R-1))) FPQ=FPQ+G(P,Q,R,R)
          ENDDO
         ENDDO
         DENOM=EPSILON(P,0,0,0)-EPSILON(Q,0,0,0)
         IF (DABS(DENOM) < 1.0D-10) &
          E3TEMP((IA-1)*NCFB+IB)=E3TEMP((IA-1)*NCFB+IB)+FPQ**2
        ENDIF
        IF ((PSPIN==2).AND.(BTEST(CFHALFB(IB),P-1)).AND.(.NOT.BTEST(CFHALFB(IB),Q-1))) THEN
!        FPQ=0.0D0
         FPQ=H(P,Q)
         IF (P==Q) FPQ=FPQ-EPSILON(P,0,0,0)
!        DO J=1,IOCC
!         FPQ=FPQ-2.0D0*G(P,Q,J,J)+G(P,J,J,Q)
!        ENDDO
         DO RSPIN=1,2
          DO R=1,IALL(0,0,0)-IVIRTCORE
           IF ((RSPIN==1).AND.(BTEST(CFHALFA(IA),R-1))) FPQ=FPQ+G(P,Q,R,R)
           IF ((RSPIN==2).AND.(BTEST(CFHALFB(IB),R-1))) FPQ=FPQ+G(P,Q,R,R)-G(P,R,R,Q)
          ENDDO
         ENDDO
         DENOM=EPSILON(P,0,0,0)-EPSILON(Q,0,0,0)
         IF (DABS(DENOM) < 1.0D-10) &
          E3TEMP((IA-1)*NCFB+IB)=E3TEMP((IA-1)*NCFB+IB)+FPQ**2
        ENDIF
       ENDDO
      ENDDO
     ENDDO
     DO PSPIN=1,2
     DO P=1,IALL(0,0,0)-IVIRTCORE
      IF ((PSPIN==1).AND.(.NOT.BTEST(CFHALFA(IA),P-1))) CYCLE
      IF ((PSPIN==2).AND.(.NOT.BTEST(CFHALFB(IB),P-1))) CYCLE
      DO RSPIN=1,2
      DO R=1,IALL(0,0,0)-IVIRTCORE
       IF ((RSPIN==1).AND.(BTEST(CFHALFA(IA),R-1))) CYCLE
       IF ((RSPIN==2).AND.(BTEST(CFHALFB(IB),R-1))) CYCLE
       DO QSPIN=1,2
       DO Q=1,IALL(0,0,0)-IVIRTCORE
        IF ((QSPIN==1).AND.(.NOT.BTEST(CFHALFA(IA),Q-1))) CYCLE
        IF ((QSPIN==2).AND.(.NOT.BTEST(CFHALFB(IB),Q-1))) CYCLE
        DO SSPIN=1,2
        DO S=1,IALL(0,0,0)-IVIRTCORE
         IF ((SSPIN==1).AND.(BTEST(CFHALFA(IA),S-1))) CYCLE
         IF ((SSPIN==2).AND.(BTEST(CFHALFB(IB),S-1))) CYCLE
         DENOM=EPSILON(P,0,0,0)+EPSILON(Q,0,0,0)-EPSILON(R,0,0,0)-EPSILON(S,0,0,0)
         IF (DABS(DENOM) > 1.0D-10) CYCLE
         PQRS=0.0D0
         IF ((PSPIN==RSPIN).AND.(QSPIN==SSPIN)) PQRS=PQRS+G(P,R,Q,S)
         IF ((PSPIN==SSPIN).AND.(QSPIN==RSPIN)) PQRS=PQRS-G(P,S,Q,R)
         E3TEMP((IA-1)*NCFB+IB)=E3TEMP((IA-1)*NCFB+IB)+0.25D0*PQRS**2
        ENDDO
        ENDDO
       ENDDO
       ENDDO
      ENDDO
      ENDDO
     ENDDO
     ENDDO
    ENDDO
   ENDDO

   DO IA=1,NCFA*NCFB
    E0TEMP(IA)=E0TEMP(IA)+NUCLEAR_REPULSION
   ENDDO
   CALL PIKSRT5(NCFA*NCFB,NCFA*NCFB,E0TEMP,E1TEMP,E2STEMP,E2DTEMP,E3TEMP)
   DO IA=1,NCFA*NCFB
    E0TEST2(N+IA)=E0TEMP(IA)
    E1TEST2(N+IA)=E1TEMP(IA)
    E2S    (N+IA)=E2STEMP(IA)
    E2D    (N+IA)=E2DTEMP(IA)
    E2TEST2(N+IA)=E2STEMP(IA)+E2DTEMP(IA)
    E3TEST2(N+IA)=E3TEMP(IA) ! THIS IS NOW REPORTING E(1)**2
   ENDDO

!   WRITE(6,'(A)') &
!!'    N      E0(SOS)    E0(REDUCED)     DIFF        E1(SOS)    E1(REDUCED)     DIFF        E2(SOS)    E2(REDUCED)     DIFF'
!'    N      E0(SOS)    E0(REDUCED)     DIFF        E1(SOS)    E1(REDUCED)     DIFF        E1^2(SOS)  E1^2(REDUCED)   DIFF'
!   WRITE(6,'(A)') &
!'  ------------------------------------------------------------------------------------------------------------------------'
!   DO IA=1,NCFA*NCFB
!    WRITE(6,'(I5,9F13.6)') N+IA,E0TEST(N+IA),E0TEST2(N+IA),DABS(E0TEST(N+IA)-E0TEST2(N+IA)) &
!                               ,E1TEST(N+IA),E1TEST2(N+IA),DABS(E1TEST(N+IA)-E1TEST2(N+IA)) &
!!                              ,E2TEST(N+IA),E2TEST2(N+IA),DABS(E2TEST(N+IA)-E2TEST2(N+IA))
!                               ,E3TEST(N+IA),E3TEST2(N+IA),DABS(E3TEST(N+IA)-E3TEST2(N+IA))
!   ENDDO

   CLOSE(50)
   CLOSE(60)

   DEALLOCATE(IIJJ)
   DEALLOCATE(E0TEMP,E1TEMP,E2TEMP,E2STEMP,E2DTEMP,E3TEMP)
   DEALLOCATE(TRL)
   DEALLOCATE(HAM)

   RETURN
END SUBROUTINE



SUBROUTINE THERMAL_MBPT_GENERALORDER
! PERFORM GENERAL-ORDERTHERMAL MBPT USING RECURSION

   USE CONSTANTS
   USE CONTROL
   USE STRUCTURE
   USE INTEGRAL
   USE BASISSET
   USE GRADIENT
   USE THR_FULLCI

   IMPLICIT NONE
   DOUBLE PRECISION,PARAMETER :: DELTALAMBDA=0.001D0
   INTEGER :: NALL_CHECK,I,J,K
   INTEGER :: IA,IB
   INTEGER :: ORDER
   REAL :: ICPUS,ICPUE
   INTEGER :: ILAMBDA
   DOUBLE PRECISION :: LAMBDA
   DOUBLE PRECISION :: NBAR      ! MEAN NUMBER OF ELECTRONS
   DOUBLE PRECISION :: BETA      ! 1/(kB T)
   DOUBLE PRECISION :: M_ACC,O_ACC,U_ACC,S_ACC
   DOUBLE PRECISION,ALLOCATABLE :: FMINUS2(:),FPLUS2(:)
   DOUBLE PRECISION,ALLOCATABLE :: E0(:)
   DOUBLE PRECISION :: MU_R_N,MU_R_D,MU_L ! RIGHT AND LEFT HAND SIDES OF MU RECURSION
   DOUBLE PRECISION :: O_R_N,O_R_D        ! NUMERATOR AND DENOMINATOR OF OMEGA RECURSION
   DOUBLE PRECISION :: U_R_N,U_R_D        ! NUMERATOR AND DENOMINATOR OF U RECURSION
   INTEGER,ALLOCATABLE :: BGROUPS(:),BORDERS(:,:)
   INTEGER :: IGROUP,IORDER,IBRACKET
   DOUBLE PRECISION,ALLOCATABLE :: FACTORIAL(:)
   DOUBLE PRECISION,ALLOCATABLE :: ALLE_LAMBDA(:,:)
   DOUBLE PRECISION,ALLOCATABLE :: E0_CHECK(:),E1_CHECK(:),E2_CHECK(:),E3_CHECK(:)
   DOUBLE PRECISION,ALLOCATABLE :: TMP1(:,:),TMP2(:,:)
   INTEGER,ALLOCATABLE :: N_COMP(:),I_COMP(:,:),J_COMP(:,:)
   DOUBLE PRECISION,ALLOCATABLE :: E_COMP(:,:)

   ALLOCATE(H(IALLMAX-IVIRTCORE,IALLMAX-IVIRTCORE))
   ALLOCATE(G(IALLMAX-IVIRTCORE,IALLMAX-IVIRTCORE,IALLMAX-IVIRTCORE,IALLMAX-IVIRTCORE))
   CALL THERMAL_ONE_ELECTRON_INTEGRALS
   CALL THERMAL_TWO_ELECTRON_INTEGRALS
   NALL=2**(2*(IALL(0,0,0)-IVIRTCORE-ICORE))
   ALLOCATE(E0(NALL),ALLE(NALL),ALLN(NALL))
   ALLOCATE(ALL_M(NALL))

!=============== FOR CHECK FROM HERE ....
goto 1
   ALLOCATE(ALLE_LAMBDA(NALL,0:8),E0_CHECK(NALL),E1_CHECK(NALL),E2_CHECK(NALL),E3_CHECK(NALL))
   ! LAMBDA-VARIATION HIRSCHFELDER-CERTAIN DEGENERATE PERTURBATION THEORY
   DO ILAMBDA=0,8
    LAMBDA=DFLOAT(ILAMBDA)*DELTALAMBDA
    WRITE(6,'(/,A)') '************************************'
    WRITE(6,'(A)')   '* LAMBDA VARIATION FOR E0,E1,E2,E3 *'
    WRITE(6,'(A)')   '************************************'
    WRITE(6,'(A,F20.6,A)') 'LAMBDA    = ',LAMBDA
    WRITE(6,'(A,E20.6,A)') 'TEMP      = ',DOPTN(98),' K'
    WRITE(6,'(A,F20.6,A)') 'FERMI     = ',FERMI,' HARTREE'
    NALL_CHECK=0
    DO NELE=2*ICORE,2*(IALL(0,0,0)-IVIRTCORE)
     DO NELEA=ICORE,NELE
      NELEB=NELE-NELEA
      IF (NELEA > IALL(0,0,0)-IVIRTCORE) CYCLE
      IF (NELEB > IALL(0,0,0)-IVIRTCORE) CYCLE
      IF (NELEA < ICORE) CYCLE
      IF (NELEB < ICORE) CYCLE
!===== CANONICAL ===================================================
      IF (NELE /= 2*IOCC) CYCLE
!===================================================================
      CALL THERMAL_GENERATE_CONFIGURATIONSA(NELEA,MIN(NELEA,IALL(0,0,0)-IVIRTCORE-NELEA))
      CALL THERMAL_GENERATE_CONFIGURATIONSB(NELEB,MIN(NELEB,IALL(0,0,0)-IVIRTCORE-NELEB))
      CALL THERMAL_FULL_CI(LAMBDA,NALL_CHECK)
      DO I=1,NCFA*NCFB
       ALLN(NALL_CHECK+I)=NELE
      ENDDO
      NALL_CHECK=NALL_CHECK+NCFA*NCFB
      DEALLOCATE(CFHALFA,ADDRSSA,NORDERA)
      DEALLOCATE(CFHALFB,ADDRSSB,NORDERB)
     ENDDO
    ENDDO
    NALL=NALL_CHECK
    DO I=1,NALL
     ALLE_LAMBDA(I,ILAMBDA)=ALLE(I)
    ENDDO
   ENDDO
   WRITE(6,'(/,A,/)') '/\/\/\/\/\/\/\/\/\/\/\/\/\/\/\/\/\/\/\/\/\/\/\/\/\/\/\/\/\/\/\/\/\/\/\/\/\/\'
   WRITE(6,'(A)')     'LAMBDA-VARIATION FOR HIRSCHFELDER-CERTAIN PERTURBATION THEORY'
   WRITE(6,'(/,A,/)') 'FORWARD SEVEN- AND EIGHT-POINT FORMULA'
   WRITE(6,'(A)') '-------------------------------------------------------------------------------------'
   WRITE(6,'(A)') 'STATE        E(0)                E(1)                E(2)                E(3)'
   WRITE(6,'(A)') '-------------------------------------------------------------------------------------'
   ESHIFT=1.0D9
   DO I=1,NALL
    E0_CHECK(I)=ALLE_LAMBDA(I,0)+NUCLEAR_REPULSION
    IF (E0_CHECK(I) < ESHIFT) ESHIFT=E0_CHECK(I)
    E1_CHECK(I)=(-49.0D0/20.0D0*ALLE_LAMBDA(I,0)+6.0D0*ALLE_LAMBDA(I,1)-15.0D0/2.0D0*ALLE_LAMBDA(I,2) &
      +20.0D0/3.0D0*ALLE_LAMBDA(I,3)-15.0D0/4.0D0*ALLE_LAMBDA(I,4)+6.0D0/5.0D0*ALLE_LAMBDA(I,5) &
      -1.0D0/6.0D0*ALLE_LAMBDA(I,6))/DELTALAMBDA
    E2_CHECK(I)=(+469.0D0/90.0D0*ALLE_LAMBDA(I,0)-223.0D0/10.0D0*ALLE_LAMBDA(I,1)+879.0D0/20.0D0*ALLE_LAMBDA(I,2) &
      -949.0D0/18.0D0*ALLE_LAMBDA(I,3)+41.0D0*ALLE_LAMBDA(I,4)-201.0D0/10.0D0*ALLE_LAMBDA(I,5) &
      +1019.0D0/180.0D0*ALLE_LAMBDA(I,6)-7.0D0/10.0D0*ALLE_LAMBDA(I,7))/(DELTALAMBDA**2)/2.0D0
    E3_CHECK(I)=(-801.0D0/80.0D0*ALLE_LAMBDA(I,0)+349.0D0/6.0D0*ALLE_LAMBDA(I,1)-18353.0D0/120.0D0*ALLE_LAMBDA(I,2) &
      +2391.0D0/10.0D0*ALLE_LAMBDA(I,3)-1457.0D0/6.0D0*ALLE_LAMBDA(I,4)+4891.0D0/30.0D0*ALLE_LAMBDA(I,5) &
      -561.0D0/8.0D0*ALLE_LAMBDA(I,6)+527.0D0/30.0D0*ALLE_LAMBDA(I,7)-469.0D0/240.0D0*ALLE_LAMBDA(I,8)) &
      /(DELTALAMBDA**3)/6.0D0
    WRITE(6,'(I5,4F20.10)') I,E0_CHECK(I),E1_CHECK(I),E2_CHECK(I),E3_CHECK(I)
   ENDDO
   WRITE(6,'(A)') '-------------------------------------------------------------------------'
   DEALLOCATE(ALLE_LAMBDA)
1 continue
!=============== ... TO HERE FOR CHECK

   IF (IOPTN(49)==0) RETURN
   IF ((KVCX /= 0).OR.(KVCY /= 0).OR.(KVCZ /= 0)) CALL PABORT('FOR MOLECULES ONLY')
   IF (LOPTN(25)) CALL PABORT('USE NON-DIRECT ALGORITHM')
   IF (IALL(0,0,0)-IOCC-IVIRTCORE <= 0) CALL PABORT('NO VIRTUAL ORBITAL')
   IF (ICORE > 0) CALL PABORT('ICORE LOGIC NOT TESTED YET')
   IF (IVIRTCORE > 0) CALL PABORT('IVIRTCORE LOGIC NOT TESTED YET')

   NBAR=DFLOAT(IOCC*2)
   BETA=1.0D0/BOLTZMANN/DOPTN(98)

!goto 999

   WRITE(6,'(/,A)') '************************************************'
   WRITE(6,'(A)')   '* GENERAL-ORDER THERMAL MBPT (GRAND CANONICAL) *'
   WRITE(6,'(A)')   '************************************************'
   WRITE(6,'(A,E20.6,A)') 'TEMP      = ',DOPTN(98),' K'
   WRITE(6,'(A,F20.6,A)') 'FERMI     = ',FERMI,' HARTREE'
   WRITE(6,'(A,I0)')      'ORDER     = ',IOPTN(49)
   CALL CPU_TIME(ICPUS)

   ! ==========================================
   ! GENERATE HCPT EFFECTIVE HAMILTONIAN MATRIX
   ! ==========================================
   !
   ! ZEROTH-ORDER ENERGIES UNSORTED
   !                       ^^^^^^^^
   NALL_CHECK=0
   ESHIFT=1.0D9
   DO NELE=2*ICORE,2*(IALL(0,0,0)-IVIRTCORE)
    DO NELEA=ICORE,NELE
     NELEB=NELE-NELEA
     IF (NELEA > IALL(0,0,0)-IVIRTCORE) CYCLE
     IF (NELEB > IALL(0,0,0)-IVIRTCORE) CYCLE
     IF (NELEA < ICORE) CYCLE
     IF (NELEB < ICORE) CYCLE
     CALL THERMAL_GENERATE_CONFIGURATIONSA(NELEA,MIN(NELEA,IALL(0,0,0)-IVIRTCORE-NELEA))
     CALL THERMAL_GENERATE_CONFIGURATIONSB(NELEB,MIN(NELEB,IALL(0,0,0)-IVIRTCORE-NELEB))
     DO IA=1,NCFA
      DO IB=1,NCFB
       E0(NALL_CHECK+(IA-1)*NCFB+IB)=NUCLEAR_REPULSION
       DO I=1,IALL(0,0,0)-IVIRTCORE
        IF (BTEST(CFHALFA(IA),I-1)) &
         E0(NALL_CHECK+(IA-1)*NCFB+IB)=E0(NALL_CHECK+(IA-1)*NCFB+IB)+EPSILON(I,0,0,0)
        IF (BTEST(CFHALFB(IB),I-1)) &
         E0(NALL_CHECK+(IA-1)*NCFB+IB)=E0(NALL_CHECK+(IA-1)*NCFB+IB)+EPSILON(I,0,0,0)
       ENDDO
      ENDDO
     ENDDO
     DO I=1,NCFA*NCFB
      ALLN(NALL_CHECK+I)=NELE
      IF (E0(NALL_CHECK+I) < ESHIFT) ESHIFT=E0(NALL_CHECK+I)
     ENDDO
     NALL_CHECK=NALL_CHECK+NCFA*NCFB
     DEALLOCATE(CFHALFA,ADDRSSA,NORDERA)
     DEALLOCATE(CFHALFB,ADDRSSB,NORDERB)
    ENDDO
   ENDDO
   NALL=NALL_CHECK
   !
   ! ALLOCATE EHC ARRAY AND POPULATE ZEROTH ORDER
   !
   ALLOCATE(EHC(NALL,NALL,0:IOPTN(49)),VHC(NALL,NALL,0:IOPTN(49)))
   EHC=0.0D0
   DO I=1,NALL
    EHC(I,I,0)=E0(I)
   ENDDO
   VHC=0.0D0
   DO I=1,NALL
    VHC(I,I,0)=1.0D0
   ENDDO
   !
   ! GENERATE HCPT EFFECTIVE HAMILTONIAN RECURSIVELY
   !
   CALL CPU_TIME(ICPUS)
   WRITE(6,'(/,A)')   'GENERATING HCPT EFFECTIVE HAMILTONIAN MATRIX'
   CALL CPU_TIME(ICPUS)
   DO ORDER=1,IOPTN(49)
    NALL_CHECK=0
    DO NELE=2*ICORE,2*(IALL(0,0,0)-IVIRTCORE)
     DO NELEA=ICORE,NELE
      NELEB=NELE-NELEA
      IF (NELEA > IALL(0,0,0)-IVIRTCORE) CYCLE
      IF (NELEB > IALL(0,0,0)-IVIRTCORE) CYCLE
      IF (NELEA < ICORE) CYCLE
      IF (NELEB < ICORE) CYCLE
      CALL THERMAL_GENERATE_CONFIGURATIONSA(NELEA,MIN(NELEA,IALL(0,0,0)-IVIRTCORE-NELEA))
      CALL THERMAL_GENERATE_CONFIGURATIONSB(NELEB,MIN(NELEB,IALL(0,0,0)-IVIRTCORE-NELEB))
      CALL EHC_GEN(ORDER,NALL_CHECK)
      
      NALL_CHECK=NALL_CHECK+NCFA*NCFB
      DEALLOCATE(CFHALFA,ADDRSSA,NORDERA)
      DEALLOCATE(CFHALFB,ADDRSSB,NORDERB)
     ENDDO
    ENDDO
    CALL CPU_TIME(ICPUE)
    WRITE(6,'(A,I3,A,F10.2)') 'ORDER:',ORDER,' CPU/SEC =',ICPUE-ICPUS
    CALL PFLUSH(6)
   ENDDO
   NALL=NALL_CHECK

! -----------
! COMPRESSION
! -----------

   ALLOCATE(N_COMP(0:IOPTN(49)),I_COMP(NALL*NALL,0:IOPTN(49)),J_COMP(NALL*NALL,0:IOPTN(49)))
   ALLOCATE(E_COMP(NALL*NALL,0:IOPTN(49)))
   N_COMP=0
   I_COMP=0
   J_COMP=0
   E_COMP=0.0D0
   DO ORDER=0,IOPTN(49)
    DO I=1,NALL
     DO J=1,NALL
      IF (DABS(EHC(J,I,ORDER)) > 1.0D-14) THEN
       N_COMP(ORDER)=N_COMP(ORDER)+1
       I_COMP(N_COMP(ORDER),ORDER)=I
       J_COMP(N_COMP(ORDER),ORDER)=J
       E_COMP(N_COMP(ORDER),ORDER)=EHC(J,I,ORDER)
      ENDIF
     ENDDO
    ENDDO
    WRITE(6,'(A,I3,A,I5,A,I10)') 'ORDER:',ORDER,' COMPRESSION = ',N_COMP(ORDER),' /',NALL*NALL
   ENDDO

   ALLOCATE(TMP1(NALL,NALL),TMP2(NALL,NALL))
   ALLOCATE(M_GEN(0:IOPTN(49)),O_GEN(0:IOPTN(49)),U_GEN(0:IOPTN(49)),S_GEN(0:IOPTN(49)))
   ALLOCATE(FMINUS2(1:2*(IALL(0,0,0)-IVIRTCORE)),FPLUS2(1:2*(IALL(0,0,0)-IVIRTCORE)))

   DO I=1,IALL(0,0,0)-IVIRTCORE
    FMINUS2(I)=1.0D0/(1.0D0+DEXP(BETA*(EPSILON(I,0,0,0)-FERMI)))
    FPLUS2(I)=1.0D0-FMINUS2(I)
    FMINUS2(I+IALL(0,0,0)-IVIRTCORE)=FMINUS2(I)
    FPLUS2(I+IALL(0,0,0)-IVIRTCORE)=FPLUS2(I)
   ENDDO

!----
!write(*,*) 'debug'
!  DO ORDER=0,IOPTN(49)
!   O_R_N=0.0D0
!   O_R_D=0.0D0
!   DO I=1,NALL
!    O_R_N=O_R_N+EHC(I,I,ORDER)*DEXP(-BETA*(EHC(I,I,0)-ESHIFT-FERMI*DFLOAT(ALLN(I))))
!    O_R_D=O_R_D+DEXP(-BETA*(EHC(I,I,0)-ESHIFT-FERMI*DFLOAT(ALLN(I))))
!   ENDDO
!   write(*,'(A,I0,A,F20.10)') '<E(',ORDER,')> = ',O_R_N/O_R_D
!  ENDDO
!----

!  --------------------------------------------------------------------
!  MU RECURSION (CAN BE PERFORMED INDEPENDENT OF OTHER THERMOFUNCTIONS)
!  --------------------------------------------------------------------

   CALL CPU_TIME(ICPUS)
   M_GEN(0)=FERMI
   M_ACC=M_GEN(0)
   WRITE(6,'(/,A)') '-----------------------------------------------------'
   WRITE(6,'(A)')   'ORDER       DELTA MU(n)          SUM MU(n)    CPU/SEC'
   CALL CPU_TIME(ICPUE)
   WRITE(6,'(I3,F20.10,F20.10,F10.1)') 0,M_GEN(0),M_ACC,ICPUE-ICPUS
   CALL PFLUSH(6)
   CALL CPU_TIME(ICPUS)

   DO ORDER=1,IOPTN(49)
    ALLOCATE(BGROUPS(2**(ORDER-1)),BORDERS(2**(ORDER-1),ORDER),FACTORIAL(0:ORDER))

    ! BRUECKNER BRACKET COMBINATORICS
    FACTORIAL(0)=1.0D0
    DO I=1,ORDER
     FACTORIAL(I)=FACTORIAL(I-1)*DFLOAT(I)
    ENDDO
    BGROUPS=0
    BORDERS=0
    DO IBRACKET=1,2**(ORDER-1)
     IGROUP=0
     IORDER=0
     IF (ORDER > 1) THEN
      DO J=1,ORDER-1
       IORDER=IORDER+1
       IF (BTEST(IBRACKET-1,J-1)) THEN ! BRACKET CLOSES
        IGROUP=IGROUP+1
        BORDERS(IBRACKET,IGROUP)=IORDER
        IORDER=0
       ENDIF
      ENDDO
     ENDIF
     IORDER=IORDER+1
     IGROUP=IGROUP+1
     BORDERS(IBRACKET,IGROUP)=IORDER
     BGROUPS(IBRACKET)=IGROUP
    ENDDO
!   WRITE(6,'(A,I3)') 'ORDER =',ORDER
!   DO IBRACKET=1,2**(ORDER-1)
!    WRITE(6,'(A,I3,A,20I2)') ' BRACKETING #',IBRACKET,':',(BORDERS(IBRACKET,J),J=1,BGROUPS(IBRACKET))
!   ENDDO

    ALL_M=0.0D0
    DO IBRACKET=1,2**(ORDER-1)
     TMP1=0.0D0
     DO I=1,NALL
      TMP1(I,I)=DFLOAT(ALLN(I))-NBAR
     ENDDO
     DO IGROUP=1,BGROUPS(IBRACKET)
      TMP2=0.0D0
      DO J=1,NALL
! ---- compressed
       DO I=1,N_COMP(BORDERS(IBRACKET,IGROUP))
        TMP2(J_COMP(I,BORDERS(IBRACKET,IGROUP)),J)=TMP2(J_COMP(I,BORDERS(IBRACKET,IGROUP)),J) &
               +E_COMP(I,BORDERS(IBRACKET,IGROUP))*TMP1(I_COMP(I,BORDERS(IBRACKET,IGROUP)),J)
! ---- uncompressed
!      DO I=1,NALL
!       DO K=1,NALL
!        TMP2(I,J)=TMP2(I,J)+EHC(I,K,BORDERS(IBRACKET,IGROUP))*TMP1(K,J)
!       ENDDO
! ---- uncompressed
       ENDDO
      ENDDO
      IF (IBRACKET > 1) THEN
       DO I=1,NALL
        DO J=1,NALL
         TMP2(I,J)=TMP2(I,J)-M_GEN(BORDERS(IBRACKET,IGROUP))*DFLOAT(ALLN(I))*TMP1(I,J)
        ENDDO
       ENDDO
      ENDIF
      TMP1=TMP2
     ENDDO
     DO I=1,NALL
      ALL_M(I)=ALL_M(I)+(-BETA)**(BGROUPS(IBRACKET)-1)/FACTORIAL(BGROUPS(IBRACKET))*TMP1(I,I)
     ENDDO
    ENDDO

    MU_R_N=0.0D0
    MU_R_D=0.0D0
    DO I=1,NALL
     MU_R_N=MU_R_N+ALL_M(I)*DEXP(-BETA*(E0(I)-ESHIFT-M_GEN(0)*DFLOAT(ALLN(I))))
     MU_R_D=MU_R_D+DEXP(-BETA*(E0(I)-ESHIFT-M_GEN(0)*DFLOAT(ALLN(I))))
    ENDDO
    MU_L=0.0D0
    DO I=1,2*(IALL(0,0,0)-IVIRTCORE)
     MU_L=MU_L+FMINUS2(I)*FPLUS2(I)  
    ENDDO
    M_GEN(ORDER)=MU_R_N/MU_R_D/MU_L
    M_ACC=M_ACC+M_GEN(ORDER)
    CALL CPU_TIME(ICPUE)
    WRITE(6,'(I3,F20.10,F20.10,F10.1)') ORDER,M_GEN(ORDER),M_ACC,ICPUE-ICPUS
    CALL PFLUSH(6)
    CALL CPU_TIME(ICPUS)

    DEALLOCATE(BGROUPS,BORDERS,FACTORIAL)

   ENDDO

!  ---------------
!  OMEGA RECURSION
!  ---------------

   O_GEN(0)=NUCLEAR_REPULSION
   DO I=1,IALL(0,0,0)-IVIRTCORE
    O_GEN(0)=O_GEN(0)+2.0D0*(EPSILON(I,0,0,0)-FERMI)+2.0D0*DLOG(FMINUS2(I))/BETA
   ENDDO
   O_ACC=O_GEN(0)
   WRITE(6,'(/,A)') '-----------------------------------------------------'
   WRITE(6,'(A)')   'ORDER    DELTA OMEGA(n)        SUM OMEGA(n)   CPU/SEC'
   CALL CPU_TIME(ICPUE)
   WRITE(6,'(I3,F20.10,F20.10,F10.1)') 0,O_GEN(0),O_ACC,ICPUE-ICPUS
   CALL PFLUSH(6)
   CALL CPU_TIME(ICPUS)

   DO ORDER=1,IOPTN(49)

    ALLOCATE(BGROUPS(2**(ORDER-1)),BORDERS(2**(ORDER-1),ORDER),FACTORIAL(0:ORDER))

    ! BRUECKNER BRACKET COMBINATORICS
    FACTORIAL(0)=1.0D0
    DO I=1,ORDER
     FACTORIAL(I)=FACTORIAL(I-1)*DFLOAT(I)
    ENDDO
    BGROUPS=0
    BORDERS=0
    DO IBRACKET=1,2**(ORDER-1)
     IGROUP=0
     IORDER=0
     IF (ORDER > 1) THEN
      DO J=1,ORDER-1
       IORDER=IORDER+1
       IF (BTEST(IBRACKET-1,J-1)) THEN ! BRACKET CLOSES
        IGROUP=IGROUP+1
        BORDERS(IBRACKET,IGROUP)=IORDER
        IORDER=0
       ENDIF
      ENDDO
     ENDIF
     IORDER=IORDER+1
     IGROUP=IGROUP+1
     BORDERS(IBRACKET,IGROUP)=IORDER
     BGROUPS(IBRACKET)=IGROUP
    ENDDO
!   WRITE(6,'(A,I3)') 'ORDER =',ORDER
!   DO IBRACKET=1,2**(ORDER-1)
!    WRITE(6,'(A,I3,A,20I2)') ' BRACKETING #',IBRACKET,':',(BORDERS(IBRACKET,J),J=1,BGROUPS(IBRACKET))
!   ENDDO

    ALL_M=0.0D0
    DO IBRACKET=1,2**(ORDER-1)
     TMP1=0.0D0
     DO I=1,NALL
      TMP1(I,I)=1.0D0
     ENDDO
     DO IGROUP=1,BGROUPS(IBRACKET)
      TMP2=0.0D0
      DO J=1,NALL
! ---- compressed
       DO I=1,N_COMP(BORDERS(IBRACKET,IGROUP))
        TMP2(J_COMP(I,BORDERS(IBRACKET,IGROUP)),J)=TMP2(J_COMP(I,BORDERS(IBRACKET,IGROUP)),J) &
               +E_COMP(I,BORDERS(IBRACKET,IGROUP))*TMP1(I_COMP(I,BORDERS(IBRACKET,IGROUP)),J)
! ---- uncompressed
!      DO I=1,NALL
!       DO K=1,NALL
!        TMP2(I,J)=TMP2(I,J)+EHC(I,K,BORDERS(IBRACKET,IGROUP))*TMP1(K,J)
!       ENDDO
! ---- uncompressed
       ENDDO
      ENDDO
      DO I=1,NALL
       DO J=1,NALL
        TMP2(I,J)=TMP2(I,J)-M_GEN(BORDERS(IBRACKET,IGROUP))*DFLOAT(ALLN(I))*TMP1(I,J)
       ENDDO
      ENDDO
      TMP1=TMP2
     ENDDO
!write(*,*) 'debug'
!if ((ORDER == 3).and.(BGROUPS(IBRACKET) /= 3)) cycle
     DO I=1,NALL
      ALL_M(I)=ALL_M(I)+(-BETA)**(BGROUPS(IBRACKET)-1)/FACTORIAL(BGROUPS(IBRACKET))*TMP1(I,I)
     ENDDO
    ENDDO
 
    O_R_N=0.0D0
    O_R_D=0.0D0
    DO I=1,NALL
     O_R_N=O_R_N+ALL_M(I)*DEXP(-BETA*(E0(I)-ESHIFT-M_GEN(0)*DFLOAT(ALLN(I))))
     O_R_D=O_R_D+DEXP(-BETA*(E0(I)-ESHIFT-M_GEN(0)*DFLOAT(ALLN(I))))
    ENDDO
    O_GEN(ORDER)=O_R_N/O_R_D
    IF (ORDER > 1) THEN
     DO IBRACKET=2,2**(ORDER-1)
!write(*,*) 'debug'
!if ((ORDER == 3).and.(BGROUPS(IBRACKET) /= 3)) cycle
      O_R_N=1.0D0
      DO IGROUP=1,BGROUPS(IBRACKET)
       O_R_N=O_R_N*O_GEN(BORDERS(IBRACKET,IGROUP))
!write(*,*) '* Omega(',BORDERS(IBRACKET,IGROUP),')=',O_GEN(BORDERS(IBRACKET,IGROUP))
      ENDDO
      O_GEN(ORDER)=O_GEN(ORDER)-(-BETA)**(BGROUPS(IBRACKET)-1)/FACTORIAL(BGROUPS(IBRACKET))*O_R_N
!write(*,*) '- beta**',BGROUPS(IBRACKET)-1,'/',BGROUPS(IBRACKET),'!'
     ENDDO
    ENDIF
    O_ACC=O_ACC+O_GEN(ORDER)
    CALL CPU_TIME(ICPUE)
    WRITE(6,'(I3,F20.10,F20.10,F10.1)') ORDER,O_GEN(ORDER),O_ACC,ICPUE-ICPUS
    CALL PFLUSH(6)
    CALL CPU_TIME(ICPUS)

    DEALLOCATE(BGROUPS,BORDERS,FACTORIAL)

   ENDDO

!  -----------
!  U RECURSION
!  -----------

   U_GEN(0)=NUCLEAR_REPULSION
   DO I=1,IALL(0,0,0)-IVIRTCORE
    U_GEN(0)=U_GEN(0)+2.0D0*EPSILON(I,0,0,0)*FMINUS2(I)
   ENDDO
   U_ACC=U_GEN(0)
   WRITE(6,'(/,A)') '-----------------------------------------------------'
   WRITE(6,'(A)')   'ORDER       DELTA U(n)           SUM U(n)     CPU/SEC'
   CALL CPU_TIME(ICPUE)
   WRITE(6,'(I3,F20.10,F20.10,F10.1)') 0,U_GEN(0),U_ACC,ICPUE-ICPUS
   CALL PFLUSH(6)
   CALL CPU_TIME(ICPUS)

   DO ORDER=1,IOPTN(49)

    ALLOCATE(BGROUPS(2**ORDER),BORDERS(2**ORDER,ORDER+1),FACTORIAL(0:ORDER))

    ! BRUECKNER BRACKET COMBINATORICS
    FACTORIAL(0)=1.0D0
    DO I=1,ORDER
     FACTORIAL(I)=FACTORIAL(I-1)*DFLOAT(I)
    ENDDO
    BGROUPS=0
    BORDERS=0
    DO IBRACKET=1,2**(ORDER-1)
     IGROUP=0
     IORDER=0
     IF (ORDER > 1) THEN
      DO J=1,ORDER-1
       IORDER=IORDER+1
       IF (BTEST(IBRACKET-1,J-1)) THEN ! BRACKET CLOSES
        IGROUP=IGROUP+1
        BORDERS(IBRACKET,IGROUP)=IORDER
        IORDER=0
       ENDIF
      ENDDO
     ENDIF
     IORDER=IORDER+1
     IGROUP=IGROUP+1
     BORDERS(IBRACKET,IGROUP)=IORDER
     BGROUPS(IBRACKET)=IGROUP
    ENDDO
    DO IBRACKET=1,2**(ORDER-1)
     BGROUPS(IBRACKET+2**(ORDER-1))=BGROUPS(IBRACKET)+1
     DO J=1,BGROUPS(IBRACKET)
      BORDERS(IBRACKET+2**(ORDER-1),J)=BORDERS(IBRACKET,J)
     ENDDO
     BORDERS(IBRACKET+2**(ORDER-1),BGROUPS(IBRACKET)+1)=0
    ENDDO
!   WRITE(6,'(A,I3)') 'ORDER =',ORDER
!   DO IBRACKET=1,2**ORDER
!    WRITE(6,'(A,I3,A,20I2)') ' BRACKETING #',IBRACKET,':',(BORDERS(IBRACKET,J),J=1,BGROUPS(IBRACKET))
!   ENDDO

    ALL_M=0.0D0
    DO IBRACKET=1,2**ORDER
     TMP1=0.0D0
     DO I=1,NALL
      TMP1(I,I)=1.0D0
     ENDDO
     DO IGROUP=1,BGROUPS(IBRACKET)
      TMP2=0.0D0
      DO J=1,NALL
! ---- compressed
       DO I=1,N_COMP(BORDERS(IBRACKET,IGROUP))
        TMP2(J_COMP(I,BORDERS(IBRACKET,IGROUP)),J)=TMP2(J_COMP(I,BORDERS(IBRACKET,IGROUP)),J) &
               +E_COMP(I,BORDERS(IBRACKET,IGROUP))*TMP1(I_COMP(I,BORDERS(IBRACKET,IGROUP)),J)
! ---- uncompressed
!      DO I=1,NALL
!       DO K=1,NALL
!        TMP2(I,J)=TMP2(I,J)+EHC(I,K,BORDERS(IBRACKET,IGROUP))*TMP1(K,J)
!       ENDDO
! ---- uncompressed
       ENDDO
      ENDDO
      IF (IBRACKET > 1) THEN
       DO I=1,NALL
        DO J=1,NALL
         TMP2(I,J)=TMP2(I,J)-M_GEN(BORDERS(IBRACKET,IGROUP))*DFLOAT(ALLN(I))*TMP1(I,J)
        ENDDO
       ENDDO
      ENDIF
      TMP1=TMP2
     ENDDO
     DO I=1,NALL
      ALL_M(I)=ALL_M(I)+(-BETA)**(BGROUPS(IBRACKET)-1)/FACTORIAL(BGROUPS(IBRACKET)-1)*TMP1(I,I)
     ENDDO
    ENDDO

    U_R_N=0.0D0
    U_R_D=0.0D0
    DO I=1,NALL
     U_R_N=U_R_N+ALL_M(I)*DEXP(-BETA*(E0(I)-ESHIFT-M_GEN(0)*DFLOAT(ALLN(I))))
     U_R_D=U_R_D+DEXP(-BETA*(E0(I)-ESHIFT-M_GEN(0)*DFLOAT(ALLN(I))))
    ENDDO
    U_GEN(ORDER)=U_R_N/U_R_D
    DO IBRACKET=2,2**ORDER
     U_R_N=1.0D0
     DO IGROUP=1,BGROUPS(IBRACKET)
      IF (IGROUP==BGROUPS(IBRACKET)) THEN
       U_R_N=U_R_N*(U_GEN(BORDERS(IBRACKET,IGROUP))-M_GEN(BORDERS(IBRACKET,IGROUP))*NBAR)
!write(*,'(a,i0,a,i0,a)') '* U(',BORDERS(IBRACKET,IGROUP),')-mu(',BORDERS(IBRACKET,IGROUP),')N'
!write(*,*) U_GEN(BORDERS(IBRACKET,IGROUP))-M_GEN(BORDERS(IBRACKET,IGROUP))*NBAR
      ELSE
       U_R_N=U_R_N*O_GEN(BORDERS(IBRACKET,IGROUP))
!write(*,'(a,i0,a)') '* Omega(',BORDERS(IBRACKET,IGROUP),')'
!write(*,*) O_GEN(BORDERS(IBRACKET,IGROUP))
      ENDIF
     ENDDO
     U_GEN(ORDER)=U_GEN(ORDER)-(-BETA)**(BGROUPS(IBRACKET)-1)/FACTORIAL(BGROUPS(IBRACKET)-1)*U_R_N
!write(*,*) '-(-beta)**',BGROUPS(IBRACKET)-1,'/',BGROUPS(IBRACKET)-1,'!'
    ENDDO
    U_ACC=U_ACC+U_GEN(ORDER)
    CALL CPU_TIME(ICPUE)
    WRITE(6,'(I3,F20.10,F20.10,F10.1)') ORDER,U_GEN(ORDER),U_ACC,ICPUE-ICPUS
    CALL PFLUSH(6)
    CALL CPU_TIME(ICPUS)

    DEALLOCATE(BGROUPS,BORDERS,FACTORIAL)

   ENDDO

!  -----------
!  S RECURSION
!  -----------

   S_ACC=0.0D0
   WRITE(6,'(/,A)') '-----------------------------------------------------'
   WRITE(6,'(A)')   'ORDER     DELTA S(n)/kB         SUM S(n)/kB   CPU/SEC'
   CALL CPU_TIME(ICPUS)
   DO ORDER=0,IOPTN(49)
    S_GEN(ORDER)=(U_GEN(ORDER)-M_GEN(ORDER)*NBAR-O_GEN(ORDER))*BETA
    S_ACC=S_ACC+S_GEN(ORDER)
    CALL CPU_TIME(ICPUE)
    WRITE(6,'(I3,F20.10,F20.10,F10.1)') ORDER,S_GEN(ORDER),S_ACC,ICPUE-ICPUS
    CALL PFLUSH(6)
    CALL CPU_TIME(ICPUS)
   ENDDO

   DEALLOCATE(N_COMP,I_COMP,J_COMP,E_COMP)
   DEALLOCATE(FMINUS2,FPLUS2)
   DEALLOCATE(TMP1,TMP2)
   DEALLOCATE(EHC,VHC)

999 continue
   WRITE(6,'(/,A)') '=========================================='
   WRITE(6,'(A)')   '= GENERAL-ORDER THERMAL MBPT (CANONICAL) ='
   WRITE(6,'(A)')   '=========================================='
   WRITE(6,'(A,E20.6,A)') 'TEMP      = ',DOPTN(98),' K'
   WRITE(6,'(A,F20.6,A)') 'FERMI     = ',FERMI,' HARTREE'
   WRITE(6,'(A,I0)')      'ORDER     = ',IOPTN(49)

   ! ==========================================
   ! GENERATE HCPT EFFECTIVE HAMILTONIAN MATRIX
   ! ==========================================
   !
   ! ZEROTH-ORDER ENERGIES UNSORTED
   !                       ^^^^^^^^
   NALL_CHECK=0
   ESHIFT=1.0D9
   DO NELE=2*ICORE,2*(IALL(0,0,0)-IVIRTCORE)
    DO NELEA=ICORE,NELE
     NELEB=NELE-NELEA
     IF (NELEA > IALL(0,0,0)-IVIRTCORE) CYCLE
     IF (NELEB > IALL(0,0,0)-IVIRTCORE) CYCLE
     IF (NELEA < ICORE) CYCLE
     IF (NELEB < ICORE) CYCLE
!===== CANONICAL ===================================================
     IF (NELE /= 2*IOCC) CYCLE
!===================================================================
     CALL THERMAL_GENERATE_CONFIGURATIONSA(NELEA,MIN(NELEA,IALL(0,0,0)-IVIRTCORE-NELEA))
     CALL THERMAL_GENERATE_CONFIGURATIONSB(NELEB,MIN(NELEB,IALL(0,0,0)-IVIRTCORE-NELEB))
     DO IA=1,NCFA
      DO IB=1,NCFB
       E0(NALL_CHECK+(IA-1)*NCFB+IB)=NUCLEAR_REPULSION
       DO I=1,IALL(0,0,0)-IVIRTCORE
        IF (BTEST(CFHALFA(IA),I-1)) &
         E0(NALL_CHECK+(IA-1)*NCFB+IB)=E0(NALL_CHECK+(IA-1)*NCFB+IB)+EPSILON(I,0,0,0)
        IF (BTEST(CFHALFB(IB),I-1)) &
         E0(NALL_CHECK+(IA-1)*NCFB+IB)=E0(NALL_CHECK+(IA-1)*NCFB+IB)+EPSILON(I,0,0,0)
       ENDDO
      ENDDO
     ENDDO
     DO I=1,NCFA*NCFB
      ALLN(NALL_CHECK+I)=NELE
      IF (E0(NALL_CHECK+I) < ESHIFT) ESHIFT=E0(NALL_CHECK+I)
     ENDDO
     NALL_CHECK=NALL_CHECK+NCFA*NCFB
     DEALLOCATE(CFHALFA,ADDRSSA,NORDERA)
     DEALLOCATE(CFHALFB,ADDRSSB,NORDERB)
    ENDDO
   ENDDO
   NALL=NALL_CHECK
   !
   ! ALLOCATE EHC ARRAY AND POPULATE ZEROTH ORDER
   !
   ALLOCATE(EHC(NALL,NALL,0:IOPTN(49)),VHC(NALL,NALL,0:IOPTN(49)))
   EHC=0.0D0
   DO I=1,NALL
    EHC(I,I,0)=E0(I)
   ENDDO
   VHC=0.0D0
   DO I=1,NALL
    VHC(I,I,0)=1.0D0
   ENDDO
   !
   ! GENERATE HCPT EFFECTIVE HAMILTONIAN RECURSIVELY
   !
   CALL CPU_TIME(ICPUS)
   WRITE(6,'(/,A)')   'GENERATING HCPT EFFECTIVE HAMILTONIAN MATRIX'
   DO ORDER=1,IOPTN(49)
    CALL CPU_TIME(ICPUS)
    NALL_CHECK=0
    DO NELE=2*ICORE,2*(IALL(0,0,0)-IVIRTCORE)
     DO NELEA=ICORE,NELE
      NELEB=NELE-NELEA
      IF (NELEA > IALL(0,0,0)-IVIRTCORE) CYCLE
      IF (NELEB > IALL(0,0,0)-IVIRTCORE) CYCLE
      IF (NELEA < ICORE) CYCLE
      IF (NELEB < ICORE) CYCLE
!===== CANONICAL ===================================================
      IF (NELE /= 2*IOCC) CYCLE
!===================================================================
      CALL THERMAL_GENERATE_CONFIGURATIONSA(NELEA,MIN(NELEA,IALL(0,0,0)-IVIRTCORE-NELEA))
      CALL THERMAL_GENERATE_CONFIGURATIONSB(NELEB,MIN(NELEB,IALL(0,0,0)-IVIRTCORE-NELEB))
      CALL EHC_GEN(ORDER,NALL_CHECK)
      NALL_CHECK=NALL_CHECK+NCFA*NCFB
      DEALLOCATE(CFHALFA,ADDRSSA,NORDERA)
      DEALLOCATE(CFHALFB,ADDRSSB,NORDERB)
     ENDDO
    ENDDO
    NALL=NALL_CHECK
    CALL CPU_TIME(ICPUE)
    WRITE(6,'(A,I3,A,F10.2)') 'ORDER:',ORDER,' CPU/SEC =',ICPUE-ICPUS
    CALL PFLUSH(6)
   ENDDO

! -----------
! COMPRESSION
! -----------

   ALLOCATE(N_COMP(0:IOPTN(49)),I_COMP(NALL*NALL,0:IOPTN(49)),J_COMP(NALL*NALL,0:IOPTN(49)))
   ALLOCATE(E_COMP(NALL*NALL,0:IOPTN(49)))
   N_COMP=0
   I_COMP=0
   J_COMP=0
   E_COMP=0.0D0
   DO ORDER=0,IOPTN(49)
    DO I=1,NALL
     DO J=1,NALL
      IF (DABS(EHC(J,I,ORDER)) > 1.0D-14) THEN
       N_COMP(ORDER)=N_COMP(ORDER)+1
       I_COMP(N_COMP(ORDER),ORDER)=I
       J_COMP(N_COMP(ORDER),ORDER)=J
       E_COMP(N_COMP(ORDER),ORDER)=EHC(J,I,ORDER)
      ENDIF
     ENDDO
    ENDDO
    WRITE(6,'(A,I3,A,I5,A,I10)') 'ORDER:',ORDER,' COMPRESSION = ',N_COMP(ORDER),' /',NALL*NALL
   ENDDO

   ! ALL GRAND CANONICAL QUANTITIES ARE OVERWRITTEN
   ALLOCATE(TMP1(NALL,NALL),TMP2(NALL,NALL))

!  ---------------------
!  CANONICAL F RECURSION
!  ---------------------

   M_GEN=0.0D0

   O_GEN(0)=0.0D0
   DO I=1,NALL
    O_GEN(0)=O_GEN(0)+DEXP(-BETA*E0(I))
   ENDDO
   O_GEN(0)=-DLOG(O_GEN(0))/BETA
   O_ACC=O_GEN(0)
   WRITE(6,'(/,A)') '====================== CANONICAL ===================='
   WRITE(6,'(A)')   'ORDER       DELTA F(n)           SUM F(n)     CPU/SEC'
   CALL CPU_TIME(ICPUE)
   WRITE(6,'(I3,F20.10,F20.10,F10.1)') 0,O_GEN(0),O_ACC,ICPUE-ICPUS
   CALL PFLUSH(6)
   CALL CPU_TIME(ICPUS)

   DO ORDER=1,IOPTN(49)

    ALLOCATE(BGROUPS(2**(ORDER-1)),BORDERS(2**(ORDER-1),ORDER),FACTORIAL(0:ORDER))
    BETA=1.0D0/BOLTZMANN/DOPTN(98)

    ! BRUECKNER BRACKET COMBINATORICS
    FACTORIAL(0)=1.0D0
    DO I=1,ORDER
     FACTORIAL(I)=FACTORIAL(I-1)*DFLOAT(I)
    ENDDO
    BGROUPS=0
    BORDERS=0
    DO IBRACKET=1,2**(ORDER-1)
     IGROUP=0
     IORDER=0
     IF (ORDER > 1) THEN
      DO J=1,ORDER-1
       IORDER=IORDER+1
       IF (BTEST(IBRACKET-1,J-1)) THEN ! BRACKET CLOSES
        IGROUP=IGROUP+1
        BORDERS(IBRACKET,IGROUP)=IORDER
        IORDER=0
       ENDIF
      ENDDO
     ENDIF
     IORDER=IORDER+1
     IGROUP=IGROUP+1
     BORDERS(IBRACKET,IGROUP)=IORDER
     BGROUPS(IBRACKET)=IGROUP
    ENDDO
!   WRITE(6,'(A,I3)') 'ORDER =',ORDER
!   DO IBRACKET=1,2**(ORDER-1)
!    WRITE(6,'(A,I3,A,20I2)') ' BRACKETING #',IBRACKET,':',(BORDERS(IBRACKET,J),J=1,BGROUPS(IBRACKET))
!   ENDDO
 
    ALL_M=0.0D0
    DO IBRACKET=1,2**(ORDER-1)
     TMP1=0.0D0
     DO I=1,NALL
      TMP1(I,I)=1.0D0
     ENDDO
     DO IGROUP=1,BGROUPS(IBRACKET)
      TMP2=0.0D0
      DO J=1,NALL
! --- compressed
       DO I=1,N_COMP(BORDERS(IBRACKET,IGROUP))
        TMP2(J_COMP(I,BORDERS(IBRACKET,IGROUP)),J)=TMP2(J_COMP(I,BORDERS(IBRACKET,IGROUP)),J)+ &
                E_COMP(I,BORDERS(IBRACKET,IGROUP))*TMP1(I_COMP(I,BORDERS(IBRACKET,IGROUP)),J)
! --- uncompressed
!      DO I=1,NALL
!       DO K=1,NALL
!        TMP2(I,J)=TMP2(I,J)+EHC(I,K,BORDERS(IBRACKET,IGROUP))*TMP1(K,J)
!       ENDDO
! --- uncompressed
       ENDDO
      ENDDO
      TMP1=TMP2
     ENDDO
     DO I=1,NALL
      ALL_M(I)=ALL_M(I)+(-BETA)**(BGROUPS(IBRACKET)-1)/FACTORIAL(BGROUPS(IBRACKET))*TMP1(I,I)
     ENDDO
    ENDDO
    O_R_N=0.0D0
    O_R_D=0.0D0
    DO I=1,NALL
     O_R_N=O_R_N+ALL_M(I)*DEXP(-BETA*(E0(I)-ESHIFT-M_GEN(0)*DFLOAT(ALLN(I))))
     O_R_D=O_R_D+DEXP(-BETA*(E0(I)-ESHIFT-M_GEN(0)*DFLOAT(ALLN(I))))
    ENDDO
    O_GEN(ORDER)=O_R_N/O_R_D
    IF (ORDER > 1) THEN
     DO IBRACKET=2,2**(ORDER-1)
      O_R_N=1.0D0
      DO IGROUP=1,BGROUPS(IBRACKET)
       O_R_N=O_R_N*O_GEN(BORDERS(IBRACKET,IGROUP))
!write(*,*) '* Omega(',BORDERS(IBRACKET,IGROUP),')=',O_GEN(BORDERS(IBRACKET,IGROUP))
      ENDDO
      O_GEN(ORDER)=O_GEN(ORDER)-(-BETA)**(BGROUPS(IBRACKET)-1)/FACTORIAL(BGROUPS(IBRACKET))*O_R_N
!write(*,*) '- beta**',BGROUPS(IBRACKET)-1,'/',BGROUPS(IBRACKET),'!'
     ENDDO
    ENDIF
    O_ACC=O_ACC+O_GEN(ORDER)
    CALL CPU_TIME(ICPUE)
    WRITE(6,'(I3,F20.10,F20.10,F10.1)') ORDER,O_GEN(ORDER),O_ACC,ICPUE-ICPUS
    CALL PFLUSH(6)
    CALL CPU_TIME(ICPUS)
!----
!write(*,*) 'debug'
!   O_R_N=0.0D0
!   O_R_D=0.0D0
!   MU_R_N=0.0D0
!   MU_R_D=0.0D0
!   U_R_N=0.0D0
!   U_R_D=0.0D0
!   DO I=1,NALL
!    MU_R_N=MU_R_N+E1_CHECK(I)*DEXP(-BETA*(E0_CHECK(I)-ESHIFT))
!    MU_R_D=MU_R_D+E2_CHECK(I)*DEXP(-BETA*(E0_CHECK(I)-ESHIFT))
!    U_R_N=U_R_N+E2_CHECK(I)*DEXP(-BETA*(E0_CHECK(I)-ESHIFT)) &
!                             -0.5D0*BETA*E1_CHECK(I)*E1_CHECK(I)*DEXP(-BETA*(E0_CHECK(I)-ESHIFT))
!    U_R_D=U_R_D+E1_CHECK(I)*E1_CHECK(I)*DEXP(-BETA*(E0_CHECK(I)-ESHIFT))
!    O_R_N=O_R_N+(E3_CHECK(I)-BETA*E1_CHECK(I)*E2_CHECK(I)+BETA*BETA/6.0D0*E1_CHECK(I)**3) &
!                *DEXP(-BETA*(E0_CHECK(I)-ESHIFT))
!    O_R_D=O_R_D+DEXP(-BETA*(E0_CHECK(I)-ESHIFT))
!   ENDDO
!   if (order==1) write(*,'(A,F20.10)') 'Order 1 =',MU_R_N/O_R_D
!   if (order==2) write(*,'(A,F20.10)') 'Order 2 =',MU_R_D/O_R_D-0.5D0*BETA*U_R_D/O_R_D+0.5D0*BETA*(MU_R_N/O_R_D)**2
!   if (order==3) write(*,'(A,F20.10)') 'Order 3 =',O_R_N/O_R_D+BETA*(MU_R_N/O_R_D)*(MU_R_D/O_R_D) &
!                                       -(BETA**2)/2.0D0*(MU_R_N/O_R_D)*(U_R_D/O_R_D) &
!                                       +(BETA**2)/3.0D0*(MU_R_N/O_R_D)**3
!----

    DEALLOCATE(BGROUPS,BORDERS,FACTORIAL)

   ENDDO

!  ---------------------
!  CANONICAL U RECURSION
!  ---------------------

   U_R_N=0.0D0
   U_R_D=0.0D0
   DO I=1,NALL
    U_R_N=U_R_N+E0(I)*DEXP(-BETA*E0(I))
    U_R_D=U_R_D+DEXP(-BETA*E0(I))
   ENDDO
   U_GEN(0)=U_R_N/U_R_D
   U_ACC=U_GEN(0)
   WRITE(6,'(/,A)') '====================== CANONICAL ===================='
   WRITE(6,'(A)')   'ORDER       DELTA U(n)           SUM U(n)     CPU/SEC'
   CALL CPU_TIME(ICPUE)
   WRITE(6,'(I3,F20.10,F20.10,F10.1)') 0,U_GEN(0),U_ACC,ICPUE-ICPUS
   CALL PFLUSH(6)
   CALL CPU_TIME(ICPUS)

   DO ORDER=1,IOPTN(49)

    ALLOCATE(BGROUPS(2**ORDER),BORDERS(2**ORDER,ORDER+1),FACTORIAL(0:ORDER))
    BETA=1.0D0/BOLTZMANN/DOPTN(98)

    ! BRUECKNER BRACKET COMBINATORICS
    FACTORIAL(0)=1.0D0
    DO I=1,ORDER
     FACTORIAL(I)=FACTORIAL(I-1)*DFLOAT(I)
    ENDDO
    BGROUPS=0
    BORDERS=0
    DO IBRACKET=1,2**(ORDER-1)
     IGROUP=0
     IORDER=0
     IF (ORDER > 1) THEN
      DO J=1,ORDER-1
       IORDER=IORDER+1
       IF (BTEST(IBRACKET-1,J-1)) THEN ! BRACKET CLOSES
        IGROUP=IGROUP+1
        BORDERS(IBRACKET,IGROUP)=IORDER
        IORDER=0
       ENDIF
      ENDDO
     ENDIF
     IORDER=IORDER+1
     IGROUP=IGROUP+1
     BORDERS(IBRACKET,IGROUP)=IORDER
     BGROUPS(IBRACKET)=IGROUP
    ENDDO
    DO IBRACKET=1,2**(ORDER-1)
     BGROUPS(IBRACKET+2**(ORDER-1))=BGROUPS(IBRACKET)+1
     DO J=1,BGROUPS(IBRACKET)
      BORDERS(IBRACKET+2**(ORDER-1),J)=BORDERS(IBRACKET,J)
     ENDDO
     BORDERS(IBRACKET+2**(ORDER-1),BGROUPS(IBRACKET)+1)=0
    ENDDO
!   WRITE(6,'(A,I3)') 'ORDER =',ORDER
!   DO IBRACKET=1,2**ORDER
!    WRITE(6,'(A,I3,A,20I2)') ' BRACKETING #',IBRACKET,':',(BORDERS(IBRACKET,J),J=1,BGROUPS(IBRACKET))
!   ENDDO
 
    ALL_M=0.0D0
    DO IBRACKET=1,2**ORDER
     TMP1=0.0D0
     DO I=1,NALL
      TMP1(I,I)=1.0D0
     ENDDO
     DO IGROUP=1,BGROUPS(IBRACKET)
      TMP2=0.0D0
      DO J=1,NALL
! --- compressed
       DO I=1,N_COMP(BORDERS(IBRACKET,IGROUP))
        TMP2(J_COMP(I,BORDERS(IBRACKET,IGROUP)),J)=TMP2(J_COMP(I,BORDERS(IBRACKET,IGROUP)),J)+ &
                E_COMP(I,BORDERS(IBRACKET,IGROUP))*TMP1(I_COMP(I,BORDERS(IBRACKET,IGROUP)),J)
! --- uncompressed
!      DO I=1,NALL
!       DO K=1,NALL
!        TMP2(I,J)=TMP2(I,J)+EHC(I,K,BORDERS(IBRACKET,IGROUP))*TMP1(K,J)
!       ENDDO
! --- uncompressed
       ENDDO
      ENDDO
      TMP1=TMP2
     ENDDO
     DO I=1,NALL
      ALL_M(I)=ALL_M(I)+(-BETA)**(BGROUPS(IBRACKET)-1)/FACTORIAL(BGROUPS(IBRACKET)-1)*TMP1(I,I)
     ENDDO
    ENDDO
    U_R_N=0.0D0
    U_R_D=0.0D0
    DO I=1,NALL
     U_R_N=U_R_N+ALL_M(I)*DEXP(-BETA*(E0(I)-ESHIFT-M_GEN(0)*DFLOAT(ALLN(I))))
     U_R_D=U_R_D+DEXP(-BETA*(E0(I)-ESHIFT-M_GEN(0)*DFLOAT(ALLN(I))))
    ENDDO
    U_GEN(ORDER)=U_R_N/U_R_D
    DO IBRACKET=2,2**ORDER
     U_R_N=1.0D0
     DO IGROUP=1,BGROUPS(IBRACKET)
      IF (IGROUP==BGROUPS(IBRACKET)) THEN
       U_R_N=U_R_N*(U_GEN(BORDERS(IBRACKET,IGROUP))-M_GEN(BORDERS(IBRACKET,IGROUP))*NBAR)
!write(*,'(a,i0,a,i0,a)') '* U(',BORDERS(IBRACKET,IGROUP),')-mu(',BORDERS(IBRACKET,IGROUP),')N'
!write(*,*) U_GEN(BORDERS(IBRACKET,IGROUP))-M_GEN(BORDERS(IBRACKET,IGROUP))*NBAR
      ELSE
       U_R_N=U_R_N*O_GEN(BORDERS(IBRACKET,IGROUP))
!write(*,'(a,i0,a)') '* Omega(',BORDERS(IBRACKET,IGROUP),')'
!write(*,*) O_GEN(BORDERS(IBRACKET,IGROUP))
      ENDIF
     ENDDO
     U_GEN(ORDER)=U_GEN(ORDER)-(-BETA)**(BGROUPS(IBRACKET)-1)/FACTORIAL(BGROUPS(IBRACKET)-1)*U_R_N
!write(*,*) '-(-beta)**',BGROUPS(IBRACKET)-1,'/',BGROUPS(IBRACKET)-1,'!'
    ENDDO
    U_ACC=U_ACC+U_GEN(ORDER)
    CALL CPU_TIME(ICPUE)
    WRITE(6,'(I3,F20.10,F20.10,F10.1)') ORDER,U_GEN(ORDER),U_ACC,ICPUE-ICPUS
    CALL PFLUSH(6)
    CALL CPU_TIME(ICPUS)

    DEALLOCATE(BGROUPS,BORDERS,FACTORIAL)

   ENDDO

!  ---------------------
!  CANONICAL S RECURSION
!  ---------------------

   S_ACC=0.0D0
   WRITE(6,'(/,A)') '====================== CANONICAL ===================='
   WRITE(6,'(A)')   'ORDER     DELTA S(n)/kB         SUM S(n)/kB   CPU/SEC'
   CALL CPU_TIME(ICPUS)
   DO ORDER=0,IOPTN(49)
    S_GEN(ORDER)=(U_GEN(ORDER)-O_GEN(ORDER))*BETA
    S_ACC=S_ACC+S_GEN(ORDER)
    CALL CPU_TIME(ICPUE)
    WRITE(6,'(I3,F20.10,F20.10,F10.1)') ORDER,S_GEN(ORDER),S_ACC,ICPUE-ICPUS
    CALL PFLUSH(6)
    CALL CPU_TIME(ICPUS)
   ENDDO

   DEALLOCATE(TMP1,TMP2)
   DEALLOCATE(EHC,VHC)
   DEALLOCATE(ALL_M,E0,ALLE,ALLN)
   DEALLOCATE(H,G)

   RETURN
END SUBROUTINE



SUBROUTINE THERMAL_V_PRODUCT(INFILE,OUTFILE)
! FORM THE PRODUCT OF V (PERTURBATION) MATRIX AND A TRIAL VECTOR IN INFILE
! AND STORE THE PRODUCT VECTOR IN OUTFILE. 

   USE CONTROL
   USE GRADIENT
   USE STRUCTURE
   USE INTEGRAL
   USE BASISSET
   USE THR_FULLCI

   IMPLICIT NONE
   INTEGER :: INFILE,OUTFILE
   INTEGER :: I
   INTEGER :: IA,IB
   DOUBLE PRECISION,ALLOCATABLE :: TRL(:,:),PRD(:,:)

   ALLOCATE(TRL(NCFB,NCFA),PRD(NCFB,NCFA))
   
   ! ACT HAMILTONIAN ON INFILE
   REWIND(INFILE)
   READ(INFILE) TRL
   CALL THERMAL_HAMILTONIAN_PRODUCT(INFILE,OUTFILE,0,1.0D0)
   REWIND(OUTFILE)
   READ(OUTFILE) PRD

   ! H0
   DO IA=1,NCFA
    DO IB=1,NCFB
     DO I=1,IALL(0,0,0)-IVIRTCORE
      IF (BTEST(CFHALFA(IA),I-1)) PRD(IB,IA)=PRD(IB,IA)-EPSILON(I,0,0,0)*TRL(IB,IA)
      IF (BTEST(CFHALFB(IB),I-1)) PRD(IB,IA)=PRD(IB,IA)-EPSILON(I,0,0,0)*TRL(IB,IA)
     ENDDO
    ENDDO
   ENDDO

   ! STORE PRODUCT VECTOR
   REWIND(OUTFILE)
   WRITE(OUTFILE) PRD

   DEALLOCATE(TRL,PRD)

   RETURN
END SUBROUTINE



SUBROUTINE RESOLVENT_PRODUCT(IA,IB,INFILE,OUTFILE)
! ACT THE RESOLVENT OPERATOR ON A TRIAL VECTOR.

   USE CONTROL
   USE STRUCTURE
   USE INTEGRAL
   USE BASISSET
   USE THR_FULLCI

   IMPLICIT NONE
   INTEGER :: IA,IB
   INTEGER :: INFILE,OUTFILE
   INTEGER :: IC,ID,I
   DOUBLE PRECISION :: E0,DENOM
   DOUBLE PRECISION,ALLOCATABLE :: TRL(:,:)

   ALLOCATE(TRL(NCFB,NCFA))
   REWIND(INFILE)
   READ(INFILE) TRL

   ! E0
   E0=0.0D0
   DO I=1,IALL(0,0,0)-IVIRTCORE
    IF (BTEST(CFHALFA(IA),I-1)) E0=E0+EPSILON(I,0,0,0)
    IF (BTEST(CFHALFB(IB),I-1)) E0=E0+EPSILON(I,0,0,0)
   ENDDO

   ! DIVIDE BY NONZERO DENOMINATOR OR ZERO BY ZERO DENOMINATOR
   DO IC=1,NCFA
    DO ID=1,NCFB
     DENOM=E0
     DO I=1,IALL(0,0,0)-IVIRTCORE
      IF (BTEST(CFHALFA(IC),I-1)) DENOM=DENOM-EPSILON(I,0,0,0)
      IF (BTEST(CFHALFB(ID),I-1)) DENOM=DENOM-EPSILON(I,0,0,0)
     ENDDO
     IF (DABS(DENOM) > 1.0D-13) THEN
      TRL(ID,IC)=TRL(ID,IC)/DENOM
     ELSE
      TRL(ID,IC)=0.0D0
     ENDIF
    ENDDO
   ENDDO

   REWIND(OUTFILE)
   WRITE(OUTFILE) TRL

   RETURN
END SUBROUTINE



SUBROUTINE ANTIRESOLVENT_PRODUCT(IA,IB,INFILE,OUTFILE)
! ACT THE RESOLVENT OPERATOR ON A TRIAL VECTOR.

   USE CONTROL
   USE STRUCTURE
   USE INTEGRAL
   USE BASISSET
   USE THR_FULLCI

   IMPLICIT NONE
   INTEGER :: IA,IB
   INTEGER :: INFILE,OUTFILE
   INTEGER :: IC,ID,I
   DOUBLE PRECISION :: E0,DENOM
   DOUBLE PRECISION,ALLOCATABLE :: TRL(:,:)

   ALLOCATE(TRL(NCFB,NCFA))
   REWIND(INFILE)
   READ(INFILE) TRL

   ! E0
   E0=0.0D0
   DO I=1,IALL(0,0,0)-IVIRTCORE
    IF (BTEST(CFHALFA(IA),I-1)) E0=E0+EPSILON(I,0,0,0)
    IF (BTEST(CFHALFB(IB),I-1)) E0=E0+EPSILON(I,0,0,0)
   ENDDO

   ! DIVIDE BY NONZERO DENOMINATOR OR ZERO BY ZERO DENOMINATOR
   DO IC=1,NCFA
    DO ID=1,NCFB
     DENOM=E0
     DO I=1,IALL(0,0,0)-IVIRTCORE
      IF (BTEST(CFHALFA(IC),I-1)) DENOM=DENOM-EPSILON(I,0,0,0)
      IF (BTEST(CFHALFB(ID),I-1)) DENOM=DENOM-EPSILON(I,0,0,0)
     ENDDO
     IF (DABS(DENOM) > 1.0D-13) TRL(ID,IC)=0.0D0
    ENDDO
   ENDDO

   REWIND(OUTFILE)
   WRITE(OUTFILE) TRL

   RETURN
END SUBROUTINE



SUBROUTINE EHC_GEN(ORDER,NALL_CHECK)
! CALCULATE THE HCPT EFFECTIVE HAMILTONIAN MATRIX AT ORDER > 0

   USE CONSTANTS
   USE CONTROL
   USE GRADIENT
   USE STRUCTURE
   USE INTEGRAL
   USE BASISSET
   USE THR_FULLCI

   IMPLICIT NONE
   INTEGER,PARAMETER :: MAXFILE = 100
   INTEGER :: ORDER
   INTEGER :: NALL_CHECK
   INTEGER :: IA,IB,IC,ID,IE,IG
   INTEGER :: I,J,K
   REAL :: MEM,ICPUS,ICPUE
   DOUBLE PRECISION,ALLOCATABLE :: VEC1(:,:),VEC2(:,:),VEC3(:,:)

   CALL CPU_TIME(ICPUS)
   MEM=16.0*2.0*NCFA*NCFB
   IF (MEM > DOPTN(28)*1000000.0) CALL PABORT('OUT OF MEMORY')
   ALLOCATE(VEC1(NCFB,NCFA),VEC2(NCFB,NCFA),VEC3(NCFB,NCFA))

   OPEN(50,FILE=TRIM(COPTN(1))//'.fi0',FORM='UNFORMATTED')
   OPEN(51,FILE=TRIM(COPTN(1))//'.fo0',FORM='UNFORMATTED')

   ! LOOP OVER ALL STATES
   DO IA=1,NCFA
    DO IB=1,NCFB

     DO I=1,ORDER

      ! V |I-1>
      DO IC=1,NCFA
       DO ID=1,NCFB
        VEC3(ID,IC)=VHC((IC-1)*NCFB+ID+NALL_CHECK,(IA-1)*NCFB+IB+NALL_CHECK,I-1)
       ENDDO
      ENDDO
      REWIND(50)
      WRITE(50) VEC3
      CALL THERMAL_V_PRODUCT(50,51)
      REWIND(51)
      READ(51) VEC1


      ! EHC(X,Y,I)=<0(Y)|V|I-1(X)>
      REWIND(50)
      WRITE(50) VEC1
      CALL ANTIRESOLVENT_PRODUCT(IA,IB,50,51)
      REWIND(51)
      READ(51) VEC2
      DO IC=1,NCFA
       DO ID=1,NCFB
        EHC((IA-1)*NCFB+IB+NALL_CHECK,(IC-1)*NCFB+ID+NALL_CHECK,I)=VEC2(ID,IC)
       ENDDO
      ENDDO

      IF (I > 1) THEN

       ! - E(J)|I-J>, J=1,...,I-1
       DO J=1,I-1
        DO IC=1,NCFA
         DO ID=1,NCFB
          DO IE=1,NCFA
           DO IG=1,NCFB
            VEC1(ID,IC)=VEC1(ID,IC)-EHC((IA-1)*NCFB+IB+NALL_CHECK,(IE-1)*NCFB+IG+NALL_CHECK,J) &
                                   *VHC((IC-1)*NCFB+ID+NALL_CHECK,(IE-1)*NCFB+IG+NALL_CHECK,I-J)
           ENDDO
          ENDDO
         ENDDO
        ENDDO
       ENDDO

      ENDIF

      ! R0
      REWIND(50)
      WRITE(50) VEC1
      CALL RESOLVENT_PRODUCT(IA,IB,50,51)
      REWIND(51)
      READ(51) VEC1

      DO IC=1,NCFA
       DO ID=1,NCFB
        VHC((IC-1)*NCFB+ID+NALL_CHECK,(IA-1)*NCFB+IB+NALL_CHECK,I)=VEC1(ID,IC)
       ENDDO
      ENDDO

     ENDDO

    ENDDO
   ENDDO
   CALL CPU_TIME(ICPUE)

   DEALLOCATE(VEC3,VEC2,VEC1)
   CLOSE(50)
   CLOSE(51)
   RETURN
END SUBROUTINE



SUBROUTINE TSDA_GRANDCANONICAL(LAMBDA,MU,OOO,UUU,SSS,LPRINT)
! PERFORM THERMAL SINGLE-DETERMINANT APPROXIMATION (WITHOUT ORBITAL ROTATION) IN GRAND CANONICAL ENSEMBLE

   USE CONSTANTS
   USE CONTROL
   USE STRUCTURE
   USE INTEGRAL
   USE BASISSET
   USE GRADIENT
   USE THR_FULLCI

   IMPLICIT NONE
   LOGICAL :: LPRINT
   DOUBLE PRECISION :: LAMBDA
   INTEGER :: NALL_CHECK,I
   DOUBLE PRECISION :: NBAR  ! MEAN NUMBER OF ELECTRONS
   DOUBLE PRECISION :: XI    ! GRAND PARTITION FUNCTION
   DOUBLE PRECISION :: MU    ! CHEMICAL POTENTIAL
   DOUBLE PRECISION :: OOO   ! GRAND POTENTIAL
   DOUBLE PRECISION :: UUU   ! INTERNAL ENERGY
   DOUBLE PRECISION :: SSS   ! ENTROPY
   DOUBLE PRECISION :: BETA  ! 1/(kB T)
   DOUBLE PRECISION :: MUMAX,MUMIN,MUMID
   DOUBLE PRECISION :: NBMAX,NBMIN,NBMID,NBERR

   IF ((KVCX /= 0).OR.(KVCY /= 0).OR.(KVCZ /= 0)) CALL PABORT('FOR MOLECULES ONLY')
   IF (LOPTN(25)) CALL PABORT('USE NON-DIRECT ALGORITHM')
   IF (IALL(0,0,0)-IOCC-IVIRTCORE <= 0) CALL PABORT('NO VIRTUAL ORBITAL')
   IF (ICORE > 0) CALL PABORT('ICORE LOGIC NOT TESTED YET')
   IF (IVIRTCORE > 0) CALL PABORT('IVIRTCORE LOGIC NOT TESTED YET')

   IF (LPRINT) THEN
    WRITE(6,'(/,A)') '********************************************************************'
    WRITE(6,'(A)')   '* THERMAL SINGLE-DETERMINANT APPROXIMATION (TSDA0) GRAND CANONICAL *'
    WRITE(6,'(A)')   '********************************************************************'
    WRITE(6,'(A,F20.6,A)') 'LAMBDA    = ',LAMBDA
    WRITE(6,'(A,E20.6,A)') 'TEMP      = ',DOPTN(98),' K'
    WRITE(6,'(A,F20.6,A)') 'FERMI     = ',FERMI,' HARTREE'
   ENDIF

   ALLOCATE(H(IALLMAX-IVIRTCORE,IALLMAX-IVIRTCORE))
   ALLOCATE(G(IALLMAX-IVIRTCORE,IALLMAX-IVIRTCORE,IALLMAX-IVIRTCORE,IALLMAX-IVIRTCORE))
   CALL THERMAL_ONE_ELECTRON_INTEGRALS
   CALL THERMAL_TWO_ELECTRON_INTEGRALS

   NALL=2**(2*(IALL(0,0,0)-IVIRTCORE-ICORE))
   ALLOCATE(ALLE(NALL),ALLN(NALL))

   ! LOOP OVER NUMBER OF ELECTRONS
   NALL_CHECK=0
   ESHIFT=1.0D9
   DO NELE=2*ICORE,2*(IALL(0,0,0)-IVIRTCORE)
!   WRITE(6,'(/,A,I3)')   'TOTAL # ELECTRONS             = ',NELE
    ! LOOP OVER SZ
    DO NELEA=ICORE,NELE
     NELEB=NELE-NELEA
     IF (NELEA > IALL(0,0,0)-IVIRTCORE) CYCLE
     IF (NELEB > IALL(0,0,0)-IVIRTCORE) CYCLE
     IF (NELEA < ICORE) CYCLE
     IF (NELEB < ICORE) CYCLE
!    WRITE(6,'(/,A,I3,A,I3)') ' # ALPHA-, BETA-ELECTRONS       = ',NELEA,'  ',NELEB
     CALL THERMAL_GENERATE_CONFIGURATIONSA(NELEA,MIN(NELEA,IALL(0,0,0)-IVIRTCORE-NELEA))
!    WRITE(6,'(A)') '     -----------------------'
     CALL THERMAL_GENERATE_CONFIGURATIONSB(NELEB,MIN(NELEB,IALL(0,0,0)-IVIRTCORE-NELEB))
!    WRITE(6,'(A,I3,A,I3,A,I4)') ' # ALPHA-, BETA-CONFIGURATIONS  = ',NCFA,' x',NCFB,'=',NCFA*NCFB
     CALL THERMAL_FULL_DIAGONAL(LAMBDA,NALL_CHECK)
     DO I=1,NCFA*NCFB
      ALLN(NALL_CHECK+I)=NELE
      IF (ALLE(NALL_CHECK+I) < ESHIFT) ESHIFT=ALLE(NALL_CHECK+I) 
     ENDDO
     NALL_CHECK=NALL_CHECK+NCFA*NCFB
     DEALLOCATE(CFHALFA,ADDRSSA,NORDERA)
     DEALLOCATE(CFHALFB,ADDRSSB,NORDERB)
    ENDDO
   ENDDO
!  WRITE(6,'(A,2I6)') 'TOTAL # CONFIGURATIONS = ',NALL_CHECK
   IF (NALL_CHECK /= NALL) CALL PABORT('A BUG IN THERMAL_CORRELATION')

!  WRITE(6,'(A)') '----------------------------'
!  WRITE(6,'(A)') '       N        ENERGY'
!  WRITE(6,'(A)') '----------------------------'
!  DO I=1,NALL
!   WRITE(6,'(I5,I3,F20.15)') I,ALLN(I),ALLE(I)
!  ENDDO
!  WRITE(6,'(A)') '----------------------------'
!  WRITE(6,'(A,F20.15)') 'SHIFT = ',ESHIFT

   ! CALCULATE XI & MU
   NBAR=DFLOAT(IOCC*2)
   BETA=1.0D0/BOLTZMANN/DOPTN(98)
   MUMAX=FERMI+DSQRT(DOPTN(98)/1.0D4)
   MUMIN=FERMI-DSQRT(DOPTN(98)/1.0D4)
   MUMID=(MUMAX+MUMIN)/2.0D0
   NBERR=1.0D9

   IF (LPRINT) THEN
    WRITE(6,'(/,A)') '----------------------------------------------------------------------------'
    WRITE(6,'(A)') '  TREND         N   (  MU MIN  )      N   (  MU MID  )      N   (  MU MAX  )'
    WRITE(6,'(A)') '----------------------------------------------------------------------------'
   ENDIF
   DO WHILE ((NBERR > 1.0D-10).OR.(MUMAX-MUMIN > 1.0D-6))
    CALL CALCNBAR(BETA,MUMAX,NBMAX)
    CALL CALCNBAR(BETA,MUMIN,NBMIN)
    CALL CALCNBAR(BETA,MUMID,NBMID)
    IF ((NBMAX > NBMID).AND.(NBMID > NBMIN)) THEN
     IF (LPRINT) &
     WRITE(6,'(A,3(F10.6,A,F10.6,A))') 'INCREASING',NBMIN,'(',MUMIN,')',NBMID,'(',MUMID,')',NBMAX,'(',MUMAX,')'
     IF (NBAR > NBMAX) THEN
      MUMIN=MUMAX
      MUMAX=MUMAX+(MUMAX-MUMID)
     ELSE IF (NBAR > NBMID) THEN
      MUMIN=MUMID
     ELSE IF (NBAR > NBMIN) THEN
      MUMAX=MUMID
     ELSE
      MUMAX=MUMIN
      MUMIN=MUMIN-(MUMID-MUMIN)
     ENDIF
     MUMID=(MUMAX+MUMIN)/2.0D0
    ELSE IF ((NBMAX < NBMID).AND.(NBMID < NBMIN)) THEN
     IF (LPRINT) &
     WRITE(6,'(A,3(F10.6,A,F10.6,A))') 'DECREASING',NBMIN,'(',MUMIN,')',NBMID,'(',MUMID,')',NBMAX,'(',MUMAX,')'
     IF (NBAR < NBMAX) THEN
      MUMIN=MUMAX
      MUMAX=MUMAX+(MUMAX-MUMID)
     ELSE IF (NBAR < NBMID) THEN
      MUMIN=MUMID
     ELSE IF (NBAR < NBMIN) THEN
      MUMAX=MUMID
     ELSE
      MUMAX=MUMIN
      MUMIN=MUMIN-(MUMID-MUMIN)
     ENDIF
     MUMID=(MUMAX+MUMIN)/2.0D0
    ELSE
     IF (LPRINT) &
     WRITE(6,'(A,3(F10.6,A,F10.6,A))') 'CONCAV/VEX',NBMIN,'(',MUMIN,')',NBMID,'(',MUMID,')',NBMAX,'(',MUMAX,')'
     CALL WARNING('BISECTION FAILED')
     MUMIN=1.0D99
     EXIT
    ENDIF
    NBERR=DABS(NBAR-NBMID)
   ENDDO
   IF (LPRINT) &
   WRITE(6,'(A)') '----------------------------------------------------------------------------'
   MU=MUMIN

   CALL CALCTHERM(BETA,MU,NBAR,XI,OOO,UUU,SSS)

   IF (LPRINT) THEN
    WRITE(6,'(/,A,F20.10)')          'LAMBDA                        =',LAMBDA
    WRITE(6,'(A,E20.10,A)')          'TEMPERATURE                   =',DOPTN(98),' K'
    WRITE(6,'(A,F20.10,A)')          'BETA                          =',BETA,' HARTREE**(-1)'
    WRITE(6,'(A,F20.10,A)')          'CONVERGED MU                  =',MU,' HARTREE'
    WRITE(6,'(A,F20.10,A)')          'ESHIFT                        =',ESHIFT,' HARTREE'
    WRITE(6,'(A,E20.10,A,F15.10,A)') 'XI (GRAND PARTITION FUNCTION) =',XI,' x EXP(',-BETA*ESHIFT,')'
    WRITE(6,'(A,F20.10,A)')          'OMEGA (GRAND POTENTIAL)       =',OOO,' HARTREE'
    WRITE(6,'(A,F20.10,A)')          'U (INTERNAL ENERGY)           =',UUU,' HARTREE'
    WRITE(6,'(A,F20.10,A)')          'S (ENTROPY)                   =',SSS,' kB'
   ENDIF
     
   DEALLOCATE(ALLE,ALLN,H,G)

   RETURN
END SUBROUTINE



SUBROUTINE THERMAL_FULL_DIAGONAL(LAMBDA,N)
! FORM FULL HAMILTONIAN AND COLLECT DIAGONAL ELEMENTS (NO DIAGONALIZATION OR EIGENVALUES)

   USE CONTROL
   USE GRADIENT
   USE STRUCTURE
   USE INTEGRAL
   USE BASISSET
   USE THR_FULLCI

   IMPLICIT NONE
   DOUBLE PRECISION :: LAMBDA
   INTEGER :: N
   LOGICAL,PARAMETER :: LEVEC = .FALSE.
   INTEGER :: IA,IB,IC,ID
   INTEGER :: INFO
   REAL :: MEM,DEV
   DOUBLE PRECISION,ALLOCATABLE :: HAM(:,:)
   DOUBLE PRECISION,ALLOCATABLE :: VL(:,:),VR(:,:),ER(:),EI(:),WK(:)
   DOUBLE PRECISION,ALLOCATABLE :: TRL(:,:)

   IF (LEVEC) THEN
    MEM=16.0*(2.0*NCFA*NCFB*NCFA*NCFB+8.0*NCFA*NCFB)
   ELSE
    MEM=16.0*(NCFA*NCFB*NCFA*NCFB+9.0*NCFA*NCFB)
   ENDIF
!  IF (MEM > 1000000.0) THEN
!   WRITE(6,'(A,F7.1,A)') 'ESTIMATED MEMORY USAGE WILL BE ',MEM/1000000.0,' MB'
!  ELSE IF (MEM > 1000.0) THEN
!   WRITE(6,'(A,F7.1,A)') 'ESTIMATED MEMORY USAGE WILL BE ',MEM/1000.0,' KB'
!  ELSE
!   WRITE(6,'(A,F7.1,A)') 'ESTIMATED MEMORY USAGE WILL BE ',MEM,' B'
!  ENDIF
   IF (MEM > DOPTN(28)*1000000.0) CALL PABORT('OUT OF MEMORY')
   ALLOCATE(HAM(NCFA*NCFB,NCFA*NCFB),VL(1,NCFA*NCFB),ER(NCFA*NCFB),EI(NCFA*NCFB),WK(4*NCFA*NCFB))
   IF (LEVEC) THEN
    ALLOCATE(VR(NCFA*NCFB,NCFA*NCFB))
   ELSE
    ALLOCATE(VR(1,NCFA*NCFB))
   ENDIF
   ALLOCATE(TRL(NCFB,NCFA))

   OPEN(50,FILE=TRIM(COPTN(1))//'.fi0',FORM='UNFORMATTED')
   OPEN(60,FILE=TRIM(COPTN(1))//'.fo0',FORM='UNFORMATTED')

   ! FORM HAMILTONIAN AND KEEP IT IN MEMORY
   DO IA=1,NCFA
    DO IB=1,NCFB
     TRL=0.0D0
     TRL(IB,IA)=1.0D0
     REWIND(50)
     WRITE(50) TRL
     CALL THERMAL_HAMILTONIAN_PRODUCT(50,60,0,LAMBDA)
     REWIND(60)
     READ(60) TRL
     DO IC=1,NCFA
      DO ID=1,NCFB
       HAM((IA-1)*NCFB+IB,(IC-1)*NCFB+ID)=TRL(ID,IC)
      ENDDO
     ENDDO
    ENDDO
   ENDDO
!  CALL DUMP5(HAM,NCFA*NCFB)

   IC=N
   DO IA=1,NCFA
    DO IB=1,NCFB
     IC=IC+1
!    WRITE(6,'(A,I3,A,F20.15,A,2I5)') 'STATE ',IC,' DIAGONAL = ', HAM((IA-1)*NCFB+IB,(IA-1)*NCFB+IB)+NUCLEAR_REPULSION,&
!                                     ' HARTREE',CFHALFA(IA),CFHALFB(IB)
    ENDDO
   ENDDO

   DEALLOCATE(TRL)
   CLOSE(50)
   CLOSE(60)

   ! COLLECT DIAGONAL ELEMENTS
   DO IA=1,NCFA*NCFB
    ER(IA)=HAM(IA,IA)
   ENDDO
   CALL PIKSRT_EVALONLY(NCFA*NCFB,ER)
   DO IA=1,NCFA*NCFB
    ALLE(N+IA)=ER(IA)+NUCLEAR_REPULSION
   ENDDO
   DO IA=1,NCFA*NCFB
!   WRITE(6,'(A,I3,A,F20.15,A)') 'STATE ',N+IA,' ENERGY = ', ER(IA)+NUCLEAR_REPULSION,' HARTREE'
   ENDDO
   CALL PFLUSH(6)

   DEALLOCATE(HAM,VL,VR,ER,EI,WK)

   RETURN
END SUBROUTINE
